<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Professional Rental Settlement Calculator for property sales with active tenancy in UAE. Calculate settlements, export reports, and generate communication messages.">
    <title>Rental Settlement Calculator</title>
    <link rel="icon" href="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text y=%22.9em%22 font-size=%2290%22&gt;%F0%9F%8F%A0&lt;/text&gt;&lt;/svg&gt;">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
    :root{
      --bg:#f1f5f9;
      --card:#ffffff;
      --muted:#6b7280;
      --border:#e6eef6;
      --accent:#0ea5a3;
      --accent-2:#60a5fa;
      --accent-3:#0077cc;
      --success:#10b981;
      --danger:#ef4444;
      --radius:12px;
      --shadow: 0 8px 20px rgba(9,30,63,0.06);
      --font-sans: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      --max-width:1240px;
      --text-primary:#0f172a;
      --text-secondary:#334155;
      --input-bg:#ffffff;
    }
    
    /* Dark Mode */
    [data-theme="dark"] {
      --bg:#0f172a;
      --card:#1e293b;
      --muted:#94a3b8;
      --border:#334155;
      --text-primary:#f1f5f9;
      --text-secondary:#cbd5e1;
      --input-bg:#1e293b;
      --shadow: 0 8px 20px rgba(0,0,0,0.3);
    }
    [data-theme="dark"] body{color:var(--text-primary)}
    [data-theme="dark"] .card{background:var(--card);border-color:var(--border)}
    [data-theme="dark"] input,[data-theme="dark"] select,[data-theme="dark"] textarea{background:var(--input-bg);color:var(--text-primary);border-color:var(--border)}
    [data-theme="dark"] input::placeholder{color:var(--muted)}
    [data-theme="dark"] label{color:var(--text-secondary)}
    [data-theme="dark"] .section-title{color:var(--text-primary)}
    [data-theme="dark"] .chq{background:var(--card);border-color:var(--border)}
    [data-theme="dark"] .chq.cleared{background:#1a2332;opacity:0.8}
    [data-theme="dark"] .chq.outstanding{background:var(--card)}
    [data-theme="dark"] .btn.gray{background:var(--card);color:var(--text-primary);border-color:var(--border)}
    [data-theme="dark"] .icon-btn-elegant{background:var(--card) !important;color:var(--text-secondary) !important;border-color:var(--border) !important}
    [data-theme="dark"] table{background:#1e293b !important}
    [data-theme="dark"] th{background:#334155 !important;color:#f1f5f9 !important;border-color:#475569 !important}
    [data-theme="dark"] td{color:#f1f5f9 !important;border-color:#334155 !important;background:#1e293b}
    [data-theme="dark"] thead th{background:#0f172a !important;color:#cbd5e1 !important}
    [data-theme="dark"] tbody tr:nth-child(odd) td{background:#1e293b !important}
    [data-theme="dark"] tbody tr:nth-child(even) td{background:#0f172a !important}
    [data-theme="dark"] #resultsCard{background:#1e293b !important;border-color:#334155 !important}
    [data-theme="dark"] #resultsTable{background:#1e293b !important}
    [data-theme="dark"] #resultsTable th{background:#0f172a !important;color:#e2e8f0 !important}
    [data-theme="dark"] #resultsTable td{background:#1e293b !important;color:#f1f5f9 !important}
    [data-theme="dark"] #resultsTable tbody tr:hover td{background:#334155 !important}
    [data-theme="dark"] .table-title{color:#f1f5f9 !important}
    [data-theme="dark"] .table-placeholder{color:#94a3b8 !important}
    [data-theme="dark"] .highlight-seller{background:#422006 !important;color:#fcd34d !important}
    [data-theme="dark"] .highlight-buyer{background:#14532d !important;color:#86efac !important}
    [data-theme="dark"] .highlight-service{background:#3f3f00 !important;color:#fef08a !important}
    [data-theme="dark"] .highlight-total{background:#450a0a !important;color:#fca5a5 !important}
    [data-theme="dark"] .summary{background:#1e293b !important;border-color:#334155 !important}
    [data-theme="dark"] .summary .net{color:#34d399 !important}
    [data-theme="dark"] #summaryTotal{color:#34d399 !important}
    [data-theme="dark"] #directionText{color:#7dd3fc !important}
    [data-theme="dark"] #notes{color:#cbd5e1 !important}
    [data-theme="dark"] .comm-open-btn{background:#334155 !important;color:#f1f5f9 !important;border-color:#475569 !important}
    [data-theme="dark"] .modal-content{background:var(--card);color:var(--text-primary)}
    [data-theme="dark"] .health-panel{background:var(--card);border-color:var(--border)}
    [data-theme="dark"] .cases-panel{background:var(--card)}
    [data-theme="dark"] .case-item{background:var(--input-bg);border-color:var(--border)}
    [data-theme="dark"] .case-item:hover{background:#334155}
    [data-theme="dark"] .saved-badge{background:#334155}
    [data-theme="dark"] .chip{background:var(--card);border-color:var(--border);color:var(--text-primary)}
    [data-theme="dark"] .timeline{background:#334155}
    [data-theme="dark"] #summarySection{background:#1e293b !important;border-color:#334155 !important}
    [data-theme="dark"] .amount-mismatch-warning{background:#422006;border-color:#854d0e;color:#fcd34d}
    /* Additional dark mode styles for all elements */
    [data-theme="dark"] .grid > div{background:#1e293b !important;border-color:var(--border) !important;color:var(--text-primary) !important}
    [data-theme="dark"] .grid > div label{color:var(--text-secondary) !important}
    [data-theme="dark"] .grid > div input,[data-theme="dark"] .grid > div select,[data-theme="dark"] .grid > div textarea{background:#0f172a !important;color:#f1f5f9 !important;border-color:var(--border) !important}
    [data-theme="dark"] .grid > div input::placeholder{color:#64748b !important}
    [data-theme="dark"] .grid > div input[readonly]{background:#1e293b !important;color:#cbd5e1 !important}
    [data-theme="dark"] #basicGrid > div{background:#1e293b !important;color:var(--text-primary) !important}
    [data-theme="dark"] #basicGrid label{color:#cbd5e1 !important}
    [data-theme="dark"] #basicGrid input{background:#0f172a !important;color:#f1f5f9 !important;border-color:#334155 !important}
    [data-theme="dark"] #basicGrid select{background:#0f172a !important;color:#f1f5f9 !important;border-color:#334155 !important}
    [data-theme="dark"] #basicGrid input::placeholder{color:#64748b !important}
    [data-theme="dark"] .muted{color:var(--muted)}
    [data-theme="dark"] .total-box{background:linear-gradient(180deg,#1e293b,#0f172a);color:var(--text-primary);border-color:var(--border)}
    [data-theme="dark"] .total-amount{color:#7dd3fc}
    [data-theme="dark"] .totals span{color:var(--text-primary)}
    [data-theme="dark"] .indicator-card{background:#1e293b !important;border-color:var(--border) !important}
    [data-theme="dark"] .indicator-card.count{background:linear-gradient(135deg,#1e293b 0%,#14532d 100%) !important}
    [data-theme="dark"] .indicator-card.total{background:linear-gradient(135deg,#1e293b 0%,#1e3a5f 100%) !important}
    [data-theme="dark"] .indicator-card .indicator-icon{background:#0f172a;border-color:var(--border);color:var(--text-primary)}
    [data-theme="dark"] .indicator-card.count .indicator-icon{background:#14532d;border-color:#166534}
    [data-theme="dark"] .indicator-card.total .indicator-icon{background:#1e3a5f;border-color:#1d4ed8}
    [data-theme="dark"] .indicator-label{color:var(--muted) !important}
    [data-theme="dark"] .indicator-value{color:var(--text-primary) !important}
    [data-theme="dark"] .collapse-btn{background:var(--card);border-color:var(--border);color:var(--text-secondary)}
    [data-theme="dark"] .summary-hero{background:#1e293b;border-color:var(--border)}
    [data-theme="dark"] .summary-label{color:var(--muted)}
    [data-theme="dark"] .summary-amount{color:#34d399}
    [data-theme="dark"] .note-panel{background:#1e293b;border-color:var(--border)}
    [data-theme="dark"] .note-panel-header{background:#0f172a;border-color:var(--border)}
    [data-theme="dark"] .note-panel-title{color:var(--muted)}
    [data-theme="dark"] .note-rows{background:#1e293b}
    [data-theme="dark"] .note-row{border-color:#334155}
    [data-theme="dark"] .note-row.total{background:#0f172a;border-color:var(--border)}
    [data-theme="dark"] .note-label{color:#94a3b8 !important}
    [data-theme="dark"] .note-value{color:#f1f5f9 !important}
    [data-theme="dark"] .note-value.positive{color:#34d399 !important}
    [data-theme="dark"] .note-value.negative{color:#94a3b8 !important}
    [data-theme="dark"] .note-value.danger{color:#f87171 !important}
    [data-theme="dark"] .note-total{color:#f1f5f9 !important}
    [data-theme="dark"] .inline-card-note{color:var(--text-primary)}
    [data-theme="dark"] .modal{background:#1e293b}
    [data-theme="dark"] .modal-title{color:var(--text-primary)}
    [data-theme="dark"] .modal-close{color:var(--muted)}
    [data-theme="dark"] .modal-save{background:#0f172a}
    [data-theme="dark"] .modal-label{color:var(--text-primary)}
    [data-theme="dark"] .case-input{background:var(--input-bg);color:var(--text-primary);border-color:var(--border)}
    [data-theme="dark"] .modal-search{background:var(--input-bg);color:var(--text-primary);border-color:var(--border)}
    [data-theme="dark"] .filter-select{background:var(--input-bg);color:var(--text-primary);border-color:var(--border)}
    [data-theme="dark"] .cases-list{background:#1e293b;border-color:var(--border)}
    [data-theme="dark"] .cases-empty{color:var(--muted)}
    [data-theme="dark"] .cases-empty strong{color:var(--text-secondary)}
    [data-theme="dark"] .case-row{background:#1e293b;border-color:#334155}
    [data-theme="dark"] .case-row:hover{background:#334155}
    [data-theme="dark"] .case-row-title{color:var(--text-primary)}
    [data-theme="dark"] .case-row-meta{color:var(--muted)}
    [data-theme="dark"] .footer{border-color:var(--border)}
    [data-theme="dark"] .footer-note{color:var(--muted)}
    [data-theme="dark"] .footer-legal{color:var(--muted)}
    [data-theme="dark"] .section-subnote{color:var(--muted)}
    [data-theme="dark"] .building-input{background:rgba(30,41,59,0.8) !important;color:#f1f5f9 !important;border-color:rgba(255,255,255,0.2) !important}
    [data-theme="dark"] .building-input::placeholder{color:rgba(255,255,255,0.5) !important}
    [data-theme="dark"] hr{border-color:var(--border) !important}
    [data-theme="dark"] .btn{color:var(--text-primary)}
    [data-theme="dark"] .pdc-section-elegant{background:linear-gradient(180deg,#1e293b 0%,#0f172a 100%) !important;border-color:var(--border) !important}
    [data-theme="dark"] .cheques-section{background:linear-gradient(180deg,#1e293b 0%,#0f172a 100%) !important}
    [data-theme="dark"] .autosave-meta{color:rgba(255,255,255,0.7)}
    /* Autosave indicator dark mode */
    [data-theme="dark"] .autosave-indicator{background:rgba(30,41,59,0.8) !important;border-color:#334155 !important;color:#94a3b8 !important}
    [data-theme="dark"] .autosave-label{color:#f1f5f9 !important}
    [data-theme="dark"] .autosave-indicator.error{background:rgba(69,10,10,0.6) !important;border-color:#991b1b !important;color:#fca5a5 !important}
    [data-theme="dark"] .autosave-indicator.error .autosave-label{color:#fca5a5 !important}
    [data-theme="dark"] .icon-btn small{color:var(--text-primary)}
    [data-theme="dark"] .section-chip{background:rgba(30,41,59,0.8);color:var(--text-primary);border-color:var(--border)}
    [data-theme="dark"] .template-dropdown{background:var(--input-bg);color:var(--text-primary);border-color:var(--border)}
    [data-theme="dark"] .health-entry{border-color:var(--border)}
    [data-theme="dark"] .health-title{color:var(--text-primary)}
    [data-theme="dark"] .health-detail{color:var(--text-secondary)}
    [data-theme="dark"] .lease-badge{background:#334155;color:var(--text-primary);border-color:var(--border)}
    [data-theme="dark"] datalist{background:var(--input-bg);color:var(--text-primary)}
    /* Health Modal (Section Health popup) dark mode */
    [data-theme="dark"] .health-modal-backdrop{background:rgba(0,0,0,0.8)}
    [data-theme="dark"] .health-modal{background:#1e293b !important;border-color:#334155 !important;box-shadow:0 30px 60px rgba(0,0,0,0.6) !important}
    [data-theme="dark"] .health-modal-title{color:#f1f5f9 !important}
    [data-theme="dark"] .health-modal-close{color:#94a3b8 !important}
    [data-theme="dark"] .health-modal-close:hover{color:#f1f5f9 !important}
    [data-theme="dark"] .health-modal-intro{color:#94a3b8 !important}
    [data-theme="dark"] .health-modal-body{color:#f1f5f9}
    /* Health Panel & Cards dark mode */
    [data-theme="dark"] .health-panel{background:#1e293b !important;border-color:#334155 !important}
    [data-theme="dark"] .health-card{background:#0f172a !important;border-color:#334155 !important;box-shadow:0 4px 12px rgba(0,0,0,0.3) !important}
    [data-theme="dark"] .health-card .health-title{color:#f1f5f9 !important}
    [data-theme="dark"] .health-card .health-detail{color:#cbd5e1 !important}
    [data-theme="dark"] .health-card .health-text{color:#f1f5f9 !important}
    [data-theme="dark"] .health-card.ok{background:#0f2e1f !important;border-color:#166534 !important}
    [data-theme="dark"] .health-card.ok .health-chip{background:#14532d !important;border-color:#22c55e !important;color:#86efac !important}
    [data-theme="dark"] .health-card.ok .health-title{color:#86efac !important}
    [data-theme="dark"] .health-card.ok .health-detail{color:#a7f3d0 !important}
    [data-theme="dark"] .health-card.warn{background:#2e1f0f !important;border-color:#854d0e !important}
    [data-theme="dark"] .health-card.warn .health-chip{background:#422006 !important;border-color:#f97316 !important;color:#fdba74 !important}
    [data-theme="dark"] .health-card.warn .health-title{color:#fcd34d !important}
    [data-theme="dark"] .health-card.warn .health-detail{color:#fde68a !important}
    [data-theme="dark"] .health-card.critical{background:#2e0f0f !important;border-color:#991b1b !important}
    [data-theme="dark"] .health-card.critical .health-chip{background:#450a0a !important;border-color:#ef4444 !important;color:#fca5a5 !important}
    [data-theme="dark"] .health-card.critical .health-title{color:#fca5a5 !important}
    [data-theme="dark"] .health-card.critical .health-detail{color:#fecaca !important}
    [data-theme="dark"] .health-card.todo{background:#0f1e2e !important;border-color:#1d4ed8 !important}
    [data-theme="dark"] .health-card.todo .health-chip{background:#1e3a5f !important;border-color:#3b82f6 !important;color:#93c5fd !important}
    [data-theme="dark"] .health-card.todo .health-title{color:#93c5fd !important}
    [data-theme="dark"] .health-card.todo .health-detail{color:#bfdbfe !important}
    [data-theme="dark"] .health-card.info{background:#1e1e2e !important;border-color:#475569 !important}
    [data-theme="dark"] .health-card.info .health-chip{background:#334155 !important;border-color:#64748b !important;color:#cbd5e1 !important}
    [data-theme="dark"] .health-card.info .health-title{color:#cbd5e1 !important}
    [data-theme="dark"] .health-card.info .health-detail{color:#94a3b8 !important}
    /* Communication Modal dark mode */
    [data-theme="dark"] .comm-modal{background:#1e293b !important}
    [data-theme="dark"] .comm-modal .modal-head{border-color:#334155}
    [data-theme="dark"] .comm-modal .modal-title{color:#f1f5f9 !important}
    [data-theme="dark"] .names-grid > div{background:#0f172a !important;padding:12px;border-radius:8px;border:1px solid #334155}
    [data-theme="dark"] .names-grid label{color:#cbd5e1 !important}
    [data-theme="dark"] .names-grid input{background:#1e293b !important;color:#f1f5f9 !important;border-color:#334155 !important}
    [data-theme="dark"] .names-grid input::placeholder{color:#64748b !important}
    [data-theme="dark"] .sender-row label{color:#cbd5e1 !important}
    [data-theme="dark"] .sender-row input{background:#1e293b !important;color:#f1f5f9 !important;border-color:#334155 !important}
    [data-theme="dark"] .sender-row .sender-hint{color:#94a3b8 !important}
    [data-theme="dark"] .comm-grid{color:var(--text-primary)}
    [data-theme="dark"] .comm-card{background:#0f172a !important;border-color:#334155 !important}
    [data-theme="dark"] .comm-card .comm-head{color:#f1f5f9 !important}
    [data-theme="dark"] .comm-card .comm-head span{color:#f1f5f9 !important}
    [data-theme="dark"] .comm-body{background:#1e293b !important;color:#e2e8f0 !important;border-color:#334155 !important}
    [data-theme="dark"] .comm-body-display{background:#1e293b !important;color:#e2e8f0 !important;border-color:#334155 !important}
    [data-theme="dark"] .comm-btn.gray{background:#334155 !important;color:#f1f5f9 !important;border-color:#475569 !important}
    [data-theme="dark"] .comm-edit-btn{background:#334155 !important;color:#f1f5f9 !important;border-color:#475569 !important}
    /* Toned down buttons for dark mode - less eye strain */
    [data-theme="dark"] .btn.whatsapp{background:#1a5c3a !important;color:#86efac !important;border:1px solid #166534 !important}
    [data-theme="dark"] .btn.whatsapp:hover{background:#166534 !important}
    [data-theme="dark"] .btn.primary{background:#1e3a5f !important;color:#93c5fd !important;border:1px solid #1d4ed8 !important}
    [data-theme="dark"] .btn.primary:hover{background:#1d4ed8 !important}
    [data-theme="dark"] .share-btn{background:#1a5c3a !important;color:#86efac !important;border:1px solid #166534 !important;box-shadow:none !important}
    [data-theme="dark"] .share-btn:hover{background:#166534 !important}
    /* Health buttons for dark mode */
    [data-theme="dark"] .health-btn{background:linear-gradient(145deg,#1e293b,#0f172a) !important;box-shadow:0 4px 12px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.05) !important}
    [data-theme="dark"] .health-btn::before{background:linear-gradient(145deg, rgba(20,184,166,0.3), rgba(59,130,246,0.2)) !important}
    [data-theme="dark"] .health-btn:hover{background:linear-gradient(145deg,#334155,#1e293b) !important;box-shadow:0 8px 20px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.08) !important}
    [data-theme="dark"] .health-btn .health-icon{opacity:0.9}
    [data-theme="dark"] .health-btn .health-label{background:linear-gradient(135deg,#5eead4,#7dd3fc) !important;-webkit-background-clip:text !important;background-clip:text !important;-webkit-text-fill-color:transparent !important}
    [data-theme="dark"] .calc-btn{background:linear-gradient(145deg,#1e293b,#0f172a) !important}
    [data-theme="dark"] .calc-btn::before{background:linear-gradient(145deg, rgba(59,130,246,0.3), rgba(139,92,246,0.25)) !important}
    [data-theme="dark"] .calc-btn:hover{background:linear-gradient(145deg,#334155,#1e293b) !important}
    [data-theme="dark"] .calc-btn .health-label{background:linear-gradient(135deg,#93c5fd,#c4b5fd) !important;-webkit-background-clip:text !important;background-clip:text !important;-webkit-text-fill-color:transparent !important}
    /* Additional cheque and form dark mode styles */
    [data-theme="dark"] .chq{background:#1e293b !important;border-color:var(--border) !important}
    [data-theme="dark"] .chq input,[data-theme="dark"] .chq select{background:#0f172a !important;color:var(--text-primary) !important;border-color:var(--border) !important}
    [data-theme="dark"] .chq label{color:var(--text-secondary) !important}
    [data-theme="dark"] .chq.cleared{background:#0f172a !important;opacity:0.7}
    [data-theme="dark"] .chq.outstanding{background:#1e293b !important}
    [data-theme="dark"] .chq.date-warning{border-color:#f59e0b !important;background:#422006 !important}
    [data-theme="dark"] .chq.pdc-date-warning{border-color:#f59e0b !important;background:#422006 !important}
    [data-theme="dark"] .chq.pdc-date-past{border-color:#ef4444 !important;background:#450a0a !important}
    [data-theme="dark"] .chq.duplicate-warning{border-color:#ef4444 !important;background:#450a0a !important}
    [data-theme="dark"] .cheque-meta label{color:var(--muted) !important}
    [data-theme="dark"] .cheque-cleared-icon{background:#1e293b;border-color:var(--border);color:#f97316}
    [data-theme="dark"] .cheque-bank,[data-theme="dark"] .cheque-number{background:#0f172a !important;color:var(--text-primary) !important}
    [data-theme="dark"] .basic-info-card{background:var(--card) !important;border-color:var(--border) !important}
    [data-theme="dark"] .card-head{color:var(--text-primary)}
    [data-theme="dark"] .muted,.muted-note{color:var(--muted) !important}
    [data-theme="dark"] .btn.gray{background:var(--card) !important;color:var(--text-primary) !important;border-color:var(--border) !important}
    [data-theme="dark"] .btn-chip{background:var(--card) !important;color:var(--text-primary) !important}
    [data-theme="dark"] .lease-duration-badge{background:linear-gradient(135deg,#374151,#4b5563) !important;border-color:#6b7280 !important;color:#d1d5db !important}
    [data-theme="dark"] .lease-duration-badge.standard{background:linear-gradient(135deg,#374151,#4b5563) !important;border-color:#6b7280 !important;color:#d1d5db !important}
    [data-theme="dark"] .lease-duration-badge.unusual{background:linear-gradient(135deg,#78350f,#92400e) !important;border-color:#f59e0b !important;color:#fef3c7 !important}
    [data-theme="dark"] option{background:var(--input-bg);color:var(--text-primary)}
    [data-theme="dark"] .case-notes-icon{background:rgba(30,41,59,0.8) !important;border-color:#475569 !important;color:#f1f5f9}
    [data-theme="dark"] .case-notes-icon:hover{background:rgba(51,65,85,0.9) !important;border-color:#64748b !important}
    [data-theme="dark"] .case-notes-icon.has-notes{background:linear-gradient(135deg,#854d0e 0%,#a16207 100%) !important;border-color:#fbbf24 !important;box-shadow:0 0 12px rgba(251,191,36,0.6),0 0 24px rgba(251,191,36,0.3) !important}
    [data-theme="dark"] .case-notes-icon.has-notes:hover{box-shadow:0 0 16px rgba(251,191,36,0.8),0 0 32px rgba(251,191,36,0.4) !important}
    [data-theme="dark"] #pageTitle{color:white}
    [data-theme="dark"] .brand-elegant{color:white}
    [data-theme="dark"] .tr-row:nth-child(even) td{background:#1e293b}
    [data-theme="dark"] .tr-row:nth-child(odd) td{background:#0f172a}
    [data-theme="dark"] tbody tr:nth-child(even){background:#1e293b}
    [data-theme="dark"] tbody tr:nth-child(odd){background:#0f172a}
    [data-theme="dark"] .pdc-box{background:#1e293b !important;border-color:var(--border) !important}
    [data-theme="dark"] .pdc-box input,[data-theme="dark"] .pdc-box select{background:#0f172a !important;color:var(--text-primary) !important;border-color:var(--border) !important}
    [data-theme="dark"] .pdc-box label{color:var(--text-secondary) !important}
    [data-theme="dark"] #pdcTotalDisplay{color:#7dd3fc}
    [data-theme="dark"] #rentalTotalDisplay{color:#7dd3fc}
    [data-theme="dark"] #rentalClearedDisplay{color:#34d399}
    [data-theme="dark"] #rentalOutstandingDisplay{color:#fbbf24}
    [data-theme="dark"] .field-wrapper{color:var(--text-primary)}
    [data-theme="dark"] .inline-field{color:var(--text-primary)}
    [data-theme="dark"] #totalDaysDisplay,[data-theme="dark"] #sellerDaysDisplay,[data-theme="dark"] #buyerDaysDisplay{background:#0f172a !important;color:var(--text-primary) !important}
    [data-theme="dark"] #sellerRentDisplay,[data-theme="dark"] #buyerRentDisplay{background:#0f172a !important;color:var(--text-primary) !important}
    [data-theme="dark"] .text-green{color:#34d399 !important}
    [data-theme="dark"] .text-red{color:#f87171 !important}
    /* Date picker and special inputs dark mode */
    [data-theme="dark"] input[type="date"]{background:#0f172a !important;color:#f1f5f9 !important;border-color:#334155 !important;color-scheme:dark}
    [data-theme="dark"] input[type="date"]::-webkit-calendar-picker-indicator{filter:invert(1)}
    [data-theme="dark"] .for-buyer{background:#0f2e1f !important;border-color:#166534 !important}
    [data-theme="dark"] .for-buyer label{color:#86efac !important}
    [data-theme="dark"] .against-buyer{background:#2e1f0f !important;border-color:#854d0e !important}
    [data-theme="dark"] .against-buyer label{color:#fcd34d !important}
    [data-theme="dark"] .basic-info-card{background:#1e293b !important;border-color:#334155 !important}
    [data-theme="dark"] .card-head{color:#f1f5f9}
    [data-theme="dark"] .section-title{color:#e2e8f0 !important}
    [data-theme="dark"] .muted-note{color:#94a3b8 !important}
    [data-theme="dark"] #dailyRentDisplay{background:#0f172a !important;color:#f1f5f9 !important}
    [data-theme="dark"] .small{background:#0f172a !important;color:#f1f5f9 !important}
    [data-theme="dark"] .field-wrapper label{color:#cbd5e1 !important}
    [data-theme="dark"] .inline-field input{background:#0f172a !important;color:#f1f5f9 !important}
    /* Bulk Import Cheques section dark mode */
    [data-theme="dark"] .special-import{background:linear-gradient(180deg,#1e293b 0%,#0f172a 100%) !important;border-color:#334155 !important}
    [data-theme="dark"] .special-import textarea{background:#0f172a !important;color:#f1f5f9 !important;border-color:#334155 !important}
    [data-theme="dark"] .special-import textarea::placeholder{color:#64748b !important}
    [data-theme="dark"] .import-field label{color:#cbd5e1 !important}
    [data-theme="dark"] .hint{color:#94a3b8 !important}
    [data-theme="dark"] .import-actions .btn.ghost{background:#334155 !important;color:#f1f5f9 !important;border-color:#475569 !important}
    [data-theme="dark"] .import-actions .btn.ghost:hover{background:#475569 !important}
    [data-theme="dark"] .cheque-ribbon-separator{background:linear-gradient(135deg,#0f172a 0%,#1e3a5f 100%);border-color:#334155}
    [data-theme="dark"] .flex-between{color:var(--text-primary)}
    
    .dashboard-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;padding:12px;background:linear-gradient(135deg,#f0f9ff,#e0f2fe);border-radius:10px;margin-bottom:16px;border:1px solid #bae6fd}
    .stat-card{background:white;padding:10px 12px;border-radius:8px;text-align:center;box-shadow:0 2px 6px rgba(0,0,0,0.06)}
    .stat-value{font-size:1.2rem;font-weight:700;color:#0369a1;display:block}
    .stat-label{font-size:0.7rem;color:#64748b;text-transform:uppercase;letter-spacing:0.5px}
    [data-theme="dark"] .dashboard-stats{background:linear-gradient(135deg,#1e3a5f,#0f172a);border-color:#334155}
    [data-theme="dark"] .stat-card{background:#1e293b}
    [data-theme="dark"] .stat-value{color:#7dd3fc}
    [data-theme="dark"] .stat-label{color:#94a3b8}
    .month-group{margin-bottom:12px}
    .month-header{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:linear-gradient(135deg,#f1f5f9,#e2e8f0);border-radius:8px;margin-bottom:8px;cursor:pointer;transition:all 0.2s}
    .month-header:hover{background:linear-gradient(135deg,#e2e8f0,#cbd5e1)}
    .month-title{font-weight:600;color:#334155;font-size:0.9rem}
    .month-stats{display:flex;gap:12px;font-size:0.75rem;color:#64748b}
    .month-stat{display:flex;align-items:center;gap:4px}
    .month-cases{margin-left:8px}
    .view-toggle{display:flex;gap:4px;margin-bottom:12px}
    .view-btn{padding:5px 12px;font-size:0.8rem;border:1px solid #e2e8f0;background:#fff;border-radius:6px;cursor:pointer;transition:all 0.2s}
    .view-btn.active{background:#3b82f6;color:#fff;border-color:#3b82f6}
    .view-btn:hover:not(.active){background:#f1f5f9}
    [data-theme="dark"] .month-header{background:linear-gradient(135deg,#334155,#1e293b)}
    [data-theme="dark"] .month-title{color:#e2e8f0}
    [data-theme="dark"] .month-stats{color:#94a3b8}
    [data-theme="dark"] .view-btn{background:var(--card);color:var(--text-primary);border-color:var(--border)}
    [data-theme="dark"] .view-btn.active{background:#3b82f6;color:#fff}
    *{box-sizing:border-box;margin:0;padding:0}
    html{height:100%;overflow-y:scroll}
    body{font-family:var(--font-sans);background:var(--bg);color:#0f172a;padding:20px;line-height:1.35;min-height:100%}
    .wrap{max-width:var(--max-width);margin:0 auto}
    
    /* Layout */
    .head { display:flex;align-items:flex-start;justify-content:space-between; gap:0; margin-bottom:4px; flex-wrap:wrap; }
    .brand { background:linear-gradient(135deg,#3b82f6,#06b6d4); color:white; padding:10px 11px; border-radius:14px; box-shadow:0 10px 25px -5px rgba(59,130,246,0.5), 0 8px 10px -6px rgba(59,130,246,0.1); flex:0 0 calc(50% + 5.0cm); max-width:calc(50% + 5.0cm); }
    .brand h1{font-size:1.05rem;font-weight:600;margin-bottom:4px}
    .brand p{margin:0;font-size:0.85rem;opacity:0.95}
    .brand-subtitle{margin:0;font-size:0.82rem;opacity:0.9}
    .brand-top{display:flex;gap:8px;flex-wrap:nowrap;align-items:center;margin-bottom:6px}
    .autosave-banner{margin-top:0;display:flex;flex-direction:column;gap:0}
    .autosave-inline{margin-top:0;align-self:flex-end;margin-right:auto}
    .autosave-left{order:-1;align-self:flex-start;margin-right:auto}
    .autosave-below{display:flex;justify-content:flex-start;margin-bottom:0}
    .autosave-meta{font-size:0.75rem;color:rgba(15,23,42,0.65);letter-spacing:0.01em}
    .building-input{font-size:1.45rem;font-weight:700;color:#0f172a;border:none;border-bottom:3px solid rgba(255,255,255,0.45);background:rgba(255,255,255,0.25);padding:6px 10px;border-radius:12px 12px 4px 4px;min-width:220px;flex:0 0 17.5%;box-shadow:inset 0 0 0 1px rgba(255,255,255,0.25)}
    .building-input::placeholder{color:rgba(15,23,42,0.65);font-size:1rem;font-weight:500}
    .building-input:focus{outline:none;border-bottom-color:#fde68a;box-shadow:0 4px 12px rgba(15,23,42,0.12);background:rgba(255,255,255,0.4)}
    .page-title-strong{font-weight:700}
    .head-actions{display:flex;gap:12px;flex-wrap:wrap;justify-content:flex-end;align-items:flex-start}
    .action-stack{display:flex;flex-direction:column;gap:8px}
    .icon-btn{width:68px;height:68px;border-radius:15px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:1.19rem;position:relative;padding:0 7px;transition:all 0.2s ease;}
    .icon-btn:hover{transform:translateY(-2px);box-shadow:0 10px 15px -3px rgba(0,0,0,0.1),0 4px 6px -2px rgba(0,0,0,0.05);}    
    .icon-btn small{margin-top:5px;font-size:0.6rem;font-weight:600;letter-spacing:0.03em;text-transform:uppercase;color:#0f172a}
    .collapsible-head{display:flex;justify-content:space-between;gap:12px;align-items:flex-start}
    .section-indicators{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .section-chip{padding:6px 10px;border-radius:999px;font-size:0.75rem;font-weight:600;background:rgba(255,255,255,0.25);color:#0f172a;border:1px solid rgba(15,23,42,0.1)}
    .section-chip.ghost{background:rgba(15,23,42,0.08)}
    .indicator-stack{display:flex;gap:12px;flex-wrap:wrap;align-items:stretch}
    .indicator-card{min-width:140px;padding:14px 18px;border-radius:12px;border:1px solid #e2e8f0;background:#ffffff;box-shadow:0 2px 8px rgba(15,23,42,0.06);display:flex;gap:12px;align-items:center;text-align:left;transition:all 0.2s ease}
    .indicator-card:hover{box-shadow:0 4px 16px rgba(15,23,42,0.1);transform:translateY(-1px)}
    .indicator-card.count{background:linear-gradient(135deg,#ffffff 0%,#f0fdf4 100%);border-color:#d1fae5}
    .indicator-card.total{background:linear-gradient(135deg,#ffffff 0%,#eff6ff 100%);border-color:#dbeafe}
    .indicator-card .indicator-icon{width:40px;height:40px;border-radius:10px;background:#f8fafc;display:flex;align-items:center;justify-content:center;font-size:1.15rem;color:#1e293b;border:1px solid #e2e8f0}
    .indicator-card.count .indicator-icon{background:#ecfdf5;border-color:#a7f3d0}
    .indicator-card.total .indicator-icon{background:#eff6ff;border-color:#bfdbfe}
    .indicator-card .indicator-text{display:flex;flex-direction:column;gap:3px}
    /* SC Rate note styling: smaller, lighter, positioned lower in the cell */
    .sc-rate-note{display:none;color:#9aa6b6;font-size:0.66rem;line-height:1;vertical-align:middle;margin-left:calc(8px + 5mm);position:relative;top:calc(12px - 2mm);opacity:0.85}
    .indicator-card .indicator-label{font-size:0.7rem;letter-spacing:0.06em;text-transform:uppercase;color:#64748b;font-weight:600}
    .indicator-card .indicator-value{font-size:1.05rem;font-weight:600;color:#1e293b;letter-spacing:-0.01em}
    .collapse-btn{border:1px solid #e2e8f0;background:#ffffff;border-radius:8px;padding:8px 14px;cursor:pointer;display:flex;align-items:center;gap:6px;font-size:0.8rem;font-weight:500;color:#475569;transition:all 0.2s ease;box-shadow:0 1px 3px rgba(15,23,42,0.04)}
    .collapse-btn svg{transition:transform 0.2s ease}
    .collapse-btn.is-collapsed svg{transform:rotate(-90deg)}
    .collapse-btn:hover{background:#f8fafc;border-color:#cbd5e1;color:#1e293b}
    .collapsible-body{margin-top:14px}
    .collapsible-body.collapsed{display:none}
    .section-subnote{font-size:0.8rem;color:#64748b;margin-top:6px}
    .autosave-indicator{width:100%;max-width:320px;font-size:0.82rem;color:var(--muted);display:flex;flex-direction:column;align-items:flex-start;gap:4px;padding:8px 12px;border-radius:12px;background:rgba(15,23,42,0.04);border:1px solid rgba(148,163,184,0.4)}
    .autosave-label{display:flex;align-items:center;gap:6px;font-weight:600;color:#0f172a}
    .autosave-label::before{content:'';width:8px;height:8px;border-radius:999px;background:#9ca3af;display:inline-flex}
    .autosave-indicator.pending .autosave-label::before{background:#f97316}
    .autosave-indicator.saving .autosave-label::before{background:#0ea5a3;animation:autosavePulse 1.2s infinite ease-in-out}
    .autosave-indicator.saved .autosave-label::before{background:#10b981}
    .autosave-indicator.error .autosave-label::before{background:#dc2626}
    .autosave-indicator.error{color:#dc2626;border-color:#fecaca;background:rgba(254,226,226,0.4)}
    .card-head{display:flex;justify-content:space-between;align-items:center;gap:14px;margin-bottom:12px;flex-wrap:wrap}
    .flex-row{display:flex}
    .flex-between{display:flex;justify-content:space-between;align-items:center}
    .muted-note{font-size:0.86rem}
    .timeline-wrapper{margin:10px 0}
    .inline-field{display:flex;gap:4px;align-items:center}
    .field-wrapper{position:relative}
    /* Highlight unit field - soft purple, no border */
    #unitNo{background:rgba(139,92,246,0.06) !important}
    [data-theme="dark"] #unitNo{background:rgba(167,139,250,0.08) !important}
    /* Highlight handover date - blue, no border */
    #handoverDate{background:rgba(59,130,246,0.1) !important}
    [data-theme="dark"] #handoverDate{background:rgba(96,165,250,0.12) !important}
    /* Highlight service charge - soft green, no border */
    #serviceCharge{background:rgba(16,185,129,0.04) !important}
    [data-theme="dark"] #serviceCharge{background:rgba(52,211,153,0.06) !important}
    .field-hint{font-size:0.72rem;margin-top:3px;display:flex;align-items:center;gap:5px;color:#ea580c;opacity:0;transform:translateY(-2px);transition:opacity 0.2s ease,transform 0.2s ease;pointer-events:none}

    /* Input-with-lock: small inline checkbox inside numeric inputs (left) */
    .input-with-lock{position:relative;display:inline-flex;align-items:center}
    .input-with-lock .sc-rate-lock-inside{appearance:none;-webkit-appearance:none;width:14px;height:14px;border-radius:3px;border:1px solid rgba(15,23,42,0.12);background:#fff;display:inline-block;position:absolute;left:6px;top:50%;transform:translateY(-50%);cursor:pointer}
    .input-with-lock .sc-rate-lock-inside:checked{background:#1e3a5f;border-color:#1e3a5f}
    .input-with-lock input[type="number"]{padding-left:28px}

    /* Buyer name subtle styling: calm, faded (not shiny) */
    /* Softer, non-black muted tone for buyer name */
    .buyer-name-input{color:rgba(71,85,105,0.68);background:rgba(71,85,105,0.02);border:1px solid rgba(15,23,42,0.04);box-shadow:none;padding:4px 8px;border-radius:6px;transition:all 0.15s ease}
    .buyer-name-input::placeholder{color:rgba(154,166,182,0.7)}
    [data-theme="dark"] .buyer-name-input{color:rgba(203,213,225,0.85);background:rgba(255,255,255,0.02);border-color:rgba(255,255,255,0.04)}
    .field-hint::before{content:'⚠️';font-size:0.75rem}
    .field-hint.show{opacity:1;transform:translateY(0)}
    .field-wrapper.field-valid .field-hint{color:#059669}
    .field-wrapper.field-valid .field-hint::before{content:'✔️'}
    .btn-chip{padding:0 8px;font-size:0.8rem}
    .gap-6{gap:6px}
    .gap-8{gap:8px}
    .gap-12{gap:12px}
    .mt-8{mar
    gin-top:8px}
    .mt-12{margin-top:12px}
    .mt-18{margin-top:18px}
    .mb-0{margin-bottom:0}
    .mb-12{margin-bottom:12px}
    .mb-20{margin-bottom:20px}
    .inline-note{font-size:0.75rem;opacity:0.85;margin-top:2px}
    .import-field{flex:1}
    .import-actions{width:140px;align-self:flex-end}
    .w-100{width:100%}
    .grid-span-all{grid-column:1 / -1}
    .total-inline{display:inline-block}
    .card-scroll{overflow:auto}
    .table-title{font-weight:700;font-size:0.98rem}
    .table-placeholder{padding:40px}
    #summarySection{display:none}
    .summary-hero{margin-bottom:8px;text-align:center;padding:10px 12px;background:#fafbfc;border-radius:6px;border:1px solid #e2e8f0;position:relative}
    .share-btn{position:absolute;top:6px;right:6px;background:#25d366;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;display:flex;align-items:center;gap:3px;color:white;font-size:0.65rem;font-weight:600;box-shadow:0 1px 4px rgba(37,211,102,0.2)}
    .summary-label{font-size:0.52rem;margin-bottom:3px;text-transform:uppercase;letter-spacing:0.6px;font-weight:500;color:#64748b}
    .summary-amount{font-size:1.2rem;font-weight:700;color:#059669;margin-bottom:1px}
    .summary-direction{font-size:0.6rem;font-weight:600;color:#10b981;text-transform:uppercase;letter-spacing:0.3px}
    .new-owner-info{margin-top:8px;font-size:0.78rem;color:#475569;line-height:1.4}
    .new-owner-info strong{color:#0f172a;font-weight:600}
    [data-theme="dark"] .new-owner-info{color:#94a3b8}
    [data-theme="dark"] .new-owner-info strong{color:#f1f5f9}
    /* Stale Data Warning - shown when inputs changed but calculation not updated */
    .stale-data-warning{display:none;background:linear-gradient(135deg,#dc2626 0%,#b91c1c 100%);color:white;padding:10px 16px;border-radius:8px;margin-bottom:12px;font-weight:600;font-size:0.9rem;text-align:center;animation:staleWarningPulse 1.5s infinite;border:2px solid #991b1b}
    .stale-data-warning.visible{display:block}
    .stale-data-warning .warning-icon{font-size:1.2rem;margin-right:8px}
    .stale-data-warning .new-result{display:block;margin-top:4px;font-size:0.95rem}
    .stale-data-warning .new-result-value{background:rgba(255,255,255,0.2);padding:2px 10px;border-radius:4px;font-weight:700;margin-left:4px}
    .stale-data-warning .recalc-btn{background:white;color:#dc2626;border:none;padding:4px 12px;border-radius:4px;font-weight:700;cursor:pointer;margin-left:12px;font-size:0.85rem}
    .stale-data-warning .recalc-btn:hover{background:#fef2f2}
    @keyframes staleWarningPulse{0%,100%{opacity:1}50%{opacity:0.85}}
    [data-theme="dark"] .stale-data-warning{background:linear-gradient(135deg,#991b1b 0%,#7f1d1d 100%);border-color:#dc2626}
    /* Mark results section as stale */
    .results-stale #resultsCard{opacity:0.5;position:relative}
    .results-stale #resultsCard::after{content:'⚠️ DATA CHANGED - RECALCULATE';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#dc2626;color:white;padding:12px 24px;border-radius:8px;font-weight:700;font-size:1rem;z-index:100;white-space:nowrap}
    .results-stale #summarySection{opacity:0.5;pointer-events:none}
    .summary-notes{display:grid;grid-template-columns:1fr;gap:8px}
    .inline-card-note{font-size:0.8rem;line-height:1.5;color:#0f172a}
    .note-panel{background:#fafbfc;border-radius:6px;border:1px solid #e5e7eb;overflow:hidden}
    .note-panel-header{padding:6px 12px;background:#f1f5f9;border-bottom:1px solid #e5e7eb}
    .note-panel-title{font-size:0.7rem;color:#64748b;font-weight:600;text-transform:uppercase;letter-spacing:0.5px}
    .note-rows{background:white}
    .note-row{display:flex;justify-content:space-between;padding:5px 12px;border-bottom:1px solid #f3f4f6}
    .note-row:last-child{border-bottom:none}
    .note-row.total{background:#f8fafc;border-bottom:none;padding:6px 12px;border-top:1px solid #e2e8f0}
    .note-label{color:#64748b;font-size:0.78rem}
    .note-value{font-weight:600;font-size:0.78rem;color:#1e293b}
    .note-value.positive{color:#059669}
    .note-value.negative{color:#64748b}
    .note-value.danger{color:#b91c1c}
    .note-total{font-size:0.85rem}
    .export-container{position:absolute;top:-9999px;left:-9999px;width:900px;background:white;padding:20px;font-family:var(--font-sans);}
    .export-header{margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #d0d9e6;}
    .export-header h2{margin:0;font-size:18px;color:#0f172a;font-weight:700;}
    .export-header p{margin:4px 0 0 0;font-size:12px;color:#6b7280;}
    .export-table{width:100%;margin-bottom:20px;border-collapse:collapse;font-size:11px;}
    .export-table th,.export-table td{padding:8px 6px;border:1px solid #e6eef6;text-align:left;font-size:11px;}
    .export-table th{background:#f6fbfb;font-weight:600;color:#0b1220;font-size:10px;}
    .export-summary{padding:15px;background:#f6fbfb;border-radius:6px;border:1px solid #e6eef6;}
    .export-summary-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;}
    .export-summary-label{font-size:10px;color:#6b7280;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.3px;font-weight:600;}
    .export-summary-amount{font-size:26px;font-weight:700;color:#059669;margin-bottom:8px;}
    .export-summary-direction{font-size:12px;font-weight:600;color:#10b981;}
    .export-summary-notes{font-size:11px;line-height:1.6;color:#0f172a;}
    .comm-head{display:flex;justify-content:space-between;align-items:center}
    .comm-edit-btn{padding:4px 8px;font-size:0.75rem}
    .comm-actions{display:flex;gap:6px;margin-top:8px}
    .comm-action-flex{flex:1}
    .footer{margin-top:-9px;padding:8px;text-align:center;border-top:1px solid var(--border)}
    .footer-note{font-size:0.8rem;color:#64748b;margin-bottom:2px;font-weight:500}
    .footer-brand{font-family:'Poppins','Inter',sans-serif;font-size:0.95rem;font-weight:600;background:linear-gradient(135deg,#0ea5a3,#06b6d4,#0077cc);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:0.3px}
    .footer-legal{font-size:0.75rem;color:#94a3b8;margin-top:2px;font-weight:500}
    .modal-backdrop{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:9999;padding:20px;overflow:auto}
    .modal{max-width:800px;margin:40px auto;background:white;border-radius:16px;padding:24px;box-shadow:0 20px 60px rgba(0,0,0,0.3)}
    .modal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    /* Very light header when showing Load Saved Case */
    .modal.load-mode .modal-head{background:rgba(2,6,23,0.03);padding:10px;border-radius:12px;margin-bottom:12px;border:1px solid rgba(2,6,23,0.04)}
    [data-theme="dark"] .modal.load-mode .modal-head{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)}
    .modal-title{margin:0;font-size:1.4rem;color:#0f172a}
    .modal-close{background:none;border:none;font-size:1.8rem;cursor:pointer;color:#6b7280}
    .modal-save{margin-bottom:24px;padding:16px;background:#f9fafb;border-radius:8px}
    .modal-actions{display:flex;gap:8px}
    .modal-label{font-weight:600;color:#0f172a}
    .block-label{display:block;margin-bottom:8px}
    .case-input{flex:1;padding:10px;border:1px solid #d1d5db;border-radius:6px;font-size:0.95rem}
    .case-btn{white-space:nowrap}
    .modal-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .modal-filters{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    .modal-search{padding:6px 12px;border:1px solid #d1d5db;border-radius:6px;font-size:0.9rem;width:200px}
    .filter-select{flex:1 1 180px;padding:8px 10px;border:1px solid #d1d5db;border-radius:6px;font-size:0.9rem;background:white;color:#0f172a}
    .advanced-filters-toggle{margin-bottom:16px;border:1px solid #e5e7eb;border-radius:8px;background:#f9fafb;overflow:hidden}
    .advanced-filters-summary{padding:10px 14px;cursor:pointer;list-style:none;font-size:0.9rem;font-weight:600;color:#475569;user-select:none;display:flex;align-items:center;gap:6px;transition:background 0.2s}
    .advanced-filters-summary:hover{background:#f1f5f9}
    .advanced-filters-summary::-webkit-details-marker{display:none}
    .advanced-filters-content{padding:14px;background:white;border-top:1px solid #e5e7eb}
    .filter-row{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    .filter-row:last-of-type{margin-bottom:16px}
    .filter-label{min-width:120px;font-size:0.85rem;color:#64748b;font-weight:500}
    .range-inputs{display:flex;align-items:center;gap:8px;flex:1}
    .filter-input-small{flex:1;padding:7px 10px;border:1px solid #d1d5db;border-radius:6px;font-size:0.9rem;max-width:150px}
    .filter-input{flex:1;padding:7px 10px;border:1px solid #d1d5db;border-radius:6px;font-size:0.9rem}
    .range-separator{color:#94a3b8;font-weight:500}
    .filter-clear-btn{width:100%;justify-content:center;padding:8px}
    .result-count{margin-left:6px;font-size:0.85rem;color:#10b981;font-weight:600}
    .case-row-title mark,.case-row-meta mark{background:#fef08a;padding:1px 2px;border-radius:2px;font-weight:600}
    .cases-list{max-height:400px;overflow-y:auto;border:1px solid #e5e7eb;border-radius:8px;background:white}
    .cases-empty{padding:40px;text-align:center;color:#9ca3af;display:flex;flex-direction:column;gap:8px;align-items:center}
    .cases-empty strong{color:#475569;font-size:1rem}
    .cases-empty span{font-size:0.85rem;color:#94a3b8}
    .case-row{padding:12px 16px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;transition:background 0.2s;background:white;}
    .case-row:hover{background:#f9fafb}
    .case-row-main{flex:1;}
    .case-row-title{font-weight:600;color:#0f172a;margin-bottom:4px}
    .case-row-meta{font-size:0.85rem;color:#6b7280}
    .case-row-actions{display:flex;gap:10px;align-items:center}
    /* Very light pill background around the action group */
    .case-row-actions { background: rgba(2,6,23,0.02); padding:6px 8px; border-radius:12px; border:1px solid rgba(2,6,23,0.03); }
    [data-theme="dark"] .case-row-actions { background: rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.03); }
    /* Icon-only buttons styled as rounded colored pills */
    .case-row-btn{display:inline-flex;align-items:center;justify-content:center;padding:8px 12px;font-size:1rem;border-radius:10px;min-width:40px;min-height:36px;border:none;box-shadow:0 1px 2px rgba(10,20,30,0.04)}
    .case-row-btn .btn-icon{font-size:1.05rem}
    .case-row-btn.load{background:#7fb69f;color:white}
    .case-row-btn.load:hover{background:#6fa58e}
    .case-row-btn.edit{background:#e2b07a;color:white}
    .case-row-btn.edit:hover{background:#d4a574}
    .case-row-btn.delete{background:#e6bfc0;color:white}
    .case-row-btn.delete:hover{background:#d6a9aa}
    .case-row-btn.archive{background:#e0e7ff;color:#4338ca}
    .case-row-btn.archive:hover{background:#c7d2fe}
    .case-row-btn.unarchive{background:#fef3c7;color:#b45309}
    .case-row-btn.unarchive:hover{background:#fde68a}
    .case-row.archived{opacity:0.6;background:#f9fafb}
    .case-row.archived .case-row-title{color:#6b7280}
    .archive-toggle{display:flex;align-items:center;gap:8px;font-size:0.85rem;color:#6b7280;cursor:pointer;padding:4px 8px;border-radius:6px;transition:background 0.2s}
    .archive-toggle:hover{background:#f3f4f6}
    .archive-toggle input{cursor:pointer}
    .archive-badge{font-size:0.7rem;background:#e5e7eb;color:#6b7280;padding:2px 6px;border-radius:4px;margin-left:6px}
    /* Case Selection Mode & Aggregate Statement */
    .selection-mode-bar{display:none;align-items:center;justify-content:space-between;background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:white;padding:12px 16px;border-radius:10px;margin-bottom:12px;animation:slideIn 0.3s ease}
    .selection-mode-bar.visible{display:flex}
    .selection-count{font-weight:600;font-size:0.95rem}
    .selection-actions{display:flex;gap:10px}
    .selection-actions .btn{background:rgba(255,255,255,0.2);color:white;border:1px solid rgba(255,255,255,0.3);padding:8px 14px;font-size:0.85rem}
    .selection-actions .btn:hover{background:rgba(255,255,255,0.3)}
    .selection-actions .btn.generate{background:#10b981;border-color:#10b981}
    .selection-actions .btn.generate:hover{background:#059669}
    .case-checkbox{width:18px;height:18px;cursor:pointer;accent-color:#3b82f6;margin-right:12px;flex-shrink:0}
    .case-row.selectable{cursor:pointer}
    .case-row.selectable:hover{background:#eff6ff}
    .case-row.selected{background:#dbeafe;border-left:3px solid #3b82f6}
    .select-mode-btn{background:#f1f5f9;color:#475569;border:1px solid #e2e8f0;padding:6px 12px;font-size:0.85rem;border-radius:8px;cursor:pointer;transition:all 0.2s}
    .select-mode-btn:hover{background:#e2e8f0;color:#1e40af}
    .select-mode-btn.active{background:#3b82f6;color:white;border-color:#3b82f6}
    @keyframes slideIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
    /* Aggregate Statement Modal */
    .aggregate-modal-backdrop{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:10002}
    .aggregate-modal{background:white;border-radius:12px;max-width:950px;width:95%;max-height:90vh;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,0.2)}
    .aggregate-header{background:#374151;color:white;padding:16px 24px;display:flex;justify-content:space-between;align-items:center}
    .aggregate-title{font-size:1.1rem;font-weight:600;display:flex;align-items:center;gap:10px}
    .aggregate-close{background:rgba(255,255,255,0.1);border:none;color:white;width:32px;height:32px;border-radius:6px;cursor:pointer;font-size:1.2rem;display:flex;align-items:center;justify-content:center}
    .aggregate-close:hover{background:rgba(255,255,255,0.2)}
    .aggregate-body{padding:0;max-height:calc(90vh - 130px);overflow-y:auto}
    .aggregate-summary{background:#f9fafb;padding:16px 24px;border-bottom:1px solid #e5e7eb;display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
    .aggregate-stat{text-align:center}
    .aggregate-stat-value{font-size:1.25rem;font-weight:600;color:#111827}
    .aggregate-stat-value.negative{color:#dc2626}
    .aggregate-stat-label{font-size:0.7rem;color:#6b7280;margin-top:2px;text-transform:uppercase}
    .aggregate-table-wrap{padding:16px 24px}
    .aggregate-table{width:100%;border-collapse:collapse;font-size:0.85rem}
    .aggregate-table th{background:#f9fafb;padding:10px 8px;text-align:left;font-weight:600;color:#374151;border-bottom:1px solid #e5e7eb;font-size:0.75rem;text-transform:uppercase}
    .aggregate-table td{padding:10px 8px;border-bottom:1px solid #f3f4f6;color:#374151}
    .aggregate-table tr:hover td{background:#f9fafb}
    .aggregate-table .amount{font-weight:500;font-family:monospace;font-size:0.8rem;text-align:right}
    .aggregate-table .positive{color:#059669}
    .aggregate-table .negative{color:#dc2626}
    .aggregate-table .neutral{color:#374151}
    .aggregate-table .net-cell{font-weight:600}
    .aggregate-table th small{font-weight:400;color:#9ca3af;display:block;text-transform:none;font-size:0.65rem;margin-top:1px}
    .aggregate-table td small{color:#6b7280;font-size:0.7rem}
    .aggregate-table .owner-cell{max-width:110px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .aggregate-footer{padding:16px 24px;background:#f9fafb;border-top:1px solid #e5e7eb;display:flex;justify-content:flex-end;gap:10px}
    .aggregate-footer .btn{padding:10px 18px;font-weight:500;border-radius:8px;display:inline-flex;align-items:center;gap:6px;font-size:0.85rem;border:none;cursor:pointer}
    .aggregate-footer .btn.gray{background:#6b7280;color:white}
    .aggregate-footer .btn.gray:hover{background:#4b5563}
    .aggregate-footer .btn.primary{background:#3b82f6;color:white}
    .aggregate-footer .btn.primary:hover{background:#2563eb}
    .aggregate-footer .btn.positive{background:#10b981;color:white}
    .aggregate-footer .btn.positive:hover{background:#059669}
    .aggregate-footer .btn.print{background:#6b7280;color:white}
    .aggregate-footer .btn.print:hover{background:#4b5563}
    .aggregate-table tfoot tr{background:#f3f4f6}
    .aggregate-table tfoot td{font-weight:600;font-size:0.85rem;padding:12px 8px;border:none;color:#111827}
    .aggregate-table tfoot .positive{color:#059669}
    .aggregate-table tfoot .negative{color:#dc2626}
    [data-theme="dark"] .aggregate-modal{background:#1e293b;color:#f1f5f9}
    [data-theme="dark"] .aggregate-summary{background:#064e3b;border-color:#065f46}
    [data-theme="dark"] .aggregate-stat-value{color:#34d399}
    [data-theme="dark"] .aggregate-table th{background:#0f172a;color:#cbd5e1;border-color:#334155}
    [data-theme="dark"] .aggregate-table td{border-color:#334155;color:#e2e8f0}
    [data-theme="dark"] .aggregate-table tr:hover td{background:#0f172a}
    [data-theme="dark"] .aggregate-footer{background:#0f172a;border-color:#334155}
    [data-theme="dark"] .case-row.selected{background:#1e3a5f;border-left-color:#60a5fa}
    [data-theme="dark"] .case-row.selectable:hover{background:#1e3a5f}
    /* Building Picker Modal */
    .building-picker-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:10001}
    .building-picker{background:white;border-radius:16px;padding:24px;max-width:400px;width:90%;max-height:80vh;overflow:hidden;box-shadow:0 20px 40px rgba(0,0,0,0.2)}
    .building-picker-title{font-size:1.2rem;font-weight:600;margin-bottom:8px;color:#0f172a}
    .building-picker-subtitle{font-size:0.9rem;color:#6b7280;margin-bottom:16px}
    .building-picker-list{max-height:300px;overflow-y:auto;border:1px solid #e5e7eb;border-radius:8px;margin-bottom:16px}
    .building-picker-item{padding:12px 16px;border-bottom:1px solid #e5e7eb;cursor:pointer;transition:background 0.2s}
    .building-picker-item:last-child{border-bottom:none}
    .building-picker-item:hover{background:#f0f9ff}
    .building-picker-empty{padding:24px;text-align:center;color:#6b7280}
    .building-picker-or{text-align:center;color:#6b7280;margin:12px 0;font-size:0.9rem}
    .building-picker-input{width:100%;padding:10px 14px;border:1px solid #e5e7eb;border-radius:8px;font-size:1rem;margin-bottom:16px}
    .building-picker-actions{display:flex;gap:12px;justify-content:flex-end}
    [data-theme="dark"] .building-picker{background:#1e293b;color:#f1f5f9}
    [data-theme="dark"] .building-picker-title{color:#f1f5f9}
    [data-theme="dark"] .building-picker-subtitle{color:#94a3b8}
    [data-theme="dark"] .building-picker-list{border-color:#334155}
    [data-theme="dark"] .building-picker-item{border-color:#334155}
    [data-theme="dark"] .building-picker-item:hover{background:#334155}
    [data-theme="dark"] .building-picker-input{background:#0f172a;color:#f1f5f9;border-color:#334155}
    .pdc-empty{grid-column:1 / -1;margin:5px 0 0 5px}
    @keyframes autosavePulse { 0%,100%{opacity:1;transform:scale(1);} 50%{opacity:0.4;transform:scale(0.85);} }
    .is-hidden{display:none !important}
    .sc-toggle-row{display:flex;align-items:center;gap:8px;font-size:0.8rem;color:#64748b;margin-top:4px}
    .sc-toggle-row label{display:flex;align-items:center;gap:6px;cursor:pointer;user-select:none}
    .sc-toggle-row input[type="checkbox"]{width:14px;height:14px;cursor:pointer;accent-color:#3b82f6}
    .label-with-toggle{display:flex;align-items:center;gap:6px;flex-wrap:nowrap;margin-bottom:6px;min-height:20px}
    .label-with-toggle label{margin:0;margin-bottom:0}
    .label-with-toggle + input{margin-top:0}
    .mini-toggle{display:inline-flex;align-items:center;gap:3px;font-size:0.65rem;color:#94a3b8;cursor:pointer;user-select:none;background:#f1f5f9;padding:1px 5px;border-radius:8px;border:1px solid #e2e8f0}
    .mini-toggle:hover{background:#e2e8f0;color:#64748b}
    .mini-toggle input[type="checkbox"]{width:10px;height:10px;cursor:pointer;accent-color:#3b82f6;margin:0}
    .card{background:var(--card);border-radius:var(--radius);padding:18px;border:1px solid var(--border);box-shadow:var(--shadow);margin-bottom:18px;}
    
    /* Empty Unit Banner - simple but distinctive indicator */
    .empty-unit-banner{display:none;position:fixed;top:0;left:0;right:0;z-index:10000;background:#f59e0b;color:#78350f;padding:8px 16px;text-align:center;font-weight:700;font-size:0.95rem;letter-spacing:0.3px;border-bottom:3px solid #d97706}
    .empty-unit-banner.visible{display:block}
    .empty-unit-banner .banner-icon{display:inline;margin:0 8px}
    .empty-unit-banner .banner-text{display:inline}
    .empty-unit-banner .banner-title{display:inline;text-transform:uppercase}
    .empty-unit-banner .banner-subtitle{display:none}
    [data-theme="dark"] .empty-unit-banner{background:#b45309;color:#fef3c7;border-bottom-color:#92400e}
    /* Empty unit mode - visual changes to the page */
    body.empty-unit-mode{padding-top:45px}
    body.empty-unit-mode .brand-elegant{border-left:5px solid #f59e0b !important}
    body.empty-unit-mode #tenantName{background:#fef3c7 !important;border:2px solid #f59e0b !important;font-weight:700;color:#92400e}
    [data-theme="dark"] body.empty-unit-mode #tenantName{background:#78350f !important;color:#fef3c7 !important;border-color:#d97706 !important}
    /* Empty unit mode - mark non-required fields (lease dates, rent, security deposit) - handover stays active for SC calculation */
    body.empty-unit-mode #leaseStart,body.empty-unit-mode #leaseEnd,body.empty-unit-mode #rent,body.empty-unit-mode #securityDeposit{background:#f5f5f5 !important;border:1px dashed #d1d5db !important;color:#9ca3af !important;opacity:0.7}
    body.empty-unit-mode label[for="leaseStart"],body.empty-unit-mode label[for="leaseEnd"],body.empty-unit-mode label[for="rent"],body.empty-unit-mode label[for="securityDeposit"]{color:#9ca3af !important;text-decoration:line-through;opacity:0.7}
    [data-theme="dark"] body.empty-unit-mode #leaseStart,[data-theme="dark"] body.empty-unit-mode #leaseEnd,[data-theme="dark"] body.empty-unit-mode #rent,[data-theme="dark"] body.empty-unit-mode #securityDeposit{background:#1e293b !important;border-color:#475569 !important;color:#64748b !important}
    [data-theme="dark"] body.empty-unit-mode label[for="leaseStart"],[data-theme="dark"] body.empty-unit-mode label[for="leaseEnd"],[data-theme="dark"] body.empty-unit-mode label[for="rent"],[data-theme="dark"] body.empty-unit-mode label[for="securityDeposit"]{color:#64748b !important}
    
    .grid { display:grid; grid-template-columns:0.75fr 1.2fr 1.05fr 0.9fr 1fr; gap:10px; }
    .grid > div:not([style*="grid-column"]) { border: 1px solid var(--border); border-radius: 10px; padding: 8px; background: #fbfeff; }
    /* Small flag/emoji next to handover label when cutoff needs attention */
    .cutoff-flag{margin-left:8px;font-size:1.2rem;line-height:1;opacity:0.98;transform:translateY(1px);display:inline-flex;align-items:center;gap:6px}
    .cutoff-flag .cutoff-key{background:#fff1f0;padding:2px 6px;border-radius:6px;color:#7a2b00;font-weight:700;font-size:0.95rem}
    /* Small emoji for field labels (SC Buyer, Security Deposit, etc.) */
    .field-emoji{margin-left:8px;font-size:1.15rem;line-height:1;opacity:0.95;vertical-align:middle}
    /* Building name emoji (larger for emphasis) */
    .building-emoji{font-size:1.9rem;margin-left:10px;vertical-align:middle;opacity:0.98}
    @media (max-width:1100px){.grid{grid-template-columns:repeat(3,1fr)}}
    @media (max-width:640px){.grid{grid-template-columns:1fr}}
    @media (max-width:640px){
      .autosave-inline{order:-1;width:100%;margin-right:0;margin-bottom:12px}
    }
    
    /* Inputs */
    label{display:block;font-size:0.82rem;color:var(--muted);margin-bottom:6px;font-weight:500}
    input[type="text"], input[type="number"], input[type="date"], select, textarea{
      width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:white;font-size:0.95rem;
      transition: all 0.2s ease;
    }
    input[type="number"]{text-align:center}
    input[type="text"]:focus, input[type="number"]:focus, input[type="date"]:focus, select:focus, textarea:focus {
      border-color: var(--accent-3);
      box-shadow: 0 0 6px rgba(0, 119, 204, 0.1);
      outline: none;
    }
    textarea{min-height:80px;resize:vertical}
    /* Reduce default size of the Auto-fill Property Data textarea by ~20% */
    #bulkImportProperty { min-height:64px; height:64px; }
    .small{font-size:0.82rem;padding:8px}
    .section-title{font-weight:600;color:#1e3a5f;margin-bottom:8px;font-size:0.95rem}
    
    /* Cheques */
    .cheques-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:10px}
    .chq {
      background:#fbfeff;border:1px solid var(--border);padding:10px;border-radius:10px;min-height:92px;position:relative;
      display:flex;flex-direction:column;gap:6px;justify-content:flex-start;
    }
    .chq.cleared{background:#fcfcfc;opacity:0.7}
    .chq.cleared input,.chq.cleared select,.chq.cleared label,.chq.cleared .chq-label{color:#94a3b8}
    .chq.outstanding{background:#f1f5f9}
    .chq.date-warning{border:2px solid #f59e0b;background:#fffbeb}
    .chq.date-warning::before{content:'⚠️';position:absolute;top:4px;right:4px;font-size:12px}
    .chq.pdc-date-warning{border:2px solid #f59e0b;background:#fffbeb}
    .chq.pdc-date-warning::before{content:'⚠️';position:absolute;top:4px;right:4px;font-size:12px}
    .chq.pdc-date-past{border-color:#ef4444;background:#fef2f2}
    .chq.pdc-date-past::before{content:'⏰';position:absolute;top:4px;right:4px;font-size:12px}
    .chq.duplicate-warning{border:2px solid #ef4444;background:#fef2f2}
    .duplicate-input{border-color:#ef4444 !important;background:#fef2f2 !important}
    .amount-mismatch-warning{display:flex;align-items:center;gap:8px;padding:8px 12px;background:#fef3c7;border:1px solid #f59e0b;border-radius:8px;color:#92400e;font-size:0.85rem;margin-top:8px}
    .amount-mismatch-warning .warn-icon{font-size:1.1rem}
    .amount-mismatch-warning.hidden{display:none}
    .lease-duration-badge{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;background:linear-gradient(135deg,#f1f5f9,#e2e8f0);border:1px solid #cbd5e1;border-radius:12px;font-size:0.75rem;font-weight:600;color:#64748b;margin-left:8px;white-space:nowrap}
    .lease-duration-badge.standard{background:linear-gradient(135deg,#f1f5f9,#e2e8f0);border-color:#cbd5e1;color:#64748b}
    .lease-duration-badge.unusual{background:linear-gradient(135deg,#fef3c7,#fde68a);border-color:#f59e0b;color:#92400e;animation:pulse-warning 2s infinite}
    @keyframes pulse-warning{0%,100%{box-shadow:0 0 0 0 rgba(245,158,11,0.4)}50%{box-shadow:0 0 0 4px rgba(245,158,11,0)}}
    .lease-duration-badge .duration-icon{font-size:0.85rem}
    .input-with-badge{display:flex;align-items:center;gap:8px}
    .input-with-badge input{flex:1}
    .input-with-badge .inline-badge{margin-left:0;padding:4px 8px;font-size:0.7rem}
    /* SC Buyer field flag indicator */
    .input-with-flag{position:relative;display:flex;align-items:center}
    .input-with-flag input{flex:1;padding-right:28px}
    .input-with-flag .sc-value-flag{position:absolute;right:8px;top:50%;transform:translateY(-50%);font-size:1.1rem;opacity:0;transition:opacity 0.2s ease;pointer-events:none}
    .input-with-flag .sc-value-flag.visible{opacity:1}
    .input-with-flag.date-flag input{padding-right:32px}
    .input-with-flag .cutoff-value-flag{position:absolute;right:6px;top:50%;transform:translateY(-50%);font-size:1.1rem;opacity:0;transition:opacity 0.2s ease;pointer-events:none}
    .input-with-flag .cutoff-value-flag.visible{opacity:1}
    .cheque-meta{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:6px}
    .cheque-meta label{font-size:0.82rem;color:var(--muted);display:flex;align-items:center;gap:6px}
    .cheque-info-row{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:2px}
    .cheque-bank,.cheque-number{font-size:0.8rem;padding:6px 8px}
    .cheque-cleared-label{position:relative;gap:8px;display:flex;align-items:center;justify-content:center}
    .cheque-cleared-label input{position:absolute;opacity:0;width:1px;height:1px;margin:-1px;padding:0;border:0;clip:rect(0 0 0 0)}
    .cheque-cleared-icon{width:26px;height:26px;border-radius:6px;border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:0.9rem;color:#f97316;background:white;transition:all 0.2s ease;position:relative}
    .cheque-cleared-icon::before{content:'⚠';}
    .cheque-cleared-label input:focus-visible ~ .cheque-cleared-icon{box-shadow:0 0 0 2px rgba(14,165,163,0.35)}
    .cheque-cleared-label input:checked ~ .cheque-cleared-icon{background:#10b981;color:#fff;border-color:#059669}
    .cheque-cleared-label input:checked ~ .cheque-cleared-icon::before{content:'✔';}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .cheque-clear-date{width:140px}
    
    /* PDC Cheques - Always in one line */
    #pdcChequesRow {
      display:flex !important;
      flex-wrap:nowrap !important;
      gap:10px;
      overflow-x:auto;
      overflow-y:hidden;
      grid-template-columns:unset !important;
    }
    #pdcChequesRow .chq {
      flex:0 0 auto !important;
      min-width:238px;
      max-width:238px;
      display:flex !important;
    }
    
    /* Totals & Actions */
    .totals {display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-top:12px}
    .total-box{background:linear-gradient(180deg,#ffffff,#f8feff);padding:10px 14px;border-radius:10px;border:1px solid var(--border);font-weight:600}
    .total-amount{font-size:1.05rem;color:var(--accent-3)}
    .actions{display:flex;flex-direction:column;gap:12px;margin:16px 0 8px;align-items:center}
    .actions-reset{margin:0}
    
    /* Fixed Right Vertical Sidebar */
    .right-vertical-sidebar{
      position:fixed;
      right:0;
      top:calc(50% + 27px - 7mm);
      transform:translateY(-50%);
      z-index:9999;
      display:flex;
      flex-direction:column;
      gap:0;
    }
    .right-vertical-sidebar .sidebar-btn{
      writing-mode:vertical-rl;
      text-orientation:mixed;
      padding:18px 12px;
      border:none;
      border-left:3px solid transparent;
      background:#f8fafc;
      cursor:pointer;
      font-weight:600;
      font-size:0.92rem;
      display:flex;
      align-items:center;
      gap:10px;
      transition:all 0.2s ease;
      color:#1e293b;
    }
    .right-vertical-sidebar .sidebar-btn:first-child{
      border-radius:8px 0 0 0;
      border-top:1px solid #cbd5e1;
    }
    .right-vertical-sidebar .sidebar-btn:last-child{
      border-radius:0 0 0 8px;
      border-bottom:1px solid #cbd5e1;
    }
    .right-vertical-sidebar .sidebar-btn{
      border-left:1px solid #cbd5e1;
    }
    .right-vertical-sidebar .sidebar-btn:hover{
      background:#e2e8f0;
      border-left:3px solid #0ea5e9;
    }
    .right-vertical-sidebar .sidebar-btn .btn-icon{
      font-size:1.26rem;
    }
    .right-vertical-sidebar .health-sidebar-btn .btn-label{
      background:linear-gradient(135deg,#0f766e,#0369a1);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
    }
    .right-vertical-sidebar .calc-sidebar-btn .btn-label{
      background:linear-gradient(135deg,#1d4ed8,#7c3aed);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
    }
    .right-vertical-sidebar .reset-sidebar-btn .btn-label{
      color:#dc2626;
    }
    .right-vertical-sidebar .reset-sidebar-btn:hover{
      border-left-color:#ef4444;
    }
    .right-vertical-sidebar .refresh-sidebar-btn .btn-label{
      color:#0284c7;
    }
    .right-vertical-sidebar .refresh-sidebar-btn:hover{
      border-left-color:#0ea5e9;
    }
    .right-vertical-sidebar .refresh-sidebar-btn .btn-icon{
      font-size:1.1rem;
    }
    .right-vertical-sidebar .theme-sidebar-btn .btn-label{
      color:#6366f1;
    }
    .right-vertical-sidebar .theme-sidebar-btn:hover{
      border-left-color:#6366f1;
    }
    .right-vertical-sidebar .comm-sidebar-btn .btn-label{
      background:linear-gradient(135deg,#059669,#0d9488);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
    }
    .right-vertical-sidebar .comm-sidebar-btn:hover{
      border-left-color:#10b981;
    }
    .right-vertical-sidebar .verify-sidebar-btn .btn-label{
      background:linear-gradient(135deg,#8b5cf6,#a855f7);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
    }
    .right-vertical-sidebar .verify-sidebar-btn:hover{
      border-left-color:#a855f7;
    }
    [data-theme="dark"] .right-vertical-sidebar .sidebar-btn{
      background:#1e293b;
      border-color:#475569;
      color:#e2e8f0;
    }
    [data-theme="dark"] .right-vertical-sidebar .sidebar-btn:hover{
      background:#334155;
      border-left-color:#38bdf8;
    }
    .sidebar-stack{
      display:flex;
      flex-direction:column;
      gap:6px;
      width:220px;
    }
    .right-action-sidebar .health-trigger{
      width:100%;
    }
    .right-action-sidebar .health-btn{
      width:100%;
      min-width:unset;
      padding:12px 16px;
      font-size:0.85rem;
      box-shadow:0 4px 12px rgba(0,0,0,0.1);
    }
    .right-action-sidebar .health-trigger-pill{
      width:100%;
      justify-content:center;
    }
    
    /* Centered Status Pill */
    .status-pill-center{
      display:flex;
      justify-content:center;
      margin:16px 0 8px;
    }
    .status-pill-center .health-trigger-pill{
      padding:8px 20px;
      font-size:0.85rem;
    }
    
    .btn{
      padding:5px 18px; border-radius:8px; border:none; cursor:pointer; font-weight:500; font-size:0.93rem; transition:all 0.25s ease; box-shadow:none;
    }
    .btn:hover{ opacity:0.85; }
    .btn.primary{background:#0077cc;color:white;}
    .btn.positive{background:#10b981;color:white;}
    .btn.gray{background:#f0f1f3;color:#0b1220;border:1px solid #e5e7eb;}
    .btn.whatsapp{background:#25d366;color:white;}
    .btn.ghost{background:transparent;border:1px solid #d1d5db;color:var(--muted);}
    
    /* Timeline Visualization (increase ribbon height 10% only; keep font-size unchanged) */
    #timeline-container { position:relative; height: 15.97px; background: #e2e8f0; border-radius: 7.99px; overflow: visible; display: flex; font-size: 0.605rem; font-weight: 600; color: #0f172a; text-align: center; line-height: 15.97px; box-shadow: inset 0 1px 1px rgba(0,0,0,0.04); cursor:default; }
    .timeline-segment { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; transition: width 0.45s ease, opacity 0.15s ease; position:relative; display:flex; align-items:center; justify-content:center; height:100%; border-radius:7.99px; padding:0 7.99px; color: #0f172a; }
    #time-seller { background: #c7f9e0; width:0; color:#0f172a; border-top-left-radius:7.99px; border-bottom-left-radius:7.99px; }
    #time-buyer { background: #b7c4ff; width:0; color:#0f172a; border-top-right-radius:7.99px; border-bottom-right-radius:7.99px; }
    .timeline-segment.is-hover { opacity:0.92; }
    .timeline-tooltip {
      position:absolute;
      top:-34px;
      left:50%;
      transform:translateX(-50%) scale(0.95);
      background:#0f172a;
      color:#fff;
      font-size:0.56rem;
      padding:6px 10px;
      border-radius:999px;
      box-shadow:0 8px 16px rgba(15,23,42,0.25);
      opacity:0;
      pointer-events:none;
      transition:opacity 0.18s ease, transform 0.18s ease;
      white-space:nowrap;
    }
    .timeline-tooltip.show {
      opacity:1;
      transform:translateX(-50%) scale(1);
    }
    /* SC split timeline styled to match the main timeline; increase ribbon height 10% only */
    #timeline-sc-container { position:relative; height: 15.97px; background: #e2e8f0; border-radius: 7.99px; overflow: visible; display: flex; font-size: 0.605rem; font-weight: 600; color: #0f172a; text-align: center; line-height: 15.97px; margin-top:6.6px; box-shadow: inset 0 1px 1px rgba(0,0,0,0.04); }
    .timeline-sc-segment { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; transition: width 0.45s ease; height:100%; display:flex; align-items:center; justify-content:center; color: #0f172a; border-radius:7.99px; padding:0 7.99px; }
    /* Differentiate SC colors from the main timeline while keeping same size/edges */
    /* Lighter SC ribbon colors for improved subtlety and contrast */
    #sc-buyer { background: linear-gradient(135deg, #c7f9e0 0%, #a7f3d0 100%); width:0; color:#0f172a; border-radius:7.99px; }
    .timeline-sc-segment small { font-weight:600; font-size:0.56rem; }
    .timeline-labels { display: flex; justify-content: space-between; font-size: 0.55rem; color: #0f172a; margin-top: 4px; font-weight: 500; gap:8px; }
    .timeline-labels span { transition:color 0.2s ease; }
    .timeline-labels span.is-active { color:#0f172a; font-weight:600; }

    /* Communication Section */
    #commSectionWrapper {
      margin-top: 12px; text-align: center;
    }
    /* Hide only the inline communications section (keep modal and buttons available) */
    /* This hides the embedded comm section but preserves the modal/dialog and sidebar button so popups work. */
    #commSectionWrapper { display: none !important; height: 0 !important; margin: 0 !important; padding: 0 !important; overflow: hidden !important; }
    .comm-open-btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; font-size: 0.9rem; }
    .comm-modal { max-width: 950px; max-height: 90vh; overflow-y: auto; }
    .comm-modal .names-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 16px; }
    .comm-modal .sender-row { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px dashed var(--border); }
    .comm-modal .sender-row label { font-weight: 600; color: var(--text-secondary); font-size: 0.85rem; white-space: nowrap; }
    .comm-modal .sender-row input { flex: 0 0 250px; }
    .comm-modal .sender-row .sender-hint { font-size: 0.75rem; color: #64748b; font-style: italic; }
    .comm-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
    .comm-card { background: #fafbfc; border: 1px solid var(--border); border-radius: 10px; padding: 14px; display: flex; flex-direction: column; }
    .comm-body { flex: 1; background: #ffffff; border: 1px solid #edf2f7; padding: 10px; border-radius: 8px; font-family: 'Monaco', monospace; font-size: 0.75rem; color: #475569; white-space: pre-wrap; overflow-y: auto; max-height: 180px; margin-bottom: 10px; resize: vertical; min-height: 120px; }
    .comm-body-display { flex: 1; background: #ffffff; border: 1px solid #edf2f7; padding: 10px; border-radius: 8px; font-family: 'Monaco', monospace; font-size: 0.75rem; color: #475569; white-space: pre-wrap; overflow-y: auto; max-height: 180px; margin-bottom: 10px; }

    .settlement-health { display: flex; gap: 8px; margin-bottom: 14px; flex-wrap: wrap; }
    .health-badge { display: flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 20px; border: 1px solid #e2e8f0; background: #f8fafc; transition: all 0.2s ease; box-shadow: 0 1px 3px rgba(0,0,0,0.04); flex: 1; min-width: 180px; }
    .health-badge .badge-icon { font-size: 0.85rem; line-height: 1; opacity: 0.9; }
    .health-badge .badge-label { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.06em; color: #64748b; font-weight: 700; white-space: nowrap; }
    .health-badge .badge-status { font-size: 0.72rem; font-weight: 600; color: #334155; line-height: 1.3; }
    
    /* Calculations Badge - Blue/Teal theme */
    #healthBadge-calc.ready { border-color: #67e8f9; background: linear-gradient(135deg, #ecfeff 0%, #cffafe 100%); box-shadow: 0 2px 8px rgba(6,182,212,0.15); }
    #healthBadge-calc.ready .badge-icon { filter: drop-shadow(0 0 3px rgba(6,182,212,0.5)); }
    #healthBadge-calc.ready .badge-status { color: #0891b2; }
    #healthBadge-calc.warn { border-color: #93c5fd; background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); box-shadow: 0 2px 8px rgba(59,130,246,0.12); }
    #healthBadge-calc.warn .badge-icon { filter: drop-shadow(0 0 3px rgba(59,130,246,0.4)); }
    #healthBadge-calc.warn .badge-status { color: #2563eb; }
    
    /* Cheques Badge - Amber/Gold theme */
    #healthBadge-cheques.ready { border-color: #fcd34d; background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); box-shadow: 0 2px 8px rgba(245,158,11,0.15); }
    #healthBadge-cheques.ready .badge-icon { filter: drop-shadow(0 0 3px rgba(245,158,11,0.5)); }
    #healthBadge-cheques.ready .badge-status { color: #b45309; }
    #healthBadge-cheques.warn { border-color: #fdba74; background: linear-gradient(120deg, #fff7ed 0%, #ffedd5 50%, #fed7aa 100%); box-shadow: 0 2px 8px rgba(249,115,22,0.12); }
    #healthBadge-cheques.warn .badge-icon { filter: drop-shadow(0 0 3px rgba(249,115,22,0.4)); }
    #healthBadge-cheques.warn .badge-status { color: #c2410c; }
    
    /* Docs Badge - Green/Emerald theme */
    #healthBadge-docs.ready { border-color: #86efac; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); box-shadow: 0 2px 8px rgba(34,197,94,0.15); }
    #healthBadge-docs.ready .badge-icon { filter: drop-shadow(0 0 3px rgba(34,197,94,0.5)); }
    #healthBadge-docs.ready .badge-status { color: #15803d; }
    #healthBadge-docs.warn { border-color: #a7f3d0; background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); box-shadow: 0 2px 8px rgba(16,185,129,0.12); }
    #healthBadge-docs.warn .badge-icon { filter: drop-shadow(0 0 3px rgba(16,185,129,0.4)); }
    #healthBadge-docs.warn .badge-status { color: #047857; }
    
    /* Shared idle state */
    .health-badge.idle { border-color: #cbd5e1; background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%); }
    .health-badge.idle .badge-status { color: #64748b; font-weight: 500; }
    .health-badge.idle .badge-icon { opacity: 0.5; }
    
    /* Shared alert state */
    .health-badge.alert { border-color: #fca5a5; background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); box-shadow: 0 2px 8px rgba(239,68,68,0.15); animation: pulse-alert 2s infinite; }
    .health-badge.alert .badge-icon { filter: drop-shadow(0 0 3px rgba(239,68,68,0.5)); }
    .health-badge.alert .badge-status { color: #b91c1c; }
    @keyframes pulse-alert { 0%, 100% { box-shadow: 0 2px 8px rgba(239,68,68,0.15); } 50% { box-shadow: 0 2px 12px rgba(239,68,68,0.3); } }
    
    /* Recalculation Warning Flag */
    .recalc-warning-flag {
      display: none;
      position: fixed;
      top: 12px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      gap: 16px;
      padding: 18px 36px;
      border-radius: 16px;
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 40%, #fcd34d 70%, #f59e0b 100%);
      border: 4px solid #f59e0b;
      box-shadow: 0 12px 48px rgba(245,158,11,0.5), 0 0 0 8px rgba(245,158,11,0.2), inset 0 2px 4px rgba(255,255,255,0.4);
      animation: flag-pulse 1s ease-in-out infinite;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .recalc-warning-flag:hover {
      transform: translateX(-50%) scale(1.08);
      box-shadow: 0 16px 56px rgba(245,158,11,0.6), 0 0 0 12px rgba(245,158,11,0.25), inset 0 2px 4px rgba(255,255,255,0.4);
    }
    .recalc-warning-flag.visible { display: flex; }
    .recalc-warning-flag .flag-icon {
      font-size: 2.6rem;
      animation: flag-wave 0.5s ease-in-out infinite alternate;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
    }
    .recalc-warning-flag .flag-text {
      font-size: 1.4rem;
      font-weight: 800;
      color: #92400e;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      text-shadow: 0 1px 2px rgba(255,255,255,0.5);
    }
    .recalc-warning-flag .flag-settlement {
      font-size: 1.1rem;
      color: #1e3a5f;
      font-weight: 800;
      background: linear-gradient(135deg, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0.6) 100%);
      padding: 6px 14px;
      border-radius: 8px;
      margin: 6px 0;
      border: 2px solid rgba(30,58,95,0.2);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .recalc-warning-flag .flag-hint {
      font-size: 0.9rem;
      color: #b45309;
      font-weight: 600;
    }
    @keyframes flag-pulse {
      0%, 100% { box-shadow: 0 12px 48px rgba(245,158,11,0.5), 0 0 0 8px rgba(245,158,11,0.2), inset 0 2px 4px rgba(255,255,255,0.4); }
      50% { box-shadow: 0 16px 64px rgba(245,158,11,0.7), 0 0 0 16px rgba(245,158,11,0.3), inset 0 2px 4px rgba(255,255,255,0.4); }
    }
    @keyframes flag-wave {
      0% { transform: rotate(-10deg); }
      100% { transform: rotate(10deg); }
    }
    [data-theme="dark"] .recalc-warning-flag {
      background: linear-gradient(135deg, #451a03 0%, #78350f 50%, #92400e 100%);
      border-color: #fbbf24;
      box-shadow: 0 12px 48px rgba(251,191,36,0.6), 0 0 0 8px rgba(251,191,36,0.25);
    }
    [data-theme="dark"] .recalc-warning-flag .flag-text { color: #fef3c7; text-shadow: 0 1px 3px rgba(0,0,0,0.3); }
    [data-theme="dark"] .recalc-warning-flag .flag-settlement { background: linear-gradient(135deg, rgba(254,243,199,0.9) 0%, rgba(253,230,138,0.9) 100%); color: #1e3a5f; border-color: rgba(251,191,36,0.5); }
    [data-theme="dark"] .recalc-warning-flag .flag-hint { color: #fde68a; }
    
    /* Dark mode */
    [data-theme="dark"] .settlement-health { background: rgba(15,23,42,0.3); border-radius: 12px; padding: 8px; }
    [data-theme="dark"] .health-badge { border-color: #475569; background: linear-gradient(135deg, #1e293b 0%, #334155 100%); box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
    [data-theme="dark"] .health-badge .badge-label { color: #94a3b8; }
    [data-theme="dark"] .health-badge .badge-status { color: #e2e8f0; }
    [data-theme="dark"] #healthBadge-calc.ready { border-color: #06b6d4; background: linear-gradient(135deg, rgba(8,145,178,0.4) 0%, rgba(6,182,212,0.2) 100%); }
    [data-theme="dark"] #healthBadge-calc.warn { border-color: #3b82f6; background: linear-gradient(135deg, rgba(37,99,235,0.4) 0%, rgba(59,130,246,0.2) 100%); }
    [data-theme="dark"] #healthBadge-cheques.ready { border-color: #f59e0b; background: linear-gradient(135deg, rgba(180,83,9,0.4) 0%, rgba(245,158,11,0.2) 100%); }
    [data-theme="dark"] #healthBadge-cheques.warn { border-color: #ea580c; background: linear-gradient(120deg, rgba(124,45,18,0.5) 0%, rgba(194,65,12,0.3) 100%); }
    [data-theme="dark"] #healthBadge-docs.ready { border-color: #22c55e; background: linear-gradient(135deg, rgba(21,128,61,0.4) 0%, rgba(34,197,94,0.2) 100%); }
    [data-theme="dark"] #healthBadge-docs.warn { border-color: #10b981; background: linear-gradient(135deg, rgba(4,120,87,0.4) 0%, rgba(16,185,129,0.2) 100%); }
    [data-theme="dark"] .health-badge.alert { border-color: #dc2626; background: linear-gradient(135deg, rgba(127,29,29,0.5) 0%, rgba(185,28,28,0.3) 100%); }
    /* Modern formal gap clarifier card */
    .gap-clarifier { border: 1px solid rgba(15,23,42,0.06); background: linear-gradient(180deg, #ffffff, #fbfdff); padding: 14px; border-radius: 10px; margin-bottom: 12px; box-shadow: 0 8px 24px rgba(12,20,35,0.06); }
    .gap-clarifier.is-hidden { display: none; }
    .gap-clarifier-head { display: flex; justify-content: space-between; align-items: center; gap: 12px; }
    .gap-clarifier-kicker { font-size: 0.78rem; text-transform: uppercase; letter-spacing: 0.08em; color: #0f172a; font-weight: 700; opacity: 0.85; }
    .gap-clarifier-amount { font-size: 1.35rem; font-weight: 700; color: #0b61a4; }
    .gap-clarifier-direction { font-size: 0.85rem; color: #0f172a; font-weight: 600; text-align: right; opacity: 0.75; }
    .gap-clarifier-hint { margin: 10px 0 14px; font-size: 0.9rem; color: #374151; }
    .gap-clarifier-amount-wrap{display:flex;align-items:center;gap:10px}
    .gap-percent-badge{background:rgba(11,97,164,0.08);color:#0b61a4;padding:4px 8px;border-radius:999px;font-weight:700;font-size:0.8rem}
    .gap-clarifier-actions { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
    .gap-chip { border: 1px solid rgba(15,23,42,0.08); background: transparent; color: #0f172a; padding: 8px 12px; border-radius: 8px; font-size: 0.82rem; font-weight: 600; cursor: pointer; transition: all 0.12s ease; }
    .gap-chip:hover { background: rgba(15,23,42,0.03); }
    .gap-chip.active, .gap-chip:focus-visible { background: #0b61a4; color: #fff; border-color: rgba(11,97,164,0.9); box-shadow: 0 8px 20px rgba(11,97,164,0.12); }
    .gap-chip[aria-pressed="true"]{background:#0b61a4;color:#fff}

    .gap-note{width:100%;min-height:84px;border-radius:10px;border:1px solid #e6eef6;padding:10px;font-size:0.95rem;color:#0f172a}
    .gap-note::placeholder{color:#94a3b8}

    .gap-modal-footer{display:flex;justify-content:flex-end;gap:10px;margin-top:14px}
    .gap-note-label { font-size: 0.78rem; text-transform: uppercase; letter-spacing: 0.08em; color: #92400e; font-weight: 700; display: block; margin-bottom: 6px; }
    .gap-note { width: 100%; min-height: 60px; border: 1px solid #f5d0a0; border-radius: 10px; padding: 8px 10px; font-size: 0.9rem; resize: vertical; background: #fffef6; color: #7c2d12; }
    .gap-note:focus { outline: 2px solid #f97316; border-color: #f97316; background: #ffffff; }
    [data-theme="dark"] .gap-clarifier { border-color: rgba(249,115,22,0.5); background: rgba(120,53,15,0.4); box-shadow: none; }
    [data-theme="dark"] .gap-clarifier-kicker { color: #fde68a; }
    [data-theme="dark"] .gap-clarifier-amount { color: #fcd34d; }
    [data-theme="dark"] .gap-clarifier-direction { color: #fed7aa; }
    [data-theme="dark"] .gap-clarifier-hint { color: #fde68a; }
    [data-theme="dark"] .gap-chip { border-color: rgba(253,230,138,0.35); background: rgba(180,83,9,0.45); color: #fde68a; }
    [data-theme="dark"] .gap-chip.active { background: #ea580c; border-color: #f97316; color: #fff7ed; }
    [data-theme="dark"] .gap-note { background: rgba(15,23,42,0.45); color: #fde68a; border-color: #b45309; }
    .gap-modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999; opacity: 0; visibility: hidden; transition: all 0.2s ease; }
    .gap-modal-backdrop.show { opacity: 1; visibility: visible; }
    .gap-modal { background: #fff; border-radius: 12px; padding: 18px 20px; max-width: 520px; width: 92%; box-shadow: 0 24px 60px rgba(12,20,35,0.12); transform: scale(0.95); transition: transform 0.18s ease; }
    .gap-modal-backdrop.show .gap-modal { transform: scale(1); }
    .gap-modal-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .gap-modal-title { font-size: 1.1rem; font-weight: 700; color: #b45309; }
    .gap-modal-close { background: none; border: none; font-size: 1.5rem; color: #94a3b8; cursor: pointer; line-height: 1; padding: 4px; }
    .gap-modal-close:hover { color: #475569; }
    [data-theme="dark"] .gap-modal { background: #1e293b; }
    [data-theme="dark"] .gap-modal-title { color: #fcd34d; }
    [data-theme="dark"] .gap-modal-close { color: #94a3b8; }
    [data-theme="dark"] .gap-modal-close:hover { color: #f1f5f9; }
    .health-badge { cursor: pointer; transition: all 0.15s ease; }
    .health-badge:hover { transform: translateY(-1px) scale(1.02); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .health-badge:active { transform: scale(0.98); }
    .comm-btn { font-size: 0.75rem; padding: 6px 10px; min-height: 32px; display: inline-flex; align-items: center; justify-content: center; }
    .docs-popup-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; z-index: 9999; opacity: 0; visibility: hidden; transition: all 0.2s ease; }
    .docs-popup-backdrop.show { opacity: 1; visibility: visible; }
    .docs-popup { background: #fff; border-radius: 16px; padding: 20px; max-width: 380px; width: 90%; box-shadow: 0 20px 50px rgba(0,0,0,0.25); transform: scale(0.9); transition: transform 0.2s ease; }
    .docs-popup-backdrop.show .docs-popup { transform: scale(1); }
    .docs-popup-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .docs-popup-title { font-size: 1.1rem; font-weight: 700; color: #0f766e; }
    .docs-popup-close { background: none; border: none; font-size: 1.5rem; color: #94a3b8; cursor: pointer; }
    .docs-popup-close:hover { color: #475569; }
    .docs-action-grid { display: flex; flex-direction: column; gap: 10px; }
    .docs-action-btn { display: flex; align-items: center; gap: 12px; padding: 12px 14px; border-radius: 10px; border: 1px solid #e2e8f0; background: #f8fafc; cursor: pointer; transition: all 0.15s ease; text-align: left; }
    .docs-action-btn:hover { background: #f1f5f9; border-color: #cbd5e1; transform: translateX(4px); }
    .docs-action-btn.done { background: #f0fdf4; border-color: #86efac; }
    .docs-action-btn .action-icon { font-size: 1.4rem; }
    .docs-action-btn .action-text { flex: 1; }
    .docs-action-btn .action-title { font-weight: 600; color: #1e293b; font-size: 0.95rem; }
    .docs-action-btn .action-hint { font-size: 0.78rem; color: #64748b; }
    .docs-action-btn .action-check { color: #22c55e; font-size: 1.1rem; }
    [data-theme="dark"] .docs-popup { background: #1e293b; }
    [data-theme="dark"] .docs-popup-title { color: #5eead4; }
    [data-theme="dark"] .docs-action-btn { background: #334155; border-color: #475569; }
    [data-theme="dark"] .docs-action-btn:hover { background: #3f4f63; }
    [data-theme="dark"] .docs-action-btn .action-title { color: #f1f5f9; }
    [data-theme="dark"] .docs-action-btn .action-hint { color: #94a3b8; }
    [data-theme="dark"] .docs-action-btn.done { background: rgba(34,197,94,0.15); border-color: #22c55e; }
    .calc-popup-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; z-index: 9999; opacity: 0; visibility: hidden; transition: all 0.2s ease; }
    .calc-popup-backdrop.show { opacity: 1; visibility: visible; }
    .calc-popup { background: #fff; border-radius: 12px; padding: 18px; max-width: 560px; width: 92%; box-shadow: 0 24px 60px rgba(12,20,35,0.08); transform: scale(0.95); transition: transform 0.18s ease; }
    .calc-popup-backdrop.show .calc-popup { transform: scale(1); }
    .calc-popup-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .calc-popup-title { font-size: 1.15rem; font-weight: 700; color: #0f172a; }
    .calc-popup-close { background: none; border: none; font-size: 1.5rem; color: #94a3b8; cursor: pointer; }
    .calc-popup-close:hover { color: #475569; }
    .calc-popup-net { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:14px; background: linear-gradient(180deg,#ffffff,#f8fafc); border-radius:10px; margin-bottom:14px; border:1px solid #e6eef6; }
    .calc-popup-net.buyer-pays { border-color: #fdecea; background: linear-gradient(180deg,#fff,#fff7f7); }
    .calc-popup-net-amount { font-size: 1.85rem; font-weight: 800; color: #0b61a4; }
    .calc-popup-net.buyer-pays .calc-popup-net-amount { color: #b91c1c; }
    .calc-popup-net-dir { font-size: 0.95rem; font-weight: 600; color: #334155; margin-top: 0; opacity:0.85; }
    .calc-popup-net.buyer-pays .calc-popup-net-dir { color: #9b1c1c; }
    .calc-breakdown { display: flex; flex-direction: column; gap: 10px; }
    .calc-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; border-radius: 10px; background: #ffffff; border:1px solid #eef3f8; }
    .calc-row.seller { border-left: 4px solid #fbbf24; }
    .calc-row.buyer { border-left: 4px solid #60a5fa; }
    .calc-row.pdc { border-left: 4px solid #f97316; }
    .calc-row.deposit { border-left: 4px solid #06b6d4; }
    .calc-row.sc { border-left: 4px solid #a78bfa; }
    .calc-row-label { font-size: 0.9rem; color: #0f172a; font-weight: 700; }
    .calc-row-value { font-size: 1rem; font-weight: 800; color: #0f172a; }
    .calc-row-sub { font-size: 0.8rem; color: #64748b; margin-top:4px; }
    .calc-divider { height: 1px; background: #eef3f8; margin: 8px 0; }
    .calc-copy-btn { margin-top: 14px; width: 100%; padding: 10px 12px; border-radius: 10px; border: none; background: #0b61a4; color: #fff; font-weight: 700; cursor: pointer; transition: all 0.12s; box-shadow: 0 8px 20px rgba(11,97,164,0.12); }
    .calc-copy-btn:hover { transform: translateY(-1px); opacity: 0.98; }
    [data-theme="dark"] .calc-popup { background: #1e293b; }
    [data-theme="dark"] .calc-popup-title { color: #5eead4; }
    [data-theme="dark"] .calc-popup-net { background: linear-gradient(135deg, rgba(6,95,70,0.3), rgba(4,120,87,0.2)); }
    [data-theme="dark"] .calc-popup-net.buyer-pays { background: linear-gradient(135deg, rgba(185,28,28,0.3), rgba(220,38,38,0.2)); }
    [data-theme="dark"] .calc-row { background: #334155; }
    [data-theme="dark"] .calc-row-label { color: #94a3b8; }
    [data-theme="dark"] .calc-row-value { color: #f1f5f9; }
    
    /* Table & Summary */
    table{width:100%;border-collapse:collapse;margin-top:18px;background:transparent}
    th,td{padding:10px 8px;text-align:left;border-bottom:1px solid var(--border);font-size:0.92rem;color:#0b1220;vertical-align:middle}
    thead th{background:transparent;color:var(--muted);font-weight:600;font-size:0.85rem}
    .highlight-seller{background:#fff7ed}
    .highlight-buyer{background:#f0fdf4}
    .highlight-service{background:#fffbeb}
    .highlight-total{background:#fff1f2;font-weight:700;color:var(--danger)}
    .summary { margin-top:4px;padding:10px;border-radius:8px;background:#ffffff;border:1px solid #e2e8f0; }
    .summary .net{font-size:1.5rem;font-weight:700;color:#065f46}
    
    /* Utils */
    .section-divider { height: 3px; background: linear-gradient(90deg, transparent 0%, #d0d9e6 20%, #d0d9e6 80%, transparent 100%); margin: 14px 0; border: none; }
    .muted{color:var(--muted)}
    .center{text-align:center}
    .label{font-weight:600;color:var(--muted);font-size:0.86rem}
    .hint{font-size:0.82rem;color:var(--muted)}
    
    /* Imports Area */
    .special-import { background: linear-gradient(180deg, #fafbfc 0%, #f7f9fc 100%); border: 1px solid #e0e7f1; padding: 20px; border-radius: 16px; position: relative; overflow: hidden; }
    .import-area{display:flex;gap:12px;align-items:stretch;justify-content:space-between}
    /* Updated background for import textareas */
    .special-import textarea { border: 1px solid #e0e7f1; background: #e0e0e0; font-family: 'Monaco', monospace; font-size: 0.84rem; }
    
    /* New section separator for Cheques */
    .cheque-ribbon-separator {
      background: linear-gradient(135deg,#1e3a5f 0%,#2c5282 100%);
      border-top: 2px solid #1e3a5f;
      border-bottom: 2px solid #1e3a5f;
      padding: 10px 20px;
      margin: -7mm 0 0;
      text-align: center;
      font-weight: 700;
      color: #ffffff;
      font-size: 1.1rem;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(30,58,95,0.2);
      letter-spacing: 0.5px;
    }
    .cheque-ribbon-separator + .card.cheques-section{margin-top:6px}
    .card.cheques-section{margin-bottom:12px}
    .section-divider.tight { margin: 6px 0; }

    .toast { position: fixed; bottom: 20px; right: 20px; background: #333; color: white; padding: 10px 20px; border-radius: 5px; z-index: 1000; display: none; }
    .toast.show { display: block; animation: fadeout 3s forwards; }
    @keyframes fadeout { 0% { opacity: 1; } 80% { opacity: 1; } 100% { opacity: 0; } }
    
    /* PDC Cheques Section Styling */
    .pdc-cheques-area {
        display:flex;
        flex-direction:column;
        gap:16px;
    }
    .pdc-section-elegant .pdc-header-elegant{
        padding-bottom:12px;
        border-bottom:1px solid #dfe6f0;
    }
    .pdc-title-wrapper{
        display:flex;
        flex-direction:column;
    }

    @media print{
      body{background:white !important;padding:0;-webkit-print-color-adjust:exact !important;print-color-adjust:exact !important;}
      
      /* Empty Unit Banner - show in print */
      body.empty-unit-mode{padding-top:0 !important}
      .empty-unit-banner.visible{display:block !important;position:relative !important;background:#f59e0b !important;color:#78350f !important;padding:6px 12px !important;font-size:0.9rem !important;border-bottom:2px solid #d97706 !important;margin-bottom:8px !important;-webkit-print-color-adjust:exact !important;print-color-adjust:exact !important}
      
      /* Hide non-essential UI elements */
      .actions, .head .brand p, .import-area, .hint, .comm-grid, #commSectionWrapper, #commModal,
      .right-vertical-sidebar, .status-pill-center, .health-trigger, .collapse-btn, .icon-btn-elegant,
      .autosave-indicator, .floating-actions, #rightVerticalSidebar, .modal, .modal-backdrop,
      .case-notes-icon, .mini-toggle, .special-import, .import-actions, .cheque-ribbon-separator,
      #refreshPageBtn, #floatingResetBtn, #darkModeToggle, #healthPanelBtn, #calcBtn, #openCommModalSidebar,
      #verifyAiBtn, .field-emoji, .cutoff-value-flag, .sc-value-flag, .lease-duration-badge,
      .cheque-cleared-icon, datalist, #scMasterToggleWrap, .recalc-warning-flag {display:none !important}
      
      /* Show all buttons as hidden except labels */
      .btn {display:none !important}
      
      /* Card and layout styling */
      .card, table, .summary{box-shadow:none !important;border:1px solid #ccc !important;page-break-inside:avoid;}
      .wrap{padding:12px !important;max-width:100% !important;}
      .grid{grid-template-columns:repeat(3,1fr) !important; gap:6px !important;}
      
      /* Header/Brand styling for print */
      .head .brand{background:#1e3a5f !important;-webkit-print-color-adjust:exact !important;print-color-adjust:exact !important;padding:10px 16px !important;}
      .head .brand h1{color:white !important;font-size:1.1rem !important;}
      #buildingName{background:white !important;color:#1e3a5f !important;font-weight:700 !important;font-size:1rem !important;border:none !important;}
      
      /* Make all inputs display their values clearly for review */
      input, select, textarea {
        border:1px solid #999 !important;
        background:white !important;
        color:#000 !important;
        font-size:0.85rem !important;
        padding:4px 6px !important;
        -webkit-print-color-adjust:exact !important;
        print-color-adjust:exact !important;
      }
      input[readonly] {
        background:#f5f5f5 !important;
        border:1px dashed #aaa !important;
      }
      input[type="checkbox"] {
        width:14px !important;
        height:14px !important;
        -webkit-print-color-adjust:exact !important;
      }
      
      /* Labels styling */
      label {
        font-size:0.75rem !important;
        font-weight:600 !important;
        color:#333 !important;
        display:block !important;
        margin-bottom:2px !important;
      }
      
      /* Grid field containers */
      .grid > div {
        padding:6px !important;
        border:1px solid #e0e0e0 !important;
        border-radius:4px !important;
        background:#fafafa !important;
        page-break-inside:avoid;
      }
      
      /* Section titles */
      .section-title {
        font-size:0.95rem !important;
        font-weight:700 !important;
        color:#1e3a5f !important;
        border-bottom:2px solid #1e3a5f !important;
        padding-bottom:4px !important;
        margin-bottom:8px !important;
      }
      
      /* Cheques section - expand for review */
      .collapsible-body, .collapsible-body.collapsed {
        display:block !important;
        height:auto !important;
        overflow:visible !important;
        opacity:1 !important;
      }
      .cheques-row, #rentalChequesRow, #pdcChequesRow {
        display:grid !important;
        grid-template-columns:repeat(2, 1fr) !important;
        gap:6px !important;
      }
      .chq {
        display:block !important;
        border:1px solid #bbb !important;
        padding:5px 6px !important;
        border-radius:4px !important;
        background:#fff !important;
        page-break-inside:avoid;
        font-size:0.75rem !important;
      }
      .chq[style*="display: none"] {display:none !important;}
      .chq .label {
        font-weight:700 !important;
        color:#1e3a5f !important;
        font-size:0.7rem !important;
        margin-bottom:2px !important;
      }
      .chq input {
        font-size:0.7rem !important;
        padding:2px 4px !important;
        height:auto !important;
        min-height:18px !important;
      }
      .chq.cleared {
        background:#e8f5e9 !important;
        border-color:#4caf50 !important;
      }
      .cheque-meta, .cheque-info-row {
        margin-top:2px !important;
        gap:4px !important;
      }
      
      /* Hide indicator cards (cheque count & total value badges) in print */
      .indicator-card, .section-indicators, .indicator-stack {
        display:none !important;
      }
      
      /* Totals box - compact for print */
      .totals {
        display:flex !important;
        flex-wrap:wrap !important;
        gap:8px !important;
        margin-top:6px !important;
      }
      .totals, .total-box {
        background:#f0f4f8 !important;
        border:1px solid #ccc !important;
        padding:4px 8px !important;
        font-weight:600 !important;
        font-size:0.75rem !important;
      }
      .total-box {
        display:inline-block !important;
      }
      
      /* Results table */
      #resultsCard {display:block !important;}
      table th, table td{padding:4px 6px !important; font-size:0.8rem !important; border:1px solid #ccc !important;}
      table th {background:#1e3a5f !important; color:white !important; -webkit-print-color-adjust:exact !important;}
      
      /* Summary section */
      #summarySection {display:block !important;}
      .summary {
        background:#f8f9fa !important;
        padding:12px !important;
        border:1px solid #ccc !important;
      }
      
      /* Timeline - hide for print */
      #timeline-container, .timeline-labels, #timeline-sc-container, #sc-timeline-labels { display:none !important; }
      .timeline-wrapper {display:none !important;}
      
      /* Indicators */
      .indicator-card {
        border:1px solid #ddd !important;
        padding:6px 10px !important;
        background:#fff !important;
      }
      .indicator-value {
        font-weight:700 !important;
        color:#1e3a5f !important;
      }
      
      /* Page breaks */
      .cheques-section {page-break-before:auto; page-break-inside:avoid;}
      #resultsCard {page-break-before:always;}
      
      /* Print header info */
      .brand-top {
        display:flex !important;
        flex-direction:column !important;
        gap:4px !important;
      }
      
      /* Buyer name field */
      #buyerName {
        border:1px solid #999 !important;
        background:white !important;
      }
      
      /* Muted text */
      .muted {
        font-size:0.7rem !important;
        color:#666 !important;
      }
      
      /* Section dividers */
      hr, .section-divider {
        border:none !important;
        border-top:1px solid #ccc !important;
        margin:8px 0 !important;
      }
      
      /* Print-specific header */
      .head::before {
        content:"📋 RENTAL SETTLEMENT - DATA ENTRY REVIEW" !important;
        display:block !important;
        text-align:center !important;
        font-size:0.85rem !important;
        font-weight:700 !important;
        color:#1e3a5f !important;
        padding:8px !important;
        border:2px solid #1e3a5f !important;
        border-radius:6px !important;
        margin-bottom:12px !important;
        background:#f0f4f8 !important;
      }
      
      /* Print review summary box */
      .print-review-summary {
        display:block !important;
        background:#fff !important;
        border:2px solid #1e3a5f !important;
        border-radius:8px !important;
        padding:12px 16px !important;
        margin-bottom:16px !important;
        page-break-inside:avoid;
      }
      .print-review-summary h3 {
        margin:0 0 8px 0 !important;
        font-size:0.9rem !important;
        color:#1e3a5f !important;
        border-bottom:1px solid #ccc !important;
        padding-bottom:4px !important;
      }
      .print-review-grid {
        display:grid !important;
        grid-template-columns:repeat(4, 1fr) !important;
        gap:8px !important;
      }
      .print-review-item {
        background:#f8f9fa !important;
        padding:6px 8px !important;
        border-radius:4px !important;
        border:1px solid #e0e0e0 !important;
      }
      .print-review-item .label {
        font-size:0.65rem !important;
        color:#666 !important;
        text-transform:uppercase !important;
        letter-spacing:0.5px !important;
      }
      .print-review-item .value {
        font-size:0.85rem !important;
        font-weight:700 !important;
        color:#1e3a5f !important;
      }
      
      /* Show date/time stamp on print */
      .print-timestamp {
        display:block !important;
        text-align:right !important;
        font-size:0.7rem !important;
        color:#888 !important;
        margin-bottom:4px !important;
      }
      
      /* Footer for print */
      @page {
        margin:0.5in;
        size:A4;
      }
      
      /* Print footer */
      .wrap::after {
        content:"Printed for review purposes only - Please verify all data entries" !important;
        display:block !important;
        text-align:center !important;
        font-size:0.7rem !important;
        color:#888 !important;
        padding-top:16px !important;
        margin-top:16px !important;
        border-top:1px dashed #ccc !important;
      }
    }
    
    /* Hide print-only elements in normal view (outside print media query) */
    .print-review-summary {
      display:none !important;
    }
    .print-timestamp {
      display:none !important;
    }
    
    input.invalid, textarea.invalid { border-color: var(--danger) !important; }
    
    /* Validation Checkmarks */
    .field-wrapper.field-valid::after {
      content: '✓';
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--positive);
      font-weight: bold;
      font-size: 1.05rem;
      pointer-events: none;
      z-index: 6;
    }
    .field-wrapper {
      position: relative;
    }
    
    /* Live Preview */
    .live-preview {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 16px 20px;
      border-radius: 8px;
      margin: 16px 0;
      display: none;
      align-items: center;
      gap: 12px;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    .live-preview.show { display: flex; }
    .live-preview-label {
      font-size: 0.85rem;
      opacity: 0.9;
    }
    .live-preview-amount {
      font-size: 1.8rem;
      font-weight: 700;
      margin-left: auto;
    }
    
    /* Warning System */
    .warning-box {
      background: linear-gradient(135deg, #fff3cd 0%, #ffe8a1 100%);
      border: 2px solid #ffc107;
      border-left: 6px solid #ff9800;
      padding: 14px 18px;
      border-radius: 8px;
      margin: 16px 0;
      display: none;
      gap: 12px;
      align-items: start;
      box-shadow: 0 3px 10px rgba(255, 152, 0, 0.2);
      animation: warningPulse 0.5s ease-out;
    }
    .warning-box.show { display: flex; }
    @keyframes warningPulse {
      0% { transform: scale(0.98); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }
    .warning-icon {
      color: #ff9800;
      font-size: 1.4rem;
      font-weight: bold;
      flex-shrink: 0;
      animation: warningShake 0.5s ease-in-out;
    }
    @keyframes warningShake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-4px); }
      75% { transform: translateX(4px); }
    }
    @keyframes fadeIn {
      from { opacity:0; transform:translateY(10px); }
      to { opacity:1; transform:translateY(0); }
    }
    .warning-content {
      flex: 1;
    }
    .warning-title {
      font-weight: 700;
      color: #664d03;
      margin-bottom: 6px;
      font-size: 0.95rem;
    }
    .warning-message {
      font-size: 0.86rem;
      color: #664d03;
      line-height: 1.6;
    }
    .health-trigger {
      display:flex;
      flex-direction:column;
      justify-content:flex-start;
      align-items:stretch;
      gap:2px;
      margin:0;
      flex-wrap:nowrap;
      width:100%;
    }
    .health-btn {
      position:relative;
      border:none;
      background:linear-gradient(145deg,#ffffff,#f1f5f9);
      color:#1e293b;
      font-weight:600;
      font-size:0.9rem;
      padding:14px 28px;
      border-radius:16px;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:12px;
      transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow:0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.9);
      min-width:220px;
      width:100%;
      justify-content:center;
      overflow:hidden;
    }
    .health-btn::before {
      content:'';
      position:absolute;
      inset:0;
      border-radius:16px;
      padding:1.5px;
      background:linear-gradient(145deg, rgba(20,184,166,0.4), rgba(59,130,246,0.3));
      -webkit-mask:linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask:linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite:xor;
      mask-composite:exclude;
    }
    .health-btn .health-icon {
      font-size:1.2rem;
      filter:drop-shadow(0 1px 2px rgba(0,0,0,0.1));
    }
    .health-btn .health-label {
      letter-spacing:0.02em;
      background:linear-gradient(135deg,#0f766e,#0369a1);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
    }
    .health-btn:hover {
      transform:translateY(-3px);
      box-shadow:0 20px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,1);
      background:linear-gradient(145deg,#ffffff,#f8fafc);
    }
    .health-btn:active {
      transform:translateY(-1px);
      box-shadow:0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
    }
    .calc-btn {
      background:linear-gradient(145deg,#ffffff,#eef2ff);
    }
    .calc-btn::before {
      background:linear-gradient(145deg, rgba(59,130,246,0.5), rgba(139,92,246,0.4));
    }
    .calc-btn .health-label {
      background:linear-gradient(135deg,#1d4ed8,#7c3aed);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
    }
    .calc-btn:hover {
      background:linear-gradient(145deg,#ffffff,#f5f3ff);
    }
    .health-trigger-pill {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:4px;
      font-size:0.78rem;
      font-weight:600;
      padding:5px 12px;
      border-radius:18px;
      border:1px solid transparent;
      background:linear-gradient(135deg,#eef2ff,#e0f2fe);
      color:#1e3a5f;
      box-shadow:0 4px 12px rgba(30,58,95,0.16);
      transition:all 0.2s ease;
    }
    .health-trigger-pill .pill-icon,
    .health-trigger-pill .pill-text{display:flex;align-items:center;line-height:1;}
    .health-trigger-pill .pill-icon{font-size:0.85rem;justify-content:center;height:1rem;}
    .health-trigger-pill .pill-text{letter-spacing:0.04em;}
    .health-trigger-pill.has-issues {
      background:linear-gradient(135deg,#fff7ed,#ffe4d6);
      color:#b45309;
      border-color:#fdba74;
      box-shadow:0 8px 18px rgba(245,158,11,0.25);
    }
    .health-trigger-pill.is-clear {
      background:linear-gradient(135deg,#ecfdf5,#d1fae5);
      color:#047857;
      border-color:#6ee7b7;
      box-shadow:0 8px 18px rgba(16,185,129,0.25);
    }
    @media (max-width:640px) {
      .right-action-sidebar {
        right:10px;
        bottom:10px;
      }
      .sidebar-stack {
        width:180px;
      }
      .right-action-sidebar .health-btn {
        padding:10px 12px;
        font-size:0.8rem;
      }
      .actions-reset {
        width:100%;
        align-self:stretch;
      }
      .health-trigger {
        align-items:stretch;
        width:100%;
      }
      .health-btn {
        width:100%;
        justify-content:center;
      }
      .health-trigger-pill {
        width:100%;
        justify-content:center;
        text-align:center;
      }
    }
    .health-modal-backdrop {
      display:none;
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.7);
      z-index:10000;
      padding:24px;
      overflow:auto;
    }
    .health-modal-backdrop.show {
      display:block;
      animation:fadeIn 0.2s ease-out;
    }
    .health-modal {
      max-width:540px;
      margin:60px auto;
      background:#ffffff;
      border-radius:18px;
      padding:22px 24px 26px;
      box-shadow:0 30px 60px rgba(15,23,42,0.35);
      border:1px solid #e2e8f0;
    }
    .health-modal-head {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:16px;
      margin-bottom:6px;
    }
    .health-modal-title {
      margin:0;
      font-size:1.05rem;
      font-weight:700;
      color:#0f172a;
    }
    .health-modal-close {
      border:none;
      background:none;
      font-size:1.4rem;
      cursor:pointer;
      color:#94a3b8;
      transition:color 0.2s ease;
    }
    .health-modal-close:hover { color:#475569; }
    .health-modal-intro {
      font-size:0.85rem;
      color:#475569;
      margin-bottom:16px;
    }
    .health-modal-body {
      display:flex;
      flex-direction:column;
      gap:12px;
      max-height:65vh;
      overflow:auto;
      padding-right:4px;
    }
    .health-card {
      border:1px solid #e2e8f0;
      border-radius:14px;
      padding:12px 14px;
      display:flex;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
      background:#ffffff;
      box-shadow:0 4px 12px rgba(15,23,42,0.08);
    }
    .health-card .health-text { flex:1; }
    .health-card .health-title {
      font-weight:600;
      font-size:0.92rem;
      margin-bottom:4px;
      color:#0f172a;
    }
    .health-card .health-detail {
      font-size:0.82rem;
      color:#475569;
      line-height:1.4;
    }
    .health-chip {
      font-size:0.75rem;
      font-weight:700;
      border-radius:999px;
      padding:4px 12px;
      border:1px solid;
      text-transform:uppercase;
      letter-spacing:0.04em;
      white-space:nowrap;
    }
    .health-card.ok {
      background:#f0fdf4;
      border-color:#bbf7d0;
    }
    .health-card.ok .health-chip {
      border-color:#34d399;
      color:#047857;
      background:rgba(52,211,153,0.15);
    }
    .health-card.warn {
      background:#fff7ed;
      border-color:#fdba74;
    }
    .health-card.warn .health-chip {
      border-color:#f97316;
      color:#b45309;
      background:rgba(251,146,60,0.18);
    }
    .health-card.critical {
      background:#fef2f2;
      border-color:#fecaca;
    }
    .health-card.critical .health-chip {
      border-color:#ef4444;
      color:#b91c1c;
      background:rgba(248,113,113,0.15);
    }
    .health-card.todo {
      background:#e0f2fe;
      border-color:#bae6fd;
    }
    .health-card.todo .health-chip {
      border-color:#3b82f6;
      color:#1d4ed8;
      background:rgba(59,130,246,0.15);
    }
    .health-card.info {
      background:#eef2ff;
      border-color:#cbd5f5;
    }
    .health-card.info .health-chip {
      border-color:#64748b;
      color:#475569;
      background:rgba(148,163,184,0.18);
    }
    /* Health card dismiss functionality */
    .health-actions {
      display:flex;
      align-items:center;
      gap:6px;
    }
    .health-dismiss-btn {
      width:22px;
      height:22px;
      border-radius:50%;
      border:1px solid #d1d5db;
      background:#f9fafb;
      color:#6b7280;
      font-size:0.75rem;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:all 0.15s ease;
    }
    .health-dismiss-btn:hover {
      background:#e5e7eb;
      border-color:#9ca3af;
      color:#374151;
    }
    .health-dismiss-btn.dismissed {
      background:#dcfce7;
      border-color:#86efac;
      color:#16a34a;
    }
    .health-card.is-dismissed {
      opacity:0.5;
      filter:grayscale(0.3);
    }
    .health-card.is-dismissed .health-title {
      text-decoration:line-through;
    }
    /* Case Notes Icon */
    .case-notes-icon {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:28px;
      height:28px;
      border-radius:50%;
      background:rgba(255,255,255,0.2);
      border:1px solid rgba(255,255,255,0.3);
      box-shadow:0 1px 3px rgba(0,0,0,0.15);
      cursor:pointer;
      transition:all 0.2s ease;
      font-size:0.9rem;
      color:#fff;
    }
    .case-notes-icon:hover {
      background:rgba(255,255,255,0.35);
      border-color:rgba(255,255,255,0.5);
      transform:scale(1.1);
    }
    .case-notes-icon.has-notes {
      background:linear-gradient(135deg,#fef3c7 0%,#fde68a 100%);
      border-color:#f59e0b;
      box-shadow:0 0 8px rgba(245,158,11,0.5),0 0 16px rgba(245,158,11,0.3);
      animation:noteGlow 2s ease-in-out infinite alternate;
    }
    .case-notes-icon.has-notes:hover {
      box-shadow:0 0 12px rgba(245,158,11,0.7),0 0 24px rgba(245,158,11,0.4);
    }
    @keyframes noteGlow {
      0% { box-shadow:0 0 6px rgba(245,158,11,0.3),0 0 12px rgba(245,158,11,0.15); }
      100% { box-shadow:0 0 10px rgba(245,158,11,0.5),0 0 20px rgba(245,158,11,0.25); }
    }
    /* Notes Modal */
    .notes-modal-backdrop {
      display:none;
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.7);
      z-index:10000;
      padding:24px;
      overflow:auto;
    }
    .notes-modal-backdrop.show {
      display:block;
      animation:fadeIn 0.2s ease-out;
    }
    .notes-modal {
      max-width:480px;
      margin:80px auto;
      background:#ffffff;
      border-radius:18px;
      padding:22px 24px 26px;
      box-shadow:0 30px 60px rgba(15,23,42,0.35);
      border:1px solid #e2e8f0;
    }
    .notes-modal-head {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:16px;
      margin-bottom:12px;
    }
    .notes-modal-title {
      margin:0;
      font-size:1.1rem;
      font-weight:700;
      color:#0f172a;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .notes-modal-close {
      border:none;
      background:none;
      font-size:1.4rem;
      cursor:pointer;
      color:#94a3b8;
      transition:color 0.2s ease;
    }
    .notes-modal-close:hover { color:#475569; }
    .notes-modal-intro {
      font-size:0.85rem;
      color:#64748b;
      margin-bottom:16px;
      padding:10px 12px;
      background:#fffbeb;
      border:1px dashed #fbbf24;
      border-radius:8px;
    }
    .notes-modal-textarea {
      width:100%;
      min-height:180px;
      padding:14px;
      border:1px solid #e2e8f0;
      border-radius:10px;
      font-size:0.95rem;
      font-family:inherit;
      resize:vertical;
      transition:border-color 0.2s ease, box-shadow 0.2s ease;
    }
    .notes-modal-textarea:focus {
      outline:none;
      border-color:#3b82f6;
      box-shadow:0 0 0 3px rgba(59,130,246,0.15);
    }
    .notes-pdf-option {
      margin-top:12px;
      padding:12px;
      background:#f8fafc;
      border-radius:8px;
      border:1px solid #e2e8f0;
    }
    .notes-pdf-toggle {
      display:flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      font-weight:500;
      color:#334155;
    }
    .notes-pdf-toggle input[type="checkbox"] {
      width:16px;
      height:16px;
      cursor:pointer;
    }
    .notes-pdf-hint {
      display:block;
      font-size:0.8rem;
      color:#64748b;
      margin-top:4px;
      margin-left:24px;
    }
    [data-theme="dark"] .notes-pdf-option {
      background:#1e293b;
      border-color:#334155;
    }
    [data-theme="dark"] .notes-pdf-toggle {
      color:#e2e8f0;
    }
    [data-theme="dark"] .notes-pdf-hint {
      color:#94a3b8;
    }
    .notes-modal-footer {
      margin-top:16px;
      display:flex;
      justify-content:flex-end;
      gap:10px;
    }
    .notes-modal-footer .btn {
      padding:8px 18px;
      font-size:0.9rem;
    }
    </style>
</head>
<body>

  <!-- Recalculation Warning Flag - Fixed Position -->
  <div class="recalc-warning-flag" id="recalcWarningFlag" title="Data has been modified - Click to refresh page">
    <span class="flag-icon" aria-hidden="true">🚩</span>
    <div>
      <div class="flag-text">⚠ DATA MODIFIED</div>
      <div class="flag-settlement" id="flagSettlementPreview"></div>
      <div class="flag-hint">Click to refresh page</div>
    </div>
  </div>
  <div class="wrap" id="app" style="position:relative;">
    <div style="position:absolute;width:100%;left:0;top:0;z-index:10;pointer-events:none;height:0;">
      <div class="autosave-banner autosave-below autosave-elegant" style="pointer-events:auto;transform:scale(0.7);transform-origin:left center;position:absolute;left:28.2cm;top:calc(20px - 4mm);">
        <div class="autosave-indicator saved" id="autosaveStatus" role="status" aria-live="polite" style="background:linear-gradient(135deg,#f8fafc 0%,#f1f5f9 100%);border:1px solid #cbd5e1;box-shadow:0 2px 8px rgba(71,85,105,0.12);padding:7px 16px;white-space:nowrap;">
          <div class="autosave-label" id="autosaveLabel" style="font-size:1.06rem;font-weight:700;letter-spacing:0.3px;color:#1e3a5f;">Autosave ready</div>
          <div class="autosave-meta" id="autosaveMeta" style="font-size:0.93rem;color:#5a6c7d;font-weight:500;letter-spacing:0.2px;">Recovered autosave • 00:20</div>
        </div>
      </div>
      <!-- Small fixed sidebar toggle for Service Charge calculation (left side) -->
      <div id="scMasterToggleWrap" style="position:fixed;left:14px;top:180px;background:var(--card,#fff);padding:8px 10px;border:1px solid var(--border,#e2e8f0);border-radius:8px;box-shadow:0 6px 20px rgba(30,58,95,0.06);z-index:9999;font-size:0.9rem;display:flex;align-items:center;gap:8px;pointer-events:auto;">
        <input type="checkbox" id="scMasterToggle" style="width:16px;height:16px;cursor:pointer;accent-color:#3b82f6;">
        <label for="scMasterToggle" style="cursor:pointer;user-select:none;" title="Enable/disable Service Charge calculations">SC Calc</label>
      </div>
      <div class="head-actions head-actions-elegant" aria-label="Quick actions" style="pointer-events:auto;gap:7px;display:flex;transform:scale(0.7);transform-origin:right center;position:absolute;right:2mm;top:calc(90px - 5mm);">
        <button class="btn primary icon-btn icon-btn-elegant" id="saveCaseBtn" title="Save Current Case" aria-label="Save current case" style="background:#f8fafc;border:1px solid #e2e8f0;box-shadow:0 1px 3px rgba(100,116,139,0.1);padding-top:4px;padding-bottom:4px;">
          <span aria-hidden="true" style="font-size:0.72rem;color:#475569;opacity:0.8;">●</span>
          <small style="font-size:0.72rem;font-weight:800;letter-spacing:0.03em;">SAVE</small>
        </button>
        <button class="btn primary icon-btn icon-btn-elegant" id="loadCaseBtn" title="Load Saved Case" aria-label="Load saved case" style="background:#f8fafc;border:1px solid #e2e8f0;box-shadow:0 1px 3px rgba(100,116,139,0.1);padding-top:4px;padding-bottom:4px;">
          <span aria-hidden="true" style="font-size:0.72rem;color:#475569;opacity:0.8;">◐</span>
          <small style="font-size:0.72rem;font-weight:800;letter-spacing:0.03em;">LOAD</small>
        </button>
        <button class="btn gray icon-btn icon-btn-elegant" id="printBtn" title="Print" aria-label="Print settlement" style="background:#f8fafc;border:1px solid #e2e8f0;box-shadow:0 1px 3px rgba(100,116,139,0.1);color:#475569;padding-top:4px;padding-bottom:4px;">
          <span aria-hidden="true" style="font-size:0.72rem;color:#475569;opacity:0.8;">⎙</span>
          <small style="font-size:0.72rem;font-weight:800;letter-spacing:0.03em;">PRINT</small>
        </button>
        <button class="btn gray icon-btn icon-btn-elegant" id="excelBtn" title="Export Excel" aria-label="Export Excel" style="background:#f8fafc;border:1px solid #e2e8f0;box-shadow:0 1px 3px rgba(100,116,139,0.1);color:#475569;padding-top:4px;padding-bottom:4px;">
          <span aria-hidden="true" style="font-size:0.72rem;color:#475569;opacity:0.8;">▤</span>
          <small style="font-size:0.72rem;font-weight:800;letter-spacing:0.03em;">EXCEL</small>
        </button>
        <button class="btn gray icon-btn icon-btn-elegant" id="previewBtn" title="Preview PDF (Ctrl+Shift+P)" aria-label="Preview PDF" style="background:#f8fafc;border:1px solid #e2e8f0;box-shadow:0 1px 3px rgba(100,116,139,0.1);color:#475569;padding-top:4px;padding-bottom:4px;">
          <span aria-hidden="true" style="font-size:0.72rem;color:#475569;opacity:0.8;">👁</span>
          <small style="font-size:0.72rem;font-weight:800;letter-spacing:0.03em;">PREV.</small>
        </button>
        <button class="btn gray icon-btn icon-btn-elegant" id="pdfBtn" title="Export PDF - Full (Ctrl+P)" aria-label="Export PDF" style="background:#f8fafc;border:1px solid #e2e8f0;box-shadow:0 1px 3px rgba(100,116,139,0.1);color:#475569;padding-top:4px;padding-bottom:4px;">
          <span aria-hidden="true" style="font-size:0.72rem;color:#475569;opacity:0.8;">▭</span>
          <small style="font-size:0.72rem;font-weight:800;letter-spacing:0.03em;">PDF</small>
        </button>
        <button class="btn gray icon-btn icon-btn-elegant" id="buyerPdfBtn" title="Export PDF for Buyer (without Rental Cheques)" aria-label="Export Buyer PDF" style="background:#f0fdf4;border:1px solid #bbf7d0;box-shadow:0 1px 3px rgba(34,197,94,0.1);color:#166534;padding-top:4px;padding-bottom:4px;">
          <span aria-hidden="true" style="font-size:0.72rem;color:#166534;opacity:0.8;">▭</span>
          <small style="font-size:0.72rem;font-weight:800;letter-spacing:0.03em;">BUYER PDF</small>
        </button>
        <button class="btn gray icon-btn icon-btn-elegant" id="pngBtn" title="Export PNG" aria-label="Export PNG" style="background:#f8fafc;border:1px solid #e2e8f0;box-shadow:0 1px 3px rgba(100,116,139,0.1);color:#475569;padding-top:4px;padding-bottom:4px;">
          <span aria-hidden="true" style="font-size:0.72rem;color:#475569;opacity:0.8;">▢</span>
          <small style="font-size:0.72rem;font-weight:800;letter-spacing:0.03em;">PNG</small>
        </button>
      </div>
    </div>

    <div class="head">
      <div class="brand brand-elegant" role="banner" style="position:relative;background:linear-gradient(135deg,#1e3a5f 0%,#2c5282 100%);border:none;box-shadow:0 6px 20px rgba(30,58,95,0.25);">
        <div class="brand-top">
          <input type="text" id="buildingName" list="buildingHistory" placeholder="Building / Tower Name" class="building-input building-input-elegant" style="background:rgba(255,255,255,0.92);border:none;color:#1e3a5f;font-weight:600;box-shadow:0 2px 8px rgba(0,0,0,0.1);" title="Enter building or tower name - suggestions from history">
          <datalist id="buildingHistory"><option value="Laguna Tower">Laguna Tower</option></datalist>
             <span class="building-emoji" title="Building">🏢</span>
          <div style="margin-left:5mm;margin-top:2mm;display:flex;align-items:center;gap:12px;">
            <h1 id="pageTitle" style="font-size:1.25rem;font-weight:700;letter-spacing:0.5px;margin-bottom:6px;"><span class="page-title-strong">Unit 411</span> — MUHAMMED</h1>
            <button type="button" class="case-notes-icon" id="caseNotesBtn" title="Case Notes (Internal - Not Exported)" aria-label="Open case notes" style="flex-shrink:0;">📝</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Empty Unit Banner - shown when tenant is "empty" -->
    <div class="empty-unit-banner" id="emptyUnitBanner" role="alert">
      <span class="banner-icon">🏠</span>
      <span class="banner-text"><span class="banner-title">Empty Unit</span> — No Tenant</span>
      <span class="banner-icon">🏠</span>
    </div>

    <!-- Print-only Review Summary Section -->
    <div class="print-review-summary" id="printReviewSummary">
      <div class="print-timestamp" id="printTimestamp"></div>
      <h3>📋 Quick Data Summary for Review</h3>
      <div class="print-review-grid">
        <div class="print-review-item">
          <div class="label">Building</div>
          <div class="value" id="printBuilding">—</div>
        </div>
        <div class="print-review-item">
          <div class="label">Unit</div>
          <div class="value" id="printUnit">—</div>
        </div>
        <div class="print-review-item">
          <div class="label">Tenant</div>
          <div class="value" id="printTenant">—</div>
        </div>
        <div class="print-review-item">
          <div class="label">Buyer</div>
          <div class="value" id="printBuyer">—</div>
        </div>
        <div class="print-review-item">
          <div class="label">Lease Period</div>
          <div class="value" id="printLeasePeriod">—</div>
        </div>
        <div class="print-review-item">
          <div class="label">Handover Date</div>
          <div class="value" id="printHandover">—</div>
        </div>
        <div class="print-review-item">
          <div class="label">Total Rent</div>
          <div class="value" id="printRent">—</div>
        </div>
        <div class="print-review-item">
          <div class="label">Security Deposit</div>
          <div class="value" id="printDeposit">—</div>
        </div>
      </div>
    </div>

    <div class="card basic-info-card" style="border:2px solid #d0d9e6;margin-top:0;">
      <div class="card-head">
        <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap;">
          <div>
            <div class="section-title">Basic information <span class="field-emoji" title="Basic info">ℹ️</span></div>
            <div class="muted muted-note" style="font-size:0.65rem;line-height:1;">Bold unit &amp; tenant — header/exports</div>
          </div>
          <div style="display:flex;align-items:center;gap:6px;transform:translateY(-2mm) translateX(15mm);">
            <label for="buyerName" style="font-weight:400;color:#475569;font-size:0.82rem;margin:0;white-space:nowrap;">Buyer:</label>
            <input type="text" id="buyerName" class="buyer-name-input" placeholder="e.g. John Doe" style="width:520px;max-width:70%;min-width:180px;height:26px;font-size:0.82rem;line-height:1;">
          </div>
        </div>
      </div>
      <div class="grid" id="basicGrid">
        <div>
          <label for="unitNo">Unit Number * <span class="field-emoji" title="Unit">🏠</span></label>
          <input type="text" id="unitNo" placeholder="Enter Unit No." required="">
        </div>
        <div>
          <label for="tenantName">Tenant Name * <span class="field-emoji" title="Tenant">👤</span></label>
          <input type="text" id="tenantName" placeholder="Enter tenant name" required="">
        </div>
        <div>
          <div class="label-with-toggle">
            <label for="scArea" id="scAreaLabel">Unit Area (sq.ft) *</label>
            <label class="mini-toggle"><input type="checkbox" id="scAreaReqToggle" checked="">Req</label>
            <span class="field-emoji" id="scAreaEmoji" title="Unit area">📏</span>
          </div>
          <input type="text" id="scArea" inputmode="decimal" placeholder="Enter area" required="">
        </div>
        <div class="field-wrapper">
          <label for="leaseStart">Lease Start * <span class="field-emoji" title="Lease start">📅</span></label>
          <input type="date" id="leaseStart">
        </div>
        <div class="field-wrapper">
          <label for="leaseEnd">Lease End * <span class="field-emoji" title="Lease end">🏁</span></label>
          <input type="date" id="leaseEnd">
        </div>
        <div>
          <label for="totalDaysDisplay">Contract Days <span class="field-emoji" title="Contract duration">⏳</span></label>
          <div class="input-with-badge">
            <input type="text" id="totalDaysDisplay" class="small" readonly="" placeholder="Auto-calc">
            <span id="leaseDurationBadge" class="lease-duration-badge inline-badge" style="display: inline-flex;"><span class="duration-icon">📅</span><span class="duration-text">9M</span></span>
          </div>
        </div>
        <div class="field-wrapper">
          <label for="handoverDate" style="white-space:nowrap;">Handover / Cutoff Date * <span class="field-emoji" title="Handover/cutoff date">🔑</span></label>
          <div class="input-with-flag date-flag">
            <input type="date" id="handoverDate">
            <span class="cutoff-value-flag" id="cutoffValueFlag" title="Cutoff date set">🚩</span>
          </div>
        </div>
        <div class="field-wrapper">
          <label for="rent">Tot. Contract Rent (AED) * <span class="field-emoji" title="Total contract rent">💵</span></label>
          <input type="text" id="rent" inputmode="decimal" placeholder="Total (AED)">
        </div>
        <div>
          <label for="dailyRentDisplay">Daily Rent (AED) <span class="field-emoji" title="Daily rent">💲</span></label>
          <input type="text" id="dailyRentDisplay" class="small" readonly="" placeholder="Auto-calc">
        </div>
        <div class="for-buyer">
          <label for="securityDeposit">Security Deposit * <span class="field-emoji" title="Security deposit">💰</span></label>
          <input type="text" id="securityDeposit" inputmode="decimal" placeholder="AED" required="">
        </div>
        <div class="field-valid">
          <div class="label-with-toggle">
            <label for="scRate" id="scRateLabel">$/sq.ft</label>
            <label class="mini-toggle"><input type="checkbox" id="scFieldsMandatory" checked="">Req</label>
            <span class="field-emoji" id="scRateEmoji" title="SC rate">📐</span>
          </div>
          <div class="input-with-lock">
            <input type="checkbox" id="scRateLockInside" class="sc-rate-lock-inside" title="Lock SC Rate" aria-label="Lock SC Rate">
            <input type="number" id="scRate" min="6" max="20" step="0.01" inputmode="decimal" placeholder="6" value="6" required="">
          </div>
          <span id="scRateNote" class="muted sc-rate-note" style="display: none; font-size:0.64rem;">SC Rate not required</span>
        </div>
        <div>
          <label for="scTotal">Annual SC <span class="field-emoji" title="Invoice">🧾</span></label>
          <input type="text" id="scTotal" class="small" readonly="" placeholder="Auto-calc">
        </div>
        <div>
          <label for="scPerDay">SC per Day (AED) <span class="field-emoji" title="Daily service charge rate">💲</span></label>
          <input type="text" id="scPerDay" class="small" readonly="" placeholder="Auto-calc">
        </div>
        <div class="field-wrapper">
          <label for="scPaidEnd">SC Paid Period End <span class="field-emoji" title="When seller's SC coverage ends">📆</span><span class="field-emoji" title="SC paid period end">🔑</span></label>
          <div class="input-with-flag date-flag" style="display:flex;align-items:center;gap:6px;">
            <select id="scFrequency" title="SC Payment Frequency" style="padding:6px 4px;font-size:0.85rem;width:auto;min-width:42px;border-radius:6px;">
              <option value="quarterly" selected>Q</option>
              <option value="monthly">M</option>
              <option value="half-yearly">HY</option>
              <option value="yearly">Y</option>
            </select>
            <input type="date" id="scPaidEnd" style="flex:1;">
            <span class="cutoff-value-flag" id="scPaidEndFlag" title="SC period end date set">🚩</span>
          </div>
        </div>
        <div class="against-buyer">
          <label for="serviceCharge" id="scBuyerLabel">Buyer SC Portion * <span class="field-emoji" title="Buyer SC Portion">⚖️</span></label>
          <div class="input-with-flag">
            <input type="text" id="serviceCharge" inputmode="decimal" placeholder="Auto-calc" required="" readonly="" style="background: rgb(248, 250, 252);">
            <span class="sc-value-flag" id="scValueFlag" title="SC amount calculated">🚩</span>
          </div>
        </div>

        <div class="grid-span-all timeline-wrapper">
          <label>Settlement Timeline</label>
          <div id="timeline-container">
            <div class="timeline-tooltip" id="timelineTooltip" role="status" aria-live="polite"></div>
            <div id="time-seller" class="timeline-segment" data-tooltip="106 days • 30 Aug 2025 → 13 Dec 2025 • AED 12,842.31" title="Seller (106d • AED 12,842.31)" style="width: 38.8278%;">Seller (106d • AED 12,842.31)</div>
            <div id="time-buyer" class="timeline-segment" data-tooltip="167 days • 14 Dec 2025 → 29 May 2026 • AED 20,232.69" title="Buyer (167d • AED 20,232.69)" style="width: 61.1722%;">Buyer (167d • AED 20,232.69)</div>
          </div>
          <div class="timeline-labels">
            <span id="tl-start">30 Aug 2025</span>
            <span id="tl-handover">13 Dec 2025</span>
            <span id="tl-end">29 May 2026</span>
          </div>
          <!-- SC Timeline: shows Buyer's SC portion based on cutoff → SC paid period end -->
          <div id="timeline-sc-container" aria-hidden="false">
            <div class="timeline-tooltip" id="timelineScTooltip" role="status" aria-live="polite"></div>
            <div id="sc-buyer" class="timeline-sc-segment" data-tooltip="" title="" style="width: 0%;"></div>
          </div>
          <div class="timeline-labels" id="sc-timeline-labels" style="display:none;">
            <span id="sc-tl-start">-</span>
            <span id="sc-tl-end">-</span>
          </div>
        </div>

        <div class="special-import grid-span-all">
          <div class="import-area">
            <div class="import-field">
              <label for="bulkImportProperty">Auto-fill Property Data <span class="field-emoji" title="Auto-fill">🏢</span></label>
              <textarea id="bulkImportProperty" placeholder="Paste table row: Unit | Tenant | Start Date | End Date | Rent | Deposit | No. of Cheques"></textarea>
              <div class="hint">Copy a complete row from your Excel spreadsheet and paste it here.</div>
            </div>
            <div class="import-actions">
              <button class="btn ghost w-100" id="importPropertyBtn">Auto-fill Form</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <hr id="resultsDivider" class="section-divider tight is-hidden">
    
    <div class="cheque-ribbon-separator">
      CHEQUE HANDLING SECTION 💸
    </div>
    <div class="card cheques-section" style="border:1px solid #dfe7f3;">
      <div class="flex-between">
        <div>
          <div class="section-title">Bulk Import Cheques <span class="field-emoji" title="Bulk import">🧾</span></div>
          <div class="muted">Paste cheque lines here to auto-fill the Rental Cheques section</div>
        </div>
        <div style="display:flex;gap:20px;align-items:center;">
          <div style="display:flex;align-items:center;gap:6px;">
            <span style="font-size:1rem;">✍️</span>
            <label for="rentalCount" style="font-size:0.85rem;color:#475569;white-space:nowrap;font-weight:500;">Cheques Received</label>
            <select id="rentalCount" style="font-size:0.9rem;padding:4px 12px;min-width:55px;border:1px solid #cbd5e1;border-radius:6px;">
              <option selected="">0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option>
            </select>
          </div>
          <div style="display:flex;align-items:center;gap:6px;">
            <span style="font-size:1rem;">📤</span>
            <label for="pdcCount" style="font-size:0.85rem;color:#475569;white-space:nowrap;font-weight:500;">Cheques to Hand Over</label>
            <select id="pdcCount" style="font-size:0.9rem;padding:4px 12px;min-width:55px;border:1px solid #cbd5e1;border-radius:6px;">
              <option selected="">0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option>
            </select>
          </div>
        </div>
      </div>
      <div class="special-import grid-span-all mt-18">
        <div class="import-area">
          <div class="import-field">
            <label for="bulkImport">Cheque Date <span class="field-emoji" title="Cheque date">📅</span> and Amount <span class="field-emoji" title="Cheque amount">💸</span></label>
            <textarea id="bulkImport" placeholder="Paste cheque entries from Excel (one per line)"></textarea>
            <div class="hint">Supports: "Date | Amount" or extended "Unit | Tenant | Contract# | Date | Amount | Bank | Cheque #" (extra columns optional)</div>
          </div>
          <div class="import-actions">
            <button class="btn ghost w-100" id="importBtn">Import Cheques</button>
          </div>
        </div>
      </div>

      <hr style="margin:24px 0;border:none;border-top:1px dashed #e0e7f1;">

      <div class="collapsible-head">
        <div>
          <div class="section-title">Rental Cheques received by Seller <span class="field-emoji" title="Rental cheques">✍️</span></div>
          <div class="muted">Mark each cheque as Cleared if bank-cleared</div>
        </div>
        <div class="section-indicators indicator-stack">
          <div class="indicator-card count">
            <span class="indicator-icon">✍️</span>
            <span class="indicator-text">
              <span class="indicator-label">Cheques Count</span>
              <span class="indicator-value" id="rentalChipCount">0 Cheques</span>
            </span>
          </div>
          <div class="indicator-card total">
            <span class="indicator-icon">💰</span>
            <span class="indicator-text">
              <span class="indicator-label">Total Value</span>
              <span class="indicator-value" id="rentalChipTotal">AED 0.00</span>
            </span>
          </div>
          <button class="collapse-btn is-collapsed" type="button" onclick="toggleCollapse(&#39;rentalChequesBody&#39;, this)" aria-controls="rentalChequesBody" aria-expanded="false">
            Details
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 9l7 7 7-7"></path></svg>
          </button>
        </div>
      </div>
      <div class="section-subnote" id="rentalSummaryMini">Total: AED 0.00 • Cleared: AED 0.00</div>
      <div class="collapsible-body collapsed" id="rentalChequesBody" aria-hidden="true">
        <div class="cheques-row mt-12" id="rentalChequesRow"><div class="chq outstanding" id="rentChq1Item" style="display: none;">
        <div class="label">Chq 1</div>
        <input type="date" id="rentChq1Date" class="small">
        <input type="number" id="rentChq1" step="0.01" placeholder="Amount">
        <div class="cheque-info-row">
          <input type="text" id="rentChq1Bank" class="small cheque-bank" placeholder="Bank name" list="bankHistoryList" autocomplete="off">
          <input type="text" id="rentChq1Number" class="small cheque-number" placeholder="Cheque #">
        </div>
        <div class="cheque-meta">
          <label class="cheque-cleared-label">
            <span class="sr-only">Mark cheque cleared</span>
            <input type="checkbox" id="rentChq1Cleared" aria-label="Mark cheque cleared">
            <span class="cheque-cleared-icon" aria-hidden="true"></span>
          </label>
          <input type="date" id="rentChq1ClearDate" class="small cheque-clear-date" aria-label="Clear date">
        </div></div><div class="chq outstanding" id="rentChq2Item" style="display: none;">
        <div class="label">Chq 2</div>
        <input type="date" id="rentChq2Date" class="small">
        <input type="number" id="rentChq2" step="0.01" placeholder="Amount">
        <div class="cheque-info-row">
          <input type="text" id="rentChq2Bank" class="small cheque-bank" placeholder="Bank name" list="bankHistoryList" autocomplete="off">
          <input type="text" id="rentChq2Number" class="small cheque-number" placeholder="Cheque #">
        </div>
        <div class="cheque-meta">
          <label class="cheque-cleared-label">
            <span class="sr-only">Mark cheque cleared</span>
            <input type="checkbox" id="rentChq2Cleared" aria-label="Mark cheque cleared">
            <span class="cheque-cleared-icon" aria-hidden="true"></span>
          </label>
          <input type="date" id="rentChq2ClearDate" class="small cheque-clear-date" aria-label="Clear date">
        </div></div><div class="chq outstanding" id="rentChq3Item" style="display: none;">
        <div class="label">Chq 3</div>
        <input type="date" id="rentChq3Date" class="small">
        <input type="number" id="rentChq3" step="0.01" placeholder="Amount">
        <div class="cheque-info-row">
          <input type="text" id="rentChq3Bank" class="small cheque-bank" placeholder="Bank name" list="bankHistoryList" autocomplete="off">
          <input type="text" id="rentChq3Number" class="small cheque-number" placeholder="Cheque #">
        </div>
        <div class="cheque-meta">
          <label class="cheque-cleared-label">
            <span class="sr-only">Mark cheque cleared</span>
            <input type="checkbox" id="rentChq3Cleared" aria-label="Mark cheque cleared">
            <span class="cheque-cleared-icon" aria-hidden="true"></span>
          </label>
          <input type="date" id="rentChq3ClearDate" class="small cheque-clear-date" aria-label="Clear date">
        </div></div><div class="chq outstanding" id="rentChq4Item" style="display: none;">
        <div class="label">Chq 4</div>
        <input type="date" id="rentChq4Date" class="small">
        <input type="number" id="rentChq4" step="0.01" placeholder="Amount">
        <div class="cheque-info-row">
          <input type="text" id="rentChq4Bank" class="small cheque-bank" placeholder="Bank name" list="bankHistoryList" autocomplete="off">
          <input type="text" id="rentChq4Number" class="small cheque-number" placeholder="Cheque #">
        </div>
        <div class="cheque-meta">
          <label class="cheque-cleared-label">
            <span class="sr-only">Mark cheque cleared</span>
            <input type="checkbox" id="rentChq4Cleared" aria-label="Mark cheque cleared">
            <span class="cheque-cleared-icon" aria-hidden="true"></span>
          </label>
          <input type="date" id="rentChq4ClearDate" class="small cheque-clear-date" aria-label="Clear date">
        </div></div><div class="chq outstanding" id="rentChq5Item" style="display: none;">
        <div class="label">Chq 5</div>
        <input type="date" id="rentChq5Date" class="small">
        <input type="number" id="rentChq5" step="0.01" placeholder="Amount">
        <div class="cheque-info-row">
          <input type="text" id="rentChq5Bank" class="small cheque-bank" placeholder="Bank name" list="bankHistoryList" autocomplete="off">
          <input type="text" id="rentChq5Number" class="small cheque-number" placeholder="Cheque #">
        </div>
        <div class="cheque-meta">
          <label class="cheque-cleared-label">
            <span class="sr-only">Mark cheque cleared</span>
            <input type="checkbox" id="rentChq5Cleared" aria-label="Mark cheque cleared">
            <span class="cheque-cleared-icon" aria-hidden="true"></span>
          </label>
          <input type="date" id="rentChq5ClearDate" class="small cheque-clear-date" aria-label="Clear date">
        </div></div><div class="chq outstanding" id="rentChq6Item" style="display: none;">
        <div class="label">Chq 6</div>
        <input type="date" id="rentChq6Date" class="small">
        <input type="number" id="rentChq6" step="0.01" placeholder="Amount">
        <div class="cheque-info-row">
          <input type="text" id="rentChq6Bank" class="small cheque-bank" placeholder="Bank name" list="bankHistoryList" autocomplete="off">
          <input type="text" id="rentChq6Number" class="small cheque-number" placeholder="Cheque #">
        </div>
        <div class="cheque-meta">
          <label class="cheque-cleared-label">
            <span class="sr-only">Mark cheque cleared</span>
            <input type="checkbox" id="rentChq6Cleared" aria-label="Mark cheque cleared">
            <span class="cheque-cleared-icon" aria-hidden="true"></span>
          </label>
          <input type="date" id="rentChq6ClearDate" class="small cheque-clear-date" aria-label="Clear date">
        </div></div></div>
        <div class="totals">
          <div class="total-box">Total: <span id="rentalTotalDisplay" class="total-amount">AED 0.00</span></div>
          <div class="total-box">Cleared: <span id="rentalClearedDisplay">AED 0.00</span></div>
          <div class="total-box">Outstanding: <span id="rentalOutstandingDisplay">AED 0.00</span></div>
        </div>
      </div>
    </div>

    <div class="card cheques-section pdc-section-elegant" style="border:1px solid #d8e3f4;margin-top:2mm;background:linear-gradient(180deg,#fafbfd 0%,#f5f8fc 100%);box-shadow:0 4px 12px rgba(9,30,63,0.08);">
        <div class="collapsible-head">
            <div class="pdc-title-wrapper">
                <div class="section-title" style="font-size:1.1rem;color:#1e3a5f;font-weight:700;letter-spacing:0.3px;margin-bottom:6px;">Cheques to Hand Over to Buyer <span class="field-emoji" title="To hand over">📤</span></div>
                <div class="muted" id="pdcSectionHint" style="font-size:0.88rem;color:#5a6c7d;font-style:italic;">All uncleared cheques (post-dated or past-dated) automatically transferred to buyer</div>
            </div>
            <div class="section-indicators indicator-stack">
                <div class="indicator-card count">
                  <span class="indicator-icon">🧾</span>
                  <span class="indicator-text">
                    <span class="indicator-label">Cheques Count</span>
                    <span class="indicator-value" id="pdcChipCount">No Cheques</span>
                  </span>
                </div>
                <div class="indicator-card total">
                  <span class="indicator-icon">💰</span>
                  <span class="indicator-text">
                    <span class="indicator-label">Total Value</span>
                    <span class="indicator-value" id="pdcChipTotal">AED 0.00</span>
                  </span>
                </div>
                <button class="collapse-btn is-collapsed" type="button" onclick="toggleCollapse(&#39;pdcChequesBody&#39;, this)" aria-controls="pdcChequesBody" aria-expanded="false">
                  Details
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 9l7 7 7-7"></path></svg>
                </button>
            </div>
        </div>
        <div class="collapsible-body collapsed" id="pdcChequesBody" aria-hidden="true">
            <div class="pdc-cheques-area" style="margin-top:20px;">
                <div id="pdcChequesRow"><div class="muted pdc-empty">No uncleared cheques to hand over. Mark cheques as cleared to remove them from this list.</div></div>
              <div class="mt-12" style="padding-top:16px;border-top:2px solid #e1e8f0;">
                <div class="total-box total-inline" style="background:#fff;padding:14px 20px;border-radius:10px;border:1px solid #d5dfe9;box-shadow:0 2px 6px rgba(9,30,63,0.06);font-size:1rem;font-weight:700;color:#1e3a5f;">Total Cheques to Hand Over: <span id="pdcTotalDisplay" class="total-amount" style="color:#0369a1;font-size:1.15rem;">AED 0.00</span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Centered Status Pill -->
    <div class="status-pill-center">
      <span class="health-trigger-pill has-issues" id="healthStatusPill">4 checks</span>
    </div>

    <!-- Fixed Right Vertical Sidebar -->
    <div class="right-vertical-sidebar" id="rightVerticalSidebar">
      <button class="sidebar-btn refresh-sidebar-btn" id="refreshPageBtn" type="button" title="Refresh Page">
        <span class="btn-icon" aria-hidden="true">⟳</span>
        <span class="btn-label">Refresh</span>
      </button>
      <button class="sidebar-btn reset-sidebar-btn" id="floatingResetBtn" type="button" title="Reset Form">
        <span class="btn-icon" aria-hidden="true">🔄</span>
        <span class="btn-label">Reset</span>
      </button>
      <button class="sidebar-btn theme-sidebar-btn" id="darkModeToggle" type="button" title="Toggle Dark Mode">
        <span class="btn-icon" id="darkModeIcon" aria-hidden="true">🌙</span>
        <span class="btn-label">Theme</span>
      </button>
      <button class="sidebar-btn health-sidebar-btn" id="healthPanelBtn" type="button" aria-haspopup="dialog">
        <span class="btn-icon" aria-hidden="true">🩺</span>
        <span class="btn-label">Health</span>
      </button>
      <button class="sidebar-btn calc-sidebar-btn" id="calcBtn" type="button" aria-expanded="false">
        <span class="btn-icon" aria-hidden="true">🧮</span>
        <span class="btn-label">Calculate</span>
      </button>
      <button class="sidebar-btn comm-sidebar-btn" id="openCommModalSidebar" type="button" title="Communication Messages">
        <span class="btn-icon" aria-hidden="true">💬</span>
        <span class="btn-label">Messages</span>
      </button>
      <button class="sidebar-btn verify-sidebar-btn" id="verifyAiBtn" type="button" title="Copy data for AI verification">
        <span class="btn-icon" aria-hidden="true">🤖</span>
        <span class="btn-label">Verify</span>
      </button>
    </div>

    <hr class="section-divider tight">

    <!-- Stale Data Warning - shows when inputs changed after calculation -->
    <div class="stale-data-warning" id="staleDataWarning" role="alert">
      <div><span class="warning-icon">⚠️</span><span>DATA MODIFIED!</span></div>
      <div class="new-result">New settlement will be:<span class="new-result-value" id="newResultPreview">—</span></div>
      <button class="recalc-btn" onclick="document.getElementById('calcBtn').click()">🔄 RECALCULATE NOW</button>
    </div>

    <div class="card card-scroll is-hidden" id="resultsCard">
      <table id="resultsTable">
        <thead>
          <tr><th colspan="13" id="tableUnitHeader" class="table-title"></th></tr>
          <tr>
            <th>Start</th><th>End</th><th>Rent</th><th>Total Days</th>
            <th>Seller Days</th><th>Seller Rent</th><th>Buyer Days</th><th>Buyer Rent</th>
            <th>Mgt. SC</th><th>PDC</th><th>Rent Adj.</th><th>S. Deposit</th><th>NET</th>
          </tr>
        </thead>
        <tbody id="resultsBody">
          <tr><td colspan="13" class="center muted table-placeholder">Click Calculate to see results</td></tr>
        </tbody>
      </table>

      <div id="summarySection" class="summary">
        <div class="settlement-health" id="settlementHealthRibbon" aria-live="polite">
          <div class="health-badge idle" id="healthBadge-calc">
            <div class="badge-icon" aria-hidden="true">🧮</div>
            <div>
              <div class="badge-label">Calculations</div>
              <div class="badge-status">Fill lease dates &amp; rent first</div>
            </div>
          </div>
          <div class="health-badge idle" id="healthBadge-cheques">
            <div class="badge-icon" aria-hidden="true">💼</div>
            <div>
              <div class="badge-label">Cheques</div>
              <div class="badge-status">Import cheques after rent is set</div>
            </div>
          </div>
          <div class="health-badge idle" id="healthBadge-docs">
            <div class="badge-icon" aria-hidden="true">📄</div>
            <div>
              <div class="badge-label">Docs &amp; Messages</div>
              <div class="badge-status">Locked until results ready</div>
            </div>
          </div>
          <div class="health-badge idle" id="healthBadge-sc" style="display:none;">
            <div class="badge-icon" aria-hidden="true">🏢</div>
            <div>
              <div class="badge-label">Est. Seller SC</div>
              <div class="badge-status">—</div>
            </div>
          </div>
        </div>
        <!-- Gap clarifier moved to modal -->
        <div class="summary-hero">
          <button id="whatsappShareBtn" class="share-btn" title="Share via WhatsApp">
            <svg width="16" height="16" fill="white" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"></path></svg>
            Share
          </button>
          <div class="muted summary-label">Final Settlement Amount</div>
          <div id="summaryTotal" class="net summary-amount">AED 0.00</div>
          <div id="directionText" class="direction summary-direction"></div>
          <div id="newOwnerInfo" class="new-owner-info"></div>
        </div>

        <div class="summary-notes">
          <div id="notes" class="inline-card-note"></div>
        </div>
      </div>

      <div id="commSectionWrapper">
        <button type="button" class="btn gray comm-open-btn" id="openCommModal">
          <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>
          Communication Messages
        </button>
      </div>
    </div>
    
    <!-- Communication Modal -->
    <div id="commModal" class="modal-backdrop" aria-hidden="true">
      <div class="modal comm-modal" role="dialog" aria-modal="true">
        <div class="modal-head">
          <h3 class="modal-title">Settlement Communication Messages</h3>
          <button type="button" class="modal-close" id="commModalClose" aria-label="Close">×</button>
        </div>
        
        <div class="names-grid">
          <div><label>Buyer Name</label><input type="text" id="commBuyerName" placeholder="e.g. John Doe"></div>
          <div><label>PDC Colleague Name</label><input type="text" id="commPdcName" placeholder="e.g. Sarah"></div>
          <div><label>Accountant Name</label><input type="text" id="commAccName" placeholder="e.g. Finance Team"></div>
        </div>
        <div class="sender-row">
          <label>Your Name (Signature):</label>
          <input type="text" id="commSenderName" placeholder="Your name for email signature">
          <span class="sender-hint">This stays the same across all cases</span>
        </div>

        <div class="comm-grid">
          <div class="comm-card">
            <div class="comm-head">
              <span>Email to Buyer</span>
              <button class="btn gray comm-edit-btn" id="btnEditBuyer" title="Edit message">Edit</button>
            </div>
            <textarea class="comm-body is-hidden" id="msgBuyer"></textarea>
            <div class="comm-body-display" id="msgBuyerDisplay"></div>
            <div class="comm-actions">
              <button class="btn gray comm-btn comm-action-flex" id="btnCopyBuyer">Copy</button>
              <button class="btn whatsapp comm-btn comm-action-flex" id="btnWhatsappBuyer">WhatsApp</button>
              <button class="btn primary comm-btn comm-action-flex" id="btnEmailBuyer">Email</button>
            </div>
          </div>
          <div class="comm-card">
            <div class="comm-head">
              <span>Message for PDC</span>
              <button class="btn gray comm-edit-btn" id="btnEditPDC" title="Edit message">Edit</button>
            </div>
            <textarea class="comm-body is-hidden" id="msgPDC"></textarea>
            <div class="comm-body-display" id="msgPDCDisplay"></div>
            <div class="comm-actions">
              <button class="btn gray comm-btn comm-action-flex" id="btnCopyPDC">Copy</button>
              <button class="btn whatsapp comm-btn comm-action-flex" id="btnWhatsappPDC">WhatsApp</button>
              <button class="btn primary comm-btn comm-action-flex" id="btnEmailPDC">Email</button>
            </div>
          </div>
          <div class="comm-card">
            <div class="comm-head">
              <span>Message for Accounting</span>
              <button class="btn gray comm-edit-btn" id="btnEditAcc" title="Edit message">Edit</button>
            </div>
            <textarea class="comm-body is-hidden" id="msgAcc"></textarea>
            <div class="comm-body-display" id="msgAccDisplay"></div>
            <div class="comm-actions">
              <button class="btn gray comm-btn comm-action-flex" id="btnCopyAcc">Copy</button>
              <button class="btn whatsapp comm-btn comm-action-flex" id="btnWhatsappAcc">WhatsApp</button>
              <button class="btn primary comm-btn comm-action-flex" id="btnEmailAcc">Email</button>
            </div>
          </div>
          <div class="comm-card">
            <div class="comm-head">
              <span>Reconciliation</span>
              <button class="btn gray comm-edit-btn" id="btnEditRecon" title="Edit message">Edit</button>
            </div>
            <textarea class="comm-body is-hidden" id="copyReconciliation"></textarea>
            <div class="comm-body-display" id="copyReconciliationDisplay"></div>
            <div class="comm-actions">
              <button class="btn gray comm-btn comm-action-flex" id="btnCopyReconciliation">Copy</button>
              <button class="btn whatsapp comm-btn comm-action-flex" id="btnWhatsappRecon">WhatsApp</button>
              <button class="btn primary comm-btn comm-action-flex" id="btnEmailRecon">Email</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <footer class="footer">
      <div class="footer-note">Crafted with precision &amp; care</div>
      <div class="footer-brand">
        Created by Fuad Al-Taher
      </div>
      <div class="footer-legal">Rental Settlement Calculator © 2025</div>
    </footer>
  </div>
  <div class="toast" id="toast">Previous data restored</div>

  <div id="healthModal" class="health-modal-backdrop" aria-hidden="true">
    <div class="health-modal" role="dialog" aria-modal="true" aria-labelledby="healthModalTitle">
      <div class="health-modal-head">
        <h3 class="health-modal-title" id="healthModalTitle">Section Health</h3>
        <button type="button" class="health-modal-close" id="healthModalClose" aria-label="Close Section Health">×</button>
      </div>
      <div class="health-modal-intro">Quick snapshot of lease, cheques, service charge, and deposit readiness.</div>
      <div class="health-modal-body" id="healthModalBody">
        <div class="health-card critical " data-id="pdc">
          <div class="health-text">
            <div class="health-title">Cheques Handover</div>
            <div class="health-detail">Buyer has ~6 month span but no uncleared cheques are ready.</div>
          </div>
          <div class="health-actions">
            <span class="health-chip">Action</span>
            <button class="health-dismiss-btn " onclick="toggleHealthDismiss(&#39;pdc&#39;)" title="Acknowledge">✓</button>
          </div>
        </div>
        <div class="health-card warn " data-id="lease">
          <div class="health-text">
            <div class="health-title">Lease Dates</div>
            <div class="health-detail">273 day contract • unusual duration</div>
          </div>
          <div class="health-actions">
            <span class="health-chip">Check</span>
            <button class="health-dismiss-btn " onclick="toggleHealthDismiss(&#39;lease&#39;)" title="Acknowledge">✓</button>
          </div>
        </div>
        <div class="health-card warn " data-id="service">
          <div class="health-text">
            <div class="health-title">Service Charge</div>
            <div class="health-detail">0.4% of rent — verify (typical 5-8%).</div>
          </div>
          <div class="health-actions">
            <span class="health-chip">Check</span>
            <button class="health-dismiss-btn " onclick="toggleHealthDismiss(&#39;service&#39;)" title="Acknowledge">✓</button>
          </div>
        </div>
        <div class="health-card todo " data-id="cheques">
          <div class="health-text">
            <div class="health-title">Rental Cheques</div>
            <div class="health-detail">Add cheque dates and amounts received by the seller.</div>
          </div>
          <div class="health-actions">
            <span class="health-chip">To-Do</span>
            <button class="health-dismiss-btn " onclick="toggleHealthDismiss(&#39;cheques&#39;)" title="Acknowledge">✓</button>
          </div>
        </div>
        <div class="health-card ok " data-id="handover">
          <div class="health-text">
            <div class="health-title">Handover Date</div>
            <div class="health-detail">13 Dec 2025 • Buyer 167d</div>
          </div>
          <div class="health-actions">
            <span class="health-chip">Clear</span>
            
          </div>
        </div>
        <div class="health-card ok " data-id="deposit">
          <div class="health-text">
            <div class="health-title">Security Deposit</div>
            <div class="health-detail">6.3% of rent (AED 2,100.00)</div>
          </div>
          <div class="health-actions">
            <span class="health-chip">Clear</span>
            
          </div>
        </div>
        <div class="health-card ok " data-id="scArea">
          <div class="health-text">
            <div class="health-title">Unit Area (sq.ft)</div>
            <div class="health-detail">829.36 sq.ft</div>
          </div>
          <div class="health-actions">
            <span class="health-chip">Clear</span>
            
          </div>
        </div>
        <div class="health-card ok " data-id="scRate">
          <div class="health-text">
            <div class="health-title">$/sq.ft</div>
            <div class="health-detail">AED 8.00/sq.ft • Total: AED 6,634.88</div>
          </div>
          <div class="health-actions">
            <span class="health-chip">Clear</span>
            
          </div>
        </div></div>
    </div>
  </div>

  <!-- Case Notes Modal -->
  <div id="notesModal" class="notes-modal-backdrop" aria-hidden="true">
    <div class="notes-modal" role="dialog" aria-modal="true" aria-labelledby="notesModalTitle">
      <div class="notes-modal-head">
        <h3 class="notes-modal-title" id="notesModalTitle">📝 Case Notes</h3>
        <button type="button" class="notes-modal-close" id="notesModalClose" aria-label="Close Notes">×</button>
      </div>
      <div class="notes-modal-intro">
        Add notes about this case. By default, notes are confidential and not exported.
      </div>
      <textarea class="notes-modal-textarea" id="caseNotesTextarea" placeholder="Add notes about this case...

Examples:
• Cheque #12345 bounced - marked as cleared internally
• Tenant disputed amount, resolved on 15/03/2025
• Special agreement with buyer regarding SC"></textarea>
      <div class="notes-pdf-option">
        <label class="notes-pdf-toggle">
          <input type="checkbox" id="includeNotesInPdf">
          <span>Include notes in PDF export</span>
        </label>
        <span class="notes-pdf-hint">When checked, notes will appear in exported PDF documents</span>
      </div>
      <div class="notes-modal-footer">
        <button type="button" class="btn gray" id="notesClearBtn">Clear Notes</button>
        <button type="button" class="btn primary" id="notesSaveBtn">Save &amp; Close</button>
      </div>
    </div>
  </div>

  <!-- Cheque Gap Clarifier Modal -->
  <div id="chequeGapModal" class="gap-modal-backdrop" aria-hidden="true">
    <div class="gap-modal" role="dialog" aria-modal="true">
      <div class="gap-modal-head">
        <h3 class="gap-modal-title">Cheque vs Contract Rent — Discrepancy</h3>
        <button type="button" class="gap-modal-close" id="gapModalClose" aria-label="Close">×</button>
      </div>
      <div id="chequeGapCard">
        <div class="gap-clarifier-head">
          <div>
            <div class="gap-clarifier-kicker">Discrepancy Detected</div>
            <div class="gap-clarifier-amount-wrap">
              <div class="gap-clarifier-amount" id="chequeGapAmount">AED 33,075.00</div>
              <div class="gap-percent-badge" id="chequeGapPercent">100.00%</div>
            </div>
          </div>
          <div class="gap-clarifier-direction" id="chequeGapDirection">Cheques short vs rent</div>
        </div>
        <div class="gap-clarifier-hint" id="chequeGapHint">Gap is 100.00% of total contract rent. Seller collected less than the contract rent — explain the shortage.</div>
        <div class="gap-clarifier-actions">
          <button type="button" class="gap-chip" data-gap-reason="mgmtFee" aria-pressed="false">Management fee</button>
          <button type="button" class="gap-chip" data-gap-reason="cash" aria-pressed="false">Cash payment</button>
          <button type="button" class="gap-chip" data-gap-reason="deposit" aria-pressed="false">Deposit used</button>
          <button type="button" class="gap-chip" data-gap-reason="refund" aria-pressed="false">Refund issued</button>
          <button type="button" class="gap-chip" data-gap-reason="shortTerm" aria-pressed="false">Partial lease</button>
          <button type="button" class="gap-chip" data-gap-reason="typo" aria-pressed="false">Data error</button>
          <button type="button" class="gap-chip" data-gap-reason="other" aria-pressed="false">Other</button>
        </div>
        <label class="gap-note-label">Clarification Note (appears in PDF)</label>
        <textarea class="gap-note" id="gapReasonNote" placeholder="Provide details. This note will be included in exported PDFs."></textarea>
        <div class="gap-modal-footer">
          <button type="button" class="btn gray" id="gapModalCancel">Cancel</button>
          <button type="button" class="btn primary" id="gapModalSaveBtn">Save &amp; Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Docs & Export Popup -->
  <div id="docsPopup" class="docs-popup-backdrop" aria-hidden="true">
    <div class="docs-popup" role="dialog" aria-modal="true">
      <div class="docs-popup-head">
        <h3 class="docs-popup-title">📄 Export &amp; Share</h3>
        <button type="button" class="docs-popup-close" id="docsPopupClose" aria-label="Close">×</button>
      </div>
      <div class="docs-action-grid">
        <button type="button" class="docs-action-btn" id="docsActionPdf">
          <span class="action-icon">📑</span>
          <div class="action-text">
            <div class="action-title">Full PDF Report</div>
            <div class="action-hint">Complete settlement with all cheques</div>
          </div>
          <span class="action-check" style="display:none;">✓</span>
        </button>
        <button type="button" class="docs-action-btn" id="docsActionBuyerPdf">
          <span class="action-icon">🏠</span>
          <div class="action-text">
            <div class="action-title">Buyer PDF</div>
            <div class="action-hint">Clean version without rental cheques</div>
          </div>
          <span class="action-check" style="display:none;">✓</span>
        </button>
        <button type="button" class="docs-action-btn" id="docsActionPng">
          <span class="action-icon">🖼️</span>
          <div class="action-text">
            <div class="action-title">PNG Screenshot</div>
            <div class="action-hint">Quick image for WhatsApp/Email</div>
          </div>
          <span class="action-check" style="display:none;">✓</span>
        </button>
        <button type="button" class="docs-action-btn" id="docsActionMessages">
          <span class="action-icon">💬</span>
          <div class="action-text">
            <div class="action-title">Communication Messages</div>
            <div class="action-hint">Email templates for Buyer, PDC, Accountant</div>
          </div>
          <span class="action-check" style="display:none;">✓</span>
        </button>
        <button type="button" class="docs-action-btn" id="docsActionWhatsapp">
          <span class="action-icon">📲</span>
          <div class="action-text">
            <div class="action-title">Share via WhatsApp</div>
            <div class="action-hint">Send summary directly</div>
          </div>
          <span class="action-check" style="display:none;">✓</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Calculations Breakdown Popup -->
  <div id="calcPopup" class="calc-popup-backdrop" aria-hidden="true">
    <div class="calc-popup" role="dialog" aria-modal="true">
      <div class="calc-popup-head">
        <h3 class="calc-popup-title">Settlement Breakdown</h3>
        <button type="button" class="calc-popup-close" id="calcPopupClose" aria-label="Close">×</button>
      </div>
      <div class="calc-popup-net" id="calcPopupNet">
        <div class="calc-popup-net-amount" id="calcPopupNetAmount">AED 0.00</div>
        <div class="calc-popup-net-dir" id="calcPopupNetDir">Seller → Buyer</div>
      </div>
      <div class="calc-breakdown" id="calcBreakdownBody">
        <!-- Populated dynamically -->
      </div>
      <button type="button" class="calc-copy-btn" id="calcCopyBtn">Copy Breakdown</button>
    </div>
  </div>

  <!-- Save/Load Modal -->
  <div id="caseModal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-head">
        <h2 id="modalTitle" class="modal-title">Save/Load Cases</h2>
        <button id="closeModal" class="modal-close">×</button>
      </div>
      
      <div id="saveSection" class="modal-save">
        <label class="modal-label block-label">Save Current Case As:</label>
        <div class="modal-actions">
          <input type="text" id="caseNameInput" class="case-input" placeholder="e.g., Unit 512 - Alkesh Chamnani">
          <button id="saveNewCase" class="btn positive case-btn">Save</button>
        </div>
      </div>
      
      <div id="loadSection">
        <div class="dashboard-stats" id="dashboardStats">
          <div class="stat-card">
            <span class="stat-value" id="statTotalCases">0</span>
            <span class="stat-label">Total Cases</span>
          </div>
          <div class="stat-card">
            <span class="stat-value" id="statTotalValue">0</span>
            <span class="stat-label">Total Rent Value</span>
          </div>
          <div class="stat-card">
            <span class="stat-value" id="statAvgSettlement">0</span>
            <span class="stat-label">Avg Settlement</span>
          </div>
        </div>
        <div class="modal-row">
          <label class="modal-label mb-0">Saved Cases (<span id="caseCount">0</span>)<span id="resultCount" class="result-count"></span>:</label>
          <input type="text" id="searchCases" class="modal-search" placeholder="Search...">
        </div>
        <div class="view-toggle">
          <button class="view-btn active" id="viewList" title="List View">📝 List</button>
          <button class="view-btn" id="viewMonthly" title="Monthly View">📅 Monthly</button>
        </div>
        <div class="modal-filters">
          <select id="buildingFilter" class="filter-select" aria-label="Filter by building">
            <option value="">All buildings</option>
          </select>
          <select id="sortCases" class="filter-select" aria-label="Sort saved cases">
            <option value="newest">Newest first</option>
            <option value="oldest">Oldest first</option>
            <option value="name">Case name A → Z</option>
            <option value="building">Building A → Z</option>
          </select>
        </div>
        <details class="advanced-filters-toggle">
          <summary class="advanced-filters-summary">⚡ Advanced Filters</summary>
          <div class="advanced-filters-content">
            <div class="filter-row">
              <label class="filter-label">Rent Range (AED):</label>
              <div class="range-inputs">
                <input type="number" id="rentMin" class="filter-input-small" placeholder="Min" min="0">
                <span class="range-separator">→</span>
                <input type="number" id="rentMax" class="filter-input-small" placeholder="Max" min="0">
              </div>
            </div>
            <div class="filter-row">
              <label class="filter-label">Date Range:</label>
              <div class="range-inputs">
                <input type="date" id="dateFrom" class="filter-input-small">
                <span class="range-separator">→</span>
                <input type="date" id="dateTo" class="filter-input-small">
              </div>
            </div>
            <div class="filter-row">
              <label class="filter-label">Tenant Name:</label>
              <input type="text" id="tenantFilter" class="filter-input" placeholder="Filter by tenant...">
            </div>
            <button class="btn gray filter-clear-btn" id="clearAdvancedFilters">Clear All Filters</button>
          </div>
        </details>
        <!-- Selection Mode Toggle -->
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <label class="archive-toggle"><input type="checkbox" id="showArchivedToggle"> Show Archived<span class="archive-badge" id="archivedCount">0</span></label>
          <button class="select-mode-btn" id="selectModeBtn" title="Select multiple cases to generate aggregate statement">☑️ Select Mode</button>
        </div>
        <!-- Selection Bar (shown when in select mode) -->
        <div class="selection-mode-bar" id="selectionModeBar">
          <span class="selection-count"><span id="selectedCount">0</span> case(s) selected</span>
          <div class="selection-actions">
            <button class="btn" id="selectAllBtn">Select All</button>
            <button class="btn" id="deselectAllBtn">Deselect All</button>
            <button class="btn generate" id="generateStatementBtn" disabled>📊 Generate Statement</button>
          </div>
        </div>
        <div id="casesList" class="cases-list">
          <div class="cases-empty">
            <strong>No saved cases yet</strong>
            <span>Save your current scenario to start a library.</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Aggregate Statement Modal -->
  <div id="aggregateModal" class="aggregate-modal-backdrop" style="display:none">
    <div class="aggregate-modal" style="max-width:1100px">
      <div class="aggregate-header">
        <div class="aggregate-title">📊 Aggregate Settlement Statement</div>
        <button class="aggregate-close" id="closeAggregateModal">×</button>
      </div>
      <div class="aggregate-body">
        <div class="aggregate-summary" id="aggregateSummary"></div>
        <div class="aggregate-table-wrap">
          <table class="aggregate-table">
            <thead>
              <tr>
                <th>Tower</th>
                <th>Unit</th>
                <th>New Owner</th>
                <th>Buyer Rent<br><small>(Pro-rata)</small></th>
                <th>Less: PDC<br><small>Handed Over</small></th>
                <th>Add: Deposit<br><small>Security</small></th>
                <th>Less: SC<br><small>Service Charge</small></th>
                <th>Net Settlement</th>
              </tr>
            </thead>
            <tbody id="aggregateTableBody"></tbody>
            <tfoot id="aggregateTableFoot"></tfoot>
          </table>
        </div>
      </div>
      <div class="aggregate-footer">
        <button class="btn gray" id="closeAggregateBtn">✕ Close</button>
        <button class="btn primary" id="copyAggregateBtn">📋 Copy to Clipboard</button>
        <button class="btn print" id="printAggregateBtn">🖨️ Print</button>
        <button class="btn positive" id="exportAggregatePdfBtn">📄 Export PDF</button>
      </div>
    </div>
  </div>

  <script>
  (function(){
    'use strict';
    const qs = sel => document.querySelector(sel);
    const qsa = sel => Array.from(document.querySelectorAll(sel));
    
    // Debounce utility - must be defined early
    function debounce(fn, wait){
      let t;
      const debounced = function(...args){ clearTimeout(t); t = setTimeout(()=> fn.apply(this, args), wait); };
      debounced.cancel = function(){ clearTimeout(t); };
      return debounced;
    }
    
    // Flag to prevent autosave during initialization
    let isInitializing = true;
    
    // Flag to track if user manually modified SC Paid Period End
    let scPaidEndManuallySet = false;
    
    // Flag to protect SC Rate from saved case being overwritten by building rate auto-fill
    let scRateFromSavedCase = false;
    
    // Formatting Helpers
    const fmtDate = (d) => {
      if(!d) return '';
      const dt = new Date(d);
      if(isNaN(dt)) return d;
      return dt.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'});
    };
    const fmtDateForTable = fmtDate; // Alias for compatibility
    const money = (v) => 'AED ' + Number(v||0).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
    
    // Currency formatting - adds commas as you type
    function formatCurrencyInput(input) {
      input.addEventListener('focus', function() {
        // On focus, show raw number for editing
        const raw = this.value.replace(/,/g, '');
        this.value = raw;
        this.select();
      });
      input.addEventListener('blur', function() {
        // On blur, format with commas
        const raw = parseFloat(this.value.replace(/,/g, '')) || 0;
        if (raw > 0) {
          this.value = raw.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }
      });
      input.addEventListener('input', function() {
        // Store cursor position
        const pos = this.selectionStart;
        const oldLen = this.value.length;
        // Remove non-numeric except decimal
        let val = this.value.replace(/[^\d.]/g, '');
        // Ensure only one decimal point
        const parts = val.split('.');
        if (parts.length > 2) val = parts[0] + '.' + parts.slice(1).join('');
        this.value = val;
        // Adjust cursor
        const newLen = this.value.length;
        this.setSelectionRange(pos - (oldLen - newLen), pos - (oldLen - newLen));
      });
    }

    function setCurrencyValue(input, value) {
      if(!input) return;
      const raw = value ?? '';
      if(raw === '' || (typeof raw === 'string' && raw.trim() === '')) {
        input.value = '';
        return;
      }
      const normalized = typeof raw === 'number'
        ? raw
        : Number(String(raw).replace(/,/g, '').replace(/[^\d.-]/g, '')) || 0;
      input.value = normalized.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }
    
    const toggleFieldHint = (fieldId, visible) => {
      const hint = fieldHints[fieldId];
      if(!hint) return;
      hint.classList.toggle('show', Boolean(visible));
    };
    
    // Cheque date validation - warn if outside lease period
    function validateChequeDate(dateInput, cardElement) {
      if (!dateInput || !dateInput.value) {
        cardElement.classList.remove('date-warning');
        cardElement.title = '';
        return;
      }
      
      const ls = leaseStart?.value;
      const le = leaseEnd?.value;
      if (!ls || !le) {
        cardElement.classList.remove('date-warning');
        cardElement.title = '';
        return;
      }
      
      const chequeDate = new Date(dateInput.value);
      const startDate = new Date(ls);
      const endDate = new Date(le);
      
      // Allow 30 days grace before start and after end
      const graceStart = new Date(startDate);
      graceStart.setDate(graceStart.getDate() - 30);
      const graceEnd = new Date(endDate);
      graceEnd.setDate(graceEnd.getDate() + 30);
      
      if (chequeDate < graceStart || chequeDate > graceEnd) {
        cardElement.classList.add('date-warning');
        const dateStr = dateInput.value;
        if (chequeDate < graceStart) {
          cardElement.title = `⚠️ Cheque date (${fmtDate(dateStr)}) is before lease period`;
        } else {
          cardElement.title = `⚠️ Cheque date (${fmtDate(dateStr)}) is after lease period`;
        }
      } else {
        cardElement.classList.remove('date-warning');
        cardElement.title = '';
      }
    }
    
    // Validate all cheque dates
    function validateAllChequeDates() {
      for (let i = 1; i <= MAX_CHEQUES; i++) {
        const dateInput = qs(`#rentChq${i}Date`);
        const card = qs(`#rentChq${i}Item`);
        if (dateInput && card) {
          validateChequeDate(dateInput, card);
        }
      }
      detectChequeGaps();
      validatePdcDates(); // Also check PDC dates
    }
    
    // Validate PDC dates - warn if dates are in the past or before handover
    function validatePdcDates() {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const handoverVal = handoverDate?.value;
      const handoverDateObj = handoverVal ? new Date(handoverVal) : null;
      
      qsa('#pdcChequesRow .chq').forEach(card => {
        const dateInput = card.querySelector('input[type="date"]');
        if (!dateInput || !dateInput.value) {
          card.classList.remove('pdc-date-warning', 'pdc-date-past');
          card.title = '';
          return;
        }
        
        const chequeDate = new Date(dateInput.value);
        chequeDate.setHours(0, 0, 0, 0);
        
        // Check if cheque date is in the past (already due)
        if (chequeDate < today) {
          card.classList.add('pdc-date-warning', 'pdc-date-past');
          card.title = `⚠️ Past-dated: This cheque date (${fmtDate(dateInput.value)}) has already passed and needs to be deposited soon`;
        } 
        // Check if cheque date is before handover (seller should have deposited)
        else if (handoverDateObj && chequeDate < handoverDateObj) {
          card.classList.add('pdc-date-warning');
          card.classList.remove('pdc-date-past');
          card.title = `⚠️ This cheque date (${fmtDate(dateInput.value)}) is before handover date - verify it wasn't already deposited by seller`;
        } else {
          card.classList.remove('pdc-date-warning', 'pdc-date-past');
          card.title = '';
        }
      });
    }
    
    // Duplicate cheque number detection
    function checkDuplicateCheques() {
      const chequeNumbers = [];
      const count = clamp(Number(qs('#rentalCount')?.value || 0), 0, 6);
      
      // Collect all cheque numbers with their card references
      for (let i = 1; i <= count; i++) {
        const numInput = qs(`#rentChq${i}Number`);
        const card = qs(`#rentChq${i}Item`);
        if (numInput && card) {
          const num = numInput.value.trim().toUpperCase();
          if (num) {
            chequeNumbers.push({ num, index: i, input: numInput, card });
          }
          // Clear previous duplicate warning
          card.classList.remove('duplicate-warning');
          numInput.classList.remove('duplicate-input');
          numInput.title = '';
        }
      }
      
      // Find duplicates
      const seen = {};
      const duplicates = [];
      chequeNumbers.forEach(item => {
        if (seen[item.num]) {
          duplicates.push(item);
          if (!duplicates.includes(seen[item.num])) {
            duplicates.push(seen[item.num]);
          }
        } else {
          seen[item.num] = item;
        }
      });
      
      // Mark duplicates
      duplicates.forEach(item => {
        item.card.classList.add('duplicate-warning');
        item.input.classList.add('duplicate-input');
        item.input.title = `⚠️ Duplicate cheque number: ${item.num}`;
      });
      
      return duplicates.length > 0;
    }
    
    // Cheque gap detection - check for gaps in cheque date coverage
    function detectChequeGaps() {
      const leaseStartVal = leaseStart.value;
      const leaseEndVal = leaseEnd.value;
      if (!leaseStartVal || !leaseEndVal) return [];
      
      const leaseStartDate = new Date(leaseStartVal);
      const leaseEndDate = new Date(leaseEndVal);
      const rentalCount = clamp(Number(rentalCountSel.value || 0), 0, MAX_CHEQUES);
      
      if (rentalCount < 2) return []; // Need at least 2 cheques to detect gaps
      
      // Collect cheque dates
      const chequeDates = [];
      for (let i = 1; i <= rentalCount; i++) {
        const dateVal = qs(`#rentChq${i}Date`).value;
        if (dateVal) {
          chequeDates.push({ index: i, date: new Date(dateVal) });
        }
      }
      
      if (chequeDates.length < 2) return [];
      
      // Sort by date
      chequeDates.sort((a, b) => a.date - b.date);
      
      // Calculate expected interval (lease duration / number of cheques)
      const leaseDays = daysInclusive(leaseStartVal, leaseEndVal);
      const expectedInterval = leaseDays / rentalCount;
      const toleranceDays = Math.max(15, expectedInterval * 0.3); // 30% tolerance or 15 days min
      
      const gaps = [];
      for (let i = 1; i < chequeDates.length; i++) {
        const prev = chequeDates[i - 1];
        const curr = chequeDates[i];
        const daysBetween = Math.round((curr.date - prev.date) / (1000 * 60 * 60 * 24));
        
        if (daysBetween > expectedInterval + toleranceDays) {
          gaps.push({
            from: prev.date,
            to: curr.date,
            days: daysBetween,
            expected: Math.round(expectedInterval)
          });
        }
      }
      
      // Show/hide gap warning
      let gapWarning = qs('#chequeGapWarning');
      if (!gapWarning) {
        gapWarning = document.createElement('div');
        gapWarning.id = 'chequeGapWarning';
        gapWarning.className = 'amount-mismatch-warning hidden';
        gapWarning.style.background = '#fef2f2';
        gapWarning.style.borderColor = '#fca5a5';
        gapWarning.style.color = '#991b1b';
        gapWarning.innerHTML = '<span class="warn-icon">📅</span><span class="warn-text"></span>';
        // Insert after the rental summary mini section
        const rentalSummaryMini = qs('#rentalSummaryMini');
        if (rentalSummaryMini && rentalSummaryMini.parentNode) {
          rentalSummaryMini.parentNode.insertBefore(gapWarning, rentalSummaryMini.nextSibling);
        }
      }
      
      if (gaps.length > 0) {
        const gapText = gaps.map(g => {
          const fromStr = g.from.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' });
          const toStr = g.to.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' });
          return `${fromStr} → ${toStr} (${g.days} days)`;
        }).join(', ');
        gapWarning.querySelector('.warn-text').textContent = `Gap detected: ${gapText}`;
        gapWarning.classList.remove('hidden');
      } else {
        gapWarning.classList.add('hidden');
      }
      
      return gaps;
    }
    
    // Bank name history management
    const BANK_HISTORY_KEY = 'rs_bank_history';
    const BANK_HISTORY_MAX = 20;
    
    function getBankHistory() {
      try {
        return JSON.parse(localStorage.getItem(BANK_HISTORY_KEY) || '[]');
      } catch(e) { return []; }
    }
    
    function addBankToHistory(bankName) {
      if (!bankName || !bankName.trim()) return;
      const name = bankName.trim().toUpperCase();
      let history = getBankHistory();
      // Remove if exists and add to front
      history = history.filter(b => b.toUpperCase() !== name);
      history.unshift(bankName.trim());
      // Keep only max items
      if (history.length > BANK_HISTORY_MAX) history = history.slice(0, BANK_HISTORY_MAX);
      localStorage.setItem(BANK_HISTORY_KEY, JSON.stringify(history));
      updateBankDatalist();
    }
    
    function updateBankDatalist() {
      let datalist = qs('#bankHistoryList');
      if (!datalist) {
        datalist = document.createElement('datalist');
        datalist.id = 'bankHistoryList';
        document.body.appendChild(datalist);
      }
      const history = getBankHistory();
      // Add common UAE banks
      const commonBanks = ['ENBD', 'ADCB', 'FAB', 'DIB', 'CBD', 'Mashreq', 'RAK Bank', 'ADIB', 'NBF', 'UAB'];
      const allBanks = [...new Set([...history, ...commonBanks])];
      datalist.innerHTML = allBanks.map(b => `<option value="${b}">`).join('');
    }
    
    /* Elements */
    const buildingName = qs('#buildingName'), unitNo = qs('#unitNo'), tenantName = qs('#tenantName');
    const leaseStart = qs('#leaseStart'), leaseEnd = qs('#leaseEnd'), handoverDate = qs('#handoverDate');
    const rentInput = qs('#rent'), serviceCharge = qs('#serviceCharge'), securityDeposit = qs('#securityDeposit');
    const rentalCountSel = qs('#rentalCount'), pdcCountSel = qs('#pdcCount');
    const rentalChequesRow = qs('#rentalChequesRow'), pdcChequesRow = qs('#pdcChequesRow');
    const rentalChequesBody = qs('#rentalChequesBody'), pdcChequesBody = qs('#pdcChequesBody');
    const rentalChipCount = qs('#rentalChipCount'), rentalChipTotal = qs('#rentalChipTotal');
    const pdcChipCount = qs('#pdcChipCount'), pdcChipTotal = qs('#pdcChipTotal');
    const rentalTotalDisplay = qs('#rentalTotalDisplay'), rentalClearedDisplay = qs('#rentalClearedDisplay'), rentalOutstandingDisplay = qs('#rentalOutstandingDisplay');
    const pdcTotalDisplay = qs('#pdcTotalDisplay'), rentalSummaryMini = qs('#rentalSummaryMini');
    const resultsCard = qs('#resultsCard');
    const resultsDivider = qs('#resultsDivider');
    const resultsBody = qs('#resultsBody'), summarySection = qs('#summarySection');
    let settlementHealthRibbon = qs('#settlementHealthRibbon');
    const healthBadges = {
      calc: qs('#healthBadge-calc'),
      cheques: qs('#healthBadge-cheques'),
      docs: qs('#healthBadge-docs'),
      sc: qs('#healthBadge-sc')
    };
    const chequeGapModal = qs('#chequeGapModal');
    const gapModalClose = qs('#gapModalClose');
    const chequeGapCard = qs('#chequeGapCard');
    const docsPopup = qs('#docsPopup');
    const docsPopupClose = qs('#docsPopupClose');
    const calcPopup = qs('#calcPopup');
    const calcPopupClose = qs('#calcPopupClose');
    const chequeGapAmount = qs('#chequeGapAmount');
    const chequeGapDirection = qs('#chequeGapDirection');
    const chequeGapHint = qs('#chequeGapHint');
    const gapReasonNote = qs('#gapReasonNote');
    const gapReasonButtons = qsa('[data-gap-reason]');
    const summaryTotal = qs('#summaryTotal'), directionText = qs('#directionText'), notesEl = qs('#notes');
    const copyReconciliation = qs('#copyReconciliation'), tableUnitHeader = qs('#tableUnitHeader');
    const bulkImport = qs('#bulkImport');
    const staleDataWarning = qs('#staleDataWarning');

    // Track if calculation is stale (inputs changed after last calculation)
    let lastCalculationHash = null;
    let calculationIsFresh = false;
    
    function getInputsHash() {
      // Create a hash of all key input values to detect changes
      const vals = [
        unitNo?.value || '',
        tenantName?.value || '',
        leaseStart?.value || '',
        leaseEnd?.value || '',
        handoverDate?.value || '',
        rentInput?.value || '',
        serviceCharge?.value || '',
        securityDeposit?.value || '',
        qs('#scArea')?.value || '',
        qs('#scRate')?.value || ''
      ];
      // Add PDC cheque values
      qsa('#pdcChequesRow input[type="number"]').forEach(inp => vals.push(inp.value || '0'));
      return vals.join('|');
    }
    
    function markCalculationFresh() {
      lastCalculationHash = getInputsHash();
      calculationIsFresh = true;
      if(staleDataWarning) staleDataWarning.classList.remove('visible');
      document.body.classList.remove('results-stale');
    }
    
    function checkIfDataStale() {
      if(!lastCalculationHash) return; // No calculation done yet
      const currentHash = getInputsHash();
      const isStale = currentHash !== lastCalculationHash;
      
      if(isStale) {
        // Data changed - mark as stale and show new settlement
        document.body.classList.add('results-stale');
        calculationIsFresh = false;
        
        // Calculate preview once
        const preview = getQuickSettlementPreview();
        
        // Update red ribbon preview
        if(staleDataWarning) {
          staleDataWarning.classList.add('visible');
          try {
            const previewSpan = staleDataWarning.querySelector('#newResultPreview');
            if(previewSpan) previewSpan.textContent = preview;
          } catch(err) {
            console.error('Preview error:', err);
          }
        }
        
        // Update yellow flag preview
        const flagPreview = document.getElementById('flagSettlementPreview');
        if(flagPreview) flagPreview.textContent = 'New: ' + preview;
      }
    }
    
    // Quick settlement calculation for preview
    function getQuickSettlementPreview() {
      try {
        // Inline days calculation (since daysInclusive may not be defined yet)
        const calcDays = (s, e) => {
          const sd = new Date(s), ed = new Date(e);
          if(isNaN(sd) || isNaN(ed)) return 0;
          return Math.round((ed - sd) / 86400000) + 1;
        };
        const parseNum = (v) => {
          if(!v) return 0;
          const n = parseFloat(String(v).replace(/,/g, ''));
          return isNaN(n) ? 0 : n;
        };
        
        const tenantVal = (tenantName?.value || '').trim().toLowerCase();
        const isEmptyTenant = tenantVal === 'empty' || tenantVal === 'empty unit';
        const ls = leaseStart?.value, le = leaseEnd?.value, ho = handoverDate?.value;
        const rent = parseNum(rentInput?.value);
        const sc = parseNum(serviceCharge?.value);
        const dep = parseNum(securityDeposit?.value);
        
        const formatAED = (n) => 'AED ' + Math.abs(n).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        
        if(isEmptyTenant || !ls || !le || !ho) {
          const net = dep - sc;
          const dir = net >= 0 ? 'Seller→Buyer' : 'Buyer→Seller';
          return `${dir}: ${formatAED(net)}`;
        }
        
        const totalDays = calcDays(ls, le);
        if(totalDays <= 0) return '—';
        
        const dailyRent = rent / totalDays;
        const sellerDays = calcDays(ls, ho);
        const buyerDays = totalDays - sellerDays;
        const buyerRent = buyerDays * dailyRent;
        
        let pdcTotal = 0;
        document.querySelectorAll('#pdcChequesRow input[type="number"]').forEach(inp => pdcTotal += parseNum(inp.value));
        
        const adj = buyerRent - pdcTotal;
        const net = Number((adj + dep - sc).toFixed(2));
        const dir = net >= 0 ? 'Seller→Buyer' : 'Buyer→Seller';
        return `${dir}: ${formatAED(net)}`;
      } catch(e) {
        console.error('Preview calc error:', e);
        return '—';
      }
    }

    // Trigger ribbon updates when SC toggles, buyer SC, or dates change
    qs('#scFieldsMandatory')?.addEventListener('change', updateHealthRibbon);
    qs('#serviceCharge')?.addEventListener('input', updateHealthRibbon);
    qs('#leaseStart')?.addEventListener('change', updateHealthRibbon);
    qs('#leaseEnd')?.addEventListener('change', updateHealthRibbon);
    qs('#handoverDate')?.addEventListener('change', updateHealthRibbon);
    
    // Track stale data - listen to key inputs for changes
    const staleCheckInputs = [unitNo, tenantName, leaseStart, leaseEnd, handoverDate, rentInput, serviceCharge, securityDeposit, qs('#scArea'), qs('#scRate')];
    staleCheckInputs.forEach(inp => {
      if(inp) {
        inp.addEventListener('input', checkIfDataStale);
        inp.addEventListener('change', checkIfDataStale);
      }
    });
    
    // Also listen to PDC cheques section for changes (using event delegation)
    if(pdcChequesRow) {
      pdcChequesRow.addEventListener('input', checkIfDataStale);
      pdcChequesRow.addEventListener('change', checkIfDataStale);
    }
    
    const pdcSectionHint = qs('#pdcSectionHint'); // New element for feedback
    const autosaveStatus = qs('#autosaveStatus');
    const autosaveLabel = qs('#autosaveLabel');
    const autosaveMeta = qs('#autosaveMeta');
    const buildingFilterSelect = qs('#buildingFilter');
    const sortCasesSelect = qs('#sortCases');
    const searchCasesInput = qs('#searchCases');
    const fieldHints = {
      leaseStart: qs('#hintLeaseStart'),
      leaseEnd: qs('#hintLeaseEnd'),
      rent: qs('#hintRent'),
      handoverDate: qs('#hintHandover')
    };
    
    // Comms Elements
    const msgBuyer = qs('#msgBuyer'), msgPDC = qs('#msgPDC'), msgAcc = qs('#msgAcc');
    const commBuyerName = qs('#commBuyerName'), commPdcName = qs('#commPdcName'), commAccName = qs('#commAccName'), commSenderName = qs('#commSenderName');
    // Visible header Buyer Name input (keeps page visible but out of main Basic Info)
    const buyerNameInput = qs('#buyerName');
    const commSectionWrapper = qs('#commSectionWrapper');
    const healthPanelBtn = qs('#healthPanelBtn');
    const calcBtn = qs('#calcBtn');
    const calcBtnIcon = calcBtn?.querySelector('.health-icon');
    const calcBtnLabel = calcBtn?.querySelector('.health-label');
    const healthStatusPill = qs('#healthStatusPill');
    const healthModal = qs('#healthModal');
    const healthModalBody = qs('#healthModalBody');
    const healthModalClose = qs('#healthModalClose');
    const notesModal = qs('#notesModal');
    const notesModalClose = qs('#notesModalClose');
    const caseNotesBtn = qs('#caseNotesBtn');
    const caseNotesTextarea = qs('#caseNotesTextarea');
    const notesSaveBtn = qs('#notesSaveBtn');
    const notesClearBtn = qs('#notesClearBtn');
    const timelineContainer = qs('#timeline-container');
    const timelineTooltip = qs('#timelineTooltip');
    const timelineSegments = {
      seller: qs('#time-seller'),
      buyer: qs('#time-buyer')
    };
    // SC timeline elements
    const scTimelineContainer = qs('#timeline-sc-container');
    const scTimelineTooltip = qs('#timelineScTooltip');
    const scSegments = {
      buyer: qs('#sc-buyer')
    };
    const scTimelineLabels = {
      start: qs('#sc-tl-start'),
      end: qs('#sc-tl-end')
    };
    const timelineLabels = {
      start: qs('#tl-start'),
      handover: qs('#tl-handover'),
      end: qs('#tl-end')
    };

    // Timeline tooltip functions - defined early so they're available before wireEvents
    function highlightTimelineLabels(mode){
      Object.values(timelineLabels).forEach(label => label?.classList.remove('is-active'));
      if(mode === 'seller'){
        timelineLabels.start?.classList.add('is-active');
        timelineLabels.handover?.classList.add('is-active');
      } else if(mode === 'buyer'){
        timelineLabels.handover?.classList.add('is-active');
        timelineLabels.end?.classList.add('is-active');
      }
    }

    function showTimelineTooltip(segment, mode){
      if(!segment || !timelineTooltip || !timelineContainer) return;
      const message = segment.dataset.tooltip;
      if(!message) return;
      const containerRect = timelineContainer.getBoundingClientRect();
      const segmentRect = segment.getBoundingClientRect();
      const center = segmentRect.left - containerRect.left + (segmentRect.width / 2);
      timelineTooltip.style.left = `${center}px`;
      timelineTooltip.textContent = message;
      timelineTooltip.classList.add('show');
      segment.classList.add('is-hover');
      highlightTimelineLabels(mode);
    }

    function hideTimelineTooltip(){
      timelineTooltip?.classList.remove('show');
      Object.values(timelineSegments).forEach(seg => seg?.classList.remove('is-hover'));
      highlightTimelineLabels(null);
    }

    // SC timeline tooltip functions (separate tooltip element)
    function highlightScTimelineLabels(active){
      Object.values(scTimelineLabels).forEach(label => label?.classList.remove('is-active'));
      if(active){
        scTimelineLabels.start?.classList.add('is-active');
        scTimelineLabels.end?.classList.add('is-active');
      }
    }

    function showScTimelineTooltip(segment){
      if(!segment || !scTimelineTooltip || !scTimelineContainer) return;
      const message = segment.dataset.tooltip || segment.title;
      if(!message) return;
      const containerRect = scTimelineContainer.getBoundingClientRect();
      const segmentRect = segment.getBoundingClientRect();
      const center = segmentRect.left - containerRect.left + (segmentRect.width / 2);
      scTimelineTooltip.style.left = `${center}px`;
      scTimelineTooltip.textContent = message;
      scTimelineTooltip.classList.add('show');
      segment.classList.add('is-hover');
      highlightScTimelineLabels(true);
    }

    function hideScTimelineTooltip(){
      scTimelineTooltip?.classList.remove('show');
      Object.values(scSegments).forEach(seg => seg?.classList.remove('is-hover'));
      highlightScTimelineLabels(false);
    }

    const MAX_CHEQUES = 6;
    // Virtualization settings for rental cheques
    const RENT_VIRTUALIZE_THRESHOLD = 20; // start virtualization when MAX_CHEQUES exceeds this
    const RENT_WINDOW_SIZE = 8; // number of cheque cards rendered in the viewport
    let rentalChequesData = null; // array of cheque objects {date, amount, cleared, clearDate, bank, chequeNumber}
    const DEFAULT_RENTAL_COUNT = 0;
    const DEFAULT_PDC_COUNT = 0;
    // If PDC list becomes large, switch to a compact (virtualized-like) table view
    const PDC_VIRTUALIZE_THRESHOLD = 30;
    const BUILDING_HISTORY_MAX = 40;
    
    // Helper function to analyze cheque dates and return appropriate labels
    // ~90% of cases are PDCs, so labels are optimized for that common case
    function analyzeChequeTypes() {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      let postDatedCount = 0;
      let pastDatedCount = 0;
      let noDatedCount = 0;
      const chequeDetails = [];
      
      qsa('#pdcChequesRow .chq').forEach(card => {
        const dateInput = card.querySelector('input[type="date"]');
        const amountInput = card.querySelector('input[type="number"]');
        const amt = Number(amountInput?.value || 0);
        const dateStr = dateInput?.value || '';
        
        if(amt > 0) {
          if(dateStr) {
            const chequeDate = new Date(dateStr + 'T00:00:00');
            if(chequeDate > today) {
              postDatedCount++;
              chequeDetails.push({ type: 'pdc', date: dateStr, amount: amt });
            } else {
              pastDatedCount++;
              chequeDetails.push({ type: 'past', date: dateStr, amount: amt });
            }
          } else {
            noDatedCount++;
            chequeDetails.push({ type: 'unknown', date: '', amount: amt });
          }
        }
      });
      
      const total = postDatedCount + pastDatedCount + noDatedCount;
      
      // Determine the appropriate label based on composition
      // Handle singular/plural correctly
      let label, shortLabel, pluralLabel, messageHint;
      if(total === 0) {
        label = 'PDC';
        shortLabel = 'PDC';
        pluralLabel = 'PDCs';
        messageHint = '';
      } else if(postDatedCount === total) {
        // All are post-dated (most common case ~90%)
        label = total === 1 ? 'PDC' : 'PDCs';
        shortLabel = 'PDC';
        pluralLabel = 'PDCs';
        messageHint = '';
      } else if(pastDatedCount === total) {
        // All are past-dated (rare case)
        label = total === 1 ? 'Past-Dated Uncleared Cheque' : 'Past-Dated Uncleared Cheques';
        shortLabel = 'Past-Dated';
        pluralLabel = 'past-dated uncleared cheques';
        messageHint = total === 1 ? '(Note: This is past-dated but not yet cleared)' : '(Note: These are past-dated but not yet cleared)';
      } else if(postDatedCount > 0 && pastDatedCount > 0) {
        // Mix of both - explicitly mention both types
        const pdcWord = postDatedCount === 1 ? 'PDC' : 'PDCs';
        const pastWord = pastDatedCount === 1 ? 'Past-Dated Cheque' : 'Past-Dated Cheques';
        label = `${pdcWord} + ${pastWord}`;
        shortLabel = 'PDC+Past';
        pluralLabel = `PDCs and past-dated cheques`;
        messageHint = `(${postDatedCount} ${postDatedCount === 1 ? 'PDC' : 'PDCs'} + ${pastDatedCount} past-dated uncleared)`;
      } else {
        // Unknown dates - default to PDC terminology
        label = total === 1 ? 'PDC' : 'PDCs';
        shortLabel = 'PDC';
        pluralLabel = 'PDCs';
        messageHint = '';
      }
      
      return {
        postDatedCount,
        pastDatedCount,
        noDatedCount,
        total,
        label,
        shortLabel,
        pluralLabel,
        messageHint,
        details: chequeDetails,
        isAllPDC: postDatedCount === total && total > 0,
        isAllPast: pastDatedCount === total && total > 0,
        isMixed: postDatedCount > 0 && pastDatedCount > 0
      };
    }
    
    let lastCalcData = null;
    let resultsVisible = false;
    let docsReadyFlag = false;
    let recalcNeeded = false; // Flag for showing recalculation warning
    let chequeImportWarnings = [];
    let chequeGapJustification = { reason: '', note: '' };
    let lastChequeGapMeta = null;
    const STORAGE_KEY = 'rentalSettlementData';
    const CASES_KEY = 'rentalSettlementCases';
    let currentCaseId = null;
    let currentCaseOriginalKey = null; // Track original building+unit to detect when user changes to a different unit
    let lastAutosaveTimestamp = null;
    let dismissedHealthItems = new Set(); // Track dismissed health items for current session
    const queueHealthPanelRefresh = debounce(() => updateSectionHealth(), 180);
    
    // Check if all required fields are filled for auto-calculate
    function areRequiredFieldsFilled() {
      if(!unitNo?.value?.trim()) return false;
      if(!tenantName?.value?.trim()) return false;
      if(!leaseStart?.value) return false;
      if(!leaseEnd?.value) return false;
      if(!rentInput?.value || sanitizeNumber(rentInput.value) <= 0) return false;
      if(!handoverDate?.value) return false;
      if(securityDeposit?.value === '') return false;
      if(serviceCharge?.value === '') return false;
      return true;
    }
    
    // Auto-calculate when all required fields are filled
    const queueAutoCalculate = debounce(() => {
      if(areRequiredFieldsFilled()) {
        // Only auto-calculate if results not yet visible
        if(!resultsCard || resultsCard.style.display === 'none' || resultsCard.classList.contains('is-hidden')) {
          calculate(true); // silentMode = true to prevent alerts during auto-calculate
        }
      }
    }, 500);
    
    // Recalculation warning flag management - stays until page refresh
    function showRecalcWarning() {
      // Don't show warning during page initialization (loading saved data)
      if (isInitializing) return;
      recalcNeeded = true;
      const flag = qs('#recalcWarningFlag');
      if (flag) {
        flag.classList.add('visible');
        // Update settlement preview
        const flagPreview = flag.querySelector('#flagSettlementPreview');
        if(flagPreview) {
          try {
            flagPreview.textContent = 'New: ' + getQuickSettlementPreview();
          } catch(e) {}
        }
      }
    }
    
    // Flash the yellow warning briefly to indicate data changed (then auto-hide)
    function flashRecalcWarning() {
      if (isInitializing) return;
      const flag = qs('#recalcWarningFlag');
      if (flag) {
        // Update settlement preview
        const flagPreview = flag.querySelector('#flagSettlementPreview');
        if(flagPreview) {
          try {
            flagPreview.textContent = 'New: ' + getQuickSettlementPreview();
          } catch(e) {}
        }
        flag.classList.add('visible');
        setTimeout(() => {
          flag.classList.remove('visible');
        }, 5000);
      }
    }
    
    // Flash highlight on results card to indicate auto-recalculation
    function flashResultsUpdated() {
      if (!resultsCard) return;
      resultsCard.style.transition = 'box-shadow 0.3s ease';
      resultsCard.style.boxShadow = '0 0 20px 5px rgba(16, 185, 129, 0.5)';
      setTimeout(() => {
        resultsCard.style.boxShadow = '';
      }, 600);
    }

    // Live update function - recalculates instantly if results are visible
    const queueLiveUpdate = debounce(() => {
      // Don't trigger during page initialization
      if (isInitializing) return;
      updateSectionHealth();
      // If results are already visible, recalculate immediately so changes reflect instantly
      if(resultsCard && resultsCard.style.display !== 'none' && !resultsCard.classList.contains('is-hidden')) {
        calculate(true); // silentMode = true to prevent alerts during auto-recalculate
        flashResultsUpdated();
        flashRecalcWarning(); // Brief yellow flash to show data changed
      } else {
        // Show recalc warning flag when data changes (but not during init)
        showRecalcWarning();
        // Try auto-calculate if all fields are filled
        queueAutoCalculate();
      }
    }, 250);

    // Cheque-only update - updates health and auto-recalculates if results are visible
    const queueChequeUpdate = debounce(() => {
      // Don't trigger during page initialization
      if (isInitializing) return;
      updateSectionHealth();
      // If results are already visible, recalculate immediately so changes reflect instantly
      if(resultsCard && resultsCard.style.display !== 'none' && !resultsCard.classList.contains('is-hidden')) {
        calculate(true); // silentMode = true to prevent alerts during auto-recalculate
        flashResultsUpdated();
        flashRecalcWarning(); // Brief yellow flash to show data changed
      } else {
        queueAutoCalculate();
      }
    }, 250);
    
    const HEALTH_LABELS = {
      ok: 'Clear',
      warn: 'Check',
      critical: 'Action',
      todo: 'To-Do',
      info: 'Info'
    };
    const GAP_REASON_META = {
      mgmtFee: {
        label: 'Management fee included',
        short: 'Mgmt fee',
        copy: 'Management fees are embedded in one of the cheques (common: 5% of rent).',
        severityImpact: 'reduce'
      },
      cash: {
        label: 'Cash payment made',
        short: 'Cash paid',
        copy: 'Part of the rent was already paid in cash outside the cheques.',
        severityImpact: 'reduce'
      },
      deposit: {
        label: 'Deposit deducted',
        short: 'Deposit used',
        copy: 'Security deposit was used to cover part of the rent.',
        severityImpact: 'reduce'
      },
      refund: {
        label: 'Refund / adjustment',
        short: 'Refund given',
        copy: 'Tenant received a refund or rent was adjusted mid-contract.',
        severityImpact: 'reduce'
      },
      typo: {
        label: 'Data entry error',
        short: 'Needs fix',
        copy: 'There is a typo in rent or cheque amounts - please correct before closing.',
        severityImpact: 'keep'
      },
      shortTerm: {
        label: 'Short-term / partial lease',
        short: 'Partial term',
        copy: 'Lease is less than 12 months so cheques do not equal yearly rent.',
        severityImpact: 'reduce'
      },
      other: {
        label: 'Other reason',
        short: 'Other',
        copy: 'Please add a note explaining why the cheques differ from total contract rent.',
        severityImpact: 'reduce'
      }
    };

    // Multi-case management
    function getAllCases() {
      try {
        const cases = localStorage.getItem(CASES_KEY);
        return cases ? JSON.parse(cases) : {};
      } catch(e) {
        console.error('Failed to load cases:', e);
        return {};
      }
    }
    
    // Dashboard statistics
    function updateDashboardStats() {
      const cases = getAllCases();
      const caseList = Object.values(cases);
      const totalCases = caseList.length;
      
      let totalRentValue = 0;
      let totalSettlements = 0;
      let settlementCount = 0;
      
      caseList.forEach(c => {
        const data = c.data || {};
        const rent = parseFloat(String(data.rent || '0').replace(/,/g, '')) || 0;
        totalRentValue += rent;
        
        // Calculate settlement if we have enough data
        if (data.leaseStart && data.leaseEnd && data.handoverDate && rent > 0) {
          const totalDays = daysInclusive(data.leaseStart, data.leaseEnd);
          const sellerDays = Math.max(0, daysInclusive(data.leaseStart, data.handoverDate));
          const buyerDays = Math.max(0, totalDays - sellerDays);
          const daily = totalDays > 0 ? rent / totalDays : 0;
          const buyerRent = daily * buyerDays;
          
          let pdcTotal = 0;
          if (data.cheques) {
            data.cheques.forEach(chq => {
              if (!chq.cleared) {
                pdcTotal += parseFloat(String(chq.amount || '0').replace(/,/g, '')) || 0;
              }
            });
          }
          
          const dep = parseFloat(String(data.securityDeposit || '0').replace(/,/g, '')) || 0;
          const sc = parseFloat(String(data.serviceCharge || '0').replace(/,/g, '')) || 0;
          const net = Math.abs((buyerRent - pdcTotal) + dep - sc);
          totalSettlements += net;
          settlementCount++;
        }
      });
      
      const avgSettlement = settlementCount > 0 ? totalSettlements / settlementCount : 0;
      
      // Update UI
      const statTotalCases = qs('#statTotalCases');
      const statTotalValue = qs('#statTotalValue');
      const statAvgSettlement = qs('#statAvgSettlement');
      
      if (statTotalCases) statTotalCases.textContent = totalCases;
      if (statTotalValue) {
        if (totalRentValue >= 1000000) {
          statTotalValue.textContent = (totalRentValue / 1000000).toFixed(1) + 'M';
        } else if (totalRentValue >= 1000) {
          statTotalValue.textContent = (totalRentValue / 1000).toFixed(0) + 'K';
        } else {
          statTotalValue.textContent = totalRentValue.toFixed(0);
        }
      }
      if (statAvgSettlement) {
        if (avgSettlement >= 1000) {
          statAvgSettlement.textContent = (avgSettlement / 1000).toFixed(1) + 'K';
        } else {
          statAvgSettlement.textContent = avgSettlement.toFixed(0);
        }
      }
    }

    // Check for duplicate cases with same building/unit
    function findDuplicateCases(buildingVal, unitVal) {
      // Only consider duplicates when BOTH building and unit are provided and match an existing case.
      // Previously we flagged duplicates when unit matched alone which caused false positives
      // across different buildings. This stricter check avoids that behavior.
      if(!buildingVal && !unitVal) return [];
      const normalizedBuilding = (buildingVal || '').trim().toLowerCase();
      const normalizedUnit = (unitVal || '').trim().toLowerCase();
      if(!normalizedBuilding || !normalizedUnit) return [];

      const cases = getAllCases();
      const duplicates = [];
      Object.values(cases).forEach(c => {
        const caseBuilding = (c.data?.buildingName || '').trim().toLowerCase();
        const caseUnit = (c.data?.unitNo || '').trim().toLowerCase();
        if(caseBuilding === normalizedBuilding && caseUnit === normalizedUnit) {
          duplicates.push(c);
        }
      });
      return duplicates;
    }

    function saveCaseAs(caseName) {
      if(!caseName) return false;
      try {
        const state = captureCurrentState();
        console.log('📦 saveCaseAs - captured state:', { building: state.buildingName, unit: state.unitNo, tenant: state.tenantName, rent: state.rent });
        
        // Validate that building/tower name is filled - show picker if empty
        if(!state.buildingName || state.buildingName.trim() === '') {
          showBuildingPicker(caseName);
          return 'pending'; // Return pending to indicate modal is shown
        }
        
        const cases = getAllCases();
        const caseId = caseName.toLowerCase().replace(/[^a-z0-9]/g, '_');
        console.log('📦 saveCaseAs - caseId:', caseId, '| caseName:', caseName);
        
        // Check for duplicate property/unit (different from same-name check)
        // First log ALL existing cases for debugging
        console.log('📦 All existing cases:');
        Object.values(cases).forEach(c => {
          console.log('  -', c.name, '| Building:', c.data?.buildingName, '| Unit:', c.data?.unitNo);
        });
        
        console.log('📦 Attempting to save - Building:', state.buildingName, '| Unit:', state.unitNo);
        const duplicates = findDuplicateCases(state.buildingName, state.unitNo);
        const otherDuplicates = duplicates.filter(d => d.id !== caseId); // Exclude current case if overwriting

        // Debugging: log normalized values and any duplicates found so we can trace false positives
        try {
          console.debug('saveCaseAs debug:', {
            attemptedName: caseName,
            normalizedBuilding: (state.buildingName || '').trim().toLowerCase(),
            normalizedUnit: (state.unitNo || '').trim().toLowerCase(),
            allCases: Object.values(cases).map(d => ({ id: d.id, name: d.name, building: d.data?.buildingName, unit: d.data?.unitNo })),
            duplicatesFound: duplicates.map(d => ({ id: d.id, name: d.name, building: d.data?.buildingName, unit: d.data?.unitNo }))
          });
        } catch(e) { /* ignore debug errors */ }
        
        if(otherDuplicates.length > 0) {
          const dupNames = otherDuplicates.map(d => d.name).join(', ');
          const proceed = confirm(`⚠️ POTENTIAL DUPLICATE DETECTED\n\nA case with the same property/unit already exists:\n• ${dupNames}\n\nBuilding: ${state.buildingName || 'N/A'}\nUnit: ${state.unitNo || 'N/A'}\n\nDo you still want to save this as a new case?`);
          if(!proceed) return false;
        }
        
        if(cases[caseId]) {
          const overwrite = confirm(`A case named "${caseName}" already exists. Overwrite it?`);
          if(!overwrite) return false;
        }
        const caseTimestamp = state.timestamp || new Date().toISOString();
        state.timestamp = caseTimestamp;
        cases[caseId] = {
          id: caseId,
          name: caseName,
          data: state,
          timestamp: caseTimestamp
        };
        localStorage.setItem(CASES_KEY, JSON.stringify(cases));
        currentCaseId = caseId;
        // Update original key to match newly saved case
        const newBuilding = (state.buildingName || '').trim().toLowerCase();
        const newUnit = (state.unitNo || '').trim().toLowerCase();
        currentCaseOriginalKey = newBuilding + '|' + newUnit;
        
        // Save building to history
        if(state.buildingName) {
          saveBuildingToHistory(state.buildingName);
        }
        
        showToast(`Saved: ${caseName}`);
        markAutosaveSaved('Saved to case', { timestamp: caseTimestamp });
        return true;
      } catch(e) {
        console.error('Save case failed:', e);
        return false;
      }
    }
    
    // Building picker for when saving without a tower name
    function showBuildingPicker(pendingCaseName) {
      let history = [];
      try {
        history = JSON.parse(localStorage.getItem('buildingHistory') || '[]');
        if(!Array.isArray(history)) history = [];
      } catch(e) { history = []; }
      
      // Also get unique buildings from existing cases
      const cases = getAllCases();
      const caseBuildings = new Set();
      Object.values(cases).forEach(c => {
        if(c.data?.buildingName?.trim()) {
          caseBuildings.add(c.data.buildingName.trim());
        }
      });
      
      // Merge and deduplicate
      const allBuildings = [...new Set([...history, ...caseBuildings])].sort((a,b) => 
        a.localeCompare(b, undefined, { sensitivity: 'base' })
      );
      
      const buildingListHtml = allBuildings.length > 0 
        ? allBuildings.map(b => `<div class="building-picker-item" onclick="selectBuildingFromPicker('${b.replace(/'/g, "\\'")}', '${pendingCaseName.replace(/'/g, "\\'")}')">${b}</div>`).join('')
        : '<div class="building-picker-empty">No saved buildings yet.<br>Enter a new building name below.</div>';
      
      const pickerHtml = `
        <div class="building-picker-overlay" id="buildingPickerOverlay">
          <div class="building-picker">
            <div class="building-picker-title">🏢 Select Building/Tower</div>
            <div class="building-picker-subtitle">Building name is required to save. Choose from your saved buildings or enter a new one.</div>
            
            <div class="building-picker-list">
              ${buildingListHtml}
            </div>
            
            <div class="building-picker-or">— or enter a new building —</div>
            
            <input type="text" id="newBuildingInput" class="building-picker-input" placeholder="Enter new building name...">
            
            <div class="building-picker-actions">
              <button class="btn gray" onclick="closeBuildingPicker()">Cancel</button>
              <button class="btn positive" onclick="confirmNewBuilding('${pendingCaseName.replace(/'/g, "\\'")}')">Save with New Building</button>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', pickerHtml);
      
      // Focus the input
      setTimeout(() => {
        const input = qs('#newBuildingInput');
        if(input) input.focus();
      }, 100);
    }
    
    window.closeBuildingPicker = function() {
      const overlay = qs('#buildingPickerOverlay');
      if(overlay) overlay.remove();
    };
    
    window.selectBuildingFromPicker = function(selectedBuilding, caseName) {
      // Set the building field and close picker
      if(buildingName) {
        buildingName.value = selectedBuilding;
      }
      closeBuildingPicker();
      
      // Now save the case
      const result = saveCaseAs(caseName);
      if(result === true) {
        closeModal();
      }
    };
    
    window.confirmNewBuilding = function(caseName) {
      const input = qs('#newBuildingInput');
      const newBuilding = input?.value?.trim();
      
      if(!newBuilding) {
        alert('Please enter a building name or select one from the list.');
        return;
      }
      
      // Set the building field and close picker
      if(buildingName) {
        buildingName.value = newBuilding;
      }
      closeBuildingPicker();
      
      // Now save the case
      const result = saveCaseAs(caseName);
      if(result === true) {
        closeModal();
      }
    };
    
    function saveBuildingToHistory(buildingName) {
      if(!buildingName || buildingName.trim() === '') return;
      try {
        let history = JSON.parse(localStorage.getItem('buildingHistory') || '[]');
        if(!Array.isArray(history)) history = [];
        const trimmedName = buildingName.trim();
        
        history = history.filter(name => name !== trimmedName);
        history.push(trimmedName);
        if(history.length > BUILDING_HISTORY_MAX) {
          history = history.slice(history.length - BUILDING_HISTORY_MAX);
        }
        localStorage.setItem('buildingHistory', JSON.stringify(history));
        updateBuildingDatalist();
      } catch(e) {
        console.error('Failed to save building to history:', e);
      }
    }
    
    function updateBuildingDatalist() {
      try {
        let history = JSON.parse(localStorage.getItem('buildingHistory') || '[]');
        if(!Array.isArray(history)) history = [];
        const datalist = qs('#buildingHistory');
        if(!datalist) return;
        
        // Get building rates to show alongside names
        const rates = getBuildingRates();
        
        const sortedHistory = [...history].sort((a,b) => a.localeCompare(b, undefined, { sensitivity: 'base' }));
        datalist.innerHTML = sortedHistory.map(name => {
          const key = name.trim().toLowerCase();
          const rateEntry = rates[key];
          const rateLabel = rateEntry ? ` @ AED ${rateEntry.rate}/sq.ft` : '';
          return `<option value="${name}">${name}${rateLabel}</option>`;
        }).join('');
      } catch(e) {
        console.error('Failed to update building datalist:', e);
      }
    }

    function loadCase(caseId) {
      try {
        console.log('🔵 loadCase called with caseId:', caseId);
        const cases = getAllCases();
        if(!cases[caseId]) {
          console.error('❌ Case not found:', caseId);
          return false;
        }
        const selectedCase = cases[caseId];
        console.log('🔵 loadCase - case data:', { building: selectedCase.data?.buildingName, unit: selectedCase.data?.unitNo, tenant: selectedCase.data?.tenantName });
        clearDismissedHealthItems(); // Clear dismissed health items when loading new case
        // Hide results section and CLEAR all calculation data to prevent confusion with old data
        setResultsVisibility(false);
        if(resultsCard) resultsCard.classList.add('is-hidden');
        if(resultsDivider) resultsDivider.classList.add('is-hidden');
        if(summarySection) summarySection.style.display = 'none';
        // Clear the results table and summary notes from previous case
        if(resultsBody) resultsBody.innerHTML = '<tr><td colspan="13" class="center muted table-placeholder">Click Calculate to see results</td></tr>';
        if(notesEl) notesEl.innerHTML = '';
        if(summaryTotal) summaryTotal.textContent = 'AED 0.00';
        if(directionText) { directionText.textContent = ''; directionText.style.color = ''; }
        const newOwnerInfoEl = qs('#newOwnerInfo');
        if(newOwnerInfoEl) newOwnerInfoEl.innerHTML = '';
        // Clear stale data tracking - new case means no calculation yet
        lastCalculationHash = null;
        calculationIsFresh = false;
        if(staleDataWarning) staleDataWarning.classList.remove('visible');
        document.body.classList.remove('results-stale');
        // Set the active case first and suppress autosave while we restore UI/state
        console.log('🔵 Setting currentCaseId to:', caseId, '(previous:', currentCaseId, ')');
        currentCaseId = caseId;
        // Store original building+unit to detect if user changes to different unit (prevents autosave corruption)
        const origBuilding = (selectedCase.data?.buildingName || '').trim().toLowerCase();
        const origUnit = (selectedCase.data?.unitNo || '').trim().toLowerCase();
        currentCaseOriginalKey = origBuilding + '|' + origUnit;
        console.log('🔵 Set currentCaseOriginalKey:', currentCaseOriginalKey);
        isInitializing = true;
        console.log('🔵 Calling restoreState...');
        restoreState(selectedCase.data);
        markDocsReady(false);
        const caseTimestamp = selectedCase.timestamp || selectedCase.data?.timestamp || null;
        setLastAutosaveTimestamp(caseTimestamp);
        updateAutosaveMeta('Loaded case');
        setAutosaveIndicator('saved','Loaded case');
        // Re-enable autosave now that restore is complete. Do NOT auto-save immediately
        // to avoid unintentionally overwriting the saved case with any transient UI state.
        console.log('🔵 loadCase - restoreState complete, re-enabling autosave');
        isInitializing = false;
        // Save state immediately so page refresh reloads this case (not the previous one)
        try { saveState(); } catch(e) { console.warn('Post-loadCase saveState failed', e); }
        console.log('🔵 loadCase COMPLETE - currentCaseId:', currentCaseId);
        console.log('🔵 Final DOM check:', { building: buildingName?.value, unit: unitNo?.value, tenant: tenantName?.value });
        showToast(`Loaded: ${cases[caseId].name}`);
        updateHealthRibbon();
        // Check if this is an empty unit and show/hide banner accordingly
        if(typeof window.checkEmptyUnitMode === 'function') window.checkEmptyUnitMode();
        return true;
      } catch(e) {
        console.error('Load case failed:', e);
        return false;
      }
    }

    function deleteCase(caseId) {
      try {
        const cases = getAllCases();
        if(cases[caseId]) {
          delete cases[caseId];
          localStorage.setItem(CASES_KEY, JSON.stringify(cases));
          if(currentCaseId === caseId) {
            currentCaseId = null;
            currentCaseOriginalKey = null;
          }
          return true;
        }
        return false;
      } catch(e) {
        console.error('Delete case failed:', e);
        return false;
      }
    }

    function captureCurrentState() {
      if(isInitializing) {
        console.warn('⚠️ captureCurrentState called during initialization - this may capture partial state!');
      }
      console.log('📸 captureCurrentState - reading DOM:', { building: buildingName?.value, unit: unitNo?.value, tenant: tenantName?.value });
      const state = {
        buildingName: buildingName?.value || '',
        unitNo: unitNo?.value || '',
        tenantName: tenantName?.value || '',
        buyerName: buyerNameInput?.value || '',
        leaseStart: leaseStart?.value || '',
        leaseEnd: leaseEnd?.value || '',
        handoverDate: handoverDate?.value || '',
        rent: rentInput?.value || '',
        serviceCharge: serviceCharge?.value || '',
        securityDeposit: securityDeposit?.value || '',
        rentalCount: rentalCountSel?.value || DEFAULT_RENTAL_COUNT,
        pdcCount: pdcCountSel?.value || '',
        cheques: [],
        commBuyerName: commBuyerName?.value || '',
        commPdcName: commPdcName?.value || '',
        commAccName: commAccName?.value || '',
        // commSenderName is NOT saved here - it uses global persistence
        caseNotes: caseNotesTextarea ? caseNotesTextarea.value : '',
        includeNotesInPdf: qs('#includeNotesInPdf')?.checked || false,
        timestamp: new Date().toISOString(),
        // Service Charge Calculator fields
        scArea: qs('#scArea')?.value || '',
        scRate: qs('#scRate')?.value || '',
        scPaidEnd: qs('#scPaidEnd')?.value || '',
        scFrequency: qs('#scFrequency')?.value || 'quarterly',
        // Note: scPaidEndManuallySet is NOT saved - it's session-only protection
        // Toggle states (saved independently)
        scAreaReqToggle: qs('#scAreaReqToggle')?.checked ?? true,
        scFieldsMandatory: qs('#scFieldsMandatory')?.checked ?? true,
        scBuyerAutoMode: qs('#scBuyerAutoMode')?.checked ?? true,
        gapJustification: {
          reason: chequeGapJustification.reason || '',
          note: chequeGapJustification.note || '',
          lastDiff: lastChequeGapMeta?.diff || 0
        }
      };
      
      // Save cheque data
      const rentalCount = clamp(Number(rentalCountSel.value||0), 0, MAX_CHEQUES);
      if(isRentalCompactMode() && Array.isArray(rentalChequesData) && rentalChequesData.length > 0){
        // Copy authoritative rentalChequesData
        for(let i=0;i<rentalCount;i++){
          const chq = rentalChequesData[i] || {};
          state.cheques.push({
            date: chq.date || '',
            amount: chq.amount || '',
            cleared: !!chq.cleared,
            clearDate: chq.clearDate || '',
            bank: chq.bank || '',
            chequeNumber: chq.chequeNumber || ''
          });
        }
      } else {
        for(let i=1; i<=rentalCount; i++){
          const bankField = qs(`#rentChq${i}Bank`);
          const numberField = qs(`#rentChq${i}Number`);
          const bankValue = bankField ? bankField.value.trim() : '';
          const chequeValue = numberField ? numberField.value.trim() : '';
          state.cheques.push({
            date: qs(`#rentChq${i}Date`).value,
            amount: qs(`#rentChq${i}`).value,
            cleared: qs(`#rentChq${i}Cleared`).checked,
            clearDate: qs(`#rentChq${i}ClearDate`).value,
            bank: bankValue,
            chequeNumber: chequeValue
          });
        }
      }
      return state;
    }

    function saveState() {
      try {
        const state = captureCurrentState();
        console.log('Saving state:', state);
        
        // Save autosave state along with active case reference (stored separately, not inside state)
        const autosaveData = {
          state: state,
          currentCaseId: currentCaseId || null
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(autosaveData));
        console.log('State saved to localStorage');
        
        // Also auto-save to current case if one is active
        if(currentCaseId) {
          // Check if building+unit changed - if so, don't auto-save to old case (prevents data corruption)
          const currentBuilding = (state.buildingName || '').trim().toLowerCase();
          const currentUnit = (state.unitNo || '').trim().toLowerCase();
          const currentKey = currentBuilding + '|' + currentUnit;
          
          if(currentCaseOriginalKey && currentKey !== currentCaseOriginalKey) {
            // User changed to a different building/unit - disconnect from old case
            console.log('⚠️ Building/Unit changed from', currentCaseOriginalKey, 'to', currentKey, '- disconnecting from case:', currentCaseId);
            currentCaseId = null;
            currentCaseOriginalKey = null;
          } else {
            const cases = getAllCases();
            if(cases[currentCaseId]) {
              cases[currentCaseId].data = state;
              cases[currentCaseId].timestamp = new Date().toISOString();
              localStorage.setItem(CASES_KEY, JSON.stringify(cases));
              console.log('Auto-saved to case:', currentCaseId);
            }
          }
        }
        markAutosaveSaved(null, { timestamp: state.timestamp });
      } catch(e) {
        console.error('Auto-save failed:', e);
        setAutosaveIndicator('error','Autosave failed');
      }
    }

    function restoreState(state) {
      if(!state) {
        console.warn('⚠️ restoreState called with empty state');
        return;
      }
      console.log('🟢 restoreState START - state:', { building: state.buildingName, unit: state.unitNo, tenant: state.tenantName });
      
      // Restore basic fields
      if(buildingName) buildingName.value = state.buildingName || '';
      if(unitNo) unitNo.value = state.unitNo || '';
      if(tenantName) tenantName.value = state.tenantName || '';
      console.log('🟢 restoreState - DOM updated:', { building: buildingName?.value, unit: unitNo?.value, tenant: tenantName?.value });
      if(leaseStart) leaseStart.value = state.leaseStart || '';
      if(leaseEnd) leaseEnd.value = state.leaseEnd || '';
      if(handoverDate) handoverDate.value = state.handoverDate || '';
      if(rentInput) setCurrencyValue(rentInput, state.rent);
      if(serviceCharge) setCurrencyValue(serviceCharge, state.serviceCharge);
      if(securityDeposit) setCurrencyValue(securityDeposit, state.securityDeposit);
      if(rentalCountSel) rentalCountSel.value = state.rentalCount || DEFAULT_RENTAL_COUNT;
      if(commBuyerName) commBuyerName.value = state.commBuyerName || '';
      if(buyerNameInput) buyerNameInput.value = state.buyerName || '';
      if(commPdcName) commPdcName.value = state.commPdcName || '';
      // commSenderName is NOT restored from case state - it uses global persistence
      if(commAccName) commAccName.value = state.commAccName || '';
      
      // Restore Service Charge Calculator fields
      if(qs('#scArea')) qs('#scArea').value = state.scArea || '';
      if(qs('#scRate')) {
        qs('#scRate').value = state.scRate || '';
        // Protect saved case SC Rate from building rate auto-fill
        if(state.scRate) scRateFromSavedCase = true;
      }
      if(qs('#scPaidEnd')) qs('#scPaidEnd').value = state.scPaidEnd || '';
      if(qs('#scFrequency')) qs('#scFrequency').value = state.scFrequency || 'quarterly';
      // Reset SC Paid End manual flag when loading a case - each case starts fresh
      scPaidEndManuallySet = false;
      
      // Restore toggle states
      const scAreaReqToggle = qs('#scAreaReqToggle');
      const scFieldsMandatory = qs('#scFieldsMandatory');
      const scBuyerAutoMode = qs('#scBuyerAutoMode');
      const scAreaLabel = qs('#scAreaLabel');
      const scRateLabel = qs('#scRateLabel');
      const scArea = qs('#scArea');
      const scRate = qs('#scRate');
      const scBuyerInput = qs('#serviceCharge');
      
      if(scAreaReqToggle && state.scAreaReqToggle !== undefined) {
        scAreaReqToggle.checked = state.scAreaReqToggle;
        if(scAreaLabel && scArea) {
          scAreaLabel.textContent = state.scAreaReqToggle ? 'Unit Area (sq.ft) *' : 'Unit Area (sq.ft)';
          scArea.required = state.scAreaReqToggle;
        }
      }
      if(scFieldsMandatory && state.scFieldsMandatory !== undefined) {
        scFieldsMandatory.checked = state.scFieldsMandatory;
        if(scRateLabel && scRate) {
          scRateLabel.textContent = '$/sq.ft';
          scRate.required = state.scFieldsMandatory;
        }
      }
      if(scBuyerAutoMode && state.scBuyerAutoMode !== undefined) {
        scBuyerAutoMode.checked = state.scBuyerAutoMode;
        if(scBuyerInput) {
          if(state.scBuyerAutoMode) {
            scBuyerInput.placeholder = 'Auto-calc';
            scBuyerInput.readOnly = true;
            scBuyerInput.style.background = '#f8fafc';
          } else {
            scBuyerInput.placeholder = 'Enter amount';
            scBuyerInput.readOnly = false;
            scBuyerInput.style.background = '';
          }
        }
      }
      // Allow local UI toggle preferences to override case state (persisted independently)
      if(typeof loadTogglePrefs === 'function') {
        try { loadTogglePrefs(); } catch(e){ console.warn('loadTogglePrefs failed', e); }
        // Ensure master toggle state is applied even when no saved pref existed
        try{
          const master = qs('#scMasterToggle');
          if(master && typeof updateScMasterEnabled === 'function') updateScMasterEnabled(master.checked, true);
        }catch(e){}
      }

      // Re-apply case-specific SC buyer mode after loading global toggle prefs.
      // This ensures a case that was switched to manual entry keeps its manual value
      // even if the user's global UI preference differs.
      try {
        if(typeof state.scBuyerAutoMode !== 'undefined') {
          const scBuyerToggle = qs('#scBuyerAutoMode');
          const scBuyerInputEl = qs('#serviceCharge');
          if(scBuyerToggle) {
            scBuyerToggle.checked = !!state.scBuyerAutoMode;
            if(scBuyerInputEl) {
              if(scBuyerToggle.checked) {
                scBuyerInputEl.placeholder = 'Auto-calc';
                scBuyerInputEl.readOnly = true;
                scBuyerInputEl.style.background = '#f8fafc';
              } else {
                scBuyerInputEl.placeholder = 'Enter amount';
                scBuyerInputEl.readOnly = false;
                scBuyerInputEl.style.background = '';
              }
            }
          }
        }
      } catch(e) { console.warn('Re-applying scBuyerAutoMode failed', e); }

      calculateServiceCharge(); // Recalculate based on loaded values
      
      if(state.gapJustification){
        chequeGapJustification = {
          reason: state.gapJustification.reason || '',
          note: state.gapJustification.note || ''
        };
      } else {
        chequeGapJustification = { reason: '', note: '' };
      }
      syncGapReasonButtons();
      if(gapReasonNote) gapReasonNote.value = chequeGapJustification.note || '';

      // Restore case notes
      if(caseNotesTextarea) {
        caseNotesTextarea.value = state.caseNotes || '';
        updateNotesIconGlow();
      }
      
      // Restore "include notes in PDF" setting
      const includeNotesCheckbox = qs('#includeNotesInPdf');
      if(includeNotesCheckbox) {
        includeNotesCheckbox.checked = state.includeNotesInPdf || false;
      }
      
      // Clear ALL cheque fields first before restoring
      for(let i = 1; i <= MAX_CHEQUES; i++) {
        const dateField = qs(`#rentChq${i}Date`);
        const amtField = qs(`#rentChq${i}`);
        const clearedField = qs(`#rentChq${i}Cleared`);
        const clearDateField = qs(`#rentChq${i}ClearDate`);
        const bankField = qs(`#rentChq${i}Bank`);
        const numberField = qs(`#rentChq${i}Number`);
        const item = qs(`#rentChq${i}Item`);
        
        if(dateField) dateField.value = '';
        if(amtField) amtField.value = '';
        if(clearedField) clearedField.checked = false;
        if(clearDateField) clearDateField.value = '';
        if(bankField) bankField.value = '';
        if(numberField) numberField.value = '';
        if(item) {
          item.classList.remove('cleared');
          item.classList.add('outstanding');
        }
      }
      
      // Restore cheque data
      // If this case uses the compact/virtualized rental UI, restore into rentalChequesData and render compact view
      const savedRentalCount = clamp(Number(state.rentalCount || 0), 0, MAX_CHEQUES);
      if(savedRentalCount > RENT_VIRTUALIZE_THRESHOLD && state.cheques && state.cheques.length > 0) {
        rentalChequesData = state.cheques.map(chq => ({
          date: chq.date || '',
          amount: chq.amount || '',
          cleared: !!chq.cleared,
          clearDate: chq.clearDate || '',
          bank: chq.bank || '',
          chequeNumber: chq.chequeNumber || ''
        }));
        renderRentalCompact(rentalChequesData.slice(0, savedRentalCount));
      } else {
        updateRentalCount();
        if(state.cheques && state.cheques.length > 0){
          state.cheques.forEach((chq, idx) => {
            const i = idx + 1;
            if(i <= MAX_CHEQUES) {
              qs(`#rentChq${i}Date`).value = chq.date || '';
              qs(`#rentChq${i}`).value = chq.amount || '';
              qs(`#rentChq${i}Cleared`).checked = chq.cleared || false;
              qs(`#rentChq${i}ClearDate`).value = chq.clearDate || '';
              const bankField = qs(`#rentChq${i}Bank`);
              const numberField = qs(`#rentChq${i}Number`);
              if(bankField) bankField.value = chq.bank || '';
              if(numberField) numberField.value = chq.chequeNumber || '';
              
              const item = qs(`#rentChq${i}Item`);
              if(chq.cleared) {
                item.classList.add('cleared');
                item.classList.remove('outstanding');
              } else {
                item.classList.remove('cleared');
                item.classList.add('outstanding');
              }
            }
          });
        }
      }
      
      debouncedUpdateContractInfo();
      updateRentalTotal();
      syncUnclearedToPDC();
      updateTitle();
      // Re-apply manual Buyer SC value if this case was saved in manual mode.
      try {
        if(state && typeof state.scBuyerAutoMode !== 'undefined' && state.scBuyerAutoMode === false) {
          const scBuyerInputEl = qs('#serviceCharge');
          if(scBuyerInputEl && typeof state.serviceCharge !== 'undefined' && String(state.serviceCharge).trim() !== '') {
            setCurrencyValue(scBuyerInputEl, state.serviceCharge);
          }
        }
      } catch(e) { console.warn('Re-applying manual serviceCharge failed', e); }
      console.log('🟢 restoreState COMPLETE - final DOM values:', { building: buildingName?.value, unit: unitNo?.value, tenant: tenantName?.value });
    }

    function loadState() {
      try {
        console.log('Loading state from localStorage...');
        const saved = localStorage.getItem(STORAGE_KEY);
        console.log('Retrieved from localStorage:', saved ? 'Found data' : 'No data found');
        if(!saved) return;
        const parsed = JSON.parse(saved);
        
        // Handle both old format (direct state) and new format (wrapper with currentCaseId)
        let state, savedCaseId;
        if(parsed.state && parsed.hasOwnProperty('currentCaseId')) {
          // New format
          state = parsed.state;
          savedCaseId = parsed.currentCaseId;
        } else {
          // Old format (backward compatibility)
          state = parsed;
          savedCaseId = parsed.currentCaseId || null;
        }
        
        console.log('Parsed state:', state);
        restoreState(state);
        markDocsReady(false);
        
        // Restore active case ID if it was saved
        if(savedCaseId) {
          const cases = getAllCases();
          if(cases[savedCaseId]) {
            currentCaseId = savedCaseId;
            console.log('Restored active case:', savedCaseId);
          }
        }
        setLastAutosaveTimestamp(state.timestamp || null);
        updateAutosaveMeta(state.timestamp ? 'Recovered autosave' : null);
        setAutosaveIndicator('saved','State restored');
        showToast('Previous data restored');
        // Check if restored state has empty tenant - show banner
        setTimeout(function() {
          if(typeof window.checkEmptyUnitMode === 'function') window.checkEmptyUnitMode();
        }, 150);
      } catch(e) {
        console.error('Auto-load failed:', e);
      }
    }

    // Persist small UI toggle preferences separately so they survive simple page refreshes
    const TOGGLE_PREFS_KEY = 'RS_TOGGLE_PREFS_v1';
    function saveTogglePrefs(){
      try{
        const prefs = {
          scAreaReqToggle: qs('#scAreaReqToggle') ? !!qs('#scAreaReqToggle').checked : true,
          scFieldsMandatory: qs('#scFieldsMandatory') ? !!qs('#scFieldsMandatory').checked : true,
          scBuyerAutoMode: qs('#scBuyerAutoMode') ? !!qs('#scBuyerAutoMode').checked : true,
          scMasterToggle: qs('#scMasterToggle') ? !!qs('#scMasterToggle').checked : false,
          scRate: (function(){ const el = qs('#scRate'); if(!el) return null; const v = Number(el.value); return isNaN(v) ? null : v; })()
        };
        localStorage.setItem(TOGGLE_PREFS_KEY, JSON.stringify(prefs));
        console.log('Saved toggle prefs', prefs);
      }catch(e){ console.warn('saveTogglePrefs failed', e); }
    }

    function loadTogglePrefs(){
      try{
        const raw = localStorage.getItem(TOGGLE_PREFS_KEY);
        if(!raw) return null;
        const prefs = JSON.parse(raw);
        // Apply preferences if elements exist
        const scAreaReqToggle = qs('#scAreaReqToggle');
        const scFieldsMandatory = qs('#scFieldsMandatory');
        const scBuyerAutoMode = qs('#scBuyerAutoMode');
        const scMasterToggle = qs('#scMasterToggle');
        const scAreaLabel = qs('#scAreaLabel');
        const scRateLabel = qs('#scRateLabel');
        const scArea = qs('#scArea');
        const scRate = qs('#scRate');
        const scBuyerInput = qs('#serviceCharge');

        if(scAreaReqToggle && typeof prefs.scAreaReqToggle !== 'undefined'){
          scAreaReqToggle.checked = !!prefs.scAreaReqToggle;
          if(scAreaLabel && scArea) {
            scAreaLabel.textContent = prefs.scAreaReqToggle ? 'Unit Area (sq.ft) *' : 'Unit Area (sq.ft)';
            scArea.required = !!prefs.scAreaReqToggle;
          }
        }
        if(scFieldsMandatory && typeof prefs.scFieldsMandatory !== 'undefined'){
          scFieldsMandatory.checked = !!prefs.scFieldsMandatory;
          if(scRateLabel && scRate){
            scRateLabel.textContent = '$/sq.ft';
            scRate.required = !!prefs.scFieldsMandatory;
            const note = qs('#scRateNote');
            if(!prefs.scFieldsMandatory){
              // hide input and show note
              if(scRate) scRate.style.display = 'none';
              if(note) note.style.display = 'inline-block';
            } else {
              if(scRate) scRate.style.display = '';
              if(note) note.style.display = 'none';
            }
          }
          // If we have a saved scRate value, apply it (but don't override live edits if empty)
          if(typeof prefs.scRate !== 'undefined' && prefs.scRate !== null && scRate){
            scRate.value = (prefs.scRate !== undefined && prefs.scRate !== null) ? String(prefs.scRate) : (scRate.value || '6');
          }
        }
        if(scBuyerAutoMode && typeof prefs.scBuyerAutoMode !== 'undefined'){
          scBuyerAutoMode.checked = !!prefs.scBuyerAutoMode;
          if(scBuyerInput){
            if(prefs.scBuyerAutoMode){
              scBuyerInput.placeholder = 'Auto-calc';
              scBuyerInput.readOnly = true;
              scBuyerInput.style.background = '#f8fafc';
            } else {
              scBuyerInput.placeholder = 'Enter amount';
              scBuyerInput.readOnly = false;
              scBuyerInput.style.background = '';
            }
          }
        }
        // Apply master SC toggle if present (enable/disable SC fields)
        if(scMasterToggle && typeof prefs.scMasterToggle !== 'undefined'){
          scMasterToggle.checked = !!prefs.scMasterToggle;
          try{ updateScMasterEnabled(scMasterToggle.checked, true); }catch(e){}
        }
        console.log('Loaded toggle prefs', prefs);
        return prefs;
      }catch(e){ console.warn('loadTogglePrefs failed', e); return null; }
    }

    // Enable/disable all SC-related inputs based on master toggle
    function updateScMasterEnabled(enabled, skipSave) {
      console.log('🔧 updateScMasterEnabled called, enabled:', enabled);
      try{
        const scAreaEl = qs('#scArea');
        const scRateEl = qs('#scRate');
        const scPaidEndEl = qs('#scPaidEnd');
        const scTotalEl = qs('#scTotal');
        const scPerDayEl = qs('#scPerDay');
        const scBuyerInput = qs('#serviceCharge');
        const scAreaLabel = qs('#scAreaLabel');
        const scRateLabel = qs('#scRateLabel');
        const scAreaReqToggle = qs('#scAreaReqToggle');
        const scFieldsMandatory = qs('#scFieldsMandatory');

        console.log('🔧 SC elements found:', { scAreaEl: !!scAreaEl, scRateEl: !!scRateEl, scPaidEndEl: !!scPaidEndEl });

        // Disable/enable input elements that participate in SC calculation
        if(scAreaEl) { scAreaEl.disabled = !enabled; scAreaEl.style.opacity = enabled ? '1' : '0.5'; }
        if(scRateEl) { scRateEl.disabled = !enabled; scRateEl.style.opacity = enabled ? '1' : '0.5'; }
        if(scPaidEndEl) { scPaidEndEl.disabled = !enabled; scPaidEndEl.style.opacity = enabled ? '1' : '0.5'; }
        
        // Grey out labels when disabled
        if(scAreaLabel) scAreaLabel.style.opacity = enabled ? '1' : '0.5';
        if(scRateLabel) scRateLabel.style.opacity = enabled ? '1' : '0.5';
        
        // Uncheck/check the "Req" toggles for consistency
        if(scAreaReqToggle) { scAreaReqToggle.checked = enabled; scAreaReqToggle.disabled = !enabled; }
        if(scFieldsMandatory) { scFieldsMandatory.checked = enabled; scFieldsMandatory.disabled = !enabled; }

        if(!enabled) {
          // Clear calculated outputs but ENABLE buyer input for manual entry
          if(scTotalEl) { scTotalEl.value = ''; scTotalEl.style.opacity = '0.5'; }
          if(scPerDayEl) { scPerDayEl.value = ''; scPerDayEl.style.opacity = '0.5'; }
          if(scBuyerInput){ 
            // Do NOT clear the value during initialization - preserve restored manual entry
            if(!isInitializing) {
              scBuyerInput.value = ''; 
            }
            scBuyerInput.readOnly = false; 
            scBuyerInput.placeholder = 'Enter amount';
            scBuyerInput.style.background = ''; 
            scBuyerInput.style.opacity = '1'; 
          }
        } else {
          // Restore opacity and recalculate
          if(scTotalEl) scTotalEl.style.opacity = '1';
          if(scPerDayEl) scPerDayEl.style.opacity = '1';
          if(scBuyerInput) scBuyerInput.style.opacity = '1';
          // Recalculate and set buyer input readonly based on existing auto-mode
          try{ calculateServiceCharge(); }catch(e){/*ignore*/}
          if(scBuyerInput){
            const auto = typeof isScBuyerAutoMode === 'function' ? isScBuyerAutoMode() : true;
            if(auto){ scBuyerInput.readOnly = true; scBuyerInput.placeholder = 'Auto-calc'; scBuyerInput.style.background = '#f8fafc'; }
            else { scBuyerInput.readOnly = false; scBuyerInput.placeholder = 'Enter amount'; scBuyerInput.style.background = ''; }
          }
        }

        console.log('🔧 SC fields updated, disabled:', !enabled);
        if(!skipSave){ try{ if(typeof saveTogglePrefs === 'function') saveTogglePrefs(); }catch(e){} }
      }catch(e){ console.warn('updateScMasterEnabled error', e); }
    }

    // Attach listeners to persist toggles immediately when changed
    try{
      const attachToggleListeners = () => {
        ['#scAreaReqToggle','#scFieldsMandatory','#scBuyerAutoMode','#scMasterToggle'].forEach(sel=>{
          const el = qs(sel);
          if(el && !el.__rs_toggle_listener_attached){
            el.addEventListener('change', () => {
              // Keep UI consistent
              if(sel === '#scAreaReqToggle'){
                const label = qs('#scAreaLabel'); const area = qs('#scArea');
                if(label && area) { label.textContent = el.checked ? 'Unit Area (sq.ft) *' : 'Unit Area (sq.ft)'; area.required = el.checked; }
              }
              if(sel === '#scFieldsMandatory'){
                const label = qs('#scRateLabel'); const rate = qs('#scRate');
                  if(label && rate){ 
                    label.textContent = '$/sq.ft'; 
                    rate.required = el.checked; 
                  const note = qs('#scRateNote');
                  if(!el.checked){
                    // hide input and show note
                    rate.style.display = 'none';
                    if(note) note.style.display = 'inline-block';
                  } else {
                    rate.style.display = '';
                    if(note) note.style.display = 'none';
                    // Try to restore last saved rate if present
                    try{
                      const raw = localStorage.getItem(TOGGLE_PREFS_KEY);
                      if(raw){ const prefs = JSON.parse(raw); if(prefs && typeof prefs.scRate !== 'undefined' && prefs.scRate !== null){ rate.value = (prefs.scRate !== undefined && prefs.scRate !== null) ? String(prefs.scRate) : (rate.value || '6'); } }
                    }catch(e){/*ignore*/}
                  }
                }
              }
              if(sel === '#scBuyerAutoMode'){
                const input = qs('#serviceCharge');
                if(input){ if(el.checked){ input.placeholder='Auto-calc'; input.readOnly=true; input.style.background='#f8fafc'; } else { input.placeholder='Enter amount'; input.readOnly=false; input.style.background=''; } }
              }
              if(sel === '#scMasterToggle'){
                const enabled = !!el.checked;
                try{ updateScMasterEnabled(enabled); }catch(e){ console.warn('updateScMasterEnabled failed', e); }
              }
              saveTogglePrefs();
            });
            el.__rs_toggle_listener_attached = true;
          }
        });
      };
      // Run immediately and also after loadState/restoreState runs (safe to call multiple times)
      attachToggleListeners();
    }catch(e){ console.warn('Failed to attach toggle listeners', e); }

    // Ensure master toggle has a direct listener (robust fallback)
    try{
      const masterEl = qs('#scMasterToggle');
      console.log('🔧 Master toggle element:', masterEl);
      if(masterEl && !masterEl.__rs_master_listener){
        masterEl.addEventListener('change', () => {
          console.log('🔧 Master toggle changed, checked:', masterEl.checked);
          try{ updateScMasterEnabled(masterEl.checked); }catch(e){ console.error('updateScMasterEnabled error:', e); }
          try{ if(typeof saveTogglePrefs === 'function') saveTogglePrefs(); }catch(e){}
        });
        masterEl.__rs_master_listener = true;
        console.log('🔧 Master toggle listener attached');
      }
    }catch(e){ console.warn('Failed to attach master toggle listener', e); }

    // Ensure SC Rate stays within valid range 6-20 (allows decimals)
    try{
      const scRateEl = qs('#scRate');
      if(scRateEl && !scRateEl.__rs_sc_listener){
        const clampRate = () => {
          let v = Number(scRateEl.value || 0);
          if(isNaN(v)) v = 6;
          // Allow decimals, just clamp to range 6-20 but preserve entered precision
          if(v < 6) v = 6;
          if(v > 20) v = 20;
          // Do not force rounding here; keep the user's exact value
          if(String(scRateEl.value) !== String(v)) scRateEl.value = v;
          // Recalculate and mark dirty
          try{ calculateServiceCharge(); }catch(e){console.warn('calculateServiceCharge failed', e);}
          try{ markDocsDirty(); }catch(e){}
          try{ queueAutosave(); }catch(e){}
          try{ if(typeof saveTogglePrefs === 'function') saveTogglePrefs(); }catch(e){}
        };
        scRateEl.addEventListener('change', clampRate);
        scRateEl.addEventListener('input', () => {
          // allow typing but keep within range on blur/change
          const val = scRateEl.value;
          if(val === '') return;
          // if out of range during typing, don't aggressively clamp here
        });
        scRateEl.addEventListener('blur', clampRate);
        scRateEl.__rs_sc_listener = true;
      }
    }catch(e){ console.warn('Failed to attach scRate listener', e); }

    function clearSavedState() {
      try {
        localStorage.removeItem(STORAGE_KEY);
        currentCaseId = null;
        currentCaseOriginalKey = null;
        setLastAutosaveTimestamp(null);
        updateAutosaveMeta();
        setAutosaveIndicator('saved','Autosave reset');
      } catch(e) {
        console.error('Clear saved state failed:', e);
      }
    }

    // Debounced auto-save
    const debouncedSave = debounce(() => {
      console.log('🔄 debouncedSave triggered, currentCaseId:', currentCaseId);
      markAutosaveSaving();
      saveState();
    }, 900);
    function queueAutosave(){
      if(isInitializing) {
        console.log('⏸️ queueAutosave BLOCKED - isInitializing=true');
        return; // Skip autosave during initialization
      }
      console.log('⚡ queueAutosave called, currentCaseId:', currentCaseId);
      markDocsDirty();
      markAutosavePending();
      debouncedSave();
    }

    // Helpers
    function daysInclusive(s,e){
      const sd = new Date(s), ed = new Date(e);
      if(isNaN(sd) || isNaN(ed)) return 0;
      return Math.round((ed - sd) / 86400000) + 1;
    }
    function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }
    function sanitizeString(input) { return input ? input.trim().replace(/[<>&'"]/g, '') : ''; }
    function sanitizeNumber(input) { 
      const raw = String(input ?? '');
      const cleaned = raw.replace(/,/g, '').replace(/[^\d.-]/g, '');
      if(!cleaned.trim()) return 0;
      const parsed = Number(cleaned);
      return Math.max(0, isNaN(parsed) ? 0 : parsed); 
    }
    function sanitizeDate(input) { return input || ''; }
    function showToast(message) {
      const toast = qs('#toast'); toast.textContent = message; toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }
    
    // ========================================
    // AI Verification - Copy data for AI check
    // ========================================
    function copyForAiVerification() {
      const leaseStartVal = leaseStart?.value || '';
      const leaseEndVal = leaseEnd?.value || '';
      const handoverVal = handoverDate?.value || '';
      const rentVal = sanitizeNumber(rentInput?.value);
      const scVal = sanitizeNumber(serviceCharge?.value);
      const depositVal = sanitizeNumber(securityDeposit?.value);
      
      // Collect cheque data
      const rentalCount = clamp(Number(rentalCountSel?.value || 0), 0, MAX_CHEQUES);
      let clearedTotal = 0;
      let unclearedTotal = 0;
      
      for(let i = 1; i <= rentalCount; i++) {
        const amt = sanitizeNumber(qs(`#rentChq${i}`)?.value);
        const cleared = qs(`#rentChq${i}Cleared`)?.checked || false;
        if(amt > 0) {
          if(cleared) clearedTotal += amt;
          else unclearedTotal += amt;
        }
      }
      
      const prompt = `Calculate rental settlement:

  INPUTS:
  - Lease: ${leaseStartVal} to ${leaseEndVal}
  - Handover: ${handoverVal}
  - Total Contract Rent (AED): ${rentVal.toLocaleString()}
  - PDC (uncleared cheques handed to Buyer): AED ${unclearedTotal.toLocaleString()}
  - Mgt. Service Charge: AED ${scVal.toLocaleString()} (Buyer's portion to pay)
  - Security Deposit: AED ${depositVal.toLocaleString()} (to be returned to Buyer)

  FORMULA (follow exactly):
  1. Total Days = (Lease End - Lease Start) + 1
  2. Seller Days = (Handover - Lease Start) + 1 (handover day belongs to Seller)
  3. Buyer Days = Total Days - Seller Days
  4. Daily Rent = Total Contract Rent ÷ Total Days
  5. Buyer Rent = Daily Rent × Buyer Days (this is what Buyer owes for their portion)
  6. Rent Adjustment = Buyer Rent - PDC
    (Buyer receives PDC cheques, so subtract from what they owe)
  7. NET = Rent Adjustment + Security Deposit - Service Charge
    - ADD Security Deposit (Seller returns this to Buyer)
    - SUBTRACT Service Charge (Buyer pays their portion to Seller)

  If NET is positive → Seller pays Buyer
  If NET is negative → Buyer pays Seller

  IMPORTANT: ${unclearedTotal > 0 ? `Besides the NET cash amount, Seller must also hand over the PDC cheques (AED ${unclearedTotal.toLocaleString()}) to Buyer.` : 'No PDC cheques to hand over.'}`;

      navigator.clipboard.writeText(prompt.trim()).then(() => {
        showToast('📋 Copied! Paste into ChatGPT or Claude');
      }).catch(() => {
        const textarea = document.createElement('textarea');
        textarea.value = prompt.trim();
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        showToast('📋 Copied! Paste into ChatGPT or Claude');
      });
    }

    // ========================================
    // Service Charge Auto-Calculator
    // ========================================
    // Formula (Corrected SC Reimbursement Method):
    // 1. SC Paid Period End: The last day the seller has paid SC for
    // 2. Handover Date: The day the buyer takes ownership
    // 3. Buyer Responsibility Period: From day after handover to SC Paid Period End
    //    - Buyer ownership starts: day after handover (handover + 1)
    //    - Buyer reimburses until: SC Paid Period End
    // 4. Daily SC = Annual SC / 365
    // 5. Buyer SC Portion = Daily SC × Buyer Responsibility Days
    // Note: Buyer reimburses seller only for the days the seller already paid
    function calculateServiceCharge() {
      // Check if SC Master Toggle is disabled - if so, don't touch the serviceCharge field at all
      const scMasterEnabled = qs('#scMasterToggle')?.checked ?? false;
      
      const area = sanitizeNumber(qs('#scArea')?.value);
      const rate = sanitizeNumber(qs('#scRate')?.value);
      const scTotalEl = qs('#scTotal');
      const scPerDayEl = qs('#scPerDay');
      const serviceChargeEl = qs('#serviceCharge');
      
      // Check auto mode FIRST before any calculations
      const autoMode = isScBuyerAutoMode();
      
      // If SC Master is disabled, preserve manual entry and exit early
      if(!scMasterEnabled) {
        console.log('📊 calculateServiceCharge: SC Master disabled, preserving manual entry');
        return;
      }
      
      // If in manual mode, never touch the serviceCharge field - just update total/daily SC
      console.log('📊 calculateServiceCharge called:', { area, rate, autoMode, scMasterEnabled });

      // Respect user toggles: if Unit Area or SC Rate are NOT required,
      // do not calculate Annual Service Charge and do not assume a rate.
      const scAreaRequired = qs('#scAreaReqToggle')?.checked ?? true;
      const scRateRequired = qs('#scFieldsMandatory')?.checked ?? true;
      console.log('📊 Toggles:', { scAreaRequired, scRateRequired });
      
      if (!scAreaRequired || !scRateRequired) {
        console.log('📊 Toggles not required, clearing fields');
        if (scTotalEl) scTotalEl.value = '';
        if (scPerDayEl) scPerDayEl.value = '';
        // Only clear serviceCharge if in AUTO mode AND not during initialization
        if (autoMode && serviceChargeEl && !isInitializing) {
          serviceChargeEl.value = '';
        }
        updateScValueFlag();
        return;
      }
      
      // Get SC Paid Period End and handover date
      const scPaidEndVal = qs('#scPaidEnd')?.value;
      const handoverVal = qs('#handoverDate')?.value;
      console.log('📊 Dates:', { scPaidEndVal, handoverVal });
      
      if(area > 0 && rate > 0) {
        const annualTotal = area * rate;
        console.log('📊 Annual Total:', annualTotal);
        
        // Display total annual SC
        if(scTotalEl) scTotalEl.value = annualTotal.toLocaleString('en-AE', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        
        // 4. Daily SC (annual basis - always divide by 365)
        const dailySC = annualTotal / 365;
        console.log('📊 Daily SC:', dailySC);
        
        // Display SC per day
        if(scPerDayEl) scPerDayEl.value = dailySC.toLocaleString('en-AE', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        
        // Only auto-calculate buyer's portion if in auto mode (autoMode already captured at top)
        if(autoMode && serviceChargeEl) {
          // Calculate buyer's portion: from day after handover to SC Paid End
          if(scPaidEndVal && handoverVal) {
            try {
              const scPaidEnd = new Date(scPaidEndVal);
              const handoverDate = new Date(handoverVal);
              console.log('📊 Parsed dates:', { scPaidEnd, handoverDate });
              
              // Validate dates
              if(!isNaN(scPaidEnd.getTime()) && !isNaN(handoverDate.getTime())) {
                // Buyer ownership starts the day AFTER handover
                const buyerOwnershipStart = new Date(handoverDate);
                buyerOwnershipStart.setDate(buyerOwnershipStart.getDate() + 1);
                console.log('📊 Buyer starts:', buyerOwnershipStart);
                
                // Calculate buyer responsibility days
                let buyerResponsibilityDays = 0;
                if (scPaidEnd >= buyerOwnershipStart) {
                  const diffTime = scPaidEnd.getTime() - buyerOwnershipStart.getTime();
                  const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                  buyerResponsibilityDays = diffDays + 1; // +1 to include both start and end day
                }
                console.log('📊 Buyer days:', buyerResponsibilityDays);
                
                if(buyerResponsibilityDays > 0 && buyerResponsibilityDays <= 400) {
                  const buyerPortion = Math.round(dailySC * buyerResponsibilityDays * 100) / 100;
                  console.log('📊 Buyer portion:', buyerPortion);
                  serviceChargeEl.value = buyerPortion.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                } else {
                  console.log('📊 Days out of range:', buyerResponsibilityDays);
                  serviceChargeEl.value = '';
                }
              } else {
                console.log('📊 Invalid dates');
                serviceChargeEl.value = '';
              }
            } catch(e) {
              console.warn('SC calculation error:', e);
              serviceChargeEl.value = '';
            }
          } else {
            console.log('📊 Missing dates - scPaidEndVal or handoverVal empty');
            serviceChargeEl.value = '';
          }
        }
      } else {
        console.log('📊 Area or rate is 0');
        if(scTotalEl) scTotalEl.value = '';
        if(scPerDayEl) scPerDayEl.value = '';
        // Only clear serviceCharge if in AUTO mode AND not during initialization
        if(autoMode && serviceChargeEl && !isInitializing) {
          serviceChargeEl.value = '';
        }
      }
      // Update flag visibility after calculation
      updateScValueFlag();
    }
    
    // Show/hide flag indicator when Buyer SC Portion has a value
    function updateScValueFlag() {
      const scInput = qs('#serviceCharge');
      const flag = qs('#scValueFlag');
      if(!flag) return;
      const hasValue = scInput && scInput.value && scInput.value.trim() !== '' && scInput.value !== '0' && scInput.value !== '0.00';
      flag.classList.toggle('visible', hasValue);
    }
    
    // Show/hide flag indicator when Handover/Cutoff Date has a value
    function updateCutoffValueFlag() {
      const cutoffInput = qs('#handoverDate');
      const flag = qs('#cutoffValueFlag');
      if(!flag) return;
      const hasValue = cutoffInput && cutoffInput.value && cutoffInput.value.trim() !== '';
      flag.classList.toggle('visible', hasValue);
    }
    
    // Show/hide flag indicator when SC Paid Period End has a value
    function updateScPaidEndFlag() {
      const scPaidEndInput = qs('#scPaidEnd');
      const flag = qs('#scPaidEndFlag');
      if(!flag) return;
      const hasValue = scPaidEndInput && scPaidEndInput.value && scPaidEndInput.value.trim() !== '';
      flag.classList.toggle('visible', hasValue);
    }
    
    // Also update flag on manual input changes
    qs('#serviceCharge')?.addEventListener('input', updateScValueFlag);
    qs('#serviceCharge')?.addEventListener('change', updateScValueFlag);
    qs('#handoverDate')?.addEventListener('input', updateCutoffValueFlag);
    qs('#handoverDate')?.addEventListener('change', updateCutoffValueFlag);
    qs('#scPaidEnd')?.addEventListener('input', updateScPaidEndFlag);
    qs('#scPaidEnd')?.addEventListener('change', updateScPaidEndFlag);
    
    // ========================================
    // Building SC Rate Storage (links building name to SC rate)
    // ========================================
    const BUILDING_RATES_KEY = 'rentalSettlement_buildingRates';
    
    function getBuildingRates() {
      try {
        return JSON.parse(localStorage.getItem(BUILDING_RATES_KEY)) || {};
      } catch(e) { return {}; }
    }
    
    function saveBuildingRate(buildingNameVal, rate) {
      if(!buildingNameVal || !rate) return;
      const key = buildingNameVal.trim().toLowerCase();
      if(!key) return;
      const rates = getBuildingRates();
      rates[key] = { 
        name: buildingNameVal.trim(), 
        rate: parseFloat(rate) 
      };
      localStorage.setItem(BUILDING_RATES_KEY, JSON.stringify(rates));
    }
    
    function getBuildingRate(buildingNameVal) {
      if(!buildingNameVal) return null;
      const key = buildingNameVal.trim().toLowerCase();
      if(!key) return null;
      const rates = getBuildingRates();
      const entry = rates[key];
      return entry ? entry.rate : null;
    }
    
    function setupBuildingRateSync() {
      const buildingInput = qs('#buildingName');
      const scRateInput = qs('#scRate');
      
      if(buildingInput) {
        // When building name changes, auto-fill SC rate if known
        const handleBuildingChange = () => {
          const building = buildingInput.value.trim();
          // If user explicitly locked the SC rate inside the field, do not auto-fill
          try { if(localStorage.getItem('rs_scRate_lock_field') === '1') return; } catch(e) {}
          const savedRate = getBuildingRate(building);
          // Auto-fill rate if: we have a saved rate AND (field is empty OR not from saved case)
          if(savedRate && scRateInput && !scRateFromSavedCase && !isInitializing) {
            // Always fill if empty, or show a subtle indicator if different
            if(!scRateInput.value || sanitizeNumber(scRateInput.value) === 0) {
              scRateInput.value = (typeof savedRate === 'number') ? String(savedRate) : savedRate;
              calculateServiceCharge();
              queueAutosave();
            }
          }
          // Reset the flag after first building change (user is now working on this case)
          scRateFromSavedCase = false;
        };
        buildingInput.addEventListener('change', handleBuildingChange);
        // Also trigger on input to catch datalist selections
        buildingInput.addEventListener('input', () => {
          // Debounce to avoid too many calls
          clearTimeout(buildingInput._rateTimeout);
          buildingInput._rateTimeout = setTimeout(handleBuildingChange, 300);
        });
      }
      
      if(scRateInput && buildingInput) {
        // When SC rate changes and building is set, save the rate for that building
        scRateInput.addEventListener('change', () => {
          const building = buildingInput.value.trim();
          const rate = sanitizeNumber(scRateInput.value);
          if(building && rate > 0) {
            saveBuildingRate(building, rate);
            // Refresh datalist to show updated rates
            updateBuildingDatalist();
          }
        });
      }
    }
    
    function setupServiceChargeCalculator() {
      const scArea = qs('#scArea');
      const scRate = qs('#scRate');
      const scRateLockInside = qs('#scRateLockInside');
      const SC_RATE_LOCK_KEY_FIELD = 'rs_scRate_lock_field';
      const SC_RATE_LOCK_VALUE_FIELD = 'rs_scRate_lock_value';
      const handoverDateEl = qs('#handoverDate');
      const scPaidEndEl = qs('#scPaidEnd');
      
      if(scArea) scArea.addEventListener('input', () => { calculateServiceCharge(); queueAutosave(); });
      if(scRate) scRate.addEventListener('input', () => { calculateServiceCharge(); queueAutosave(); });
      // Inline lock inside the scRate field: keep number unchanged while checked
      function applyFieldLock(locked){
        try{
          if(locked){
            localStorage.setItem(SC_RATE_LOCK_KEY_FIELD, '1');
            localStorage.setItem(SC_RATE_LOCK_VALUE_FIELD, (scRate?.value||'').toString());
            if(scRate) scRate.readOnly = true;
            scRateFromSavedCase = true;
          } else {
            localStorage.removeItem(SC_RATE_LOCK_KEY_FIELD);
            localStorage.removeItem(SC_RATE_LOCK_VALUE_FIELD);
            if(scRate) scRate.readOnly = false;
            scRateFromSavedCase = false;
          }
        } catch(e){ console.warn('applyFieldLock failed', e); }
      }
      function loadFieldLock(){
        try{
          const locked = localStorage.getItem(SC_RATE_LOCK_KEY_FIELD) === '1';
          const val = localStorage.getItem(SC_RATE_LOCK_VALUE_FIELD);
          if(locked){
            if(scRate) scRate.value = val || scRate.value;
            if(scRateLockInside) scRateLockInside.checked = true;
            if(scRate) scRate.readOnly = true;
            scRateFromSavedCase = true;
          }
        } catch(e){ console.warn('loadFieldLock failed', e); }
      }
      if(scRateLockInside){
        scRateLockInside.addEventListener('change', (e)=>{
          const checked = !!e.target.checked;
          applyFieldLock(checked);
          queueAutosave();
        });
      }
      // Update persisted locked value when user changes the scRate while locked (rare, but keep in sync)
      if(scRate) scRate.addEventListener('change', ()=>{ try{ if(localStorage.getItem(SC_RATE_LOCK_KEY_FIELD) === '1') localStorage.setItem(SC_RATE_LOCK_VALUE_FIELD, (scRate?.value||'').toString()); }catch(e){} });
      // Load any persisted inline lock on init
      loadFieldLock();
      // Recalculate when dates change
      if(handoverDateEl) handoverDateEl.addEventListener('input', calculateServiceCharge);
      if(scPaidEndEl) {
        scPaidEndEl.addEventListener('input', () => { 
          // Mark as manually set when user directly edits the field
          if(!isInitializing) scPaidEndManuallySet = true;
          calculateServiceCharge(); 
          queueAutosave(); 
        });
      }
      
      // Setup building-rate sync
      setupBuildingRateSync();
    }
    // ========================================
    // End Service Charge Calculator
    // ========================================
    
    // ========================================
    // Sender Name Persistence (global across all cases)
    // ========================================
    const SENDER_NAME_KEY = 'rentalSettlement_senderName';
    
    function loadSenderName() {
      const saved = localStorage.getItem(SENDER_NAME_KEY);
      if(saved && commSenderName && !commSenderName.value) {
        commSenderName.value = saved;
      }
    }
    
    function saveSenderName() {
      if(commSenderName && commSenderName.value.trim()) {
        localStorage.setItem(SENDER_NAME_KEY, commSenderName.value.trim());
      }
    }
    
    function setupSenderNameSync() {
      if(commSenderName) {
        commSenderName.addEventListener('change', saveSenderName);
        commSenderName.addEventListener('blur', saveSenderName);
        loadSenderName();
      }
    }
    // ========================================
    // End Sender Name Persistence
    // ========================================

    // ========================================
    // SC Fields Mandatory Toggle (independent for Unit Area and SC Rate)
    // ========================================
    
    function setupScMandatoryToggle() {
      const toggleArea = qs('#scAreaReqToggle');
      const toggleRate = qs('#scFieldsMandatory');
      const scAreaLabel = qs('#scAreaLabel');
      const scRateLabel = qs('#scRateLabel');
      const scArea = qs('#scArea');
      const scRate = qs('#scRate');
      
      if(!scAreaLabel || !scRateLabel || !scArea || !scRate) return;
      
      function updateAreaLabel() {
        const isMandatory = toggleArea?.checked ?? true;
        scAreaLabel.textContent = isMandatory ? 'Unit Area (sq.ft) *' : 'Unit Area (sq.ft)';
        scArea.required = isMandatory;
        queueHealthPanelRefresh();
        queueAutosave(); // Save toggle state
      }
      
      function updateRateLabel() {
        const isMandatory = toggleRate?.checked ?? true;
        scRateLabel.textContent = '$/sq.ft';
        scRate.required = isMandatory;
        queueHealthPanelRefresh();
        queueAutosave(); // Save toggle state
      }
      
      if(toggleArea) toggleArea.addEventListener('change', updateAreaLabel);
      if(toggleRate) toggleRate.addEventListener('change', updateRateLabel);
      
      // Apply initial state from current checkbox values
      updateAreaLabel();
      updateRateLabel();
    }
    
    function isScFieldsMandatory() {
      const toggle = qs('#scFieldsMandatory') || qs('#scAreaReqToggle');
      return toggle ? toggle.checked : true; // Default to mandatory
    }
    // ========================================
    // End SC Fields Mandatory Toggle
    // ========================================

    // ========================================
    // SC Buyer Portion Auto/Manual Toggle
    // ========================================
    
    function setupScBuyerAutoToggle() {
      const toggle = qs('#scBuyerAutoMode');
      const scBuyerInput = qs('#serviceCharge');
      
      if(!toggle || !scBuyerInput) return;
      
      function updateMode() {
        const isAuto = toggle.checked;
        if(isAuto) {
          scBuyerInput.placeholder = 'Auto-calc';
          scBuyerInput.readOnly = true;
          scBuyerInput.style.background = '#f8fafc';
          // Trigger recalculation
          calculateServiceCharge();
        } else {
          scBuyerInput.placeholder = 'Enter amount';
          scBuyerInput.readOnly = false;
          scBuyerInput.style.background = '';
        }
        queueAutosave(); // Save toggle state
      }
      
      toggle.addEventListener('change', updateMode);
      updateMode(); // Apply initial state
    }
    
    function isScBuyerAutoMode() {
      const toggle = qs('#scBuyerAutoMode');
      return toggle ? toggle.checked : true; // Default to auto
    }
    // ========================================
    // End SC Buyer Portion Auto/Manual Toggle
    // ========================================
    
    let autosaveResetTimer = null;
    function setLastAutosaveTimestamp(ts){
      if(!ts){
        lastAutosaveTimestamp = null;
        return;
      }
      const parsed = ts instanceof Date ? ts : new Date(ts);
      if(isNaN(parsed)) {
        lastAutosaveTimestamp = null;
        return;
      }
      lastAutosaveTimestamp = parsed;
    }
    function formatAutosaveTimestamp(date){
      if(!date) return '';
      const d = date instanceof Date ? date : new Date(date);
      if(isNaN(d)) return '';
      const now = new Date();
      const isToday = d.toDateString() === now.toDateString();
      const time = d.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});
      if(isToday) return time;
      return `${d.toLocaleDateString('en-GB',{day:'2-digit',month:'short'})} ${time}`;
    }
    function updateAutosaveMeta(contextLabel){
      if(!autosaveMeta) return;
      if(!lastAutosaveTimestamp){
        autosaveMeta.textContent = 'No autosave yet';
        return;
      }
      const formatted = formatAutosaveTimestamp(lastAutosaveTimestamp);
      if(!formatted){
        autosaveMeta.textContent = 'Autosave time unavailable';
        return;
      }
      autosaveMeta.textContent = contextLabel ? `${contextLabel} • ${formatted}` : `Last saved ${formatted}`;
    }
    function setAutosaveIndicator(state, message) {
      if(!autosaveStatus) return;
      autosaveStatus.classList.remove('pending','saving','saved','error');
      autosaveStatus.classList.add(state);
      if(autosaveLabel) {
        autosaveLabel.textContent = message;
      }
      if(autosaveResetTimer) clearTimeout(autosaveResetTimer);
      if(state === 'saved') {
        autosaveResetTimer = setTimeout(() => {
          autosaveStatus.classList.remove('pending','saving','error');
          autosaveStatus.classList.add('saved');
          if(autosaveLabel) {
            autosaveLabel.textContent = 'Autosave ready';
          }
        }, 5000);
      }
    }
    function markAutosavePending(){ setAutosaveIndicator('pending','Unsaved changes…'); }
    function markAutosaveSaving(){ setAutosaveIndicator('saving','Saving…'); }
    function markAutosaveSaved(message, opts = {}){
      const timestamp = opts.timestamp || new Date();
      setLastAutosaveTimestamp(timestamp);
      updateAutosaveMeta(message || null);
      const label = message || 'Saved';
      setAutosaveIndicator('saved', label);
      // Clear unsaved changes flag when saved
      if(typeof hasUnsavedChanges !== 'undefined') hasUnsavedChanges = false;
    }
    
    // Helper to get UTC timestamp of midnight for comparison (avoids timezone issues)
    function getUtcDayTimestamp(dateStr) {
        const d = new Date(dateStr);
        if (isNaN(d.getTime())) return NaN;
        // Date.UTC returns milliseconds since 1970/01/01 00:00:00 UTC
        return Date.UTC(d.getFullYear(), d.getMonth(), d.getDate());
    }

    /* UI builders */
    function makeRentalCard(i){
      const el = document.createElement('div');
      el.className = 'chq outstanding';
      el.id = `rentChq${i}Item`;
      el.innerHTML = `
        <div class="label">Chq ${i}</div>
        <input type="date" id="rentChq${i}Date" class="small">
        <input type="number" id="rentChq${i}" step="0.01" placeholder="Amount">
        <div class="cheque-info-row">
          <input type="text" id="rentChq${i}Bank" class="small cheque-bank" placeholder="Bank name" list="bankHistoryList" autocomplete="off">
          <input type="text" id="rentChq${i}Number" class="small cheque-number" placeholder="Cheque #">
        </div>
        <div class="cheque-meta">
          <label class="cheque-cleared-label">
            <span class="sr-only">Mark cheque cleared</span>
            <input type="checkbox" id="rentChq${i}Cleared" aria-label="Mark cheque cleared">
            <span class="cheque-cleared-icon" aria-hidden="true"></span>
          </label>
          <input type="date" id="rentChq${i}ClearDate" class="small cheque-clear-date" aria-label="Clear date">
        </div>`;
      setTimeout(() => {
        const d = qs(`#rentChq${i}Date`), c = qs(`#rentChq${i}ClearDate`);
        const bankInput = qs(`#rentChq${i}Bank`);
        const numberInput = qs(`#rentChq${i}Number`);
        const clearedCb = qs(`#rentChq${i}Cleared`);
        const amtInput = qs(`#rentChq${i}`);
        
        // Apply currency formatting to cheque amount
        if (amtInput) formatCurrencyInput(amtInput);
        
        if(d && c && clearedCb) {
          d.addEventListener('change', (e) => { 
            if(e.target.value && clearedCb.checked) c.value = e.target.value; 
            debouncedUpdateRentalTotals(); 
            syncUnclearedToPDC();
            validateChequeDate(d, el);
            detectChequeGaps();
          });
          d.addEventListener('input', () => { 
            syncUnclearedToPDC(); 
            validateChequeDate(d, el);
            detectChequeGaps();
          });

          clearedCb.addEventListener('change', (e) => {
            c.value = e.target.checked ? d.value : '';
            if(e.target.checked){ 
                el.classList.add('cleared'); 
                el.classList.remove('outstanding'); 
            } else {
                el.classList.remove('cleared'); 
                el.classList.add('outstanding');
            }
            debouncedUpdateRentalTotals(); 
            syncUnclearedToPDC();
            queueAutosave();
            queueChequeUpdate(); // Live recalculate
          });
          // Also listen to amount change
          qs(`#rentChq${i}`).addEventListener('input', () => {
            debouncedUpdateRentalTotals();
            syncUnclearedToPDC();
            checkWarnings();
            queueAutosave();
            queueChequeUpdate(); // Live recalculate
          });
          if(bankInput){
            bankInput.addEventListener('input', () => {
              syncUnclearedToPDC();
              queueAutosave();
            });
            bankInput.addEventListener('blur', () => {
              addBankToHistory(bankInput.value);
            });
          }
          if(numberInput){
            numberInput.addEventListener('input', () => {
              syncUnclearedToPDC();
              queueAutosave();
              checkDuplicateCheques();
            });
          }
        }
      }, 0);
      return el;
    }
    
    // PDC cards now need full structure since they are populated dynamically
    function makePdcCard(i, date, amount, meta = {}){
      const safeBank = (meta.bank || '').trim();
      const safeCheque = (meta.chequeNumber || '').trim();
      const el = document.createElement('div');
      el.className = 'chq outstanding';
      el.id = `pdc${i}Item`;
      el.dataset.bank = safeBank;
      el.dataset.chequeNumber = safeCheque;
      el.innerHTML = `
        <div class="label">Chq ${i}</div>
        <input type="date" id="pdc${i}Date" class="small" readonly>
        <input type="number" id="pdc${i}" step="0.01" placeholder="Amount" readonly>
        <div class="cheque-info-row">
          <input type="text" class="small cheque-bank" placeholder="Bank name" readonly>
          <input type="text" class="small cheque-number" placeholder="Cheque #" readonly>
        </div>
        `;
      const dateInput = el.querySelector(`#pdc${i}Date`);
      const amountInput = el.querySelector(`#pdc${i}`);
      const bankInput = el.querySelector('.cheque-bank');
      const numberInput = el.querySelector('.cheque-number');
      if(dateInput) dateInput.value = date || '';
      if(amountInput) amountInput.value = amount || '';
      if(bankInput) bankInput.value = safeBank;
      if(numberInput) numberInput.value = safeCheque;
      return el;
    }

    // When many PDCs are present, render a compact table (lighter DOM) instead of many card nodes
    function renderPdcCompact(pdcs) {
      const table = document.createElement('table');
      table.className = 'pdc-compact';
      table.style.width = '100%';
      table.innerHTML = `
        <thead><tr><th style="width:8%">#</th><th style="width:22%">Date</th><th style="width:20%">Amount (AED)</th><th style="width:25%">Bank</th><th style="width:25%">Cheque #</th></tr></thead>
        <tbody></tbody>`;
      const tbody = table.querySelector('tbody');
      pdcs.forEach((pdc, idx) => {
        const tr = document.createElement('tr');
        tr.className = 'chq outstanding';
        tr.id = `pdc_compact_${idx+1}`;
        tr.dataset.bank = (pdc.bank || '').trim();
        tr.dataset.chequeNumber = (pdc.chequeNumber || '').trim();

        // Build cells with editable inputs
        const labelTd = document.createElement('td');
        labelTd.className = 'label';
        labelTd.textContent = `Chq ${idx+1}`;

        const dateTd = document.createElement('td');
        const dateInput = document.createElement('input');
        dateInput.type = 'date';
        dateInput.value = pdc.date || '';
        dateTd.appendChild(dateInput);

        const amountTd = document.createElement('td');
        const amtInput = document.createElement('input');
        amtInput.type = 'number'; amtInput.step = '0.01'; amtInput.value = pdc.amt || '';
        amtInput.className = 'pdc-amount';
        amountTd.appendChild(amtInput);

        const bankTd = document.createElement('td');
        const bankInput = document.createElement('input');
        bankInput.type = 'text'; bankInput.className = 'cheque-bank'; bankInput.value = pdc.bank || '';
        bankTd.appendChild(bankInput);

        const numTd = document.createElement('td');
        const numInput = document.createElement('input');
        numInput.type = 'text'; numInput.className = 'cheque-number'; numInput.value = pdc.chequeNumber || '';
        numTd.appendChild(numInput);

        tr.appendChild(labelTd);
        tr.appendChild(dateTd);
        tr.appendChild(amountTd);
        tr.appendChild(bankTd);
        tr.appendChild(numTd);

        // Attach listeners to keep behaviour consistent with card UI
        dateInput.addEventListener('change', () => {
          // keep dataset in sync for PDF/export
          tr.dataset.rawDate = dateInput.value || '';
          updatePdcTotal();
          queueAutosave();
          queueChequeUpdate();
        });

        amtInput.addEventListener('input', () => {
          try { formatCurrencyInput(amtInput); } catch(e) {}
          updatePdcTotal();
          markDocsDirty();
          queueAutosave();
          queueChequeUpdate();
        });

        bankInput.addEventListener('input', () => {
          tr.dataset.bank = (bankInput.value || '').trim();
          queueAutosave();
        });

        numInput.addEventListener('input', () => {
          tr.dataset.chequeNumber = (numInput.value || '').trim();
          queueAutosave();
          try { checkDuplicateCheques(); } catch(e) {}
        });

        tbody.appendChild(tr);
      });
      return table;
    }

    // Rental compact renderer (used when there are many rental cheques)
    function isRentalCompactMode() {
      const c = clamp(Number(rentalCountSel.value||0), 0, MAX_CHEQUES);
      return c > RENT_VIRTUALIZE_THRESHOLD;
    }

    function renderRentalCompact(cheques) {
      rentalChequesRow.innerHTML = '';
      const table = document.createElement('table');
      table.className = 'rental-compact';
      table.style.width = '100%';
      table.innerHTML = `
        <thead><tr><th style="width:6%">#</th><th style="width:18%">Date</th><th style="width:16%">Amount (AED)</th><th style="width:8%">Clr</th><th style="width:12%">Clr Date</th><th style="width:20%">Bank</th><th style="width:20%">Cheque #</th></tr></thead>
        <tbody></tbody>`;
      const tbody = table.querySelector('tbody');
      rentalChequesData = rentalChequesData || [];
      // Ensure array length
      for(let i=0;i<cheques.length;i++){
        const chq = cheques[i] || { date: '', amount: '', cleared: false, clearDate: '', bank: '', chequeNumber: '' };
        rentalChequesData[i] = Object.assign({}, rentalChequesData[i] || {}, {
          date: chq.date || '',
          amount: chq.amount || chq.amt || chq.AMT || chq.amt || '',
          cleared: !!chq.cleared,
          clearDate: chq.clearDate || '',
          bank: chq.bank || '',
          chequeNumber: chq.chequeNumber || chq.chequeNum || ''
        });
      }

      rentalChequesData.forEach((chq, idx) => {
        const tr = document.createElement('tr');
        tr.className = 'chq outstanding';
        tr.id = `rent_compact_${idx+1}`;
        tr.dataset.index = String(idx);

        const labelTd = document.createElement('td');
        labelTd.className = 'label';
        labelTd.textContent = `Chq ${idx+1}`;

        const dateTd = document.createElement('td');
        const dateInput = document.createElement('input');
        dateInput.type = 'date';
        dateInput.value = chq.date || '';
        dateTd.appendChild(dateInput);

        const amountTd = document.createElement('td');
        const amtInput = document.createElement('input');
        amtInput.type = 'number'; amtInput.step = '0.01'; amtInput.value = chq.amount || '';
        amtInput.className = 'rental-amount';
        amountTd.appendChild(amtInput);

        const clrTd = document.createElement('td');
        const clrInput = document.createElement('input');
        clrInput.type = 'checkbox'; clrInput.checked = !!chq.cleared;
        clrTd.appendChild(clrInput);

        const clrDateTd = document.createElement('td');
        const clrDateInput = document.createElement('input');
        clrDateInput.type = 'date'; clrDateInput.value = chq.clearDate || '';
        clrDateTd.appendChild(clrDateInput);

        const bankTd = document.createElement('td');
        const bankInput = document.createElement('input'); bankInput.type = 'text'; bankInput.className = 'cheque-bank'; bankInput.value = chq.bank || '';
        bankTd.appendChild(bankInput);

        const numTd = document.createElement('td');
        const numInput = document.createElement('input'); numInput.type = 'text'; numInput.className = 'cheque-number'; numInput.value = chq.chequeNumber || '';
        numTd.appendChild(numInput);

        tr.appendChild(labelTd);
        tr.appendChild(dateTd);
        tr.appendChild(amountTd);
        tr.appendChild(clrTd);
        tr.appendChild(clrDateTd);
        tr.appendChild(bankTd);
        tr.appendChild(numTd);

        // listeners keep rentalChequesData in sync
        const idxRef = idx;
        dateInput.addEventListener('change', () => {
          rentalChequesData[idxRef].date = dateInput.value || '';
          queueAutosave(); queueChequeUpdate(); syncUnclearedToPDC();
        });
        amtInput.addEventListener('input', () => {
          try { formatCurrencyInput(amtInput); } catch(e) {}
          rentalChequesData[idxRef].amount = amtInput.value || '';
          updateRentalTotal(); queueAutosave(); queueChequeUpdate(); syncUnclearedToPDC();
        });
        clrInput.addEventListener('change', () => {
          rentalChequesData[idxRef].cleared = !!clrInput.checked;
          if(clrInput.checked && !rentalChequesData[idxRef].clearDate) rentalChequesData[idxRef].clearDate = rentalChequesData[idxRef].date || '';
          if(clrInput.checked) tr.classList.add('cleared'); else tr.classList.remove('cleared');
          updateRentalTotal(); queueAutosave(); queueChequeUpdate(); syncUnclearedToPDC();
        });
        clrDateInput.addEventListener('change', () => { rentalChequesData[idxRef].clearDate = clrDateInput.value || ''; queueAutosave(); });
        bankInput.addEventListener('input', () => { rentalChequesData[idxRef].bank = bankInput.value.trim(); queueAutosave(); });
        numInput.addEventListener('input', () => { rentalChequesData[idxRef].chequeNumber = numInput.value.trim(); queueAutosave(); try{ checkDuplicateCheques(); }catch(e){} });

        tbody.appendChild(tr);
      });

      rentalChequesRow.appendChild(table);
      // Refresh totals and health
      updateRentalTotal();
      queueHealthPanelRefresh();
    }

    function initChequesUI(){
      rentalChequesRow.innerHTML = ''; 
      pdcChequesRow.innerHTML = ''; // PDC row cleared, cards are added by syncUnclearedToPDC
      for(let i=1;i<=MAX_CHEQUES;i++){
        rentalChequesRow.appendChild(makeRentalCard(i));
      }
      rentalCountSel.value = String(DEFAULT_RENTAL_COUNT); 
      pdcCountSel.value = String(DEFAULT_PDC_COUNT); // PDC Count is now managed by the sync function
      updateRentalCount(); 
      // Do NOT call updatePdcCount() or updatePdcTotal() here, let syncUnclearedToPDC handle it.
      syncUnclearedToPDC();
    }

    function updateRentalCount(){
      const c = clamp(Number(rentalCountSel.value||0), 0, MAX_CHEQUES);
      // If compact mode should be used for large counts, render compact table
      if(c > RENT_VIRTUALIZE_THRESHOLD) {
        // Build a lightweight data array from existing DOM (if present) or preserve existing data
        const cheques = [];
        for(let i=1;i<=c;i++){
          const date = qs(`#rentChq${i}Date`)?.value || '';
          const amount = qs(`#rentChq${i}`)?.value || '';
          const cleared = qs(`#rentChq${i}Cleared`)?.checked || false;
          const clearDate = qs(`#rentChq${i}ClearDate`)?.value || '';
          const bank = qs(`#rentChq${i}Bank`)?.value || '';
          const chequeNumber = qs(`#rentChq${i}Number`)?.value || '';
          cheques.push({ date, amount, cleared, clearDate, bank, chequeNumber });
        }
        renderRentalCompact(cheques);
      } else {
        for(let i=1;i<=MAX_CHEQUES;i++){
          const item = qs(`#rentChq${i}Item`);
          if(!item) continue;
          if(i<=c){ item.style.display='flex'; }
          else {
            item.style.display='none';
            // Clear values of hidden cheques
            qs(`#rentChq${i}`).value=''; qs(`#rentChq${i}Date`).value='';
            qs(`#rentChq${i}Cleared`).checked=false;
            qs(`#rentChq${i}ClearDate`).value=''; 
            const bankField = qs(`#rentChq${i}Bank`);
            const numberField = qs(`#rentChq${i}Number`);
            if(bankField) bankField.value='';
            if(numberField) numberField.value='';
          }
        }
      }
      debouncedUpdateRentalTotals(); 
      syncUnclearedToPDC();
      checkDuplicateCheques();
    }

    // This function is now OBSOLETE as PDC count is dynamic, but we keep the element reset logic
    function updatePdcCount(){
      // We don't control PDC count directly via select box anymore, it's driven by syncUnclearedToPDC
      updatePdcTotal();
    }

    function computeRentalTotals(){
      const c = clamp(Number(rentalCountSel.value||0), 0, MAX_CHEQUES);
      let total = 0, cleared = 0, onHandCount = 0;
      if(isRentalCompactMode() && Array.isArray(rentalChequesData) && rentalChequesData.length > 0){
        for(let i=0;i<c;i++){
          const chq = rentalChequesData[i] || {};
          const amt = Number(chq.amount || 0);
          total += amt;
          if(chq.cleared) cleared += amt;
          else if(amt>0) onHandCount++;
        }
      } else {
        for(let i=1;i<=c;i++){
          const amt = Number(qs(`#rentChq${i}`).value||0);
          total += amt;
          if(qs(`#rentChq${i}Cleared`).checked) cleared += amt;
          else if(amt>0) onHandCount++;
        }
      }
      return { total, cleared, outstanding: total - cleared, onHandCount, count: c };
    }

    function updateRentalTotal(){
      const { total, cleared, outstanding, onHandCount, count } = computeRentalTotals();
      rentalTotalDisplay.textContent = money(total);
      rentalClearedDisplay.textContent = money(cleared);
      rentalOutstandingDisplay.textContent = money(outstanding);
      rentalSummaryMini.textContent = `Total: ${money(total)} • Cleared: ${money(cleared)}`;
      if(rentalChipCount){
        const label = count === 1 ? 'cheque' : 'cheques';
        const headline = count > 0 ? `${count} ${count === 1 ? 'Cheque' : 'Cheques'}` : '0 Cheques';
        rentalChipCount.textContent = headline;
      }
      if(rentalChipTotal){
        rentalChipTotal.textContent = money(total);
      }
      queueHealthPanelRefresh();
    }
    const debouncedUpdateRentalTotals = debounce(updateRentalTotal, 180);

    function updatePdcTotal(){
      let total = 0;
      qsa('#pdcChequesRow input[type="number"]').forEach(input => {
        total += Number(input.value || 0);
      });
      pdcTotalDisplay.textContent = money(total);
      const cardCount = qsa('#pdcChequesRow .chq').length;
      if(pdcChipCount){
        const label = cardCount === 1 ? 'Cheque' : 'Cheques';
        pdcChipCount.textContent = cardCount ? `${cardCount} ${label}` : 'No Cheques';
      }
      if(pdcChipTotal){
        pdcChipTotal.textContent = money(total);
      }
      markDocsDirty();
      queueHealthPanelRefresh();
      return total;
    }

    function hasSectionHealthInput(){
      const keyFields = [
        buildingName.value,
        unitNo.value,
        tenantName.value,
        leaseStart.value,
        leaseEnd.value,
        handoverDate.value,
        rentInput.value,
        serviceCharge.value,
        securityDeposit.value
      ];
      const hasKeyField = keyFields.some(val => typeof val === 'string' ? val.trim() !== '' : Boolean(val));
      if(hasKeyField) return true;
      const chequeValueFilled = qsa('#rentalChequesRow input[type="number"]').some(input => Number(input.value || 0) > 0);
      const chequeDateFilled = qsa('#rentalChequesRow input[type="date"]').some(input => Boolean(input.value));
      const pdcValueFilled = qsa('#pdcChequesRow input[type="number"]').some(input => Number(input.value || 0) > 0);
      return chequeValueFilled || chequeDateFilled || pdcValueFilled;
    }

    function buildSectionHealthData(){
      const entries = [];
      const rent = sanitizeNumber(rentInput.value);
      const sc = sanitizeNumber(serviceCharge.value);
      const dep = sanitizeNumber(securityDeposit.value);
      const scArea = sanitizeNumber(qs('#scArea')?.value);
      const scRate = sanitizeNumber(qs('#scRate')?.value);
      const scTotal = scArea * scRate;
      const ls = leaseStart.value;
      const le = leaseEnd.value;
      const ho = handoverDate.value;
      const leaseProvided = Boolean(ls && le);
      const leaseValid = leaseProvided && new Date(ls) <= new Date(le);
      const leaseDays = leaseValid ? daysInclusive(ls, le) : 0;

      if(!leaseProvided){
        entries.push({ id:'lease', title:'Lease Dates', severity:'todo', detail:'Add lease start and end dates to unlock calculations.' });
      } else if(!leaseValid){
        entries.push({ id:'lease', title:'Lease Dates', severity:'critical', detail:'Lease start occurs after the lease end date.' });
      } else {
        let severity = 'ok';
        let detail = `${leaseDays} day contract`;
        const leaseMonths = Math.round(leaseDays / 30.44);
        
        // Valid lease durations (considering leap years):
        // Quarterly: Q1=90-91, Q2=91, Q3=92, Q4=92
        // Half-yearly: H1=181-182, H2=184
        // Full year: 365-366
        // Also consider 2-year leases: 730-731
        const validDurations = [
          // Quarters
          { min: 90, max: 92, label: '1 quarter' },
          // Half years
          { min: 181, max: 184, label: '6 months' },
          // Full year
          { min: 365, max: 366, label: '1 year' },
          // 2 years
          { min: 730, max: 731, label: '2 years' }
        ];
        
        const matchedDuration = validDurations.find(d => leaseDays >= d.min && leaseDays <= d.max);
        const isStandardDuration = matchedDuration !== undefined;
        
        if(!isStandardDuration){
          severity = 'warn';
          detail += ` (~${leaseMonths} months)`;
        } else {
          detail += ` (${matchedDuration.label})`;
        }
        entries.push({ id:'lease', title:'Lease Dates', severity, detail });
        
        // Add separate unusual duration warning
        if(!isStandardDuration){
          let durationLabel = 'Non-standard';
          if(leaseDays < 90) durationLabel = 'Very short';
          else if(leaseDays < 181) durationLabel = 'Short-term';
          else if(leaseDays < 365) durationLabel = 'Partial year';
          else if(leaseDays > 731) durationLabel = 'Extended';
          
          entries.push({ 
            id:'duration', 
            title:'Unusual Lease Duration', 
            severity:'warn', 
            detail:`${durationLabel} lease: ${leaseDays} days (~${leaseMonths} months). Expected: 90-92 (Q), 181-184 (H), 365-366 (Y), or 730-731 (2Y).`
          });
        }
      }

      const startDate = leaseProvided ? new Date(ls) : null;
      const endDate = leaseProvided ? new Date(le) : null;
      const hoDate = ho ? new Date(ho) : null;
      const handoverInsideWindow = leaseValid && hoDate && startDate && endDate && hoDate >= startDate && hoDate <= endDate;

      if(!ho){
        entries.push({ id:'handover', title:'Handover Date', severity:'todo', detail:'Enter the handover / cutoff date.' });
      } else if(!leaseProvided){
        entries.push({ id:'handover', title:'Handover Date', severity:'info', detail:'Add lease dates to validate the handover position.' });
      } else if(!leaseValid){
        entries.push({ id:'handover', title:'Handover Date', severity:'info', detail:'Fix lease dates to unlock handover checks.' });
      } else if(!handoverInsideWindow){
        entries.push({ id:'handover', title:'Handover Date', severity:'critical', detail:'Handover falls outside the lease window.' });
      } else {
        const sellerDays = Math.max(0, daysInclusive(ls, ho));
        const buyerDays = Math.max(0, leaseDays - sellerDays);
        const daysFromEdges = Math.min(
          Math.abs(Math.round((hoDate - startDate) / 86400000)),
          Math.abs(Math.round((endDate - hoDate) / 86400000))
        );
        let severity = 'ok';
        let detail = `${fmtDateForTable(ho)} • Buyer ${buyerDays}d`;
        if(daysFromEdges < 7){
          severity = 'warn';
          detail = `Very close to lease edge (${daysFromEdges}d) — buyer ${buyerDays}d`;
        }
        entries.push({ id:'handover', title:'Handover Date', severity, detail });
      }

      const rentalTotals = computeRentalTotals();
      if(rent <= 0 && rentalTotals.total <= 0){
        entries.push({ id:'cheques', title:'Rental Cheques', severity:'info', detail:'Enter total contract rent and cheque amounts to benchmark totals.' });
      } else if(rentalTotals.total <= 0){
        entries.push({ id:'cheques', title:'Rental Cheques', severity:'todo', detail:'Add cheque dates and amounts received by the seller.' });
      } else {
        const diff = rentalTotals.total - rent;
        const absDiff = Math.abs(diff);
        const diffPercent = rent ? (absDiff / rent) * 100 : 0;
        let severity = 'ok';
        let detail = 'Cheques match total contract rent ✓';
        if(diffPercent > 5){
          severity = 'critical';
          if(diff > 0) {
            detail = `Cheques exceed rent by ${money(absDiff)} — Seller received extra`;
          } else {
            detail = `Cheques short by ${money(absDiff)} — Seller received less`;
          }
        } else if(diffPercent > 1){
          severity = 'warn';
          if(diff > 0) {
            detail = `Cheques ${money(absDiff)} over rent — Seller received extra`;
          } else {
            detail = `Cheques ${money(absDiff)} under rent — Seller received less`;
          }
        }
        if(rentalTotals.outstanding > 0){
          detail += ` • ${money(rentalTotals.outstanding)} outstanding`;
        }
        entries.push({ id:'cheques', title:'Rental Cheques', severity, detail });
      }

      const leaseReady = handoverInsideWindow;
      const totalDays = leaseValid ? leaseDays : 0;
      const sellerDays = leaseReady ? Math.max(0, daysInclusive(ls, ho)) : 0;
      const buyerDays = leaseReady ? Math.max(0, totalDays - sellerDays) : 0;
      const buyerMonths = buyerDays > 0 ? Math.max(1, Math.round(buyerDays / 30)) : 0;
      const pdcCount = Number(pdcCountSel.value || 0);
      let pdcTotal = 0;
      qsa('#pdcChequesRow input[type="number"]').forEach(input => {
        pdcTotal += Number(input.value || 0);
      });
      if(!leaseReady){
        entries.push({ id:'pdc', title:'Cheques Handover', severity:'info', detail:'Set lease + handover dates to check buyer period.' });
      } else if(buyerMonths === 0){
        if(pdcCount > 0){
          entries.push({ id:'pdc', title:'Cheques Handover', severity:'info', detail:`No buyer rent remaining but ${pdcCount} cheque${pdcCount>1?'s':''} selected.` });
        } else {
          entries.push({ id:'pdc', title:'Cheques Handover', severity:'ok', detail:'No outstanding buyer rent period.' });
        }
      } else if(pdcCount === 0){
        entries.push({ id:'pdc', title:'Cheques Handover', severity:'critical', detail:`Buyer has ~${buyerMonths} month span but no uncleared cheques are ready.` });
      } else {
        const rentalChequesCount = Math.max(1, Number(rentalCountSel.value || 0));
        const monthsPerCheque = 12 / rentalChequesCount;
        const expectedCheques = Math.max(1, Math.round(buyerMonths / monthsPerCheque));
        let severity = 'ok';
        let detail = `${pdcCount} cheque${pdcCount>1?'s':''} ready (${money(pdcTotal)})`;
        if(pdcCount > expectedCheques + 1){
          severity = 'warn';
          detail = `Remaining cheque${pdcCount>1?'s':''} to hand over: ${pdcCount}, but based on dates we think it should be ${expectedCheques}`;
        } else if(pdcCount < Math.max(1, expectedCheques - 1)){
          severity = 'warn';
          detail = `Remaining cheque${pdcCount>1?'s':''} to hand over: ${pdcCount}, but based on dates we think it should be ${expectedCheques}`;
        }
        entries.push({ id:'pdc', title:'Cheques Handover', severity, detail });
      }

      if(rent <= 0 && sc <= 0){
        entries.push({ id:'service', title:'Service Charge', severity:'info', detail:'Enter service charge details to validate.' });
      } else if(sc <= 0){
        entries.push({ id:'service', title:'Service Charge', severity:'todo', detail:'Add the management service charge amount.' });
      } else {
        let severity = 'ok';
        let detail = '';
        
        // Check if SC fields are available for validation
        const scFieldsOn = isScFieldsMandatory();
        
        if(scFieldsOn && scArea > 0 && scRate > 0) {
          // Calculate Annual SC
          const annualSC = scArea * scRate;
          
          // Validate Annual SC is reasonable (typical range for Dubai)
          // For a 1000-2000 sq.ft unit at 10-18 AED/sq.ft, annual is typically 10,000-36,000 AED
          if(annualSC < 5000) {
            severity = 'warn';
            detail = `Annual SC of ${money(annualSC)} seems low — verify area and rate.`;
          } else if(annualSC > 80000) {
            severity = 'warn';
            detail = `Annual SC of ${money(annualSC)} seems high — verify area and rate.`;
          } else {
            detail = `Annual SC: ${money(annualSC)} (${scArea.toLocaleString()} sq.ft × AED ${scRate}/sq.ft). Buyer portion: ${money(sc)}`;
          }
        } else {
          // Manual SC entry - just show the amount
          detail = `Buyer SC portion: ${money(sc)}`;
        }
        
        entries.push({ id:'service', title:'Service Charge', severity, detail });
      }

      // SC Calculator fields check (if enabled)
      if(isScFieldsMandatory()) {
        if(scArea <= 0) {
          entries.push({ id:'scArea', title:'Unit Area', severity:'todo', detail:'Enter the unit area in sq.ft for SC calculation.' });
        }
        if(scRate <= 0) {
          entries.push({ id:'scRate', title:'SC Rate', severity:'todo', detail:'Enter the SC rate ($/sq.ft) for this building.' });
        } else if(scRate < 6 || scRate > 25) {
          entries.push({ id:'scRate', title:'SC Rate', severity:'warn', detail:`Rate of AED ${scRate}/sq.ft is outside typical Dubai range (6-20).` });
        }
      }

      if(rent <= 0 && dep <= 0){
        entries.push({ id:'deposit', title:'Security Deposit', severity:'info', detail:'Enter rent and deposit to see coverage.' });
      } else if(dep <= 0){
        entries.push({ id:'deposit', title:'Security Deposit', severity:'todo', detail:'Add the security deposit amount held.' });
      } else {
        const depPercent = rent ? (dep / rent) * 100 : 0;
        let severity = 'ok';
        let detail = `${depPercent.toFixed(1)}% of rent (${money(dep)})`;
        if(depPercent < 4 || depPercent > 12){
          severity = 'warn';
          detail = `${depPercent.toFixed(1)}% — outside typical 5-10% band.`;
          if(depPercent < 3 || depPercent > 15){
            severity = 'critical';
          }
        }
        entries.push({ id:'deposit', title:'Security Deposit', severity, detail });
      }

      // Unit Area (sq.ft) validation - only if mandatory or has value
      const scMandatory = isScFieldsMandatory();
      if(scArea <= 0){
        if(scMandatory){
          entries.push({ id:'scArea', title:'Unit Area (sq.ft)', severity:'todo', detail:'Enter the unit area in square feet.' });
        }
        // If not mandatory and empty, skip this entry
      } else {
        let severity = 'ok';
        let detail = `${scArea.toLocaleString()} sq.ft`;
        if(scArea < 200){
          severity = 'warn';
          detail = `${scArea.toLocaleString()} sq.ft — unusually small unit`;
        } else if(scArea > 10000){
          severity = 'warn';
          detail = `${scArea.toLocaleString()} sq.ft — unusually large, verify`;
        }
        entries.push({ id:'scArea', title:'Unit Area (sq.ft)', severity, detail });
      }

      // $/sq.ft validation - only if mandatory or has value AND toggle is checked
      const scRateToggleChecked = qs('#scFieldsMandatory')?.checked ?? true;
      if(scRate <= 0 || !scRateToggleChecked){
        if(scMandatory && scRateToggleChecked){
          entries.push({ id:'scRate', title:'$/sq.ft', severity:'todo', detail:'Enter the service charge rate per sq.ft.' });
        }
        // If not mandatory or toggle unchecked, skip this entry entirely - do not assume any rate
      } else {
        let severity = 'ok';
        let detail = `AED ${qs('#scRate')?.value ?? scRate}/sq.ft`;
        if(scRate < 5){
          severity = 'warn';
          detail = `AED ${qs('#scRate')?.value ?? scRate}/sq.ft — unusually low rate`;
        } else if(scRate > 50){
          severity = 'warn';
          detail = `AED ${qs('#scRate')?.value ?? scRate}/sq.ft — unusually high rate`;
        } else if(scRate > 100){
          severity = 'critical';
          detail = `AED ${scRate.toFixed(2)}/sq.ft — verify, rate seems too high`;
        }
        // Cross-check: Total SC vs calculated
        if(scArea > 0 && scTotal > 0){
          detail += ` • Total: ${money(scTotal)}`;
        }
        entries.push({ id:'scRate', title:'$/sq.ft', severity, detail });
      }

      // SC Calculation consistency check
      if(scArea > 0 && scRate > 0 && sc > 0){
        // Check if SC buyer portion makes sense relative to total SC
        const scPercent = (sc / scTotal) * 100;
        if(scPercent > 100){
          entries.push({ id:'scCalc', title:'SC Calculation', severity:'critical', detail:`Buyer portion (${money(sc)}) exceeds total SC (${money(scTotal)}) — verify inputs` });
        } else if(scPercent < 1){
          entries.push({ id:'scCalc', title:'SC Calculation', severity:'warn', detail:`Buyer portion is only ${scPercent.toFixed(1)}% of total SC — very short buyer period` });
        }
      }

      // Add cheque import warnings to health panel
      if(chequeImportWarnings.length > 0){
        chequeImportWarnings.forEach((warning, idx) => {
          const cleanWarning = warning.replace(/[❌⚠️]/g, '').replace(/\n/g, ' • ').trim();
          entries.push({
            id: `importWarning${idx}`,
            title: 'Cheque Import Alert',
            severity: warning.includes('❌') ? 'critical' : 'warn',
            detail: cleanWarning
          });
        });
      }

      return entries;
    }

    function renderHealthCard(entry){
      const severityClass = entry.severity || 'info';
      const badge = HEALTH_LABELS[severityClass] || severityClass.toUpperCase();
      const isDismissed = dismissedHealthItems.has(entry.id);
      const dismissable = ['warn', 'todo', 'critical'].includes(severityClass);
      const dismissBtn = dismissable ? `<button class="health-dismiss-btn ${isDismissed ? 'dismissed' : ''}" onclick="toggleHealthDismiss('${entry.id}')" title="${isDismissed ? 'Show again' : 'Acknowledge'}">${isDismissed ? '↩' : '✓'}</button>` : '';
      return `
        <div class="health-card ${severityClass} ${isDismissed ? 'is-dismissed' : ''}" data-id="${entry.id}">
          <div class="health-text">
            <div class="health-title">${entry.title}</div>
            <div class="health-detail">${entry.detail}</div>
          </div>
          <div class="health-actions">
            <span class="health-chip">${badge}</span>
            ${dismissBtn}
          </div>
        </div>`;
    }

    function updateSectionHealth(){
      const hasInput = hasSectionHealthInput();
      const entries = hasInput ? buildSectionHealthData() : [];
      
      // Sort entries by severity: critical > warn > todo > info > ok
      const severityOrder = { critical: 0, warn: 1, todo: 2, info: 3, ok: 4 };
      entries.sort((a, b) => (severityOrder[a.severity] ?? 5) - (severityOrder[b.severity] ?? 5));
      
      if(healthModalBody){
        if(entries.length === 0){
          healthModalBody.innerHTML = `
            <div class="health-card info">
              <div class="health-text">
                <div class="health-title">No data yet</div>
                <div class="health-detail">Start entering contract details to see live checks.</div>
              </div>
              <span class="health-chip">INFO</span>
            </div>`;
        } else {
          healthModalBody.innerHTML = entries.map(renderHealthCard).join('');
        }
      }
      if(healthStatusPill){
        const actionable = entries.filter(entry => ['warn','critical','todo'].includes(entry.severity) && !dismissedHealthItems.has(entry.id));
        if(actionable.length > 0){
          healthStatusPill.textContent = `${actionable.length} check${actionable.length>1?'s':''}`;
          healthStatusPill.classList.add('has-issues');
          healthStatusPill.classList.remove('is-clear');
        } else if(entries.length === 0){
          healthStatusPill.textContent = 'Waiting for data';
          healthStatusPill.classList.remove('has-issues','is-clear');
        } else {
          healthStatusPill.textContent = 'All clear';
          healthStatusPill.classList.add('is-clear');
          healthStatusPill.classList.remove('has-issues');
        }
      }
    }

    function openHealthModal(){
      if(!healthModal) return;
      updateSectionHealth();
      healthModal.classList.add('show');
      healthModal.setAttribute('aria-hidden','false');
    }

    function closeHealthModal(){
      if(!healthModal) return;
      healthModal.classList.remove('show');
      healthModal.setAttribute('aria-hidden','true');
    }

    // Toggle dismiss state for a health item
    window.toggleHealthDismiss = function(itemId) {
      if(dismissedHealthItems.has(itemId)) {
        dismissedHealthItems.delete(itemId);
      } else {
        dismissedHealthItems.add(itemId);
      }
      updateSectionHealth();
    };

    // Clear all dismissed items (for new case or reset)
    function clearDismissedHealthItems() {
      dismissedHealthItems.clear();
    }

    // Case Notes Modal Functions
    function updateNotesIconGlow(){
      const hasNotes = caseNotesTextarea && caseNotesTextarea.value.trim().length > 0;
      if(caseNotesBtn) {
        if(hasNotes) {
          caseNotesBtn.classList.add('has-notes');
          caseNotesBtn.title = 'Case Notes (Has Notes) - Not Exported';
        } else {
          caseNotesBtn.classList.remove('has-notes');
          caseNotesBtn.title = 'Case Notes (Internal - Not Exported)';
        }
      }
    }

    function openNotesModal(){
      if(!notesModal) return;
      notesModal.classList.add('show');
      notesModal.setAttribute('aria-hidden','false');
      if(caseNotesTextarea) caseNotesTextarea.focus();
    }

    function closeNotesModal(){
      if(!notesModal) return;
      notesModal.classList.remove('show');
      notesModal.setAttribute('aria-hidden','true');
      updateNotesIconGlow();
      saveState(); // Auto-save when closing notes modal
    }

    function clearCaseNotes(){
      if(caseNotesTextarea) {
        caseNotesTextarea.value = '';
        updateNotesIconGlow();
      }
    }

    function syncUnclearedToPDC(){
      const rentalCount = clamp(Number(rentalCountSel.value||0), 0, MAX_CHEQUES);
      const pdcsToTransfer = [];

      // 1. Find all uncleared cheques (support compact/virtual mode)
      if(isRentalCompactMode() && Array.isArray(rentalChequesData) && rentalChequesData.length > 0) {
        for(let i=0;i<rentalCount;i++){
          const chq = rentalChequesData[i] || {};
          const amt = Number(chq.amount || 0);
          const dateStr = chq.date || '';
          const bankName = chq.bank || '';
          const chequeNumber = chq.chequeNumber || '';
          if(!chq.cleared && amt > 0) pdcsToTransfer.push({ amt, date: dateStr, original_chq_num: i+1, bank: bankName, chequeNumber });
        }
      } else {
        for(let i=1; i<=rentalCount; i++){
          const cb = qs(`#rentChq${i}Cleared`);
          const amt = Number(qs(`#rentChq${i}`).value||0);
          const dateStr = qs(`#rentChq${i}Date`).value;
          const bankInput = qs(`#rentChq${i}Bank`);
          const numberInput = qs(`#rentChq${i}Number`);
          const bankName = bankInput ? bankInput.value.trim() : '';
          const chequeNumber = numberInput ? numberInput.value.trim() : '';
          
          // Logic: If NOT cleared AND amount > 0, transfer it. Date is irrelevant now.
          if(!cb.checked && amt > 0){
            pdcsToTransfer.push({ amt, date: dateStr, original_chq_num: i, bank: bankName, chequeNumber });
          }
        }
      }
      
      // 2. Clear and rebuild the PDC UI
      pdcChequesRow.innerHTML = '';

      const pdcCount = pdcsToTransfer.length;
      pdcCountSel.value = String(pdcCount); // Update the select box to reflect reality

      if (pdcCount === 0) {
        pdcChequesRow.innerHTML = '<div class="muted pdc-empty">No uncleared cheques to hand over. Mark cheques as cleared to remove them from this list.</div>';
      } else if (pdcCount > PDC_VIRTUALIZE_THRESHOLD) {
        // For large lists render a compact table view (lighter DOM) to improve performance
        const compact = renderPdcCompact(pdcsToTransfer);
        pdcChequesRow.appendChild(compact);
      } else {
        // 3. Populate the PDC section with new cards (default behaviour)
        pdcsToTransfer.forEach((pdc) => {
          const card = makePdcCard(pdc.original_chq_num, pdc.date, pdc.amt, { bank: pdc.bank, chequeNumber: pdc.chequeNumber });
          pdcChequesRow.appendChild(card);
        });
      }
      
      // 4. Update the total
      updatePdcTotal();
      queueHealthPanelRefresh();
      
      // 5. Validate PDC dates (check for past-dated cheques)
      validatePdcDates();
      updateHealthRibbon();
    }

    function updateContractInfo() {
      const ls = leaseStart.value, le = leaseEnd.value, ho = handoverDate.value, r = sanitizeNumber(rentInput.value);
      let totalDays = 0, daily = 0;
      
      if (ls && le) {
        if (new Date(ls) > new Date(le)) leaseStart.style.borderColor = '#ef4444';
        else {
            leaseStart.style.borderColor = '';
            totalDays = daysInclusive(ls, le);
            if (totalDays > 0 && r > 0) daily = r / totalDays;
        }
      }
      qs('#totalDaysDisplay').value = totalDays || '';
      qs('#dailyRentDisplay').value = daily.toFixed(4) || '';
      
      // Update lease duration badge
      const durationBadge = qs('#leaseDurationBadge');
      if (durationBadge) {
        const durationText = durationBadge.querySelector('.duration-text');
        if (totalDays > 0) {
          // Calculate exact months and remaining days
          const exactMonths = Math.floor(totalDays / 30.44);
          const remainingDays = Math.round(totalDays - (exactMonths * 30.44));
          const years = totalDays / 365;
          let label = '';
          let isStandard = false;
          
          // Standard durations (exact or very close)
          if (totalDays >= 365 && totalDays <= 366) {
            label = '1Y';
            isStandard = true;
          } else if (totalDays >= 730 && totalDays <= 731) {
            label = '2Y';
            isStandard = true;
          } else if (totalDays >= 182 && totalDays <= 184) {
            label = '6M';
            isStandard = true;
          } else if (totalDays >= 90 && totalDays <= 92) {
            label = '3M';
            isStandard = true;
          } else if (years >= 1) {
            // More than a year - show years + months + days
            const fullYears = Math.floor(totalDays / 365);
            const daysAfterYears = totalDays - (fullYears * 365);
            const monthsAfterYears = Math.floor(daysAfterYears / 30.44);
            const daysRemainder = Math.round(daysAfterYears - (monthsAfterYears * 30.44));
            
            if (monthsAfterYears === 0) {
              label = `${fullYears}Y`;
            } else {
              // Show years + months (drop days entirely)
              label = `${fullYears}Y ${monthsAfterYears}M`;
            }
          } else {
            // Less than a year - show months + days
            if (remainingDays === 0 || remainingDays > 28) {
              // Close to exact months
              const adjMonths = remainingDays > 28 ? exactMonths + 1 : exactMonths;
              label = `${adjMonths}M`;
              // Mark as standard if it's exactly 1, 2, 3, 6, or 12 months
              isStandard = [1, 2, 3, 6, 12].includes(adjMonths);
            } else {
              // Drop days entirely and show months only
              label = `${exactMonths}M`;
            }
          }
          
          durationText.textContent = label;
          durationBadge.style.display = 'inline-flex';
          durationBadge.classList.toggle('standard', isStandard);
          // Add warning class for unusual durations
          durationBadge.classList.toggle('unusual', !isStandard && label.includes('D'));
        } else {
          durationBadge.style.display = 'none';
        }
      }

      // Visual Timeline Logic
      const sellerBar = qs('#time-seller'), buyerBar = qs('#time-buyer');
      if(ls && le && ho && totalDays > 0) {
        // Calculate seller days up to and including the handover date
        const sellerDays = daysInclusive(ls, ho); 
        // Buyer days start on day after HO, up to LE
        const buyerDays = Math.max(0, totalDays - sellerDays); 
        
        if(sellerDays >= 0 && sellerDays <= totalDays) {
            const sellerPct = (sellerDays / totalDays) * 100;
            const buyerPct = 100 - sellerPct;
            sellerBar.style.width = `${sellerPct}%`;
            buyerBar.style.width = `${buyerPct}%`;

            // Calculate monetary portions based on pro-rata days
            const daily = totalDays ? (r / totalDays) : 0;
            const sellerRent = daily * sellerDays;
            const buyerRent = Math.max(0, r - sellerRent);

            // Always show the day count; if the segment is very narrow, show a short form (e.g. "5d").
            const sellerLabelFull = `Seller (${sellerDays}d • ${money(sellerRent)})`;
            const buyerLabelFull = `Buyer (${buyerDays}d • ${money(buyerRent)})`;
            sellerBar.textContent = sellerPct > 10 ? sellerLabelFull : `${sellerDays}d`;
            buyerBar.textContent = buyerPct > 10 ? buyerLabelFull : `${buyerDays}d`;

            // Add title/tooltip text containing days, dates and monetary portion for accessibility and hover
            if(sellerBar) {
              sellerBar.dataset.tooltip = `${sellerDays} days • ${fmtDateForTable(ls)} → ${fmtDateForTable(ho)} • ${money(sellerRent)}`;
              sellerBar.title = sellerLabelFull;
            }
            const hoDate = new Date(ho);
            const buyerStart = new Date(hoDate.getTime());
            buyerStart.setDate(buyerStart.getDate() + 1);
            const buyerStartMs = buyerStart.getTime();
            const buyerStartStr = !Number.isNaN(buyerStartMs) ? new Date(buyerStartMs).toISOString().split('T')[0] : ho;
            if(buyerBar) {
              buyerBar.dataset.tooltip = buyerDays > 0
                ? `${buyerDays} days • ${fmtDateForTable(buyerStartStr)} → ${fmtDateForTable(le)} • ${money(buyerRent)}`
                : `No buyer period remaining • ${money(buyerRent)}`;
              buyerBar.title = buyerLabelFull;
            }
            qs('#tl-start').textContent = fmtDateForTable(ls);
            qs('#tl-handover').textContent = fmtDateForTable(ho);
            qs('#tl-end').textContent = fmtDateForTable(le);
        }
      } else {
        sellerBar.style.width = '0%'; buyerBar.style.width = '0%';
        qs('#tl-start').textContent = '-'; qs('#tl-handover').textContent = '-'; qs('#tl-end').textContent = '-';
        if(sellerBar) sellerBar.dataset.tooltip = '';
        if(buyerBar) buyerBar.dataset.tooltip = '';
        hideTimelineTooltip();
      }
      
      // Render SC timeline independently (Buyer's SC portion: cutoff+1 → SC Paid Period End)
      try {
        const buyerScVal = sanitizeNumber(qs('#serviceCharge')?.value);
        const scBuyerEl = qs('#sc-buyer');
        const scPaidEndVal = qs('#scPaidEnd')?.value;
        const handoverVal = qs('#handoverDate')?.value;
        const scLabelsEl = qs('#sc-timeline-labels');
        const scTlStart = qs('#sc-tl-start');
        const scTlEnd = qs('#sc-tl-end');
        
        // Reset ribbon first
        if(scBuyerEl) {
          scBuyerEl.style.width = '0%';
          scBuyerEl.textContent = '';
          scBuyerEl.dataset.tooltip = '';
          scBuyerEl.title = '';
        }
        if(scLabelsEl) scLabelsEl.style.display = 'none';
        
        if(scBuyerEl && handoverVal && scPaidEndVal) {
          const cutoffDate = new Date(handoverVal + 'T00:00:00');
          const scEndDate = new Date(scPaidEndVal + 'T00:00:00');
          
          // Validate dates are valid
          if(!isNaN(cutoffDate.getTime()) && !isNaN(scEndDate.getTime())) {
            // Buyer responsibility starts day AFTER cutoff
            const buyerScStart = new Date(cutoffDate);
            buyerScStart.setDate(buyerScStart.getDate() + 1);
            
            // Calculate buyer SC days (cutoff NOT counted, SC paid end IS counted)
            let buyerScDays = 0;
            if(scEndDate >= buyerScStart) {
              const diffMs = scEndDate.getTime() - buyerScStart.getTime();
              buyerScDays = Math.floor(diffMs / (1000 * 60 * 60 * 24)) + 1;
            }
            
            // Show ribbon if we have valid values
            if(buyerScVal > 0 && buyerScDays > 0 && buyerScDays <= 400) {
              scBuyerEl.style.width = '100%';
              const buyerLabelFull = `Buyer SC: ${money(buyerScVal)} • ${buyerScDays} days`;
              scBuyerEl.textContent = buyerLabelFull;
              scBuyerEl.dataset.tooltip = `${money(buyerScVal)} • ${buyerScDays} days (${fmtDateForTable(buyerScStart.toISOString().split('T')[0])} → ${fmtDateForTable(scPaidEndVal)})`;
              scBuyerEl.title = buyerLabelFull;
              
              // Show labels
              if(scLabelsEl) scLabelsEl.style.display = 'flex';
              if(scTlStart) scTlStart.textContent = fmtDateForTable(buyerScStart.toISOString().split('T')[0]);
              if(scTlEnd) scTlEnd.textContent = fmtDateForTable(scPaidEndVal);
            }
          }
        }
      } catch(e) { console.warn('SC timeline render error', e); }
      
      queueHealthPanelRefresh();
    }
    const debouncedUpdateContractInfo = debounce(updateContractInfo, 180);

    /* --- Messages & Calculation --- */
    function generateMessages() {
        if(!lastCalcData) return;
        const { unit, tenant, ho, net, pdcTotal, pdcCount, pdcListText, chequeAnalysis } = lastCalcData;
        const formattedNet = money(Math.abs(net));
        const formattedPDC = money(pdcTotal);
        const buyerName = commBuyerName.value.trim() || 'Buyer';
        const pdcName = commPdcName.value.trim() || 'Colleague';
        const accName = commAccName.value.trim() || 'Finance Team';
        const senderName = commSenderName.value.trim() || '[Your Name]';
        const building = buildingName.value.trim();
        const propertyRef = building ? `${building}, Unit ${unit}` : `Unit ${unit}`;
        
        // Use dynamic cheque labels based on analysis
        const chqLabel = chequeAnalysis?.label || 'PDC'; // already count-aware singular/plural
        const chqPlural = chequeAnalysis?.pluralLabel || 'PDCs'; // always plural for general references
        const chqCount = pdcCount === 1 ? (chequeAnalysis?.shortLabel === 'Past-Dated' ? 'Past-Dated Cheque' : 'PDC') : chqPlural; // count-aware for "N cheques"
        const chqHint = chequeAnalysis?.messageHint || '';
        const pastDatedNote = (chequeAnalysis && chequeAnalysis.pastDatedCount > 0)
          ? `\n\nNote: ${chequeAnalysis.pastDatedCount} past-dated cheque${chequeAnalysis.pastDatedCount>1 ? 's' : ''} detected (may be uncleared).`
          : '';
        // Build explicit composition string for mixed cheque types to avoid ambiguity
        const postCount = chequeAnalysis?.postDatedCount || 0;
        const pastCount = chequeAnalysis?.pastDatedCount || 0;
        const unknownCount = chequeAnalysis?.noDatedCount || 0;
        const totalCheques = (chequeAnalysis && chequeAnalysis.total != null) ? chequeAnalysis.total : (pdcCount || 0);
        const parts = [];
        if(postCount) parts.push(`${postCount} ${postCount===1 ? 'PDC' : 'PDCs'}`);
        if(pastCount) parts.push(`${pastCount} ${pastCount===1 ? 'past-dated cheque' : 'past-dated cheques'}`);
        if(unknownCount) parts.push(`${unknownCount} ${unknownCount===1 ? 'undated cheque' : 'undated cheques'}`);
        const composition = parts.length ? parts.join(' + ') : `${totalCheques} ${totalCheques===1 ? 'cheque' : 'cheques'}`;
        const totalLabel = `${totalCheques} ${totalCheques===1 ? 'cheque' : 'cheques'}`;

        // Build detailed cheque breakdown for buyer message
        let chequeBreakdown = '';
        if (postCount) {
          // Get PDC amounts from lastCalcData or calculate
          const pdcAmounts = [];
          qsa('#pdcChequesRow .chq').forEach((card) => {
            const amtInput = card.querySelector('input[type="number"]');
            const dateInput = card.querySelector('input[type="date"]');
            const amt = Number(amtInput?.value || 0);
            const dateVal = dateInput?.value || '';
            if (amt > 0 && dateVal) {
              const today = new Date();
              today.setHours(0,0,0,0);
              const chqDate = new Date(dateVal);
              if (chqDate >= today) {
                pdcAmounts.push(amt);
              }
            }
          });
          const pdcTotalAmt = pdcAmounts.reduce((a,b) => a+b, 0);
          chequeBreakdown += `• ${postCount} Post-Dated ${postCount === 1 ? 'Cheque (PDC)' : 'Cheques (PDCs)'}: ${money(pdcTotalAmt)}\n`;
        }
        if (pastCount) {
          // Get past-dated amounts
          const pastAmounts = [];
          qsa('#pdcChequesRow .chq').forEach((card) => {
            const amtInput = card.querySelector('input[type="number"]');
            const dateInput = card.querySelector('input[type="date"]');
            const amt = Number(amtInput?.value || 0);
            const dateVal = dateInput?.value || '';
            if (amt > 0 && dateVal) {
              const today = new Date();
              today.setHours(0,0,0,0);
              const chqDate = new Date(dateVal);
              if (chqDate < today) {
                pastAmounts.push(amt);
              }
            }
          });
          const pastTotalAmt = pastAmounts.reduce((a,b) => a+b, 0);
          chequeBreakdown += `• ${pastCount} Past-Dated (Uncleared) ${pastCount === 1 ? 'Cheque' : 'Cheques'}: ${money(pastTotalAmt)}\n`;
        }

        let b = `Subject: Final Settlement Confirmation – ${propertyRef}\n\n`;
        b += `Dear ${buyerName},\n\n`;
        b += `I hope this message finds you well.\n\n`;
        b += `I am writing to confirm the final settlement for ${propertyRef} (Tenant: ${tenant}) following the successful handover completed on ${fmtDateForTable(ho)}.\n\n`;
        b += `SETTLEMENT SUMMARY\n`;
        if (net >= 0) {
          b += `Net Amount Due to You: ${formattedNet}\n`;
          b += `(Payable via rebate cheque)\n\n`;
        } else {
          b += `Net Amount Due from You: ${formattedNet}\n\n`;
        }
        // Include a 'Cheques to Collect' section only when there are cheques
        if (totalCheques > 0) {
          b += `Cheques to Collect:\n`;
          if (chequeBreakdown.trim()) {
            b += chequeBreakdown;
          } else {
            // Fallback to a simple composition line when detailed breakdown isn't available
            b += `• ${composition}: ${formattedPDC}\n`;
          }
          // Only show Total line if there are mixed types (PDCs + past-dated) - avoid redundancy for single type
          if (postCount > 0 && pastCount > 0) {
            b += `\nTotal Cheques: ${totalLabel} | Total Value: ${formattedPDC}\n\n`;
          } else {
            b += `\n`;
          }
        }
        b += `COLLECTION DETAILS\n`;
        // Dynamic collection message based on what's being collected
        let collectionItems = [];
        if (net >= 0) collectionItems.push('rebate cheque');
        if (pdcCount > 0) {
          // Smart cheque description: avoid redundancy for single cheque of one type
          if (pdcCount === 1) {
            // Single cheque - describe by type without repeating count
            if (postCount === 1 && pastCount === 0) {
              collectionItems.push(`PDC (${formattedPDC})`);
            } else if (pastCount === 1 && postCount === 0) {
              collectionItems.push(`uncleared cheque (${formattedPDC})`);
            } else {
              collectionItems.push(`cheque (${formattedPDC})`);
            }
          } else {
            // Multiple cheques - show count
            collectionItems.push(`${pdcCount} cheques (${formattedPDC})`);
          }
        }
        const collectionText = collectionItems.length > 0 ? collectionItems.join(' and ') : 'cheques';
        b += `Please collect your ${collectionText} from our office at your earliest convenience:\n\n`;
        b += `📍 Address:\n`;
        b += `Ayat Tower, R Floor\n`;
        b += `Al Majaz 3, Sharjah, UAE\n\n`;
        b += `📞 Phone: 06 523 3112\n\n`;
        b += `🕒 Office Hours:\n`;
        b += `Monday – Friday: 9:00 AM – 4:00 PM\n`;
        b += `Saturday: 9:00 AM – 1:00 PM\n`;
        b += `Sunday: Closed\n\n`;
        b += `📎 Attachment: Settlement Statement (PDF)\n\n`;
        b += `Should you have any questions or require further clarification, please don't hesitate to contact me.\n\n`;
        b += `Thank you for your attention to this matter.\n\n`;
        b += `Warm regards,\n${senderName}`;
        msgBuyer.value = b;
        qs('#msgBuyerDisplay').textContent = b;

        let p = `Hi ${pdcName},\n\nPlease prepare the following cheques for handover to the Buyer (${buyerName}) for ${propertyRef} (Tenant: ${tenant}).\n\n`;
        p += `📋 ${composition} (Total: ${totalLabel}; ${formattedPDC})`;
        if(chqHint) p += `\n\n⚠️ Note: ${chqHint}`;
        if(pastDatedNote) p += pastDatedNote;
        p += `\n`;
        if(pdcListText) p += `\n📄 Cheque Details:\n${pdcListText}\n`;
        p += `📅 Handover Date: ${fmtDateForTable(ho)}\n\n`;
        p += `📎 Settlement Statement attached for reference.\n\n`;
        p += `Thank you.\n\nBest regards,\n${senderName}`;
        msgPDC.value = p;
        qs('#msgPDCDisplay').textContent = p;

        let a = `Hi ${accName},\n\nKindly process the rental settlement for the following property:\n\n`;
        a += `🏢 Property: ${propertyRef}\n`;
        a += `👤 Tenant: ${tenant}\n`;
        a += `📅 Handover Date: ${fmtDateForTable(ho)}\n\n`;
        a += `━━━━━━━━━━━━━━━━━━━━━━━━━━\n`;
        a += `💰 Net Settlement Amount: **${formattedNet}**\n`;
        a += `━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n`;
        if(net >= 0) {
          a += `✅ Action Required: ISSUE CHEQUE to Buyer\n`;
          a += `👤 Payee: ${buyerName}\n`;
          a += `💵 Amount: ${formattedNet}\n`;
        } else {
          a += `⚠️ Action Required: COLLECT PAYMENT from Buyer\n`;
          a += `👤 Payer: ${buyerName}\n`;
          a += `💵 Amount Due: ${formattedNet}\n`;
        }
        if(pdcCount > 0) {
          a += `\n📋 Cheques to Hand Over: ${composition} (Total: ${totalLabel}; ${formattedPDC})\n`;
        }
        if(pastDatedNote) a += pastDatedNote;
        a += `\n📎 Settlement Statement attached for your records.\n\n`;
        a += `Please confirm once processed.\n\n`;
        a += `Thank you.\n\nBest regards,\n${senderName}`;
        msgAcc.value = a;
        qs('#msgAccDisplay').textContent = a;
    }

    // Silent recalculate - updates results without validation alerts (for live updates)
    function recalculateResults(){
      try {
        const ls = leaseStart.value, le = leaseEnd.value, ho = handoverDate.value;
        const rent = sanitizeNumber(rentInput.value), sc = sanitizeNumber(serviceCharge.value), dep = sanitizeNumber(securityDeposit.value);
        
        // Skip if essential fields are missing
        if(!ls || !le || !ho || rent <= 0) return;
        if(new Date(ls) > new Date(le)) return;
        if(new Date(ho) > new Date(le)) return;

        const totalDays = daysInclusive(ls, le);
        const sellerDays = Math.max(0, daysInclusive(ls, ho));
        const buyerDays = Math.max(0, totalDays - sellerDays);
        
        let pdcTotal = 0;
        let pdcCount = 0;
        let pdcListText = "";
        qsa('#pdcChequesRow input[type="number"]').forEach((input) => {
          const amt = Number(input.value || 0);
          if(amt > 0) {
            pdcTotal += amt;
            pdcCount++;
            const card = input.closest('.chq');
            const dateInput = input.previousElementSibling;
            const cardLabel = card?.querySelector('.label')?.textContent?.replace('(PDC)','').trim() || 'Cheque';
            const bankLabel = card?.dataset.bank || '';
            const chequeNumber = card?.dataset.chequeNumber || '';
            const displayLabel = chequeNumber ? `Cheque ${chequeNumber}` : cardLabel;
            const meta = bankLabel ? ` [${bankLabel}]` : '';
            const formattedDate = fmtDateForTable(dateInput ? dateInput.value : '');
            pdcListText += ` - ${displayLabel}: ${money(amt)} (${formattedDate})${meta}\n`;
          }
        });
        
        const daily = totalDays ? rent / totalDays : 0;
        const sellerRent = daily * sellerDays;
        const buyerRent = rent - sellerRent;
        const adj = buyerRent - pdcTotal;
        const net = Number((adj + dep - sc).toFixed(2));
        
        const chequeAnalysis = analyzeChequeTypes();
        const chequeLabel = chequeAnalysis.label;
        
        // Build SC label with rate if SC fields are required
        const scRateVal = sanitizeNumber(qs('#scRate')?.value || 0);
        const scFieldsOn = isScFieldsMandatory();
        const scLabel = scFieldsOn && scRateVal > 0 
          ? `Less: Management Service Charge @ AED ${scRateVal}/sq.ft`
          : 'Less: Management Service Charge';

        resultsBody.innerHTML = `<tr>
          <td>${fmtDateForTable(ls)}</td><td>${fmtDateForTable(le)}</td><td>${rent.toFixed(2)}</td><td>${totalDays}</td>
          <td class="highlight-seller">${sellerDays}</td><td class="highlight-seller">${sellerRent.toFixed(2)}</td>
          <td class="highlight-buyer">${buyerDays}</td><td class="highlight-buyer">${buyerRent.toFixed(2)}</td>
          <td class="highlight-service">${sc.toFixed(2)}</td><td>${pdcTotal.toFixed(2)}</td>
          <td>${adj.toFixed(2)}</td><td>${dep.toFixed(2)}</td><td class="highlight-total">${net.toFixed(2)}</td>
        </tr>`;

        summaryTotal.textContent = money(Math.abs(net));
        const isSellerPays = net >= 0;
        directionText.textContent = isSellerPays ? 'SELLER PAYS BUYER' : 'BUYER PAYS SELLER';
        directionText.style.color = summaryTotal.style.color = isSellerPays ? '#065f46' : '#b91c1c';
        const directionLabel = isSellerPays ? 'Seller → Buyer' : 'Buyer → Seller';
        const directionClass = isSellerPays ? 'positive' : 'danger';
        notesEl.innerHTML = `
          <div class="note-panel">
            <div class="note-panel-header">
              <div class="note-panel-title">Settlement Breakdown</div>
            </div>
            <div class="note-rows">
              <div class="note-row">
                <span class="note-label">Buyer Rent (Pro-rata)</span>
                <span class="note-value">AED ${buyerRent.toFixed(2)}</span>
              </div>
              <div class="note-row">
                <span class="note-label">Less: ${chequeLabel} Handed Over</span>
                <span class="note-value negative">- AED ${pdcTotal.toFixed(2)}</span>
              </div>
              <div class="note-row">
                <span class="note-label">Add: Security Deposit</span>
                <span class="note-value positive">+ AED ${dep.toFixed(2)}</span>
              </div>
              <div class="note-row">
                <span class="note-label">${scLabel}</span>
                <span class="note-value negative">- AED ${sc.toFixed(2)}</span>
              </div>
              <div class="note-row total">
                <span class="note-label">${directionLabel}</span>
                <span class="note-value note-total ${directionClass}">AED ${Math.abs(net).toFixed(2)}</span>
              </div>
            </div>
          </div>
        `;

        const u = sanitizeString(unitNo.value), t = sanitizeString(tenantName.value);
        const b = sanitizeString(buildingName.value);
        const propertyRef = b ? `${b} - Unit ${u}` : `Unit ${u}`;
        const reconText = `${propertyRef}\nTenant: ${t}\nRent: ${rent}\nSeller Days: ${sellerDays} | Buyer Days: ${buyerDays}\nNet: ${net.toFixed(2)} (${isSellerPays?'Seller Pays':'Buyer Pays'})`;
        copyReconciliation.value = reconText;
        qs('#copyReconciliationDisplay').textContent = reconText;
        
        lastCalcData = { unit: u, tenant: t, ho, net, pdcTotal, pdcCount, pdcListText, chequeAnalysis };
        generateMessages();
        
      } catch (e) { console.error('Recalculate error:', e); }
    }

    function calculate(silentMode = false){
      try {
        // Check if tenant is "empty" or "empty unit" (case insensitive) - skip most validations, no rental cutoff
        const tenantVal = tenantName.value.trim().toLowerCase();
        const isEmptyTenant = tenantVal === 'empty' || tenantVal === 'empty unit';
        
        // Validation: Check if all required fields are filled
        const missingFields = [];
        if(!unitNo.value.trim()) missingFields.push('Unit Number');
        if(!tenantName.value.trim()) missingFields.push('Tenant Name');
        // For "empty" tenant: skip lease dates, rent, security deposit validation
        // But handover date is still needed for SC calculation
        if(!isEmptyTenant) {
          if(!leaseStart.value) missingFields.push('Lease Start');
          if(!leaseEnd.value) missingFields.push('Lease End');
          if(!rentInput.value || sanitizeNumber(rentInput.value) <= 0) missingFields.push('Total Contract Rent (AED)');
          if(!handoverDate.value) missingFields.push('Handover / Cutoff Date');
          if(securityDeposit.value === '' || sanitizeNumber(securityDeposit.value) < 0) missingFields.push('Security Deposit');
        } else {
          // Empty tenant still needs handover date for SC calculation
          if(!handoverDate.value) missingFields.push('Handover / Cutoff Date (for SC calculation)');
        }
        // Only require SC fields if mandatory toggle is on (applies to both empty and non-empty)
        if(isScFieldsMandatory()) {
          if(!qs('#scArea').value || sanitizeNumber(qs('#scArea').value) <= 0) missingFields.push('Unit Area (sq.ft)');
          if(!qs('#scRate').value || sanitizeNumber(qs('#scRate').value) <= 0) missingFields.push('$/sq.ft');
        }
        if(serviceCharge.value === '' || sanitizeNumber(serviceCharge.value) < 0) missingFields.push('Management Service Charge');
        
        if(missingFields.length > 0) {
          if(!silentMode) alert(`⚠️ MISSING REQUIRED FIELDS\n\nPlease fill in the following fields before calculating:\n\n• ${missingFields.join('\n• ')}`);
          return;
        }
        
        const ls = leaseStart.value, le = leaseEnd.value, ho = handoverDate.value;
        const rent = sanitizeNumber(rentInput.value) || 0;
        const sc = sanitizeNumber(serviceCharge.value), dep = sanitizeNumber(securityDeposit.value) || 0;
        
        // Only validate date logic if tenant is NOT "empty"
        if (!isEmptyTenant) {
          if (new Date(ls) > new Date(le)) {
            if(!silentMode) alert('Lease Start must be before Lease End');
            return;
          }
          if (new Date(ho) > new Date(le)) {
            if(!silentMode) alert('Handover Date cannot be after Lease End');
            return;
          }
        }

        // For "empty" tenant: no lease period, no cutoff - everything is 0/buyer-side
        const totalDays = (isEmptyTenant || !ls || !le) ? 0 : daysInclusive(ls, le);
        const sellerDays = isEmptyTenant ? 0 : Math.max(0, daysInclusive(ls, ho));
        const buyerDays = isEmptyTenant ? 0 : Math.max(0, totalDays - sellerDays);
        
        // Recalculate PDC total based on the dynamic PDC area
        let pdcTotal = 0;
        let pdcCount = 0;
        let pdcListText = "";
        qsa('#pdcChequesRow input[type="number"]').forEach((input) => {
          const amt = Number(input.value || 0);
          if(amt > 0) {
            pdcTotal += amt;
            pdcCount++;
            const card = input.closest('.chq');
            const dateInput = input.previousElementSibling; // date input precedes amount
            const cardLabel = card?.querySelector('.label')?.textContent?.replace('(PDC)','').trim() || 'Cheque';
                const bankLabel = card?.dataset.bank || '';
                const chequeNumber = card?.dataset.chequeNumber || '';
                const displayLabel = chequeNumber ? `Cheque ${chequeNumber}` : cardLabel;
                const meta = bankLabel ? ` [${bankLabel}]` : '';
            const formattedDate = fmtDateForTable(dateInput ? dateInput.value : '');
            pdcListText += ` - ${displayLabel}: ${money(amt)} (${formattedDate})${meta}\n`;
          }
        });
        
        const daily = totalDays ? rent / totalDays : 0;
        const sellerRent = daily * sellerDays;
        const buyerRent = rent - sellerRent;
        const adj = buyerRent - pdcTotal;
        const net = Number((adj + dep - sc).toFixed(2));
        
        // Analyze cheque types for dynamic labeling
        const chequeAnalysis = analyzeChequeTypes();
        const chequeLabel = chequeAnalysis.label;
        
        // Build SC label with rate if SC fields are required
        const scRateVal = sanitizeNumber(qs('#scRate')?.value || 0);
        const scFieldsOn = isScFieldsMandatory();
        const scLabel = scFieldsOn && scRateVal > 0 
          ? `Less: Management Service Charge @ AED ${scRateVal}/sq.ft`
          : 'Less: Management Service Charge';

        resultsBody.innerHTML = `<tr>
          <td>${fmtDateForTable(ls)}</td><td>${fmtDateForTable(le)}</td><td>${rent.toFixed(2)}</td><td>${totalDays}</td>
          <td class="highlight-seller">${sellerDays}</td><td class="highlight-seller">${sellerRent.toFixed(2)}</td>
          <td class="highlight-buyer">${buyerDays}</td><td class="highlight-buyer">${buyerRent.toFixed(2)}</td>
          <td class="highlight-service">${sc.toFixed(2)}</td><td>${pdcTotal.toFixed(2)}</td>
          <td>${adj.toFixed(2)}</td><td>${dep.toFixed(2)}</td><td class="highlight-total">${net.toFixed(2)}</td>
        </tr>`;

        if(resultsCard) resultsCard.classList.remove('is-hidden');
        if(resultsDivider) resultsDivider.classList.remove('is-hidden');

        summarySection.style.display='block';
        setResultsVisibility(true);
        // Flag stays visible until page refresh - user confirmation that data changed
        summaryTotal.textContent = money(Math.abs(net));
        const isSellerPays = net >= 0;
        directionText.textContent = isSellerPays ? 'SELLER PAYS BUYER' : 'BUYER PAYS SELLER';
        directionText.style.color = summaryTotal.style.color = isSellerPays ? '#065f46' : '#b91c1c';
        
        // Show new owner info (buyer name and unit number)
        const newOwnerInfoEl = qs('#newOwnerInfo');
        if(newOwnerInfoEl) {
          const buyerFullName = buyerNameInput?.value?.trim() || '';
          const unitNumber = unitNo?.value?.trim() || '';
          if(buyerFullName || unitNumber) {
            let ownerText = 'Final settlement amount for new owner';
            if(buyerFullName) ownerText += ` <strong>${sanitizeString(buyerFullName)}</strong>`;
            if(unitNumber) ownerText += ` • Unit <strong>${sanitizeString(unitNumber)}</strong>`;
            newOwnerInfoEl.innerHTML = ownerText;
          } else {
            newOwnerInfoEl.innerHTML = '';
          }
        }
        
        const directionLabel = isSellerPays ? 'Seller → Buyer' : 'Buyer → Seller';
        const directionClass = isSellerPays ? 'positive' : 'danger';
        notesEl.innerHTML = `
          <div class="note-panel">
            <div class="note-panel-header">
              <div class="note-panel-title">Settlement Breakdown</div>
            </div>
            <div class="note-rows">
              <div class="note-row">
                <span class="note-label">Buyer Rent (Pro-rata)</span>
                <span class="note-value">AED ${buyerRent.toFixed(2)}</span>
              </div>
              <div class="note-row">
                <span class="note-label">Less: ${chequeLabel} Handed Over</span>
                <span class="note-value negative">- AED ${pdcTotal.toFixed(2)}</span>
              </div>
              <div class="note-row">
                <span class="note-label">Add: Security Deposit</span>
                <span class="note-value positive">+ AED ${dep.toFixed(2)}</span>
              </div>
              <div class="note-row">
                <span class="note-label">${scLabel}</span>
                <span class="note-value negative">- AED ${sc.toFixed(2)}</span>
              </div>
              <div class="note-row total">
                <span class="note-label">${directionLabel}</span>
                <span class="note-value note-total ${directionClass}">AED ${Math.abs(net).toFixed(2)}</span>
              </div>
            </div>
          </div>
        `;

        const u = sanitizeString(unitNo.value), t = sanitizeString(tenantName.value);
        const b = sanitizeString(buildingName.value);
        const propertyRef = b ? `${b} - Unit ${u}` : `Unit ${u}`;
        const reconText = `${propertyRef}\nTenant: ${t}\nRent: ${rent}\nSeller Days: ${sellerDays} | Buyer Days: ${buyerDays}\nNet: ${net.toFixed(2)} (${isSellerPays?'Seller Pays':'Buyer Pays'})`;
        copyReconciliation.value = reconText;
        qs('#copyReconciliationDisplay').textContent = reconText;
        
        lastCalcData = { unit: u, tenant: t, ho, net, pdcTotal, pdcCount, pdcListText, chequeAnalysis };
        markDocsReady(false);
        generateMessages();
        updateTitle();
        
        // Mark calculation as fresh - results now match inputs
        markCalculationFresh();
        
      } catch (e) { console.error(e); alert('Calculation error'); }
    }

    /* Original Professional Export Functions (Restored) */
    function drawSectionTitle(doc, title, y, left=14){
      const pageWidth = doc.internal.pageSize.getWidth();
      
      // Background bar for section title
      doc.setFillColor(240, 245, 250);
      doc.rect(left - 2, y - 4, pageWidth - (left * 2) + 4, 8, 'F');
      
      // Left accent bar
      doc.setFillColor(15, 85, 150);
      doc.rect(left - 2, y - 4, 2, 8, 'F');
      
      // Title text
      doc.setFont("helvetica", "bold");
      doc.setFontSize(10);
      doc.setTextColor(15, 60, 110);
      doc.text(title, left + 2, y + 1);
      
      doc.setTextColor(0,0,0);
      return y + 10;
    }
    function addHeader(doc) {
      const right = doc.internal.pageSize.getWidth() - 12;
      const pageWidth = doc.internal.pageSize.getWidth();
      
      // Header background with gradient effect
      doc.setFillColor(15, 45, 85);
      doc.rect(0, 0, pageWidth, 24, 'F');
      doc.setFillColor(20, 60, 100);
      doc.rect(0, 24, pageWidth, 4, 'F');
      
      // Company name
      doc.setFont('helvetica','bold'); doc.setFontSize(16); doc.setTextColor(255, 255, 255);
      doc.text('AYAT PROPERTIES', 18, 14);
      
      // Document title
      doc.setFont('helvetica','bold'); doc.setFontSize(12); doc.setTextColor(200, 220, 240);
      doc.text('RENTAL SETTLEMENT STATEMENT', pageWidth/2, 14, {align:'center'});
      
      // Reference number & Date
      const refNum = `RS-${new Date().getFullYear()}-${String(Date.now()).slice(-6)}`;
      doc.setFont('helvetica','normal'); doc.setFontSize(8); doc.setTextColor(180, 200, 220);
      doc.text(`Ref: ${refNum}`, right - 5, 10, {align:'right'});
      doc.text(`${new Date().toLocaleDateString('en-GB', {day:'2-digit', month:'short', year:'numeric'})}`, right - 5, 15, {align:'right'});
      
      // Property info bar
      doc.setFont('helvetica','normal'); doc.setFontSize(9); doc.setTextColor(255, 255, 255);
      const building = buildingName.value || '';
      const headerUnitArea = sanitizeNumber(qs('#scArea')?.value);
      const headerUnitAreaText = headerUnitArea > 0 ? ` (${headerUnitArea.toLocaleString()} sq.ft)` : '';
      const propInfo = building ? `${building} - Unit ${unitNo.value || 'N/A'}${headerUnitAreaText}` : `Unit: ${unitNo.value || 'N/A'}${headerUnitAreaText}`;
      doc.text(propInfo, 18, 22);
      doc.text(`Tenant: ${tenantName.value || 'N/A'}`, right - 5, 22, {align:'right'});
    }
    function addFooter(doc, left) {
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const right = pageWidth - 18;
      
      // Footer line
      doc.setDrawColor(200, 210, 220);
      doc.setLineWidth(0.3);
      doc.line(left, pageHeight - 10, right, pageHeight - 10);
      
      // Company info
      doc.setFontSize(7); doc.setTextColor(120, 130, 140);
      doc.text('AYAT Properties | Ayat Tower, R Floor, Al Majaz 3, Sharjah, UAE | Tel: 06 523 3112', left, pageHeight - 6);
      doc.text('Mon-Fri: 9AM-4PM | Sat: 9AM-1PM | Sun: Closed', left, pageHeight - 2);
      
      // Document info
      doc.text(`Page ${doc.internal.getCurrentPageInfo().pageNumber}`, pageWidth/2, pageHeight - 2, {align:'center'});
      doc.text(`Generated: ${new Date().toLocaleString('en-GB')}`, right, pageHeight - 2, {align:'right'});
      
      // Disclaimer
      doc.setFontSize(6); doc.setTextColor(150, 160, 170);
      doc.text('This document is computer-generated and is valid without signature.', pageWidth/2, pageHeight + 2, {align:'center'});
    }
    
    function exportToPDF(){
      if(resultsBody.innerText.includes('Click Calculate')){ alert('Please calculate first.'); return; }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({orientation: 'landscape', unit: 'mm', format: 'a4'});
      const left = 18;
      let y = 10;
      
      // SC Rate label for PDF
      const pdfScRateVal = sanitizeNumber(qs('#scRate')?.value || 0);
      const pdfScFieldsOn = isScFieldsMandatory();
      const pdfScLabel = pdfScFieldsOn && pdfScRateVal > 0 
        ? `Mgt. SC @ AED ${pdfScRateVal}/sq.ft`
        : 'Mgt. Service Charge';
      const pdfScLabelShort = pdfScFieldsOn && pdfScRateVal > 0 
        ? `Mgt. SC @ ${pdfScRateVal}/sq.ft:`
        : 'Mgt. Service:';
      
      addHeader(doc);
      y = 32;
      
      // Empty Unit Notice Banner
      const pdfTenantVal = (tenantName.value || '').trim().toLowerCase();
      if (pdfTenantVal === 'empty' || pdfTenantVal === 'empty unit') {
        doc.setFillColor(255, 191, 0); // Amber background
        doc.roundedRect(left, y - 2, 261, 10, 2, 2, 'F');
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        doc.text('EMPTY UNIT - No Tenant', 148.5, y + 4, { align: 'center' });
        y += 14;
      }
      
      y = drawSectionTitle(doc, 'Lease & Case Details', y, left);
      doc.setFont('helvetica','normal'); doc.setFontSize(10);
      const col1X = left + 2, col2X = left + 83, col3X = left + 151;
      let ly = y;
      doc.setFont('helvetica','bold'); doc.setFontSize(9); doc.setTextColor(12, 58, 120);
      doc.text('Building Name', col1X, ly);
      doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.setTextColor(30, 40, 50);
      ly += 5; doc.text(`${buildingName.value || 'N/A'}`, col1X, ly); ly += 6;
      doc.setFont('helvetica','bold'); doc.setFontSize(9); doc.setTextColor(12, 58, 120);
      // Combine Unit Number and Tenant Name on the same line
      doc.text('Unit No. / Tenant', col1X, ly);
      doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.setTextColor(30, 40, 50);
      ly += 5; doc.text(`${unitNo.value || 'N/A'}  |  ${tenantName.value || 'N/A'}`, col1X, ly); ly += 6;
      
      let col2Y = y;
      doc.setFont('helvetica','bold'); doc.setFontSize(9); doc.setTextColor(12, 58, 120);
      doc.text('Lease Start Date', col2X, col2Y);
      doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.setTextColor(30, 40, 50);
      col2Y += 5; doc.text(`${fmtDateForTable(leaseStart.value)}`, col2X, col2Y); col2Y += 6;
      doc.setFont('helvetica','bold'); doc.setFontSize(9); doc.setTextColor(12, 58, 120);
      doc.text('Lease End Date', col2X, col2Y);
      doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.setTextColor(30, 40, 50);
      col2Y += 5; doc.text(`${fmtDateForTable(leaseEnd.value)}`, col2X, col2Y);
      
      let col3Y = y;
      doc.setFont('helvetica','bold'); doc.setFontSize(9); doc.setTextColor(12, 58, 120);
      doc.text('Handover / SC Paid End', col3X, col3Y);
      doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.setTextColor(30, 40, 50);
      const pdfScPaidEnd = qs('#scPaidEnd')?.value;
      const pdfScPaidEndText = pdfScPaidEnd ? `  |  ${fmtDateForTable(pdfScPaidEnd)}` : '';
      col3Y += 5; doc.text(`${fmtDateForTable(handoverDate.value)}${pdfScPaidEndText}`, col3X, col3Y); col3Y += 6;
      doc.setFont('helvetica','bold'); doc.setFontSize(9); doc.setTextColor(12, 58, 120);
      doc.text('Yearly Rent (AED)', col3X, col3Y);
      doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.setTextColor(30, 40, 50);
      col3Y += 5; doc.text(`${sanitizeNumber(rentInput.value).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}`, col3X, col3Y);
      
      const col4X = left + 203;
      const col4Xb = col4X + 10; // shifted column for S. Deposit & Mgt. Service Charge (moved additional 5mm)
      let col4Y = y;
      doc.setFont('helvetica','bold'); doc.setFontSize(9); doc.setTextColor(12, 58, 120);
      doc.text('S. Deposit', col4Xb, col4Y);
      doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.setTextColor(30, 40, 50);
      col4Y += 5; doc.text(`${sanitizeNumber(securityDeposit.value).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}`, col4Xb, col4Y); col4Y += 6;
      doc.setFont('helvetica','bold'); doc.setFontSize(9); doc.setTextColor(12, 58, 120);
      doc.text(pdfScLabel, col4Xb, col4Y);
      doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.setTextColor(30, 40, 50);
      col4Y += 5; doc.text(`${sanitizeNumber(serviceCharge.value).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}`, col4Xb, col4Y);
      
      ly = Math.max(ly, col2Y, col3Y, col4Y) + 6;
      y = ly + 2;
      
      y = drawSectionTitle(doc, 'Rental Cheques received by Seller', y, left);
      const rentalHead = [['#','Date','Amount','Clr','Clr Date','Bank','Cheque #']];
      const rentalCount = clamp(Number(rentalCountSel.value||0), 0, MAX_CHEQUES);
      const rentalBody = [];
      let rentalTotal = 0, rentalCleared = 0, rentalOutstanding = 0;
      for(let i=1;i<=rentalCount;i++){
        const d = qs(`#rentChq${i}Date`).value;
        const amt = Number(qs(`#rentChq${i}`).value||0);
        const cle = qs(`#rentChq${i}Cleared`).checked ? 'YES' : 'NO';
        const clearD = qs(`#rentChq${i}ClearDate`).value;
        const bankLabel = qs(`#rentChq${i}Bank`).value || '';
        const chequeNo = qs(`#rentChq${i}Number`).value || '';
        rentalBody.push([String(i), fmtDateForTable(d), amt ? amt.toFixed(2) : '', cle, fmtDateForTable(clearD), bankLabel, chequeNo]);
        rentalTotal += amt;
        if(cle==='YES') rentalCleared += amt; else rentalOutstanding += amt;
      }
      rentalBody.push(['',rentalTotal? rentalTotal.toFixed(2):'', 'Total', '', '', '', '']);
      rentalBody.push(['',rentalCleared? rentalCleared.toFixed(2):'', 'Cleared', '', '', '', '']);
      rentalBody.push(['',rentalOutstanding? rentalOutstanding.toFixed(2):'', 'Outstanding', '', '', '', '']);
      const rentalRowCount = rentalCount;
      doc.autoTable({
        head: rentalHead, body: rentalBody, startY: y, theme: 'grid',
        styles: { fontSize: 7, cellPadding: 1, lineWidth: 0.1 },
        headStyles: { fillColor: [241,245,249], textColor: [51,65,85], fontStyle: 'bold', fontSize: 7 },
        alternateRowStyles: { fillColor: [250,251,252] },
        columnStyles: {
          0: { cellWidth: 8 },
          2: { halign: 'right' },
          3: { cellWidth: 12, halign: 'center' }
        },
        margin: { left: 14, right: 14 },
        didParseCell: function(data) {
          // Color code YES/NO
          if (data.column.index === 3 && data.section === 'body') {
            if (data.cell.raw === 'YES') {
              data.cell.styles.textColor = [22, 163, 74];
              data.cell.styles.fontStyle = 'bold';
            } else if (data.cell.raw === 'NO') {
              data.cell.styles.textColor = [220, 80, 80];
              data.cell.styles.fontStyle = 'bold';
            }
          }
          // Highlight summary rows
          if (data.section === 'body' && data.row.index >= rentalRowCount) {
            if (data.cell.raw === 'Total') {
              data.cell.styles.fillColor = [230, 240, 250];
              data.cell.styles.fontStyle = 'bold';
            } else if (data.cell.raw === 'Cleared') {
              data.cell.styles.fillColor = [220, 252, 231];
              data.cell.styles.textColor = [22, 101, 52];
              data.cell.styles.fontStyle = 'bold';
            } else if (data.cell.raw === 'Outstanding') {
              data.cell.styles.fillColor = [254, 243, 199];
              data.cell.styles.textColor = [161, 98, 7];
              data.cell.styles.fontStyle = 'bold';
            }
            // Also style amount cells in summary rows
            if (data.column.index === 1 && data.row.index >= rentalRowCount) {
              data.cell.styles.fontStyle = 'bold';
              if (data.row.index === rentalRowCount) data.cell.styles.fillColor = [230, 240, 250];
              if (data.row.index === rentalRowCount + 1) { data.cell.styles.fillColor = [220, 252, 231]; data.cell.styles.textColor = [22, 101, 52]; }
              if (data.row.index === rentalRowCount + 2) { data.cell.styles.fillColor = [254, 243, 199]; data.cell.styles.textColor = [161, 98, 7]; }
            }
          }
        }
      });
      y = doc.lastAutoTable.finalY + 4;
      
      // Add gap justification note if present
      const gapMeta = lastChequeGapMeta;
      const gapJust = chequeGapJustification;
      const hasGapInfo = gapMeta && gapMeta.absDiff > 0.99 && gapJust && (gapJust.reason || (gapJust.note && gapJust.note.trim()));
      if(hasGapInfo){
        const reasonLabel = gapJust.reason ? (GAP_REASON_META[gapJust.reason]?.label || gapJust.reason) : '';
        const gapDir = gapMeta.diff > 0 ? 'over' : 'short';
        let gapNote = 'Gap: AED ' + money(gapMeta.absDiff) + ' ' + gapDir + ' rent';
        if(reasonLabel){
          gapNote += ' - Reason: ' + reasonLabel;
        }
        if(gapJust.note && gapJust.note.trim()){
          gapNote += ' - Note: ' + gapJust.note.trim();
        }
        doc.setFont('helvetica','bold');
        doc.setFontSize(8);
        doc.setTextColor(180, 83, 9);
        const pageWidth = doc.internal.pageSize.getWidth();
        const gapLines = doc.splitTextToSize(gapNote, pageWidth - 36);
        doc.text(gapLines, left, y);
        y += gapLines.length * 4 + 4;
      }
      
      // PDC List generation
      let pdcTotal = 0;
      const pdcChequeList = [];
      qsa('#pdcChequesRow .chq').forEach(card => {
        const amt = Number(card.querySelector('input[type="number"]').value || 0);
        const date = card.querySelector('input[type="date"]').value;
        const labelEl = card.querySelector('.label');
        const chqMatch = labelEl ? labelEl.textContent.match(/\d+/) : null;
        const fallbackChq = chqMatch ? chqMatch[0] : '';
        const bank = card.dataset.bank || '';
        const chequeNumber = card.dataset.chequeNumber || fallbackChq;
        pdcChequeList.push({ no: chequeNumber || fallbackChq, bank, date: fmtDateForTable(date), amount: amt.toFixed(2), rawDate: date });
        pdcTotal += amt;
      });
      const pdcCount = pdcChequeList.length;
      
      // Analyze cheque types for PDF labels
      const chequeAnalysisPDF = analyzeChequeTypes();
      const pdfChequeLabel = chequeAnalysisPDF.label;

      if(pdcCount > 0){
        y = drawSectionTitle(doc, `${pdfChequeLabel} to Hand Over`, y, left);
        const pdcHead = [['Cheque #','Bank','Date','Amount (AED)']];
        const pdcBody = pdcChequeList.map(p => [p.no || '-', p.bank || '-', p.date, p.amount]);
        pdcBody.push(['','', 'Total:', pdcTotal? pdcTotal.toFixed(2):'']);
        const pdcDataRows = pdcChequeList.length;
        doc.autoTable({
          head: pdcHead, body: pdcBody, startY: y, theme: 'grid',
          styles: { fontSize: 8, cellPadding: 1, lineWidth: 0.1 },
          headStyles: { fillColor: [241,245,249], textColor: [51,65,85], fontStyle: 'bold', fontSize: 8 },
          alternateRowStyles: { fillColor: [250,251,252] },
          columnStyles: {
            3: { halign: 'right' }
          },
          margin: { left: 14, right: 14 },
          didParseCell: function(data) {
            // Highlight Total row
            if (data.section === 'body' && data.row.index === pdcDataRows) {
              data.cell.styles.fillColor = [230, 240, 250];
              data.cell.styles.fontStyle = 'bold';
              data.cell.styles.textColor = [12, 58, 120];
            }
          }
        });
        y = doc.lastAutoTable.finalY + 4;
      }
      
      addFooter(doc, left);
      doc.addPage();
      addHeader(doc);
      y = 28;
      
      y = drawSectionTitle(doc, 'Settlement Calculation', y, left);
      const settlementHead = [['Start','End','Rent','Total Days','Seller Days','Seller Rent','Buyer Days','Buyer Rent','Mgt. SC','PDC','Rent Adj.','S. Deposit','NET']];
      const settlementBody = [];
      const rows = resultsBody.rows;
      for(let r of rows){
        const rowArr = [];
        for(let c of r.cells) rowArr.push(c.innerText);
        settlementBody.push(rowArr);
      }
      doc.autoTable({
        head: settlementHead, body: settlementBody, startY: y, theme: 'grid',
        styles: { fontSize: 8, cellPadding: 1.5 },
        headStyles: { fillColor: [241,245,249], textColor: [51,65,85], fontStyle: 'bold', fontSize: 7 },
        alternateRowStyles: { fillColor: [250,251,252] },
        columnStyles: {
          4: { fillColor: [255,247,237] },
          5: { fillColor: [255,247,237], halign: 'right' },
          6: { fillColor: [240,253,244] },
          7: { fillColor: [240,253,244], halign: 'right' },
          8: { halign: 'right' },
          9: { halign: 'right' },
          10: { halign: 'right' },
          11: { halign: 'right' },
          12: { fontStyle: 'bold', halign: 'right' }
        },
        margin: { left: 14, right: 14 },
        didParseCell: function(data) {
          // Dynamic NET column color
          if (data.column.index === 12 && data.section === 'body') {
            const val = parseFloat(data.cell.raw.replace(/[^0-9.-]/g, ''));
            if (val >= 0) {
              data.cell.styles.fillColor = [220, 252, 231];
              data.cell.styles.textColor = [22, 101, 52];
            } else {
              data.cell.styles.fillColor = [254, 226, 226];
              data.cell.styles.textColor = [185, 28, 28];
            }
          }
        }
      });
      y = doc.lastAutoTable.finalY + 6;
      
      const totalDays = daysInclusive(leaseStart.value, leaseEnd.value);
      const sellerDays = Math.max(0, daysInclusive(leaseStart.value, handoverDate.value));
      const buyerDays = Math.max(0, totalDays - sellerDays);
      const rent = sanitizeNumber(rentInput.value);
      const daily = totalDays > 0 ? rent / totalDays : 0;
      const sellerRent = daily * sellerDays;
      const buyerRent = rent - sellerRent;
      const dep = sanitizeNumber(securityDeposit.value);
      const sc = sanitizeNumber(serviceCharge.value);
      const netRaw = Math.round(((buyerRent - pdcTotal) + dep - sc) * 100) / 100;
      const isSellerPays = netRaw >= 0;
      y = drawSectionTitle(doc, 'Final Settlement Summary', y, left);
      
      const pageWidth = doc.internal.pageSize.getWidth();
      const cardWidth = (pageWidth - left * 2 - 10) / 3;
      const cardPadding = 4;
      const labelColor = [100, 116, 139];
      const valueColor = [30, 41, 59];
      const headingColor = [12, 58, 120];
      
      // Helper function for drawing elegant cards
      function drawCard(x, startY, width, title, items, options = {}) {
        const cardHeight = options.height || (items.length * 8 + 16);
        
        // Card background with subtle shadow effect
        doc.setFillColor(248, 250, 252);
        doc.setDrawColor(226, 232, 240);
        doc.roundedRect(x, startY, width, cardHeight, 2, 2, 'FD');
        
        // Accent line at top
        doc.setFillColor(12, 58, 120);
        doc.rect(x, startY, width, 1.5, 'F');
        
        // Card title
        let cardY = startY + 7;
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(9);
        doc.setTextColor(...headingColor);
        doc.text(title, x + cardPadding, cardY);
        cardY += 6;
        
        // Card content
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(8);
        items.forEach(item => {
          if (item.isHighlight) {
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            doc.setTextColor(...(item.color || valueColor));
          } else {
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            doc.setTextColor(...labelColor);
          }
          
          if (item.label && item.value) {
            doc.setTextColor(...labelColor);
            doc.text(item.label, x + cardPadding, cardY);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(...valueColor);
            const labelWidth = doc.getTextWidth(item.label) + 2;
            doc.text(item.value, x + cardPadding + labelWidth, cardY);
            doc.setFont('helvetica', 'normal');
          } else if (item.text) {
            doc.text(item.text, x + cardPadding, cardY);
          }
          cardY += item.spacing || 6;
        });
        
        return cardHeight;
      }
      
      const summaryY = y;
      const cardCol1X = left;
      const cardCol2X = left + cardWidth + 5;
      const cardCol3X = left + (cardWidth + 5) * 2;
      
      // Card 1: Case Details (Unit & Tenant already shown in header)
      const caseItems = [
        { label: 'Lease Period:', value: `${fmtDateForTable(leaseStart.value)} - ${fmtDateForTable(leaseEnd.value)}` },
        { label: 'Total Rent:', value: `AED ${Number(rent).toLocaleString('en-US', {minimumFractionDigits:2})}` },
        { label: 'Cutoff Date:', value: fmtDateForTable(handoverDate.value) }
      ];
      const card1Height = drawCard(cardCol1X, summaryY, cardWidth, 'LEASE DETAILS', caseItems, { height: 36 });
      
      // Card 2: Pro-Rata Calculation
      const proRataItems = [
        { label: 'Daily Rate:', value: money(daily) },
        { label: 'Seller:', value: `${sellerDays} days = AED ${sellerRent.toLocaleString('en-US', {minimumFractionDigits:2})}` },
        { label: 'Buyer:', value: `${buyerDays} days = AED ${buyerRent.toLocaleString('en-US', {minimumFractionDigits:2})}` }
      ];
      drawCard(cardCol2X, summaryY, cardWidth, 'PRO-RATA BREAKDOWN', proRataItems, { height: 36 });
      
      // Calculate SC formula for ADJUSTMENTS card
      const scAreaVal = sanitizeNumber(qs('#scArea')?.value || 0);
      const scRateValPdf = sanitizeNumber(qs('#scRate')?.value || 0);
      const scPaidEndValPdf = qs('#scPaidEnd')?.value;
      const handoverValPdf = handoverDate.value;
      let scFormulaText = '';
      
      if (scAreaVal > 0 && scRateValPdf > 0 && scPaidEndValPdf && handoverValPdf) {
        const scPaidEndDate = new Date(scPaidEndValPdf);
        const handoverDateObj = new Date(handoverValPdf);
        const buyerOwnershipStart = new Date(handoverDateObj);
        buyerOwnershipStart.setDate(buyerOwnershipStart.getDate() + 1);
        let scBuyerDays = 0;
        if (scPaidEndDate >= buyerOwnershipStart) {
          const diffTime = scPaidEndDate.getTime() - buyerOwnershipStart.getTime();
          scBuyerDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;
        }
        if (scBuyerDays > 0) {
          scFormulaText = `(${scAreaVal.toLocaleString()} x ${scRateValPdf} / 365 x ${scBuyerDays}d)`;
        }
      }
      
      // Card 3: Settlement Calculation
      const settlementItems = [
        { label: `${pdfChequeLabel}:`, value: `- ${money(pdcTotal)}` },
        { label: 'Security Deposit:', value: `+ ${money(dep)}` },
        { label: pdfScLabelShort, value: `- ${money(sc)}` }
      ];
      if (scFormulaText) {
        settlementItems.push({ text: scFormulaText, spacing: 4 });
      }
      drawCard(cardCol3X, summaryY, cardWidth, 'ADJUSTMENTS', settlementItems, { height: scFormulaText ? 42 : 36 });
      
      // Net Settlement Result Box - Full width, prominent
      const netBoxY = summaryY + card1Height + 6;
      const netBoxWidth = pageWidth - left * 2;
      
      // Modern, soft net settlement display - compact single line
      const netTextColor = isSellerPays ? [16, 163, 127] : [220, 80, 80];
      const netLabelColor = [100, 116, 139];
      
      // Subtle separator line
      doc.setDrawColor(226, 232, 240);
      doc.setLineWidth(0.3);
      doc.line(left, netBoxY, left + netBoxWidth, netBoxY);
      
      // Net Settlement label on left
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(10);
      doc.setTextColor(...netLabelColor);
      doc.text('Net Settlement:', left, netBoxY + 10);
      
      // Amount and Direction as single combined text on far right
      const directionText = isSellerPays ? 'Seller pays Buyer' : 'Buyer pays Seller';
      const amountText = money(Math.abs(netRaw));
      const combinedText = `${amountText}  (${directionText})`;
      
      // Draw combined amount + direction - positioned properly
      doc.setFont('times', 'bold');
      doc.setFontSize(11);
      doc.setTextColor(...netTextColor);
      doc.text(combinedText, pageWidth - 18 - 225, netBoxY + 10);
      
      let rightY = netBoxY + 16;
      
      // PDC Cheques Section - elegant table style
      if(pdcChequeList.length > 0){
        // Section header with icon-like element
        doc.setFillColor(12, 58, 120);
        doc.roundedRect(left, rightY, 3, 8, 1, 1, 'F');
        
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(10);
        doc.setTextColor(12, 58, 120);
        doc.text(`${pdfChequeLabel} TO BE HANDED TO BUYER`, left + 6, rightY + 6);
        rightY += 12;
        
        // Cheques in a clean table format
        const chequeTableWidth = pageWidth - left * 2;
        const colWidths = [chequeTableWidth * 0.25, chequeTableWidth * 0.30, chequeTableWidth * 0.25, chequeTableWidth * 0.20];
        
        // Table header
        doc.setFillColor(241, 245, 249);
        doc.rect(left, rightY, chequeTableWidth, 7, 'F');
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(8);
        doc.setTextColor(71, 85, 105);
        doc.text('BANK', left + 3, rightY + 5);
        doc.text('CHEQUE NO.', left + colWidths[0] + 3, rightY + 5);
        doc.text('DATE', left + colWidths[0] + colWidths[1] + 3, rightY + 5);
        doc.text('AMOUNT (AED)', left + colWidths[0] + colWidths[1] + colWidths[2] + 3, rightY + 5);
        rightY += 8;
        
        // Table rows
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(8);
        doc.setTextColor(30, 41, 59);
        
        pdcChequeList.forEach((cheque, idx) => {
          // Alternate row background
          if (idx % 2 === 0) {
            doc.setFillColor(250, 251, 252);
            doc.rect(left, rightY - 1, chequeTableWidth, 6, 'F');
          }
          doc.text(cheque.bank || '-', left + 3, rightY + 3);
          doc.text(cheque.no || '-', left + colWidths[0] + 3, rightY + 3);
          doc.text(cheque.date, left + colWidths[0] + colWidths[1] + 3, rightY + 3);
          doc.text(cheque.amount, left + colWidths[0] + colWidths[1] + colWidths[2] + 3, rightY + 3);
          rightY += 6;
        });
        
        // Total row
        doc.setFillColor(230, 245, 255);
        doc.rect(left, rightY - 1, chequeTableWidth, 7, 'F');
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(9);
        doc.setTextColor(12, 58, 120);
        doc.text('TOTAL', left + colWidths[0] + colWidths[1] + 3, rightY + 4);
        doc.text(money(pdcTotal), left + colWidths[0] + colWidths[1] + colWidths[2] + 3, rightY + 4);
        rightY += 10;
      }
      
      let summaryEndY = rightY;
      
      // Helper to draw the 3-signature section
      function drawSignatureSection(targetDoc, leftMargin, pageW, startY) {
        const sigYLocal = typeof startY === 'number' ? startY : (summaryEndY + 3);
        const sigWidthLocal = (pageW - leftMargin * 2 - 20) / 3;
        const sigHeightLocal = 22;
        const sigGapLocal = 10;
        const labelsLocal = ['Prepared by', 'Reviewed by', 'Approved by'];

        targetDoc.setFont('helvetica', 'normal');
        targetDoc.setFontSize(8);
        targetDoc.setTextColor(100, 116, 139);

        labelsLocal.forEach((label, idx) => {
          const sigX = leftMargin + idx * (sigWidthLocal + sigGapLocal);
          const lineY = sigYLocal + sigHeightLocal - 4;

          targetDoc.setFont('helvetica', 'normal');
          targetDoc.setFontSize(8);
          targetDoc.setTextColor(100, 116, 139);
          targetDoc.text(label, sigX, lineY);

          const labelWidth = targetDoc.getTextWidth(label);
          const lineXStart = sigX + labelWidth + 2;
          const lineXEnd = sigX + sigWidthLocal;

          targetDoc.setDrawColor(180, 190, 200);
          targetDoc.setLineWidth(0.3);
          targetDoc.line(lineXStart, lineY, lineXEnd, lineY);
        });
      }
      
      // Add case notes if checkbox is checked and notes exist
      const includeNotes = qs('#includeNotesInPdf')?.checked;
      const notesText = caseNotesTextarea?.value?.trim();
      if (includeNotes && notesText) {
        // Render notes across pages
        doc.addPage();
        addHeader(doc);
        let notesY = 28;
        notesY = drawSectionTitle(doc, 'Case Notes', notesY, left);
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(9);
        doc.setTextColor(51, 65, 85);

        const maxWidth = pageWidth - left * 2;
        const lines = doc.splitTextToSize(notesText, maxWidth - 10);
        // Track the page where notes end and the last Y position
        let notesEndPage = doc.internal.getCurrentPageInfo().pageNumber;
        lines.forEach(line => {
          if (notesY > doc.internal.pageSize.getHeight() - 30) {
            addFooter(doc, left);
            doc.addPage();
            addHeader(doc);
            notesY = 28;
          }
          doc.text(line, left, notesY);
          notesY += 5;
          notesEndPage = doc.internal.getCurrentPageInfo().pageNumber;
        });
        addFooter(doc, left);

        // Place signatures on page 3 under the notes.
        // If notes ended on or before page 3, advance to page 3 (adding blanks as needed).
        // If notes overflowed beyond page 3, place signatures at the end of the last notes page.
        let currentPage = doc.internal.getCurrentPageInfo().pageNumber;
        if (notesEndPage <= 3) {
          // Add blank pages until we reach page 3
          while (currentPage < 3) {
            doc.addPage();
            addHeader(doc);
            currentPage = doc.internal.getCurrentPageInfo().pageNumber;
          }
          // If the notes end on page 3, place signatures under the note block; otherwise (we added blank page) place under header
          const sigStartY = (notesEndPage === 3 && currentPage === 3) ? notesY + 6 : 36;
          drawSignatureSection(doc, left, pageWidth, sigStartY);
          addFooter(doc, left);
        } else {
          // notesEndPage > 3: place signatures at end of notes (last page)
          drawSignatureSection(doc, left, pageWidth, notesY + 6);
          addFooter(doc, left);
        }
      } else {
        // No notes included — draw signatures on the summary page
        drawSignatureSection(doc, left, pageWidth, summaryEndY + 3);
        addFooter(doc, left);
      }
      doc.save(generateSmartFilename('pdf'));
      markDocsReady(true);
    }
    
    // Buyer PDF - compact single page, excludes Rental Cheques received by Seller
    function exportToBuyerPDF(){
      if(resultsBody.innerText.includes('Click Calculate')){ alert('Please calculate first.'); return; }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({orientation: 'landscape', unit: 'mm', format: 'a4'});
      const left = 14;
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      let y = 8;
      
      // SC Rate label for PDF
      const pdfScRateVal = sanitizeNumber(qs('#scRate')?.value || 0);
      const pdfScFieldsOn = isScFieldsMandatory();
      const pdfScLabelShort = pdfScFieldsOn && pdfScRateVal > 0 
        ? `Mgt. SC @ ${pdfScRateVal}/sq.ft:`
        : 'Mgt. Service:';
      
      // Compact Header
      doc.setFillColor(12, 58, 120);
      doc.rect(0, 0, pageWidth, 16, 'F');
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(14);
      doc.setTextColor(255, 255, 255);
      doc.text('RENTAL SETTLEMENT STATEMENT', pageWidth/2, 10, {align:'center'});
      doc.setFontSize(8);
      doc.text('AYAT PROPERTIES', left, 10);
      
      // Generate reference: RS-Unit-CutoffDate-Building
      const unitRef = (unitNo.value || 'NA').replace(/[^a-zA-Z0-9]/g, '');
      const cutoffRef = handoverDate.value ? handoverDate.value.replace(/-/g, '') : 'NA';
      const buildingRef = (buildingName.value || 'NA').replace(/[^a-zA-Z0-9]/g, '').substring(0, 8);
      const refNum = qs('#refNumber')?.value || `RS-${unitRef}-${cutoffRef}-${buildingRef}`;
      doc.text(`Ref: ${refNum}`, pageWidth - left, 10, {align:'right'});
      y = 25; // Added 5mm top margin
      
      // Property & Lease Info - compact inline format
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(8);
      doc.setTextColor(12, 58, 120);
      const propInfo = `${buildingName.value || 'N/A'} - Unit ${unitNo.value || 'N/A'} | Tenant: ${tenantName.value || 'N/A'}`;
      doc.text(propInfo, left, y);
      
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(8);
      doc.setTextColor(25, 20, 18); // Near black with warm hint
      const leaseInfo = `Lease: ${fmtDateForTable(leaseStart.value)} - ${fmtDateForTable(leaseEnd.value)} | Handover: ${fmtDateForTable(handoverDate.value)} | Rent: AED ${sanitizeNumber(rentInput.value).toLocaleString('en-US',{minimumFractionDigits:2})}`;
      doc.text(leaseInfo, left, y + 5);
      y += 17; // Added 5mm bottom margin (was 12)
      
      // PDC List generation
      let pdcTotal = 0;
      const pdcChequeList = [];
      qsa('#pdcChequesRow .chq').forEach(card => {
        const amt = Number(card.querySelector('input[type="number"]').value || 0);
        const date = card.querySelector('input[type="date"]').value;
        const labelEl = card.querySelector('.label');
        const chqMatch = labelEl ? labelEl.textContent.match(/\d+/) : null;
        const fallbackChq = chqMatch ? chqMatch[0] : '';
        const bank = card.dataset.bank || '';
        const chequeNumber = card.dataset.chequeNumber || fallbackChq;
        pdcChequeList.push({ no: chequeNumber || fallbackChq, bank, date: fmtDateForTable(date), amount: amt.toFixed(2), rawDate: date });
        pdcTotal += amt;
      });
      
      const chequeAnalysisPDF = analyzeChequeTypes();
      const pdfChequeLabel = chequeAnalysisPDF.label;
      
      // Settlement Calculation Table - compact
      doc.setFillColor(12, 58, 120);
      doc.rect(left, y, 3, 6, 'F');
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(9);
      doc.setTextColor(12, 58, 120);
      doc.text('SETTLEMENT CALCULATION', left + 5, y + 4);
      y += 8;
      
      const settlementHead = [['Start','End','Rent','Days','Seller Days','Seller Rent','Buyer Days','Buyer Rent','Mgt. SC','PDC','Rent Adj.','Deposit','NET']];
      const settlementBody = [];
      const rows = resultsBody.rows;
      for(let r of rows){
        const rowArr = [];
        for(let c of r.cells) rowArr.push(c.innerText);
        settlementBody.push(rowArr);
      }
      doc.autoTable({
        head: settlementHead, body: settlementBody, startY: y, theme: 'grid',
        styles: { fontSize: 7, cellPadding: 1 },
        headStyles: { fillColor: [241,245,249], textColor: [51,65,85], fontStyle: 'bold', fontSize: 6 },
        alternateRowStyles: { fillColor: [250,251,252] },
        columnStyles: {
          4: { fillColor: [255,247,237] },
          5: { fillColor: [255,247,237], halign: 'right' },
          6: { fillColor: [240,253,244] },
          7: { fillColor: [240,253,244], halign: 'right' },
          8: { halign: 'right' },
          9: { halign: 'right' },
          10: { halign: 'right' },
          11: { halign: 'right' },
          12: { fontStyle: 'bold', halign: 'right' }
        },
        margin: { left: left, right: left },
        didParseCell: function(data) {
          if (data.column.index === 12 && data.section === 'body') {
            const val = parseFloat(data.cell.raw.replace(/[^0-9.-]/g, ''));
            if (val >= 0) {
              data.cell.styles.fillColor = [220, 252, 231];
              data.cell.styles.textColor = [22, 101, 52];
            } else {
              data.cell.styles.fillColor = [254, 226, 226];
              data.cell.styles.textColor = [185, 28, 28];
            }
          }
        }
      });
      y = doc.lastAutoTable.finalY + 4;
      
      // Calculate values for summary
      const totalDays = daysInclusive(leaseStart.value, leaseEnd.value);
      const sellerDays = Math.max(0, daysInclusive(leaseStart.value, handoverDate.value));
      const buyerDays = Math.max(0, totalDays - sellerDays);
      const rent = sanitizeNumber(rentInput.value);
      const daily = totalDays > 0 ? rent / totalDays : 0;
      const sellerRent = daily * sellerDays;
      const buyerRent = rent - sellerRent;
      const dep = sanitizeNumber(securityDeposit.value);
      const sc = sanitizeNumber(serviceCharge.value);
      const netRaw = Math.round(((buyerRent - pdcTotal) + dep - sc) * 100) / 100;
      const isSellerPays = netRaw >= 0;
      
      // Final Settlement Summary - 3 cards
      doc.setFillColor(12, 58, 120);
      doc.rect(left, y, 3, 6, 'F');
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(9);
      doc.setTextColor(12, 58, 120);
      doc.text('FINAL SETTLEMENT SUMMARY', left + 5, y + 4);
      y += 8;
      
      const cardWidth = (pageWidth - left * 2 - 8) / 3;
      const cardHeight = 32;
      const cardPadding = 3;
      
      // Card 1: Lease Details
      doc.setFillColor(248, 250, 252);
      doc.setDrawColor(226, 232, 240);
      doc.roundedRect(left, y, cardWidth, cardHeight, 1.5, 1.5, 'FD');
      doc.setFillColor(12, 58, 120);
      doc.rect(left, y, cardWidth, 1, 'F');
      
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(8);
      doc.setTextColor(12, 58, 120);
      doc.text('LEASE DETAILS', left + cardPadding, y + 6);
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(7.5);
      doc.setTextColor(25, 20, 18); // Near black with warm hint
      doc.text(`Lease: ${fmtDateForTable(leaseStart.value)} - ${fmtDateForTable(leaseEnd.value)}`, left + cardPadding, y + 12);
      doc.text(`Rent: AED ${Number(rent).toLocaleString('en-US', {minimumFractionDigits:2})}`, left + cardPadding, y + 18);
      doc.text(`Cutoff: ${fmtDateForTable(handoverDate.value)}`, left + cardPadding, y + 24);
      
      // Card 2: Pro-Rata Breakdown
      const card2X = left + cardWidth + 4;
      doc.setFillColor(248, 250, 252);
      doc.roundedRect(card2X, y, cardWidth, cardHeight, 1.5, 1.5, 'FD');
      doc.setFillColor(12, 58, 120);
      doc.rect(card2X, y, cardWidth, 1, 'F');
      
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(8);
      doc.setTextColor(12, 58, 120);
      doc.text('PRO-RATA BREAKDOWN', card2X + cardPadding, y + 6);
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(7.5);
      doc.setTextColor(25, 20, 18); // Near black with warm hint
      doc.text(`Daily Rate: ${money(daily)}`, card2X + cardPadding, y + 12);
      doc.text(`Seller: ${sellerDays} days = AED ${sellerRent.toLocaleString('en-US', {minimumFractionDigits:2})}`, card2X + cardPadding, y + 18);
      doc.text(`Buyer: ${buyerDays} days = AED ${buyerRent.toLocaleString('en-US', {minimumFractionDigits:2})}`, card2X + cardPadding, y + 24);
      
      // Card 3: Adjustments
      const card3X = left + (cardWidth + 4) * 2;
      doc.setFillColor(248, 250, 252);
      doc.roundedRect(card3X, y, cardWidth, cardHeight, 1.5, 1.5, 'FD');
      doc.setFillColor(12, 58, 120);
      doc.rect(card3X, y, cardWidth, 1, 'F');
      
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(8);
      doc.setTextColor(12, 58, 120);
      doc.text('ADJUSTMENTS', card3X + cardPadding, y + 6);
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(7.5);
      doc.setTextColor(25, 20, 18); // Near black with warm hint
      doc.text(`${pdfChequeLabel}: - ${money(pdcTotal)}`, card3X + cardPadding, y + 12);
      doc.text(`Security Deposit: + ${money(dep)}`, card3X + cardPadding, y + 18);
      doc.text(`${pdfScLabelShort} - ${money(sc)}`, card3X + cardPadding, y + 24);
      
      y += cardHeight + 4;
      
      // Net Settlement Result - prominent display
      const netTextColor = isSellerPays ? [16, 163, 127] : [220, 80, 80];
      const directionText = isSellerPays ? 'Seller pays Buyer' : 'Buyer pays Seller';
      
      doc.setFillColor(isSellerPays ? 236 : 254, isSellerPays ? 253 : 242, isSellerPays ? 245 : 242);
      doc.roundedRect(left, y, pageWidth - left * 2, 12, 2, 2, 'F');
      
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(10);
      doc.setTextColor(...netTextColor);
      doc.text(`NET SETTLEMENT: ${money(Math.abs(netRaw))}`, left + 5, y + 8);
      doc.setFontSize(9);
      doc.text(`(${directionText})`, pageWidth - left - 5, y + 8, {align: 'right'});
      y += 16;
      
      // PDC Cheques Table - if any
      if(pdcChequeList.length > 0){
        doc.setFillColor(12, 58, 120);
        doc.rect(left, y, 3, 6, 'F');
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(9);
        doc.setTextColor(12, 58, 120);
        doc.text(`${pdfChequeLabel} TO BE HANDED TO BUYER`, left + 5, y + 4);
        y += 8;
        
        const pdcHead = [['Cheque #','Bank','Date','Amount (AED)']];
        const pdcBody = pdcChequeList.map(p => [p.no || '-', p.bank || '-', p.date, p.amount]);
        pdcBody.push(['','', 'TOTAL:', money(pdcTotal)]);
        const pdcDataRows = pdcChequeList.length;
        
        doc.autoTable({
          head: pdcHead, body: pdcBody, startY: y, theme: 'grid',
          styles: { fontSize: 8, cellPadding: 1.5 },
          headStyles: { fillColor: [241,245,249], textColor: [51,65,85], fontStyle: 'bold', fontSize: 8 },
          alternateRowStyles: { fillColor: [250,251,252] },
          columnStyles: {
            3: { halign: 'right' }
          },
          margin: { left: left, right: left },
          didParseCell: function(data) {
            if (data.section === 'body' && data.row.index === pdcDataRows) {
              data.cell.styles.fillColor = [230, 240, 250];
              data.cell.styles.fontStyle = 'bold';
              data.cell.styles.textColor = [12, 58, 120];
            }
          }
        });
      }
      
      // Compact Footer
      doc.setDrawColor(200, 210, 220);
      doc.setLineWidth(0.3);
      doc.line(left, pageHeight - 12, pageWidth - left, pageHeight - 12);
      doc.setFontSize(6);
      doc.setTextColor(120, 130, 140);
      doc.text('AYAT Properties | Ayat Tower, R Floor, Al Majaz 3, Sharjah | Tel: 06 523 3112 | Mon-Fri: 9AM-4PM | Sat: 9AM-1PM', left, pageHeight - 8);
      doc.text(`Generated: ${new Date().toLocaleString('en-GB')}`, pageWidth - left, pageHeight - 8, {align:'right'});
      
      // Use unit + buyer name as filename (sanitized). Fallbacks: unit-only, buyer-only, then refNum.
      const sanitizeForFile = s => (s||'').toString().trim().replace(/[^a-zA-Z0-9]+/g, '_').replace(/^_+|_+$/g, '');
      const unitRaw = qs('#unitNo')?.value || '';
      const buyerRaw = qs('#buyerName')?.value || '';
      const unitSafe = sanitizeForFile(unitRaw);
      const buyerSafe = sanitizeForFile(buyerRaw);
      let buyerFilename = '';
      if(unitSafe && buyerSafe) {
        buyerFilename = `${unitSafe}_${buyerSafe}.pdf`;
      } else if(unitSafe) {
        buyerFilename = `${unitSafe}.pdf`;
      } else if(buyerSafe) {
        buyerFilename = `${buyerSafe}.pdf`;
      } else {
        buyerFilename = `${sanitizeForFile(refNum) || 'Buyer'}.pdf`;
      }
      doc.save(buyerFilename);
      markDocsReady(true);
    }
    
    function previewPDF(){
      if(resultsBody.innerText.includes('Click Calculate')){ alert('Please calculate first.'); return; }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({orientation: 'landscape', unit: 'mm', format: 'a4'});
      const left = 18;
      let y = 10;
      
      // SC Rate label for PDF
      const pdfScRateVal = sanitizeNumber(qs('#scRate')?.value || 0);
      const pdfScFieldsOn = isScFieldsMandatory();
      const pdfScLabel = pdfScFieldsOn && pdfScRateVal > 0 
        ? `Mgt. SC @ AED ${pdfScRateVal}/sq.ft`
        : 'Mgt. Service Charge';
      const pdfScLabelShort = pdfScFieldsOn && pdfScRateVal > 0 
        ? `Mgt. SC @ ${pdfScRateVal}/sq.ft:`
        : 'Mgt. Service:';
      
      addHeader(doc);
      y = 32;
      
      y = drawSectionTitle(doc, 'Lease & Case Details', y, left);
      doc.setFont('helvetica','normal'); doc.setFontSize(10);
      const col1X = left + 2, col2X = left + 83, col3X = left + 151;
      let ly = y;
      doc.setFont('helvetica','bold'); doc.setFontSize(9); doc.setTextColor(12, 58, 120);
      doc.text('Building Name', col1X, ly);
      doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.setTextColor(30, 40, 50);
      ly += 5; doc.text(`${buildingName.value || 'N/A'}`, col1X, ly); ly += 6;
      doc.setFont('helvetica','bold'); doc.setFontSize(9); doc.setTextColor(12, 58, 120);
      // Combine Unit Number and Tenant Name on the same line
      doc.text('Unit No. / Tenant', col1X, ly);
      doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.setTextColor(30, 40, 50);
      ly += 5; doc.text(`${unitNo.value || 'N/A'}  |  ${tenantName.value || 'N/A'}`, col1X, ly);
      
      let col2Y = y;
      doc.setFont('helvetica','bold'); doc.setFontSize(9); doc.setTextColor(12, 58, 120);
      doc.text('Lease Start Date', col2X, col2Y);
      doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.setTextColor(30, 40, 50);
      col2Y += 5; doc.text(`${fmtDateForTable(leaseStart.value)}`, col2X, col2Y); col2Y += 6;
      doc.setFont('helvetica','bold'); doc.setFontSize(9); doc.setTextColor(12, 58, 120);
      doc.text('Lease End Date', col2X, col2Y);
      doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.setTextColor(30, 40, 50);
      col2Y += 5; doc.text(`${fmtDateForTable(leaseEnd.value)}`, col2X, col2Y);
      
      let col3Y = y;
      doc.setFont('helvetica','bold'); doc.setFontSize(9); doc.setTextColor(12, 58, 120);
      doc.text('Handover / SC Paid End', col3X, col3Y);
      doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.setTextColor(30, 40, 50);
      const prevScPaidEnd = qs('#scPaidEnd')?.value;
      const prevScPaidEndText = prevScPaidEnd ? `  |  ${fmtDateForTable(prevScPaidEnd)}` : '';
      col3Y += 5; doc.text(`${fmtDateForTable(handoverDate.value)}${prevScPaidEndText}`, col3X, col3Y); col3Y += 6;
      doc.setFont('helvetica','bold'); doc.setFontSize(9); doc.setTextColor(12, 58, 120);
      doc.text('Yearly Rent (AED)', col3X, col3Y);
      doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.setTextColor(30, 40, 50);
      col3Y += 5; doc.text(`${sanitizeNumber(rentInput.value).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}`, col3X, col3Y);
      
      const col4X = left + 203;
      const col4Xb = col4X + 10; // shifted column for S. Deposit & Mgt. Service Charge (second block, moved additional 5mm)
      let col4Y = y;
      doc.setFont('helvetica','bold'); doc.setFontSize(9); doc.setTextColor(12, 58, 120);
      doc.text('S. Deposit', col4Xb, col4Y);
      doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.setTextColor(30, 40, 50);
      col4Y += 5; doc.text(`${sanitizeNumber(securityDeposit.value).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}`, col4Xb, col4Y); col4Y += 6;
      doc.setFont('helvetica','bold'); doc.setFontSize(9); doc.setTextColor(12, 58, 120);
      doc.text(pdfScLabel, col4Xb, col4Y);
      doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.setTextColor(30, 40, 50);
      col4Y += 5; doc.text(`${sanitizeNumber(serviceCharge.value).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}`, col4Xb, col4Y);
      
      ly = Math.max(ly, col2Y, col3Y, col4Y) + 6;
      y = ly + 2;
      
      y = drawSectionTitle(doc, 'Rental Cheques received by Seller', y, left);
      const rentalHead = [['#','Date','Amount','Clr','Clr Date','Bank','Cheque #']];
      const rentalCount = clamp(Number(rentalCountSel.value||0), 0, MAX_CHEQUES);
      const rentalBody = [];
      let rentalTotal = 0, rentalCleared = 0, rentalOutstanding = 0;
      for(let i=1;i<=rentalCount;i++){
        const d = qs(`#rentChq${i}Date`).value;
        const amt = Number(qs(`#rentChq${i}`).value||0);
        const cle = qs(`#rentChq${i}Cleared`).checked ? 'YES' : 'NO';
        const clearD = qs(`#rentChq${i}ClearDate`).value;
        const bankLabel = qs(`#rentChq${i}Bank`).value || '';
        const chequeNo = qs(`#rentChq${i}Number`).value || '';
        rentalBody.push([String(i), fmtDateForTable(d), amt ? amt.toFixed(2) : '', cle, fmtDateForTable(clearD), bankLabel, chequeNo]);
        rentalTotal += amt;
        if(cle==='YES') rentalCleared += amt; else rentalOutstanding += amt;
      }
      rentalBody.push(['',rentalTotal? rentalTotal.toFixed(2):'', 'Total', '', '', '', '']);
      rentalBody.push(['',rentalCleared? rentalCleared.toFixed(2):'', 'Cleared', '', '', '', '']);
      rentalBody.push(['',rentalOutstanding? rentalOutstanding.toFixed(2):'', 'Outstanding', '', '', '', '']);
      const rentalRowCount = rentalCount;
      doc.autoTable({
        head: rentalHead, body: rentalBody, startY: y, theme: 'grid',
        styles: { fontSize: 7, cellPadding: 1, lineWidth: 0.1 },
        headStyles: { fillColor: [241,245,249], textColor: [51,65,85], fontStyle: 'bold', fontSize: 7 },
        alternateRowStyles: { fillColor: [250,251,252] },
        columnStyles: {
          0: { cellWidth: 8 },
          2: { halign: 'right' },
          3: { cellWidth: 12, halign: 'center' }
        },
        margin: { left: 14, right: 14 },
        didParseCell: function(data) {
          if (data.column.index === 3 && data.section === 'body') {
            if (data.cell.raw === 'YES') {
              data.cell.styles.textColor = [22, 163, 74];
              data.cell.styles.fontStyle = 'bold';
            } else if (data.cell.raw === 'NO') {
              data.cell.styles.textColor = [220, 80, 80];
              data.cell.styles.fontStyle = 'bold';
            }
          }
          if (data.section === 'body' && data.row.index >= rentalRowCount) {
            if (data.cell.raw === 'Total') {
              data.cell.styles.fillColor = [230, 240, 250];
              data.cell.styles.fontStyle = 'bold';
            } else if (data.cell.raw === 'Cleared') {
              data.cell.styles.fillColor = [220, 252, 231];
              data.cell.styles.textColor = [22, 101, 52];
              data.cell.styles.fontStyle = 'bold';
            } else if (data.cell.raw === 'Outstanding') {
              data.cell.styles.fillColor = [254, 243, 199];
              data.cell.styles.textColor = [161, 98, 7];
              data.cell.styles.fontStyle = 'bold';
            }
            if (data.column.index === 1 && data.row.index >= rentalRowCount) {
              data.cell.styles.fontStyle = 'bold';
              if (data.row.index === rentalRowCount) data.cell.styles.fillColor = [230, 240, 250];
              if (data.row.index === rentalRowCount + 1) { data.cell.styles.fillColor = [220, 252, 231]; data.cell.styles.textColor = [22, 101, 52]; }
              if (data.row.index === rentalRowCount + 2) { data.cell.styles.fillColor = [254, 243, 199]; data.cell.styles.textColor = [161, 98, 7]; }
            }
          }
        }
      });
      y = doc.lastAutoTable.finalY + 8;
      
      let pdcTotal = 0;
      const pdcChequeList = [];
      qsa('#pdcChequesRow .chq').forEach(card => {
        const amt = Number(card.querySelector('input[type="number"]').value || 0);
        const date = card.querySelector('input[type="date"]').value;
        const labelEl = card.querySelector('.label');
        const chqMatch = labelEl ? labelEl.textContent.match(/\d+/) : null;
        const fallbackChq = chqMatch ? chqMatch[0] : '';
        const bank = card.dataset.bank || '';
        const chequeNumber = card.dataset.chequeNumber || fallbackChq;
        pdcChequeList.push({ no: chequeNumber || fallbackChq, bank, date: fmtDateForTable(date), amount: amt.toFixed(2), rawDate: date });
        pdcTotal += amt;
      });
      const pdcCount = pdcChequeList.length;
      
      const chequeAnalysisPDF = analyzeChequeTypes();
      const pdfChequeLabel = chequeAnalysisPDF.label;

      if(pdcCount > 0){
        y = drawSectionTitle(doc, `${pdfChequeLabel} to Hand Over`, y, left);
        const pdcHead = [['Cheque #','Bank','Date','Amount (AED)']];
        const pdcBody = pdcChequeList.map(p => [p.no || '-', p.bank || '-', p.date, p.amount]);
        pdcBody.push(['','', 'Total:', pdcTotal? pdcTotal.toFixed(2):'']);
        const pdcDataRows = pdcChequeList.length;
        doc.autoTable({
          head: pdcHead, body: pdcBody, startY: y, theme: 'grid',
          styles: { fontSize: 8, cellPadding: 1, lineWidth: 0.1 },
          headStyles: { fillColor: [241,245,249], textColor: [51,65,85], fontStyle: 'bold', fontSize: 8 },
          alternateRowStyles: { fillColor: [250,251,252] },
          columnStyles: { 3: { halign: 'right' } },
          margin: { left: 14, right: 14 },
          didParseCell: function(data) {
            if (data.section === 'body' && data.row.index === pdcDataRows) {
              data.cell.styles.fillColor = [230, 240, 250];
              data.cell.styles.fontStyle = 'bold';
              data.cell.styles.textColor = [12, 58, 120];
            }
          }
        });
        y = doc.lastAutoTable.finalY + 4;
      }
      
      addFooter(doc, left);
      doc.addPage();
      addHeader(doc);
      y = 28;
      
      y = drawSectionTitle(doc, 'Settlement Calculation', y, left);
      const settlementHead = [['Start','End','Rent','Total Days','Seller Days','Seller Rent','Buyer Days','Buyer Rent','Mgt. SC','PDC','Rent Adj.','S. Deposit','NET']];
      const settlementBody = [];
      const rows = resultsBody.rows;
      for(let r of rows){
        const rowArr = [];
        for(let c of r.cells) rowArr.push(c.innerText);
        settlementBody.push(rowArr);
      }
      doc.autoTable({
        head: settlementHead, body: settlementBody, startY: y, theme: 'grid',
        styles: { fontSize: 8, cellPadding: 1.5 },
        headStyles: { fillColor: [241,245,249], textColor: [51,65,85], fontStyle: 'bold', fontSize: 7 },
        alternateRowStyles: { fillColor: [250,251,252] },
        columnStyles: {
          4: { fillColor: [255,247,237] },
          5: { fillColor: [255,247,237], halign: 'right' },
          6: { fillColor: [240,253,244] },
          7: { fillColor: [240,253,244], halign: 'right' },
          8: { halign: 'right' },
          9: { halign: 'right' },
          10: { halign: 'right' },
          11: { halign: 'right' },
          12: { fontStyle: 'bold', halign: 'right' }
        },
        margin: { left: 14, right: 14 },
        didParseCell: function(data) {
          if (data.column.index === 12 && data.section === 'body') {
            const val = parseFloat(data.cell.raw.replace(/[^0-9.-]/g, ''));
            if (val >= 0) {
              data.cell.styles.fillColor = [220, 252, 231];
              data.cell.styles.textColor = [22, 101, 52];
            } else {
              data.cell.styles.fillColor = [254, 226, 226];
              data.cell.styles.textColor = [185, 28, 28];
            }
          }
        }
      });
      y = doc.lastAutoTable.finalY + 6;
      
      const totalDays = daysInclusive(leaseStart.value, leaseEnd.value);
      const sellerDays = Math.max(0, daysInclusive(leaseStart.value, handoverDate.value));
      const buyerDays = Math.max(0, totalDays - sellerDays);
      const rent = sanitizeNumber(rentInput.value);
      const daily = totalDays > 0 ? rent / totalDays : 0;
      const sellerRent = daily * sellerDays;
      const buyerRent = rent - sellerRent;
      const dep = sanitizeNumber(securityDeposit.value);
      const sc = sanitizeNumber(serviceCharge.value);
      const netRaw = Math.round(((buyerRent - pdcTotal) + dep - sc) * 100) / 100;
      const isSellerPays = netRaw >= 0;
      y = drawSectionTitle(doc, 'Final Settlement Summary', y, left);
      
      const pageWidth = doc.internal.pageSize.getWidth();
      const cardWidth = (pageWidth - left * 2 - 10) / 3;
      const cardPadding = 4;
      const labelColor = [100, 116, 139];
      const valueColor = [30, 41, 59];
      const headingColor = [12, 58, 120];
      
      function drawCard(x, startY, width, title, items, options = {}) {
        const cardHeight = options.height || (items.length * 8 + 16);
        doc.setFillColor(248, 250, 252);
        doc.setDrawColor(226, 232, 240);
        doc.roundedRect(x, startY, width, cardHeight, 2, 2, 'FD');
        doc.setFillColor(12, 58, 120);
        doc.rect(x, startY, width, 1.5, 'F');
        let cardY = startY + 7;
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(9);
        doc.setTextColor(...headingColor);
        doc.text(title, x + cardPadding, cardY);
        cardY += 6;
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(8);
        items.forEach(item => {
          if (item.isHighlight) {
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            doc.setTextColor(...(item.color || valueColor));
          } else {
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            doc.setTextColor(...labelColor);
          }
          if (item.label && item.value) {
            doc.setTextColor(...labelColor);
            doc.text(item.label, x + cardPadding, cardY);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(...valueColor);
            const labelWidth = doc.getTextWidth(item.label) + 2;
            doc.text(item.value, x + cardPadding + labelWidth, cardY);
            doc.setFont('helvetica', 'normal');
          } else if (item.text) {
            doc.text(item.text, x + cardPadding, cardY);
          }
          cardY += item.spacing || 6;
        });
        return cardHeight;
      }
      
      const summaryY = y;
      const cardCol1X = left;
      const cardCol2X = left + cardWidth + 5;
      const cardCol3X = left + (cardWidth + 5) * 2;
      
      const caseItems = [
        { label: 'Lease Period:', value: `${fmtDateForTable(leaseStart.value)} - ${fmtDateForTable(leaseEnd.value)}` },
        { label: 'Total Rent:', value: `AED ${Number(rent).toLocaleString('en-US', {minimumFractionDigits:2})}` },
        { label: 'Cutoff Date:', value: fmtDateForTable(handoverDate.value) }
      ];
      const card1Height = drawCard(cardCol1X, summaryY, cardWidth, 'LEASE DETAILS', caseItems, { height: 36 });
      
      const proRataItems = [
        { label: 'Daily Rate:', value: money(daily) },
        { label: 'Seller:', value: `${sellerDays} days = AED ${sellerRent.toLocaleString('en-US', {minimumFractionDigits:2})}` },
        { label: 'Buyer:', value: `${buyerDays} days = AED ${buyerRent.toLocaleString('en-US', {minimumFractionDigits:2})}` }
      ];
      drawCard(cardCol2X, summaryY, cardWidth, 'PRO-RATA BREAKDOWN', proRataItems, { height: 36 });
      
      // Calculate SC formula for ADJUSTMENTS card
      const scAreaValPrev = sanitizeNumber(qs('#scArea')?.value || 0);
      const scRateValPrev = sanitizeNumber(qs('#scRate')?.value || 0);
      const scPaidEndValPrev = qs('#scPaidEnd')?.value;
      const handoverValPrev = handoverDate.value;
      let scFormulaTextPrev = '';
      
      if (scAreaValPrev > 0 && scRateValPrev > 0 && scPaidEndValPrev && handoverValPrev) {
        const scPaidEndDatePrev = new Date(scPaidEndValPrev);
        const handoverDateObjPrev = new Date(handoverValPrev);
        const buyerOwnershipStartPrev = new Date(handoverDateObjPrev);
        buyerOwnershipStartPrev.setDate(buyerOwnershipStartPrev.getDate() + 1);
        let scBuyerDaysPrev = 0;
        if (scPaidEndDatePrev >= buyerOwnershipStartPrev) {
          const diffTimePrev = scPaidEndDatePrev.getTime() - buyerOwnershipStartPrev.getTime();
          scBuyerDaysPrev = Math.floor(diffTimePrev / (1000 * 60 * 60 * 24)) + 1;
        }
        if (scBuyerDaysPrev > 0) {
          scFormulaTextPrev = `(${scAreaValPrev.toLocaleString()} x ${scRateValPrev} / 365 x ${scBuyerDaysPrev}d)`;
        }
      }
      
      const settlementItems = [
        { label: `${pdfChequeLabel}:`, value: `- ${money(pdcTotal)}` },
        { label: 'Security Deposit:', value: `+ ${money(dep)}` },
        { label: pdfScLabelShort, value: `- ${money(sc)}` }
      ];
      if (scFormulaTextPrev) {
        settlementItems.push({ text: scFormulaTextPrev, spacing: 4 });
      }
      drawCard(cardCol3X, summaryY, cardWidth, 'ADJUSTMENTS', settlementItems, { height: scFormulaTextPrev ? 42 : 36 });
      
      const netBoxY = summaryY + card1Height + 6;
      const netBoxWidth = pageWidth - left * 2;
      const netTextColor = isSellerPays ? [16, 163, 127] : [220, 80, 80];
      const netLabelColor = [100, 116, 139];
      doc.setDrawColor(226, 232, 240);
      doc.setLineWidth(0.3);
      doc.line(left, netBoxY, left + netBoxWidth, netBoxY);
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(10);
      doc.setTextColor(...netLabelColor);
      doc.text('Net Settlement:', left, netBoxY + 10);
      const directionText = isSellerPays ? 'Seller pays Buyer' : 'Buyer pays Seller';
      const amountText = money(Math.abs(netRaw));
      const combinedText = `${amountText}  (${directionText})`;
      doc.setFont('times', 'bold');
      doc.setFontSize(11);
      doc.setTextColor(...netTextColor);
      doc.text(combinedText, pageWidth - 18 - 225, netBoxY + 10);
      
      let rightY = netBoxY + 16;
      
      if(pdcChequeList.length > 0){
        doc.setFillColor(12, 58, 120);
        doc.roundedRect(left, rightY, 3, 8, 1, 1, 'F');
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(10);
        doc.setTextColor(12, 58, 120);
        doc.text(`${pdfChequeLabel} TO BE HANDED TO BUYER`, left + 6, rightY + 6);
        rightY += 12;
        const chequeTableWidth = pageWidth - left * 2;
        const colWidths = [chequeTableWidth * 0.25, chequeTableWidth * 0.30, chequeTableWidth * 0.25, chequeTableWidth * 0.20];
        doc.setFillColor(241, 245, 249);
        doc.rect(left, rightY, chequeTableWidth, 7, 'F');
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(8);
        doc.setTextColor(71, 85, 105);
        doc.text('BANK', left + 3, rightY + 5);
        doc.text('CHEQUE NO.', left + colWidths[0] + 3, rightY + 5);
        doc.text('DATE', left + colWidths[0] + colWidths[1] + 3, rightY + 5);
        doc.text('AMOUNT (AED)', left + colWidths[0] + colWidths[1] + colWidths[2] + 3, rightY + 5);
        rightY += 8;
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(8);
        doc.setTextColor(30, 41, 59);
        pdcChequeList.forEach((cheque, idx) => {
          if (idx % 2 === 0) {
            doc.setFillColor(250, 251, 252);
            doc.rect(left, rightY - 1, chequeTableWidth, 6, 'F');
          }
          doc.text(cheque.bank || '-', left + 3, rightY + 3);
          doc.text(cheque.no || '-', left + colWidths[0] + 3, rightY + 3);
          doc.text(cheque.date, left + colWidths[0] + colWidths[1] + 3, rightY + 3);
          doc.text(cheque.amount, left + colWidths[0] + colWidths[1] + colWidths[2] + 3, rightY + 3);
          rightY += 6;
        });
        doc.setFillColor(230, 245, 255);
        doc.rect(left, rightY - 1, chequeTableWidth, 7, 'F');
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(9);
        doc.setTextColor(12, 58, 120);
        doc.text('TOTAL', left + colWidths[0] + colWidths[1] + 3, rightY + 4);
        doc.text(money(pdcTotal), left + colWidths[0] + colWidths[1] + colWidths[2] + 3, rightY + 4);
        rightY += 10;
      }
      
      // Add case notes if checkbox is checked and notes exist
      const includeNotes = qs('#includeNotesInPdf')?.checked;
      const notesText = caseNotesTextarea?.value?.trim();
      if (includeNotes && notesText) {
        addFooter(doc, left);
        doc.addPage();
        addHeader(doc);
        let notesY = 28;
        notesY = drawSectionTitle(doc, 'Case Notes', notesY, left);
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(9);
        doc.setTextColor(51, 65, 85);
        
        // Split notes into lines that fit the page width
        const maxWidth = 260; // Page width minus margins
        const lines = doc.splitTextToSize(notesText, maxWidth);
        lines.forEach(line => {
          if (notesY > 190) { // Check if we need a new page
            addFooter(doc, left);
            doc.addPage();
            addHeader(doc);
            notesY = 28;
          }
          doc.text(line, left, notesY);
          notesY += 5;
        });
        addFooter(doc, left);
      } else {
        addFooter(doc, left);
      }
      
      // Open in new tab for preview instead of downloading
      const pdfBlob = doc.output('blob');
      const blobUrl = URL.createObjectURL(pdfBlob);
      window.open(blobUrl, '_blank');
    }
    
    function exportToExcel(){
      if(resultsBody.innerText.includes('Click Calculate')){ alert('Please calculate first.'); return; }
      const filename = generateSmartFilename('xlsx');
      const wb = XLSX.utils.book_new();
      const wsData = [];
      wsData.push(["RENTAL SETTLEMENT"]);
      wsData.push([]);
      wsData.push(["Building Name", buildingName.value]);
      wsData.push(["Unit Number", unitNo.value]);
      wsData.push(["Tenant Name", tenantName.value]);
      wsData.push(["Lease Start", leaseStart.value]);
      wsData.push(["Lease End", leaseEnd.value]);
      wsData.push(["Total Contract Rent (AED)", rentInput.value]);
      wsData.push(["Handover Date", handoverDate.value]);
      wsData.push(["S. Deposit", securityDeposit.value]);
      wsData.push(["Mgt. Service Charge", serviceCharge.value]);
      wsData.push([]);
      const rentalCount = clamp(Number(rentalCountSel.value||0), 0, MAX_CHEQUES);
      let rentalTotal = 0, rentalCleared = 0;
      wsData.push(["Rental Cheques"]);
      wsData.push(["No", "Date", "Amount", "Cleared", "Clear Date", "Bank", "Cheque #"]);
      for (let i = 1; i <= rentalCount; i++) {
        const date = qs(`#rentChq${i}Date`).value;
        const amount = Number(qs(`#rentChq${i}`).value || 0);
        const cleared = qs(`#rentChq${i}Cleared`).checked ? "YES" : "NO";
        const clearDate = qs(`#rentChq${i}ClearDate`).value;
        const bankLabel = qs(`#rentChq${i}Bank`).value || '';
        const chequeNo = qs(`#rentChq${i}Number`).value || '';
        wsData.push([i, date, amount.toFixed(2), cleared, clearDate, bankLabel, chequeNo]);
        rentalTotal += amount;
        if (cleared === "YES") rentalCleared += amount;
      }
      wsData.push(["Total", "", rentalTotal.toFixed(2), "", "", "", ""]);
      wsData.push(["Cleared", "", rentalCleared.toFixed(2), "", "", "", ""]);
      wsData.push(["Outstanding", "", (rentalTotal - rentalCleared).toFixed(2), "", "", "", ""]);
      wsData.push([]);
      
      // Analyze cheque types for Excel labels
      const chequeAnalysisXL = analyzeChequeTypes();
      const xlChequeLabel = chequeAnalysisXL.label;
      
      // PDC List data for Excel
      let pdcTotal = 0;
      wsData.push([`${xlChequeLabel} to Hand Over`]);
      wsData.push(["Cheque #", "Bank", "Date", "Amount"]);
      qsa('#pdcChequesRow .chq').forEach(card => {
        const amt = Number(card.querySelector('input[type="number"]').value || 0);
        const date = card.querySelector('input[type="date"]').value;
        const labelEl = card.querySelector('.label');
        const chqMatch = labelEl ? labelEl.textContent.match(/\d+/) : null;
        const fallbackChq = chqMatch ? chqMatch[0] : '';
        const bank = card.dataset.bank || '';
        const chequeNumber = card.dataset.chequeNumber || fallbackChq;
        wsData.push([chequeNumber || fallbackChq, bank, date, amt.toFixed(2)]);
        pdcTotal += amt;
      });
      wsData.push([`Total ${xlChequeLabel}`, "", "", pdcTotal.toFixed(2)]);
      
      wsData.push([]);
      wsData.push(["Settlement Table"]);
      const table = qs('#resultsTable');
      const rows = table.rows;
      for(let i=0; i<rows.length; i++){
        const cells = rows[i].cells;
        const rowData = [];
        for(let j=0; j<cells.length; j++){
          rowData.push(cells[j].innerText);
        }
        wsData.push(rowData);
      }
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      XLSX.utils.book_append_sheet(wb, ws, "Settlement");
      XLSX.writeFile(wb, filename);
    }
    
    async function exportToPNG(){
      if(resultsBody.innerText.includes('Click Calculate')){ alert('Please calculate first.'); return; }
      try {
        const container = document.createElement('div');
        container.className = 'export-container';
        
        const header = document.createElement('div');
        const buildingText = buildingName.value ? `${buildingName.value} — ` : '';
        header.className = 'export-header';
        header.innerHTML = `
          <h2>${buildingText}Unit ${unitNo.value || 'N/A'} — ${tenantName.value || 'N/A'}</h2>
          <p>Settlement Report</p>
        `;
        container.appendChild(header);
        
        const tableClone = qs('#resultsTable').cloneNode(true);
        tableClone.classList.add('export-table');
        container.appendChild(tableClone);
        
        const settlement = document.createElement('div');
        settlement.className = 'export-summary';
        const summaryTotal = qs('#summaryTotal').textContent;
        const directionText = qs('#directionText').textContent;
        const notesHtml = qs('#notes').innerHTML;
        settlement.innerHTML = `
          <div class="export-summary-grid">
            <div>
              <div class="export-summary-label">Final Settlement</div>
              <div class="export-summary-amount">${summaryTotal}</div>
              <div class="export-summary-direction">${directionText}</div>
            </div>
            <div>
              <div class="export-summary-label">Breakdown</div>
              <div class="export-summary-notes">${notesHtml}</div>
            </div>
          </div>
        `;
        container.appendChild(settlement);
        document.body.appendChild(container);
        
        const canvas = await html2canvas(container, {
          scale: 1.5, useCORS: true, backgroundColor: '#ffffff', logging: false, allowTaint: true
        });
        document.body.removeChild(container);
        
        canvas.toBlob(function(blob) {
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = generateSmartFilename('png');
          link.click();
          URL.revokeObjectURL(link.href);
        }, 'image/png', 0.85);
      } catch(err) {
        console.error('PNG export error:', err);
        alert('Error exporting PNG. Please try PDF or Excel instead.');
      }
    }

    function resetAll(){
      qsa('input').forEach(i => { if(i.type !== 'button' && i.type !== 'checkbox') i.value = ''; });
      qsa('input[type="checkbox"]').forEach(i => i.checked = false);
      qsa('select').forEach(s => s.selectedIndex = 0);
      qsa('textarea').forEach(t => t.value = ''); // Clear all textareas including bulk import
      initChequesUI();
      qs('#timeline-container').innerHTML = '<div id="time-seller">Seller</div><div id="time-buyer">Buyer</div>';
      qs('#time-seller').style.width = '0%';
      qs('#time-buyer').style.width = '0%';
      // Reset lease duration badge
      const durationBadge = qs('#leaseDurationBadge');
      if(durationBadge) {
        durationBadge.style.display = 'none';
        const durationText = durationBadge.querySelector('.duration-text');
        if(durationText) durationText.textContent = '';
        durationBadge.classList.remove('standard', 'warning', 'unusual');
      }
      if(resultsCard) resultsCard.classList.add('is-hidden');
      if(resultsDivider) resultsDivider.classList.add('is-hidden');
      summarySection.style.display = 'none';
      setResultsVisibility(false);
      resultsBody.innerHTML = '<tr><td colspan="13" class="center muted">Click Calculate to see results</td></tr>';
      qs('#commSectionWrapper').classList.remove('active');
      clearGapJustification({ hideCard: true });
      clearDismissedHealthItems(); // Clear dismissed health items on reset
      chequeImportWarnings = []; // Clear import warnings on reset
      scPaidEndManuallySet = false; // Reset SC Paid End manual flag
      scRateFromSavedCase = false; // Reset SC Rate saved case protection
      updateTitle(); 
      syncUnclearedToPDC(); // Resync on reset to clear any remaining PDCs
      clearSavedState(); // Clear auto-saved data
      // If user previously locked SC Rate inside the field, restore it after reset
      try{
        const locked = localStorage.getItem('rs_scRate_lock_field') === '1';
        const val = localStorage.getItem('rs_scRate_lock_value');
        if(locked && qs('#scRate')) {
          qs('#scRate').value = val || qs('#scRate').value;
          const lockEl = qs('#scRateLockInside');
          if(lockEl) lockEl.checked = true;
          qs('#scRate').readOnly = true;
          scRateFromSavedCase = true;
        }
      } catch(e) { console.warn('restore scRate lock after reset failed', e); }
      // Reapply user's persisted toggle preferences so Req/Auto toggles remain as last chosen
      try{ if(typeof loadTogglePrefs === 'function') loadTogglePrefs(); } catch(e){ console.warn('Reapplying toggle prefs failed', e); }
      showToast('Form reset and saved data cleared');
      validateFields();
      markDocsReady(false);
      updateHealthRibbon();
      // Clear empty unit mode banner on reset
      if(typeof window.checkEmptyUnitMode === 'function') window.checkEmptyUnitMode();
      // Clear stale data tracking on reset
      lastCalculationHash = null;
      calculationIsFresh = false;
      if(staleDataWarning) staleDataWarning.classList.remove('visible');
      document.body.classList.remove('results-stale');
    }

    function parsePropertyData(text){
      // Split by tab or pipe, keep empty values to preserve column positions
      const rawParts = text.split(/\t|\|/).map(p => p.trim());
      const parts = rawParts;
      
      console.log('Parsed parts:', parts, 'Count:', parts.length);
      
      if(parts.length < 3) return alert('Not enough data to parse');
      
      // Smart date parser - handles multiple formats
      const parseD = d => { 
        if(!d) return '';
        d = d.trim();
        const monthMap = {jan:'01',feb:'02',mar:'03',apr:'04',may:'05',jun:'06',jul:'07',aug:'08',sep:'09',oct:'10',nov:'11',dec:'12'};
        
        // Try to extract day, month name, and year from the string
        // This handles: 23-May-2025, 23/May/2025, 23 May 2025, May-23-2025, etc.
        const monthNames = Object.keys(monthMap).join('|');
        const dateWithMonthName = d.match(new RegExp(`(\\d{1,2})[\\-\\/\\s\\.]*(${monthNames})[a-z]*[\\-\\/\\s\\.]*(\\d{4})`, 'i'));
        if(dateWithMonthName) {
          const day = dateWithMonthName[1].padStart(2,'0');
          const monKey = dateWithMonthName[2].toLowerCase().substring(0,3);
          const mon = monthMap[monKey];
          const year = dateWithMonthName[3];
          if(mon) return `${year}-${mon}-${day}`;
        }
        
        // Try month-day-year format (May-23-2025)
        const monthFirstFormat = d.match(new RegExp(`(${monthNames})[a-z]*[\\-\\/\\s\\.]*(\\d{1,2})[\\-\\/\\s\\.]*(\\d{4})`, 'i'));
        if(monthFirstFormat) {
          const monKey = monthFirstFormat[1].toLowerCase().substring(0,3);
          const day = monthFirstFormat[2].padStart(2,'0');
          const year = monthFirstFormat[3];
          const mon = monthMap[monKey];
          if(mon) return `${year}-${mon}-${day}`;
        }
        
        // Handle dd/mm/yyyy or dd-mm-yyyy
        const ddmmyyyy = d.match(/^(\d{1,2})[-\/](\d{1,2})[-\/](\d{4})$/);
        if(ddmmyyyy) {
          return `${ddmmyyyy[3]}-${ddmmyyyy[2].padStart(2,'0')}-${ddmmyyyy[1].padStart(2,'0')}`;
        }
        // Handle yyyy-mm-dd
        if(/^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
        
        // Last resort: try JavaScript Date parser
        const dt = new Date(d); 
        return isNaN(dt) ? '' : dt.toISOString().split('T')[0]; 
      };
      
      const cleanNum = v => parseFloat((v || '').replace(/,/g,'').replace(/[^0-9.]/g,'')) || 0;
      
      // Format 1: Old format - Unit | Tenant | Start | End | Rent | Term | Deposit | Cheques (8 columns)
      // Detect by: 8 columns, first is 3-digit unit, second is name, columns 3-4 are dates
      const is8ColFormat = parts.length === 8 && 
        /^\d{3,4}$/.test((parts[0] || '').trim()) && 
        parseD(parts[2]) !== '' && 
        parseD(parts[3]) !== '';
      
      if(is8ColFormat) {
        console.log('Detected 8-column old format: Unit | Tenant | Start | End | Rent | Term | Deposit | Cheques');
        const unitNum = (parts[0] || '').trim();
        const tenant = (parts[1] || '').trim();
        const startDate = parseD(parts[2]);
        const endDate = parseD(parts[3]);
        const rent = cleanNum(parts[4]);
        // parts[5] is term (e.g., 12 months) - skip
        const deposit = cleanNum(parts[6]);
        const cheques = parseInt(parts[7]) || 0;
        
        console.log('Mapped values:', {unitNum, tenant, startDate, endDate, rent, deposit, cheques});
        
        unitNo.value = unitNum;
        tenantName.value = tenant;
        if(startDate) leaseStart.value = startDate;
        if(endDate) leaseEnd.value = endDate;
        if(rent) setCurrencyValue(rentInput, rent);
        if(deposit) setCurrencyValue(securityDeposit, deposit);
        if(cheques) { 
          rentalCountSel.value = String(Math.min(6, cheques)); 
          updateRentalCount(); 
        }
        
        debouncedUpdateContractInfo();
        calculateServiceCharge();
        updateTitle();
        syncUnclearedToPDC();
        queueAutosave();
        return;
      }
      
      // Format 2: SI.No | Area | BHK | Unit | Tenant | Start | End | Rent | Term | Deposit | Cheques
      // Detect by: 11 columns, first is small serial number, second has decimal (area)
      const hasEnoughCols = parts.length >= 8;
      const firstIsSerial = /^\d{1,2}$/.test((parts[0] || '').trim()); // SI.No is 1-99
      const secondIsArea = cleanNum(parts[1]) >= 100 && cleanNum(parts[1]) <= 50000; // Area 100-50000 sq.ft
      const hasDates = parts.some(p => parseD(p) !== ''); // Has at least one date
      
      console.log('Detection:', {hasEnoughCols, firstIsSerial, secondIsArea, hasDates});
      
      if(hasEnoughCols && firstIsSerial && secondIsArea && hasDates) {
        console.log('Detected SI.No format - using fixed column mapping');
        
        // Fixed column mapping:
        // 0: SI.No (ignore), 1: Area, 2: BHK (ignore), 3: Unit, 4: Tenant
        // 5: Start, 6: End, 7: Rent, 8: Term (ignore), 9: Deposit, 10: Cheques
        const area = cleanNum(parts[1]);         
        const unitNum = (parts[3] || '').trim(); 
        const tenant = (parts[4] || '').trim();  
        const startDate = parseD(parts[5]);      
        const endDate = parseD(parts[6]);        
        const rent = cleanNum(parts[7]);         
        const deposit = parts[9] ? cleanNum(parts[9]) : 0;
        const cheques = parts[10] ? parseInt(parts[10]) : 0;
        
        console.log('Mapped values:', {unitNum, area, tenant, startDate, endDate, rent, deposit, cheques});
        
        // Fill form fields
        unitNo.value = unitNum;
        tenantName.value = tenant;
        if(startDate) leaseStart.value = startDate;
        if(endDate) leaseEnd.value = endDate;
        if(rent) setCurrencyValue(rentInput, rent);
        if(deposit) setCurrencyValue(securityDeposit, deposit);
        if(cheques) { 
          rentalCountSel.value = String(Math.min(6, cheques)); 
          updateRentalCount(); 
        }
        if(area && qs('#scArea')) qs('#scArea').value = area.toFixed(2);
        
        debouncedUpdateContractInfo();
        calculateServiceCharge();
        updateTitle();
        syncUnclearedToPDC();
        queueAutosave();
        return;
      }
      
      // Fallback: Smart detection for other formats
      const isDate = v => parseD(v) !== '';
      const isLargeNumber = v => cleanNum(v) >= 1000;
      const isSmallNumber = v => /^\d{1,2}$/.test((v||'').trim());
      const isAreaLike = v => cleanNum(v) >= 100 && cleanNum(v) <= 50000;
      const isName = v => /^[A-Za-z\s]{3,}/.test((v||'').trim()) && !/^\d/.test(v);
      const isUnitNo = v => /^\d{2,5}$/.test((v||'').trim()) || /^[A-Za-z]?\d+[A-Za-z]?$/i.test((v||'').trim());
      
      const classified = parts.map((val, idx) => ({
        idx, val,
        isDate: isDate(val),
        isLargeNum: isLargeNumber(val),
        isSmallNum: isSmallNumber(val),
        isArea: isAreaLike(val) && !isDate(val),
        isName: isName(val),
        isUnit: isUnitNo(val),
        numVal: cleanNum(val)
      }));
      
      const dates = classified.filter(c => c.isDate).sort((a,b) => a.idx - b.idx);
      const largeNums = classified.filter(c => c.isLargeNum && !c.isDate).sort((a,b) => b.numVal - a.numVal);
      const names = classified.filter(c => c.isName);
      const smallNums = classified.filter(c => c.isSmallNum);
      const areas = classified.filter(c => c.isArea && !c.isLargeNum);
      
      let foundUnit = '', foundTenant = '', foundStart = '', foundEnd = '';
      let foundRent = 0, foundDeposit = 0, foundCheques = 0, foundArea = 0;
      
      if(dates.length >= 2) {
        foundStart = parseD(dates[0].val);
        foundEnd = parseD(dates[1].val);
      } else if(dates.length === 1) {
        foundStart = parseD(dates[0].val);
      }
      
      if(largeNums.length >= 1) foundRent = largeNums[0].numVal;
      if(largeNums.length >= 2) foundDeposit = largeNums[1].numVal;
      
      const usedIndices = new Set([...largeNums.slice(0,2).map(c=>c.idx), ...dates.map(c=>c.idx)]);
      const areaCandidate = areas.find(c => !usedIndices.has(c.idx) && c.numVal >= 100 && c.numVal <= 10000);
      if(areaCandidate) foundArea = areaCandidate.numVal;
      
      const chequeCandidate = smallNums.find(c => c.numVal >= 1 && c.numVal <= 12 && !usedIndices.has(c.idx));
      if(chequeCandidate) foundCheques = chequeCandidate.numVal;
      
      if(names.length > 0) {
        const sorted = names.sort((a,b) => b.val.length - a.val.length);
        foundTenant = sorted[0].val;
      }
      
      const unitCandidates = classified.filter(c => 
        !usedIndices.has(c.idx) && 
        c.val !== foundTenant &&
        (c.isUnit || (c.isSmallNum && c.numVal > 12))
      );
      if(unitCandidates.length > 0) {
        const threeDigit = unitCandidates.find(c => /^\d{3,4}$/.test(c.val.trim()));
        foundUnit = threeDigit ? threeDigit.val : unitCandidates[0].val;
      }
      
      if(foundUnit) unitNo.value = foundUnit;
      if(foundTenant) tenantName.value = foundTenant;
      if(foundStart) leaseStart.value = foundStart;
      if(foundEnd) leaseEnd.value = foundEnd;
      if(foundRent) setCurrencyValue(rentInput, foundRent);
      if(foundDeposit) setCurrencyValue(securityDeposit, foundDeposit);
      if(foundCheques) { 
        rentalCountSel.value = String(Math.min(6, foundCheques)); 
        updateRentalCount(); 
      }
      if(foundArea && qs('#scArea')) qs('#scArea').value = foundArea.toFixed(2);
      
      debouncedUpdateContractInfo();
      calculateServiceCharge();
      updateTitle();
      syncUnclearedToPDC();
      queueAutosave();
    }
    
    // Enhanced Cheque Import Function with Date Shift Bug Fix + metadata support
    function parseBulkLines(text){
      text = sanitizeString(text);
      if(!text) return [];
      const lines = text.split('\n').map(l => l.trim()).filter(Boolean);
      const parsed = [];

      const splitLine = (line) => line
        .split(/\t|\s*\|\s*/)
        .map(p => p.trim())
        .filter(Boolean);

      const tryParseDate = (token) => {
        if(!token) return null;
        const value = token.trim();
        let result = null;
        if(/^\d{1,2}\/\d{1,2}\/\d{2,4}$/.test(value)){
          const [d,m,y] = value.split('/');
          const fullYear = y.padStart(4,'20');
          const iso = `${fullYear}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
          result = new Date(iso + 'T00:00:00');
        } else if(/^\d{4}-\d{2}-\d{2}$/.test(value)){
          result = new Date(value + 'T00:00:00');
        } else {
          const fallback = new Date(value);
          if(!isNaN(fallback)) result = fallback;
        }
        if(result && !isNaN(result) && result.getFullYear() >= 2000) return result;
        return null;
      };

      const cleanAmount = (token) => (token || '').replace(/[^0-9.,-]/g,'').replace(/,/g,'');

      const normalizeToken = (token) => (token || '').replace(/\s+/g,' ').trim();
      const looksLikeBank = (value) => /^[A-Za-z&\s]{3,}$/.test(value);
      const looksLikeChequeNumber = (value) => /\d{3,}/.test(value);

      const extractMeta = (partsForMeta) => {
        let bankName = '';
        let chequeNumber = '';

        const assignFromToken = (rawToken) => {
          if(!rawToken) return;
          const token = normalizeToken(rawToken);
          if(!token) return;

          const splitMatch = token.match(/^([A-Za-z&\s]+)[\-–—_#\s]*([A-Za-z0-9]+.*)$/);
          if(splitMatch){
            const maybeBank = normalizeToken(splitMatch[1]);
            const maybeNumber = normalizeToken(splitMatch[2]);
            if(maybeBank && looksLikeBank(maybeBank) && !bankName) bankName = maybeBank;
            if(maybeNumber && !chequeNumber && looksLikeChequeNumber(maybeNumber)) chequeNumber = maybeNumber;
            if(maybeNumber && !chequeNumber) chequeNumber = maybeNumber;
            return;
          }

          if(!bankName && looksLikeBank(token)) {
            bankName = token;
            return;
          }

          if(!chequeNumber && looksLikeChequeNumber(token)) {
            chequeNumber = token.replace(/\s+/g,'');
            return;
          }

          if(!chequeNumber) {
            chequeNumber = token;
          }
        };

        partsForMeta.forEach(assignFromToken);
        return { bankName, chequeNumber };
      };

      for(const line of lines){
        const parts = splitLine(line);
        if(parts.length < 2) continue;

        let unitPart = null;
        let dateIndex, amountIndex, extraStart;
        let dateObj = null;
        let amt = 0;
        let bankChequeCombo = '';

        const metaCandidates = [];
        
        // Format: RENEW-XXXX | Unit | Name | Bank-ChequeNo | Date | Amount (6 columns)
        // Detect by: first column starts with RENEW or has 6 columns with date at index 4
        if(parts.length >= 6 && (parts[0].toUpperCase().startsWith('RENEW') || tryParseDate(parts[4]))){
          // New format: ignore col 0 & 1, col 3 is bank-cheque, col 4 is date, col 5 is amount
          unitPart = parts[1] || null;
          bankChequeCombo = parts[3] || '';
          dateObj = tryParseDate(parts[4]);
          amt = Number(cleanAmount(parts[5]));
          if(bankChequeCombo) metaCandidates.push(bankChequeCombo);
        } else if(parts.length >= 5){
          unitPart = parts[0] || null;
          dateIndex = 3;
          amountIndex = 4;
          extraStart = 5;
          if(parts[2]) metaCandidates.push(parts[2]);
          dateObj = tryParseDate(parts[dateIndex]);
          amt = Number(cleanAmount(parts[amountIndex]));
        } else {
          dateIndex = 0;
          amountIndex = 1;
          extraStart = 2;
          dateObj = tryParseDate(parts[dateIndex]);
          amt = Number(cleanAmount(parts[amountIndex]));
        }

        // Fallback: try to find date in any column if not found
        if(!dateObj){
          for(let idx = 0; idx < parts.length; idx++){
            const attempt = tryParseDate(parts[idx]);
            if(attempt){
              dateObj = attempt;
              // If date found, amount is likely the next column or last column
              if(idx + 1 < parts.length && !amt){
                amt = Number(cleanAmount(parts[idx + 1]));
              }
              if(!amt && parts.length > idx){
                amt = Number(cleanAmount(parts[parts.length - 1]));
              }
              break;
            }
          }
        }
        
        if(!dateObj) continue;
        if(isNaN(amt) || amt <= 0) continue;

        const extraParts = parts.length > 5 ? parts.slice(6) : (parts.length > 2 ? parts.slice(2) : []);
        const { bankName, chequeNumber } = extractMeta([...metaCandidates, ...extraParts]);

        const year = dateObj.getFullYear();
        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
        const day = String(dateObj.getDate()).padStart(2, '0');
        const iso = `${year}-${month}-${day}`;

        parsed.push({ date: iso, amt, unit: unitPart, bank: bankName, chequeNumber });
      }
      return parsed;
    }
    
    function updateTitle() {
        const u = unitNo.value, t = tenantName.value;
        const pageTitle = qs('#pageTitle');
        
        // Update page title
        if(u || t) {
          pageTitle.innerHTML = `<span class="page-title-strong">Unit ${u}</span> — ${t}`;
        } else {
          pageTitle.innerHTML = 'Rental Settlement';
        }
    }
    
    function generateSmartFilename(extension) {
      const unitRaw = (unitNo.value || '').trim();
      const tenantRaw = (tenantName.value || '').trim();
      const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');

      const sanitize = s => s.replace(/[^a-zA-Z0-9]+/g, '_').replace(/^_+|_+$/g, '');

      const unit = unitRaw ? sanitize(unitRaw) : '';
      // use first word of tenant as short name (common pattern), fallback to full name if single word
      const tenant = tenantRaw ? sanitize(tenantRaw.split(' ')[0]) : '';

      if(unit && tenant) {
        return `${unit}_${tenant}.${extension}`;
      } else if(unit) {
        return `${unit}.${extension}`;
      } else if(tenant) {
        return `${tenant}.${extension}`;
      } else {
        return `Settlement_${date}.${extension}`;
      }
    }

    function toggleEdit(textareaId, displayId) {
      const textarea = qs(`#${textareaId}`);
      const display = qs(`#${displayId}`);
      const isHidden = textarea.classList.contains('is-hidden');

      if(isHidden) {
        textarea.classList.remove('is-hidden');
        display.classList.add('is-hidden');
        textarea.focus();
      } else {
        display.textContent = textarea.value;
        textarea.classList.add('is-hidden');
        display.classList.remove('is-hidden');
      }
    }
    
    function copyMessage(textareaId) {
      const textarea = qs(`#${textareaId}`);
      const text = textarea.value;
      navigator.clipboard.writeText(text).then(() => {
        showToast('Message copied to clipboard');
      });
    }
    
    function sendWhatsApp(textareaId) {
      const textarea = qs(`#${textareaId}`);
      const text = textarea.value;
      if(!text) {
        alert('No message to send. Please calculate first.');
        return;
      }
      const encodedMessage = encodeURIComponent(text);
      const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
      window.open(whatsappUrl, '_blank');
    }
    
    function sendEmail(textareaId) {
      const textarea = qs(`#${textareaId}`);
      const text = textarea.value;
      if(!text) {
        alert('No message to send. Please calculate first.');
        return;
      }
      
      // Extract subject from first line if it starts with "Subject:"
      let subject = 'Rental Settlement';
      let body = text;
      
      if(text.startsWith('Subject:')) {
        const lines = text.split('\n');
        subject = lines[0].replace('Subject:', '').trim();
        body = lines.slice(1).join('\n').trim();
      }
      
      const buyerEmail = commBuyerName.value.includes('@') ? commBuyerName.value : '';
      const mailtoLink = `mailto:${buyerEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      window.location.href = mailtoLink;
    }

    function shareViaWhatsApp() {
      if(!lastCalcData) {
        alert('Please calculate the settlement first.');
        return;
      }
      
      const { unit, tenant, ho, net, pdcTotal, pdcCount, chequeAnalysis } = lastCalcData;
      const isSellerPays = net >= 0;
      const formattedNet = money(Math.abs(net));
      const building = buildingName.value.trim();
      
      // Use dynamic cheque labels
      const chqLabel = chequeAnalysis?.label || 'Cheques';
      
      // Get settlement breakdown
      const ls = leaseStart.value, le = leaseEnd.value;
      const rent = sanitizeNumber(rentInput.value);
      const dep = sanitizeNumber(securityDeposit.value);
      const sc = sanitizeNumber(serviceCharge.value);
      const totalDays = daysInclusive(ls, le);
      const sellerDays = Math.max(0, daysInclusive(ls, ho));
      const buyerDays = Math.max(0, totalDays - sellerDays);
      const daily = totalDays > 0 ? rent / totalDays : 0;
      const sellerRent = daily * sellerDays;
      const buyerRent = rent - sellerRent;
      
      // Build WhatsApp message
      let message = `*RENTAL SETTLEMENT SUMMARY*\n\n`;
      if(building) message += `🏢 *Building:* ${building}\n`;
      message += `📋 *Unit:* ${unit}\n`;
      message += `👤 *Tenant:* ${tenant}\n`;
      message += `📅 *Handover Date:* ${fmtDateForTable(ho)}\n\n`;
      message += `━━━━━━━━━━━━━━━━━━━━\n\n`;
      message += `*FINAL SETTLEMENT AMOUNT*\n`;
      message += `💰 *${formattedNet}*\n`;
      message += `${isSellerPays ? '✅ SELLER PAYS BUYER' : '⚠️ BUYER PAYS SELLER'}\n\n`;
      message += `━━━━━━━━━━━━━━━━━━━━\n\n`;
      message += `*BREAKDOWN:*\n\n`;
      message += `Buyer Rent (Pro-rata)\n${money(buyerRent)}\n\n`;
      message += `Less: ${chqLabel} (${pdcCount})\n- ${money(pdcTotal)}\n\n`;
      message += `Add: Security Deposit\n+ ${money(dep)}\n\n`;
      message += `Less: Service Charge\n- ${money(sc)}\n\n`;
      message += `━━━━━━━━━━━━━━━━━━━━\n\n`;
      message += `*${isSellerPays ? 'Seller → Buyer' : 'Buyer → Seller'}*\n`;
      message += `*${formattedNet}*\n\n`;
      message += `_Generated by Rental Settlement Calculator_`;
      
      // Encode and open WhatsApp
      const encodedMessage = encodeURIComponent(message);
      const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
      window.open(whatsappUrl, '_blank');
    }

    function hasCoreInputsFilled(){
      const required = [buildingName, unitNo, tenantName, leaseStart, leaseEnd, handoverDate, rentInput];
      return required.every(input => input && String(input.value || '').trim() !== '');
    }

    function getPdcMetrics(){
      let count = 0, total = 0;
      qsa('#pdcChequesRow input[type="number"]').forEach(input => {
        const amt = Number(input.value || 0);
        if(amt > 0){
          count++;
          total += amt;
        }
      });
      return { count, total };
    }

    function syncGapReasonButtons(){
      if(!gapReasonButtons) return;
      gapReasonButtons.forEach(btn => {
        if(!btn) return;
        const reason = btn.dataset.gapReason || '';
        const isActive = chequeGapJustification.reason === reason && reason !== '';
        btn.classList.toggle('active', isActive);
        btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
      });
    }

    function clearGapJustification(options = {}){
      chequeGapJustification = { reason: '', note: '' };
      if(gapReasonNote) gapReasonNote.value = '';
      syncGapReasonButtons();
      if(options.hideCard && chequeGapCard){
        chequeGapCard.classList.add('is-hidden');
      }
    }

    function selectGapReason(reason){
      if(!gapReasonButtons?.length) return;
      if(chequeGapJustification.reason === reason){
        chequeGapJustification.reason = '';
      } else if(GAP_REASON_META[reason]){
        chequeGapJustification.reason = reason;
      } else {
        chequeGapJustification.reason = '';
      }
      syncGapReasonButtons();
      updateGapClarifier();
      queueAutosave();
      updateHealthRibbon();
    }

    function updateGapClarifier(meta){
      if(meta) lastChequeGapMeta = meta;
      const info = lastChequeGapMeta;
      if(!info || info.absDiff < 1 || info.rentAnnual <= 0){
        clearGapJustification();
        return;
      }
      // Update the modal content (displayed when modal opens)
      if(chequeGapAmount){
        chequeGapAmount.textContent = money(info.absDiff);
      }
        if(document.getElementById('chequeGapPercent')){
          document.getElementById('chequeGapPercent').textContent = `${(info.percent||0).toFixed(2)}%`;
        }
      if(chequeGapDirection){
        chequeGapDirection.textContent = info.diff > 0 ? 'Cheques exceed rent' : 'Cheques short vs rent';
      }
      const reasonMeta = chequeGapJustification.reason ? GAP_REASON_META[chequeGapJustification.reason] : null;
      let hintText = `Gap is ${(info.percent || 0).toFixed(2)}% of total contract rent.`;
      if(reasonMeta){
        hintText = reasonMeta.copy;
      } else if((info.percent || 0) <= 3){
        hintText += ' Often this is a management fee or cash adjustment — tag it below.';
      } else if(info.diff > 0){
        hintText += ' Seller collected more than the contract rent — explain the adjustment.';
      } else {
        hintText += ' Seller collected less than the contract rent — explain the shortage.';
      }
      if(chequeGapHint) chequeGapHint.textContent = hintText;
      if(gapReasonNote && gapReasonNote.value !== (chequeGapJustification.note || '')){
        gapReasonNote.value = chequeGapJustification.note || '';
      }
      syncGapReasonButtons();
    }

    function openChequeGapModal(){
      if(!chequeGapModal || !lastChequeGapMeta) return;
      if(lastChequeGapMeta.absDiff < 1) return; // No gap to clarify
      updateGapClarifier();
      chequeGapModal.classList.add('show');
      chequeGapModal.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';
    }
    function closeChequeGapModal(){
      if(!chequeGapModal) return;
      chequeGapModal.classList.remove('show');
      chequeGapModal.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
    }

    // Docs popup tracking
    let docsExportStatus = { pdf: false, buyerPdf: false, png: false, messages: false, whatsapp: false };
    
    function openDocsPopup(){
      if(!docsPopup) return;
      const calcReady = resultsCard && !resultsCard.classList.contains('is-hidden');
      if(!calcReady){
        showToast('Calculate first to unlock exports', 'warn');
        return;
      }
      updateDocsPopupStatus();
      docsPopup.classList.add('show');
      docsPopup.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';
    }
    
    function closeDocsPopup(){
      if(!docsPopup) return;
      docsPopup.classList.remove('show');
      docsPopup.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
    }
    
    function updateDocsPopupStatus(){
      const btns = {
        pdf: qs('#docsActionPdf'),
        buyerPdf: qs('#docsActionBuyerPdf'),
        png: qs('#docsActionPng'),
        messages: qs('#docsActionMessages'),
        whatsapp: qs('#docsActionWhatsapp')
      };
      Object.entries(btns).forEach(([key, btn]) => {
        if(!btn) return;
        const check = btn.querySelector('.action-check');
        if(docsExportStatus[key]){
          btn.classList.add('done');
          if(check) check.style.display = '';
        } else {
          btn.classList.remove('done');
          if(check) check.style.display = 'none';
        }
      });
    }
    
    function markDocExported(type){
      docsExportStatus[type] = true;
      updateDocsPopupStatus();
      updateDocsHealthBadge();
    }
    
    function updateDocsHealthBadge(){
      const exported = Object.values(docsExportStatus).filter(v => v).length;
      const total = Object.keys(docsExportStatus).length;
      const calcReady = resultsCard && !resultsCard.classList.contains('is-hidden');
      
      if(exported > 0){
        const items = [];
        if(docsExportStatus.pdf) items.push('PDF');
        if(docsExportStatus.buyerPdf) items.push('Buyer');
        if(docsExportStatus.messages) items.push('Msgs');
        setHealthBadgeState('docs', 'ready', '✓ ' + items.join(', ') + ' done — tap for more');
      } else if(calcReady){
        setHealthBadgeState('docs', 'warn', '📤 Tap to export & share');
      } else {
        setHealthBadgeState('docs', 'idle', 'Locked until results ready');
      }
    }

    // Calculations popup
    function openCalcPopup(){
      if(!calcPopup) return;
      const calcReady = resultsCard && !resultsCard.classList.contains('is-hidden');
      if(!calcReady){
        showToast('Calculate first to see breakdown', 'warn');
        return;
      }
      buildCalcBreakdown();
      calcPopup.classList.add('show');
      calcPopup.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';
    }
    
    function closeCalcPopup(){
      if(!calcPopup) return;
      calcPopup.classList.remove('show');
      calcPopup.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
    }
    
    function buildCalcBreakdown(){
      const ls = leaseStart.value, le = leaseEnd.value, ho = handoverDate.value;
      const rent = sanitizeNumber(rentInput.value);
      const sc = sanitizeNumber(serviceCharge.value);
      const dep = sanitizeNumber(securityDeposit.value);
      
      if(!ls || !le || !ho || rent <= 0) return;
      
      const totalDays = daysInclusive(ls, le);
      const sellerDays = Math.max(0, daysInclusive(ls, ho));
      const buyerDays = Math.max(0, totalDays - sellerDays);
      const daily = totalDays ? rent / totalDays : 0;
      const sellerRent = daily * sellerDays;
      const buyerRent = rent - sellerRent;
      
      let pdcTotal = 0;
      qsa('#pdcChequesRow input[type="number"]').forEach(input => {
        pdcTotal += Number(input.value || 0);
      });
      
      const adj = buyerRent - pdcTotal;
      const net = Number((adj + dep - sc).toFixed(2));
      const isSellerPays = net >= 0;
      
      // Update net display
      const netEl = qs('#calcPopupNet');
      const netAmtEl = qs('#calcPopupNetAmount');
      const netDirEl = qs('#calcPopupNetDir');
      if(netEl) netEl.classList.toggle('buyer-pays', !isSellerPays);
      if(netAmtEl) netAmtEl.textContent = money(Math.abs(net));
      if(netDirEl) netDirEl.textContent = isSellerPays ? 'Seller pays Buyer' : 'Buyer pays Seller';
      
      // Build breakdown rows
      const body = qs('#calcBreakdownBody');
      if(!body) return;

      const chequeAnalysis = analyzeChequeTypes();

      body.innerHTML = `
        <div class="calc-row">
          <div>
            <div class="calc-row-label">Lease Period</div>
            <div class="calc-row-sub">${fmtDateForTable(ls)} → ${fmtDateForTable(le)}</div>
          </div>
          <div class="calc-row-value">${totalDays} days</div>
        </div>
        <div class="calc-row seller">
          <div>
            <div class="calc-row-label">Seller Period</div>
            <div class="calc-row-sub">${sellerDays} days • ${money(daily)}/day</div>
          </div>
          <div class="calc-row-value">${money(sellerRent)}</div>
        </div>
        <div class="calc-row buyer">
          <div>
            <div class="calc-row-label">Buyer Period</div>
            <div class="calc-row-sub">${buyerDays} days • ${money(daily)}/day</div>
          </div>
          <div class="calc-row-value">${money(buyerRent)}</div>
        </div>
        <div class="calc-divider"></div>
        <div class="calc-row pdc">
          <div>
            <div class="calc-row-label">Handed Cheques</div>
            <div class="calc-row-sub">Handed Cheques (PDC/PD)</div>
          </div>
          <div class="calc-row-value">- ${money(pdcTotal)}</div>
        </div>
        <div class="calc-row deposit">
          <div>
            <div class="calc-row-label">Security Deposit</div>
            <div class="calc-row-sub">Added to settlement</div>
          </div>
          <div class="calc-row-value">+ ${money(dep)}</div>
        </div>
        <div class="calc-row sc">
          <div>
            <div class="calc-row-label">Service Charge</div>
            <div class="calc-row-sub">Deducted from settlement</div>
          </div>
          <div class="calc-row-value">- ${money(sc)}</div>
        </div>
      `;
    }
    
    function copyCalcBreakdown(){
      const ls = leaseStart.value, le = leaseEnd.value, ho = handoverDate.value;
      const rent = sanitizeNumber(rentInput.value);
      const sc = sanitizeNumber(serviceCharge.value);
      const dep = sanitizeNumber(securityDeposit.value);
      const totalDays = daysInclusive(ls, le);
      const sellerDays = Math.max(0, daysInclusive(ls, ho));
      const buyerDays = Math.max(0, totalDays - sellerDays);
      const daily = totalDays ? rent / totalDays : 0;
      const sellerRent = daily * sellerDays;
      const buyerRent = rent - sellerRent;
      let pdcTotal = 0;
      qsa('#pdcChequesRow input[type="number"]').forEach(input => {
        pdcTotal += Number(input.value || 0);
      });
      const adj = buyerRent - pdcTotal;
      const net = Number((adj + dep - sc).toFixed(2));
      const isSellerPays = net >= 0;
      
      // SC Rate label for copy text
      const copyScRateVal = sanitizeNumber(qs('#scRate')?.value || 0);
      const copyScFieldsOn = isScFieldsMandatory();
      const copyScLabel = copyScFieldsOn && copyScRateVal > 0 
        ? `Less SC @ AED ${copyScRateVal}/sq.ft`
        : 'Less SC';
      
      const text = `SETTLEMENT BREAKDOWN
${'='.repeat(30)}
Unit: ${unitNo.value || 'N/A'} | Tenant: ${tenantName.value || 'N/A'}
Lease: ${fmtDateForTable(ls)} to ${fmtDateForTable(le)} (${totalDays} days)
Handover: ${fmtDateForTable(ho)}

Seller: ${sellerDays} days = AED ${sellerRent.toFixed(2)}
Buyer: ${buyerDays} days = AED ${buyerRent.toFixed(2)}

Buyer Rent: AED ${buyerRent.toFixed(2)}
Less PDCs: - AED ${pdcTotal.toFixed(2)}
Add Deposit: + AED ${dep.toFixed(2)}
${copyScLabel}: - AED ${sc.toFixed(2)}
${'='.repeat(30)}
NET: AED ${Math.abs(net).toFixed(2)} (${isSellerPays ? 'Seller pays Buyer' : 'Buyer pays Seller'})`;
      
      navigator.clipboard.writeText(text).then(() => {
        showToast('Breakdown copied!', 'success');
      });
    }

    function setHealthBadgeState(key, state, text){
      const badge = healthBadges[key];
      if(!badge) return;
      badge.classList.remove('ready','warn','idle','alert');
      badge.classList.add(state);
      const statusEl = badge.querySelector('.badge-status');
      if(statusEl) statusEl.textContent = text;
    }

    function updateHealthRibbon(){
      if(!settlementHealthRibbon) {
        settlementHealthRibbon = qs('#settlementHealthRibbon');
      }
      if(!settlementHealthRibbon) return;
      const calcReady = resultsCard && !resultsCard.classList.contains('is-hidden');
      const inputsReady = hasCoreInputsFilled();
      const { count: pdcCount, total: pdcTotal } = getPdcMetrics();
      const chequesReady = pdcCount > 0;
      const docsReady = docsReadyFlag;

      // Calculations badge - show NET amount when ready
      let calcState = calcReady ? 'ready' : (inputsReady ? 'warn' : 'idle');
      let calcText = 'Fill lease dates & rent first';
      if(calcReady && lastCalcData){
        const net = Math.abs(lastCalcData.net || 0);
        const direction = (lastCalcData.net || 0) >= 0 ? 'Seller → Buyer' : 'Buyer → Seller';
        calcText = `${money(net)} ${direction} — tap for details`;
      } else if(inputsReady){
        calcText = '⚡ Press Calculate to see NET';
      }
      setHealthBadgeState('calc', calcState, calcText);

      // Cheques badge - show mismatch warnings and import alerts
      const rentAnnual = sanitizeNumber(rentInput?.value);
      const rentalTotals = computeRentalTotals();
      const chequeDiff = rentAnnual > 0 ? rentalTotals.total - rentAnnual : 0;
      const chequeDiffAbs = Math.abs(chequeDiff);
      const diffPercent = rentAnnual > 0 ? (chequeDiffAbs / rentAnnual) * 100 : 0;
      updateGapClarifier({ diff: chequeDiff, absDiff: chequeDiffAbs, percent: diffPercent, rentAnnual, chequeTotal: rentalTotals.total });

      let chequesState = chequesReady ? 'ready' : (calcReady ? 'warn' : 'idle');
      let chequeText = chequesReady
        ? `${pdcCount} PDC${pdcCount !== 1 ? 's' : ''} ready` + (pdcTotal ? ` • ${money(pdcTotal)}` : '')
        : (calcReady ? '⚠️ Import cheques before closing' : 'Import cheques after rent is set');

      // Show rent vs cheques mismatch
      if(rentAnnual > 0 && rentalTotals.total > 0){
        if(diffPercent > 5){
          chequesState = 'alert';
          chequeText = `❌ ${money(chequeDiffAbs)} ${chequeDiff > 0 ? 'OVER' : 'SHORT'} vs rent!`;
        } else if(diffPercent > 1){
          chequesState = chequesReady ? 'warn' : chequesState;
          chequeText = `⚠️ ${money(chequeDiffAbs)} ${chequeDiff > 0 ? 'over' : 'under'} rent`;
        }
      }

      // Show outstanding cheques info
      if(rentalTotals.outstanding > 0 && chequesState === 'ready'){
        chequeText += ` • ${money(rentalTotals.outstanding)} outstanding`;
      }

      // Show import warnings if any - with specific messages for unit/rent mismatch
      if(chequeImportWarnings.length > 0){
        chequesState = 'alert';
        const hasUnitMismatch = chequeImportWarnings.some(w => w.includes('UNIT MISMATCH'));
        const hasRentMismatch = chequeImportWarnings.some(w => w.includes('RENT MISMATCH'));
        if(hasUnitMismatch && hasRentMismatch){
          chequeText = '❌ Unit + Rent mismatch! Check health panel';
        } else if(hasUnitMismatch){
          chequeText = '❌ WRONG UNIT! Cheques don\'t match this unit';
        } else if(hasRentMismatch){
          chequeText = '❌ Rent mismatch! Cheques ≠ Annual rent';
        } else {
          chequeText = `⚠️ Import warning: ${chequeImportWarnings.length} issue${chequeImportWarnings.length > 1 ? 's' : ''}`;
        }
      }

      const hasChequeGap = rentAnnual > 0 && rentalTotals.total > 0 && chequeDiffAbs >= 1;
      if(hasChequeGap){
        const reasonMeta = chequeGapJustification.reason ? GAP_REASON_META[chequeGapJustification.reason] : null;
        // Always show the difference amount
        const diffDisplay = `${money(chequeDiffAbs)} ${chequeDiff > 0 ? 'over' : 'short'}`;
        if(reasonMeta){
          if(reasonMeta.severityImpact === 'reduce' && chequesState === 'alert' && chequeImportWarnings.length === 0){
            chequesState = 'warn';
          }
          if(reasonMeta.severityImpact === 'keep'){
            chequesState = 'alert';
          }
          // Keep the difference amount visible along with the justification
          chequeText = `✔ ${diffDisplay} — ${reasonMeta.short}`;
          const gapNoteSnippet = (chequeGapJustification.note || '').trim();
          if(gapNoteSnippet){
            const preview = gapNoteSnippet.length > 25 ? `${gapNoteSnippet.slice(0,25)}…` : gapNoteSnippet;
            chequeText += ` (${preview})`;
          }
          chequeText += ' ✎';
        } else {
          // Gap exists but not justified - show prompt to click
          chequeText = `⚠️ ${diffDisplay} — tap to clarify`;
          chequesState = 'warn';
        }
      }

      setHealthBadgeState('cheques', chequesState, chequeText.trim());

      // SC badge - estimate Seller SC when SC Rate is NOT required
      updateScHealthBadge();

      // Docs badge - use dedicated function
      updateDocsHealthBadge();
    }

    // SC Health Badge: Estimate Seller SC when SC Rate is NOT required
    // Formula: Seller SC = (Buyer SC / Buyer Days) × Seller Days
    // Purely informational - does NOT affect any calculations
    function updateScHealthBadge() {
      const scBadge = qs('#healthBadge-sc');
      if (!scBadge) return;

      const scRateRequired = qs('#scFieldsMandatory')?.checked ?? true;
      const scAreaRequired = qs('#scAreaReqToggle')?.checked ?? true;
      const buyerSC = sanitizeNumber(qs('#serviceCharge')?.value);
      const lsVal = qs('#leaseStart')?.value;
      const leVal = qs('#leaseEnd')?.value;
      const hoVal = qs('#handoverDate')?.value;

      // If both Unit Area and SC Rate are NOT required, just show Buyer SC on ribbon
      if (!scAreaRequired && !scRateRequired && buyerSC > 0) {
        scBadge.style.display = '';
        scBadge.classList.remove('idle', 'warn', 'ready', 'alert');
        scBadge.classList.add('ready');
        const statusEl = scBadge.querySelector('.badge-status');
        if (statusEl) {
          statusEl.textContent = `Buyer SC ${money(buyerSC)}`;
        }
        if(!settlementHealthRibbon) {
          settlementHealthRibbon = qs('#settlementHealthRibbon');
        }
        const resultsCardEl = qs('#resultsCard');
        const resultsDividerEl = qs('#resultsDivider');
        const summarySectionEl = qs('#summarySection');
        if (settlementHealthRibbon) settlementHealthRibbon.style.display = 'flex';
        if (resultsCardEl) resultsCardEl.classList.remove('is-hidden');
        if (resultsDividerEl) resultsDividerEl.classList.remove('is-hidden');
        if (summarySectionEl) summarySectionEl.style.display = 'block';
        return;
      }

      // Only show when SC Rate is NOT required AND Buyer SC has a real value
      if (scRateRequired || buyerSC <= 0 || !lsVal || !leVal || !hoVal) {
        scBadge.style.display = 'none';
        return;
      }

      // Calculate days
      const totalDays = daysInclusive(lsVal, leVal);
      const sellerDays = daysInclusive(lsVal, hoVal);
      const buyerDays = totalDays - sellerDays;

      if (totalDays <= 0 || buyerDays <= 0 || sellerDays < 0) {
        scBadge.style.display = 'none';
        return;
      }

      // Estimate: Seller SC = (Buyer SC / Buyer Days) × Seller Days
      const dailySC = buyerSC / buyerDays;
      const sellerEstimate = Math.round(dailySC * sellerDays * 100) / 100;

      // Show the badge
      scBadge.style.display = '';
      scBadge.classList.remove('idle', 'warn', 'ready', 'alert');
      scBadge.classList.add('ready');
      const statusEl = scBadge.querySelector('.badge-status');
      if (statusEl) {
        statusEl.textContent = `${money(sellerEstimate)} (${sellerDays}d)`;
      }

      // Ensure ribbon/results are visible so the badge can be seen
      if(!settlementHealthRibbon) {
        settlementHealthRibbon = qs('#settlementHealthRibbon');
      }
      const resultsCardEl = qs('#resultsCard');
      const resultsDividerEl = qs('#resultsDivider');
      const summarySectionEl = qs('#summarySection');
      if (settlementHealthRibbon) settlementHealthRibbon.style.display = 'flex';
      if (resultsCardEl) resultsCardEl.classList.remove('is-hidden');
      if (resultsDividerEl) resultsDividerEl.classList.remove('is-hidden');
      if (summarySectionEl) summarySectionEl.style.display = 'block';

      // Make sure the ribbon is visible even if results card was hidden
      if(!settlementHealthRibbon) {
        settlementHealthRibbon = qs('#settlementHealthRibbon');
      }
      if (settlementHealthRibbon) {
        settlementHealthRibbon.style.display = 'flex';
        const resultsCardEl = qs('#resultsCard');
        const resultsDividerEl = qs('#resultsDivider');
        const summarySectionEl = qs('#summarySection');
        if (resultsCardEl) resultsCardEl.classList.remove('is-hidden');
        if (resultsDividerEl) resultsDividerEl.classList.remove('is-hidden');
        if (summarySectionEl) summarySectionEl.style.display = 'block';
      }
    }

    function markDocsDirty(){
      if(docsReadyFlag){
        docsReadyFlag = false;
      }
      hasUnsavedChanges = true;
      updateHealthRibbon();
    }

    function markDocsReady(state){
      docsReadyFlag = Boolean(state);
      hasUnsavedChanges = false;
      updateHealthRibbon();
    }
    
    // Track unsaved changes for page leave warning
    let hasUnsavedChanges = false;
    
    // Warn user before leaving page with unsaved changes
    window.addEventListener('beforeunload', function(e) {
      // Save scroll position before leaving/refreshing
      sessionStorage.setItem('rs_scrollPos', window.scrollY.toString());
      if(hasUnsavedChanges) {
        e.preventDefault();
        e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
        return e.returnValue;
      }
    });

    // Scroll position is restored later in initialization (after 400ms delay)

    function setResultsVisibility(isVisible){
      resultsVisible = isVisible;
      if(calcBtnLabel) calcBtnLabel.textContent = isVisible ? 'Hide Results' : 'Calculate Settlement';
      if(calcBtnIcon) calcBtnIcon.textContent = isVisible ? '🔼' : '🧮';
      if(calcBtn) calcBtn.setAttribute('aria-expanded', String(isVisible));
    }

    function hideResultsSection(){
      if(resultsCard) resultsCard.classList.add('is-hidden');
      if(resultsDivider) resultsDivider.classList.add('is-hidden');
      if(summarySection) summarySection.style.display = 'none';
      setResultsVisibility(false);
    }

    function handleCalcButtonClick(){
      if(resultsCard && !resultsCard.classList.contains('is-hidden')){
        hideResultsSection();
        return;
      }
      calculate();
    }

    setResultsVisibility(false);

    /* Event Wiring */
    function wireEvents(){
      console.log('wireEvents starting...');
      // Auto-save on any input change
      const autoSaveInputs = [buildingName, unitNo, tenantName, leaseStart, leaseEnd, handoverDate, rentInput, serviceCharge, securityDeposit, commBuyerName, commPdcName, commAccName, buyerNameInput].filter(e => e);
      console.log('autoSaveInputs count:', autoSaveInputs.length, autoSaveInputs);
      autoSaveInputs.forEach(el => el.addEventListener('input', queueAutosave));
      autoSaveInputs.forEach(el => el.addEventListener('change', queueAutosave));
      console.log('wireEvents completed');
      
      // Live updates - recalculate and refresh health when key fields change
      const liveUpdateInputs = [leaseStart, leaseEnd, handoverDate, rentInput, serviceCharge, securityDeposit].filter(e => e);
      liveUpdateInputs.forEach(el => {
        el.addEventListener('input', queueLiveUpdate);
        el.addEventListener('change', queueLiveUpdate);
      });
      
      // Also trigger live update for SC calculator fields
      const scArea = qs('#scArea');
      const scRate = qs('#scRate');
      const scPaidEnd = qs('#scPaidEnd');
      if(scArea) scArea.addEventListener('input', queueLiveUpdate);
      if(scRate) scRate.addEventListener('input', queueLiveUpdate);
      if(scPaidEnd) {
        scPaidEnd.addEventListener('input', queueLiveUpdate);
        scPaidEnd.addEventListener('change', queueLiveUpdate);
      }
      const scFrequency = qs('#scFrequency');
      if(scFrequency) scFrequency.addEventListener('change', queueLiveUpdate);
      
      // Save building name to history on blur (when user finishes typing)
      buildingName.addEventListener('blur', () => {
        if(buildingName.value.trim()) {
          saveBuildingToHistory(buildingName.value);
        }
      });
      
      rentalCountSel.addEventListener('change', () => { updateRentalCount(); queueAutosave(); });
      // pdcCountSel.addEventListener('change', updatePdcCount); // Obsolete now
      
      [leaseStart, leaseEnd, rentInput].forEach(el => el.addEventListener('input', debouncedUpdateContractInfo));
      
      // Validate cheque dates when lease dates change
      [leaseStart, leaseEnd].forEach(el => el.addEventListener('change', validateAllChequeDates));
      
      // Auto-set SC Paid Period End based on handover date and selected frequency
      // Frequencies: monthly (end of current month), quarterly (end of quarter),
      // half-yearly (end of half-year: Jun 30 or Dec 31), yearly (Dec 31)
      function autoSetScPaidEnd(forceOverwrite) {
        const hoVal = qs('#handoverDate')?.value;
        const scPaidEndEl = qs('#scPaidEnd');
        const freqEl = qs('#scFrequency');
        if(!hoVal || !scPaidEndEl) return;
        
        // Don't overwrite if user manually set the SC Paid Period End
        if(scPaidEndManuallySet && !isInitializing) return;
        
        // Don't overwrite if scPaidEnd already has a value (e.g. restored from saved state)
        // unless forceOverwrite is true (user changed handover date or frequency)
        if(!forceOverwrite && scPaidEndEl.value) return;
        
        const hoDate = new Date(hoVal + 'T00:00:00');
        if(isNaN(hoDate.getTime())) return;
        
        const month = hoDate.getMonth(); // 0-11
        const year = hoDate.getFullYear();
        const freq = freqEl?.value || 'quarterly';
        
        let periodEnd;
        
        if(freq === 'monthly') {
          // End of current month
          periodEnd = new Date(year, month + 1, 0); // Day 0 of next month = last day of current month
        } else if(freq === 'quarterly') {
          // Quarter ends: Mar 31 (Q1), Jun 30 (Q2), Sep 30 (Q3), Dec 31 (Q4)
          if(month < 3) {
            periodEnd = new Date(year, 2, 31);
          } else if(month < 6) {
            periodEnd = new Date(year, 5, 30);
          } else if(month < 9) {
            periodEnd = new Date(year, 8, 30);
          } else {
            periodEnd = new Date(year, 11, 31);
          }
        } else if(freq === 'half-yearly') {
          // Half-year ends: Jun 30 (H1) or Dec 31 (H2)
          if(month < 6) {
            periodEnd = new Date(year, 5, 30);
          } else {
            periodEnd = new Date(year, 11, 31);
          }
        } else if(freq === 'yearly') {
          // Year ends Dec 31
          periodEnd = new Date(year, 11, 31);
        } else {
          // Default to quarterly
          if(month < 3) {
            periodEnd = new Date(year, 2, 31);
          } else if(month < 6) {
            periodEnd = new Date(year, 5, 30);
          } else if(month < 9) {
            periodEnd = new Date(year, 8, 30);
          } else {
            periodEnd = new Date(year, 11, 31);
          }
        }
        
        // Format as YYYY-MM-DD
        const yyyy = periodEnd.getFullYear();
        const mm = String(periodEnd.getMonth() + 1).padStart(2, '0');
        const dd = String(periodEnd.getDate()).padStart(2, '0');
        scPaidEndEl.value = `${yyyy}-${mm}-${dd}`;
        
        // Trigger SC recalculation
        calculateServiceCharge();
        debouncedUpdateContractInfo();
      }
      
      // Re-run autoSetScPaidEnd when frequency changes
      qs('#scFrequency')?.addEventListener('change', () => autoSetScPaidEnd(true));
      
      handoverDate.addEventListener('change', () => { debouncedUpdateContractInfo(); syncUnclearedToPDC(); autoSetScPaidEnd(true); });
      handoverDate.addEventListener('input', debouncedUpdateContractInfo);
      
      // Run autoSetScPaidEnd on initial load if handover date exists
      setTimeout(() => { autoSetScPaidEnd(); }, 100);

      if(calcBtn) calcBtn.addEventListener('click', handleCalcButtonClick);
      qs('#floatingResetBtn')?.addEventListener('click', resetAll);
      qs('#refreshPageBtn')?.addEventListener('click', () => {
        // Save scroll position before refresh
        sessionStorage.setItem('rs_scrollPos', window.scrollY.toString());
        location.reload();
      });
      // Flag click triggers page refresh (only way to clear flag)
      qs('#recalcWarningFlag')?.addEventListener('click', () => {
        // Save scroll position before refresh
        sessionStorage.setItem('rs_scrollPos', window.scrollY.toString());
        location.reload();
      });
      qs('#printBtn').addEventListener('click', () => {
        // Check if data is stale - warn user before printing
        if(!calculationIsFresh && lastCalculationHash !== null) {
          const proceed = confirm('⚠️ WARNING: Data has changed since last calculation!\n\nThe results may not match current input values.\n\nClick OK to recalculate first, or Cancel to print anyway (not recommended).');
          if(proceed) {
            document.getElementById('calcBtn').click();
            setTimeout(() => {
              preparePrintReview();
              window.print();
            }, 300);
            return;
          }
        }
        // Populate print review summary before printing
        preparePrintReview();
        window.print();
      });
      
      // Prepare print review summary with current form data
      function preparePrintReview() {
        const formatDate = (dateStr) => {
          if (!dateStr) return '—';
          const d = new Date(dateStr);
          return d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
        };
        
        const formatCurrency = (val) => {
          const num = parseFloat(val) || 0;
          return 'AED ' + num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        };
        
        // Update timestamp
        const timestampEl = qs('#printTimestamp');
        if (timestampEl) {
          timestampEl.textContent = 'Printed: ' + new Date().toLocaleString('en-GB', { 
            day: '2-digit', month: 'short', year: 'numeric', 
            hour: '2-digit', minute: '2-digit' 
          });
        }
        
        // Populate summary fields
        const printBuilding = qs('#printBuilding');
        const printUnit = qs('#printUnit');
        const printTenant = qs('#printTenant');
        const printBuyer = qs('#printBuyer');
        const printLeasePeriod = qs('#printLeasePeriod');
        const printHandover = qs('#printHandover');
        const printRent = qs('#printRent');
        const printDeposit = qs('#printDeposit');
        
        if (printBuilding) printBuilding.textContent = qs('#buildingName')?.value || '—';
        if (printUnit) printUnit.textContent = qs('#unitNo')?.value || '—';
        if (printTenant) printTenant.textContent = qs('#tenantName')?.value || '—';
        if (printBuyer) printBuyer.textContent = qs('#buyerName')?.value || '—';
        
        const leaseStartVal = qs('#leaseStart')?.value;
        const leaseEndVal = qs('#leaseEnd')?.value;
        if (printLeasePeriod) {
          printLeasePeriod.textContent = leaseStartVal && leaseEndVal 
            ? formatDate(leaseStartVal) + ' → ' + formatDate(leaseEndVal)
            : '—';
        }
        
        if (printHandover) printHandover.textContent = formatDate(qs('#handoverDate')?.value);
        if (printRent) printRent.textContent = formatCurrency(qs('#rent')?.value);
        if (printDeposit) printDeposit.textContent = formatCurrency(qs('#securityDeposit')?.value);
      }
      
      // Wrapper function to check stale data before export
      function checkStaleBeforeExport(exportFn) {
        if(!calculationIsFresh && lastCalculationHash !== null) {
          const proceed = confirm('⚠️ WARNING: Data has changed since last calculation!\n\nThe exported document may not match current input values.\n\nClick OK to recalculate first, or Cancel to export anyway (not recommended).');
          if(proceed) {
            document.getElementById('calcBtn').click();
            setTimeout(exportFn, 300);
            return;
          }
        }
        exportFn();
      }
      
      qs('#excelBtn').addEventListener('click', () => checkStaleBeforeExport(exportToExcel));
      qs('#previewBtn').addEventListener('click', () => checkStaleBeforeExport(previewPDF));
      qs('#pdfBtn').addEventListener('click', () => checkStaleBeforeExport(exportToPDF));
      qs('#buyerPdfBtn').addEventListener('click', () => checkStaleBeforeExport(exportToBuyerPDF));
      qs('#pngBtn').addEventListener('click', () => checkStaleBeforeExport(exportToPNG));
      
      // Dark Mode Toggle
      const darkModeToggle = qs('#darkModeToggle');
      const darkModeIcon = qs('#darkModeIcon');
      const savedTheme = localStorage.getItem('rs_theme');
      if (savedTheme === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
        darkModeIcon.textContent = '☀️';
      }
      darkModeToggle.addEventListener('click', () => {
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        if (isDark) {
          document.documentElement.removeAttribute('data-theme');
          localStorage.setItem('rs_theme', 'light');
          darkModeIcon.textContent = '🌙';
        } else {
          document.documentElement.setAttribute('data-theme', 'dark');
          localStorage.setItem('rs_theme', 'dark');
          darkModeIcon.textContent = '☀️';
        }
      });
      
      qs('#importPropertyBtn').addEventListener('click', () => parsePropertyData(qs('#bulkImportProperty').value));
      
      // Restored Import Cheque Event with Enhanced Validation
      qs('#importBtn').addEventListener('click', () => {
        const text = bulkImport.value.trim();
        if(!text){ alert('Paste cheque lines first.'); return; }
        const parsed = parseBulkLines(text);
        if(parsed.length === 0){ alert('No valid lines found. Use the supported formats only.'); return; }
        
        let validationMessages = [];
        
        // Validation 1: Check if unit numbers match (if unit data was provided in import)
        const currentUnit = unitNo.value.trim();
        const mismatchedUnits = parsed.filter(p => p.unit && currentUnit && p.unit !== currentUnit);
        
        if(mismatchedUnits.length > 0) {
          const uniqueUnits = [...new Set(mismatchedUnits.map(p => p.unit))].join(', ');
          validationMessages.push(`❌ UNIT MISMATCH\nCurrent Unit: ${currentUnit}\nCheques Unit: ${uniqueUnits}`);
        }
        
        // Validation 2: Check total cheque amounts against annual rent (only if rent is filled)
        const annualRent = sanitizeNumber(rentInput.value);
        const totalCheques = parsed.reduce((sum, chq) => sum + chq.amt, 0);
        const difference = Math.abs(totalCheques - annualRent);
        
        if(annualRent > 0 && totalCheques > 0 && difference > 1) { // Allow 1 AED tolerance for rounding
          const diffText = totalCheques > annualRent ? 'MORE' : 'LESS';
          validationMessages.push(
            `❌ RENT MISMATCH\n` +
            `Annual Rent: AED ${annualRent.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2})}\n` +
            `Total Cheques: AED ${totalCheques.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2})}\n` +
            `Difference: AED ${difference.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2})} ${diffText}`
          );
        }
        
        // Show all validation issues together
        if(validationMessages.length > 0) {
          const message = `⚠️ VALIDATION WARNINGS\n\n` + 
                         validationMessages.join('\n\n') + 
                         `\n\n━━━━━━━━━━━━━━━━━━━━━━━\n\nDo you want to proceed with import anyway?`;
          if(!confirm(message)) return;
          chequeImportWarnings = [...validationMessages];
        } else {
          chequeImportWarnings = [];
        }
        
        rentalCountSel.value = String(parsed.length);
        updateRentalCount();
        // First clear ALL cheques before populating with imported data
        for(let i=1; i<=MAX_CHEQUES; i++){
          qs(`#rentChq${i}`).value = '';
          qs(`#rentChq${i}Date`).value = '';
          qs(`#rentChq${i}Cleared`).checked = false;
          qs(`#rentChq${i}ClearDate`).value = '';
          const bankField = qs(`#rentChq${i}Bank`);
          const numberField = qs(`#rentChq${i}Number`);
          if(bankField) bankField.value = '';
          if(numberField) numberField.value = '';
          const item = qs(`#rentChq${i}Item`);
          if(item) {
            item.classList.remove('cleared');
            item.classList.add('outstanding');
          }
        }
        // Now populate with imported data
        for(let i=0;i<parsed.length && i<MAX_CHEQUES;i++){
          const idx = i+1;
          qs(`#rentChq${idx}`).value = parsed[i].amt;
          qs(`#rentChq${idx}Date`).value = parsed[i].date;
          const bankField = qs(`#rentChq${idx}Bank`);
          const numberField = qs(`#rentChq${idx}Number`);
          if(bankField) bankField.value = parsed[i].bank || '';
          if(numberField) numberField.value = parsed[i].chequeNumber || '';
        }
        updateRentalCount(); // Call again to hide empty cheques
        debouncedUpdateRentalTotals(); syncUnclearedToPDC(); 
        showToast(`Imported ${parsed.length} cheques.`);
        queueHealthPanelRefresh();
        updateHealthRibbon();
        queueAutosave();
      });
      
      // Communication Modal open/close
      qs('#openCommModal').addEventListener('click', () => {
        const modal = qs('#commModal');
        modal.style.display = 'block';
        modal.setAttribute('aria-hidden', 'false');
      });
      qs('#openCommModalSidebar')?.addEventListener('click', () => {
        const modal = qs('#commModal');
        modal.style.display = 'block';
        modal.setAttribute('aria-hidden', 'false');
      });
      qs('#commModalClose').addEventListener('click', () => {
        const modal = qs('#commModal');
        modal.style.display = 'none';
        modal.setAttribute('aria-hidden', 'true');
      });
      qs('#commModal').addEventListener('click', (e) => {
        if(e.target.id === 'commModal') {
          e.target.style.display = 'none';
          e.target.setAttribute('aria-hidden', 'true');
        }
      });
      [commBuyerName, commPdcName, commAccName, commSenderName, buyerNameInput].filter(e => e).forEach(e => e.addEventListener('input', generateMessages));

      // Keep header `#buyerName` and modal `#commBuyerName` in sync (user can edit either)
      if(buyerNameInput && commBuyerName) {
        // when header input changes, update comm modal field
        buyerNameInput.addEventListener('input', () => {
          if(commBuyerName) commBuyerName.value = buyerNameInput.value;
          generateMessages();
          queueAutosave();
        });
        // when modal field changes, reflect to header input
        commBuyerName.addEventListener('input', () => {
          if(buyerNameInput) buyerNameInput.value = commBuyerName.value;
          generateMessages();
          queueAutosave();
        });
      }
      // Communication message handlers
      qs('#btnEditBuyer').addEventListener('click', () => toggleEdit('msgBuyer', 'msgBuyerDisplay'));
      qs('#btnEditPDC').addEventListener('click', () => toggleEdit('msgPDC', 'msgPDCDisplay'));
      qs('#btnEditAcc').addEventListener('click', () => toggleEdit('msgAcc', 'msgAccDisplay'));
      qs('#btnEditRecon').addEventListener('click', () => toggleEdit('copyReconciliation', 'copyReconciliationDisplay'));
      
      qs('#btnCopyBuyer').addEventListener('click', () => copyMessage('msgBuyer'));
      qs('#btnCopyPDC').addEventListener('click', () => copyMessage('msgPDC'));
      qs('#btnCopyAcc').addEventListener('click', () => copyMessage('msgAcc'));
      qs('#btnCopyReconciliation').addEventListener('click', () => copyMessage('copyReconciliation'));
      
      qs('#btnWhatsappBuyer').addEventListener('click', () => sendWhatsApp('msgBuyer'));
      qs('#btnWhatsappPDC').addEventListener('click', () => sendWhatsApp('msgPDC'));
      qs('#btnWhatsappAcc').addEventListener('click', () => sendWhatsApp('msgAcc'));
      qs('#btnWhatsappRecon').addEventListener('click', () => sendWhatsApp('copyReconciliation'));
      
      qs('#btnEmailBuyer').addEventListener('click', () => sendEmail('msgBuyer'));
      qs('#btnEmailPDC').addEventListener('click', () => sendEmail('msgPDC'));
      qs('#btnEmailAcc').addEventListener('click', () => sendEmail('msgAcc'));
      qs('#btnEmailRecon').addEventListener('click', () => sendEmail('copyReconciliation'));
      
      gapReasonButtons.forEach(btn => {
        btn.addEventListener('click', () => selectGapReason(btn.dataset.gapReason || ''));
      });
      if(gapReasonNote){
        gapReasonNote.addEventListener('input', () => {
          chequeGapJustification.note = gapReasonNote.value;
          updateGapClarifier();
          queueAutosave();
          updateHealthRibbon();
        });
      }

      qs('#whatsappShareBtn').addEventListener('click', shareViaWhatsApp);

      Object.entries(timelineSegments).forEach(([mode, segment]) => {
        if(!segment) return;
        segment.addEventListener('mouseenter', () => showTimelineTooltip(segment, mode));
        segment.addEventListener('mouseleave', hideTimelineTooltip);
      });
      if(timelineContainer){
        timelineContainer.addEventListener('mouseleave', hideTimelineTooltip);
      }
      // Wire hover events for SC timeline segments (buyer only)
      Object.entries(scSegments).forEach(([mode, segment]) => {
        if(!segment) return;
        segment.addEventListener('mouseenter', () => showScTimelineTooltip(segment));
        segment.addEventListener('mouseleave', hideScTimelineTooltip);
      });
      if(scTimelineContainer){
        scTimelineContainer.addEventListener('mouseleave', hideScTimelineTooltip);
      }
      
      if(healthPanelBtn) healthPanelBtn.addEventListener('click', openHealthModal);
      if(healthModalClose) healthModalClose.addEventListener('click', closeHealthModal);
      if(healthModal) {
        healthModal.addEventListener('click', (e) => {
          if(e.target === healthModal) closeHealthModal();
        });
      }
      document.addEventListener('keydown', (e) => {
        if(e.key === 'Escape' && healthModal?.classList.contains('show')) {
          closeHealthModal();
        }
        if(e.key === 'Escape' && notesModal?.classList.contains('show')) {
          closeNotesModal();
        }
      });

      // Notes Modal Event Listeners
      if(caseNotesBtn) caseNotesBtn.addEventListener('click', openNotesModal);
      if(notesModalClose) notesModalClose.addEventListener('click', closeNotesModal);
      if(notesSaveBtn) notesSaveBtn.addEventListener('click', closeNotesModal);
      if(notesClearBtn) notesClearBtn.addEventListener('click', clearCaseNotes);
      if(notesModal) {
        notesModal.addEventListener('click', (e) => {
          if(e.target === notesModal) closeNotesModal();
        });
      }
      if(caseNotesTextarea) {
        caseNotesTextarea.addEventListener('input', debounce(() => {
          updateNotesIconGlow();
          saveState();
        }, 1000));
      }
      
      // Include notes in PDF checkbox - save on change
      const includeNotesCheckbox = qs('#includeNotesInPdf');
      if(includeNotesCheckbox) {
        includeNotesCheckbox.addEventListener('change', () => {
          saveState();
        });
      }

      // Cheque Gap Modal Event Listeners
      if(healthBadges.cheques) {
        healthBadges.cheques.addEventListener('click', () => {
          if(lastChequeGapMeta && lastChequeGapMeta.absDiff >= 1) {
            openChequeGapModal();
          }
        });
      }
      if(gapModalClose) gapModalClose.addEventListener('click', closeChequeGapModal);
      const gapModalSaveBtn = qs('#gapModalSaveBtn');
      if(gapModalSaveBtn) gapModalSaveBtn.addEventListener('click', closeChequeGapModal);
      const gapModalCancel = qs('#gapModalCancel');
      if(gapModalCancel) gapModalCancel.addEventListener('click', closeChequeGapModal);
      if(chequeGapModal) {
        chequeGapModal.addEventListener('click', (e) => {
          if(e.target === chequeGapModal) closeChequeGapModal();
        });
      }
      // Escape key to close gap modal
      document.addEventListener('keydown', (e) => {
        if(e.key === 'Escape' && chequeGapModal?.classList.contains('show')) {
          closeChequeGapModal();
        }
        if(e.key === 'Escape' && docsPopup?.classList.contains('show')) {
          closeDocsPopup();
        }
      });

      // Docs Popup Event Listeners
      if(healthBadges.docs) {
        healthBadges.docs.addEventListener('click', openDocsPopup);
      }
      if(docsPopupClose) docsPopupClose.addEventListener('click', closeDocsPopup);
      if(docsPopup) {
        docsPopup.addEventListener('click', (e) => {
          if(e.target === docsPopup) closeDocsPopup();
        });
      }
      // Docs popup action buttons
      qs('#docsActionPdf')?.addEventListener('click', () => {
        exportToPDF();
        markDocExported('pdf');
      });
      qs('#docsActionBuyerPdf')?.addEventListener('click', () => {
        exportToBuyerPDF();
        markDocExported('buyerPdf');
      });
      qs('#docsActionPng')?.addEventListener('click', () => {
        qs('#pngBtn')?.click();
        markDocExported('png');
      });
      qs('#docsActionMessages')?.addEventListener('click', () => {
        closeDocsPopup();
        qs('#openCommModal')?.click();
        markDocExported('messages');
      });
      qs('#docsActionWhatsapp')?.addEventListener('click', () => {
        shareViaWhatsApp();
        markDocExported('whatsapp');
      });

      // Calculations Popup Event Listeners
      if(healthBadges.calc) {
        healthBadges.calc.addEventListener('click', openCalcPopup);
      }
      if(calcPopupClose) calcPopupClose.addEventListener('click', closeCalcPopup);
      if(calcPopup) {
        calcPopup.addEventListener('click', (e) => {
          if(e.target === calcPopup) closeCalcPopup();
        });
      }
      qs('#calcCopyBtn')?.addEventListener('click', copyCalcBreakdown);
      // Escape key for calc popup
      document.addEventListener('keydown', (e) => {
        if(e.key === 'Escape' && calcPopup?.classList.contains('show')) {
          closeCalcPopup();
        }
      });

      // AI Verification Button
      const verifyAiBtn = qs('#verifyAiBtn');
      if(verifyAiBtn) {
        verifyAiBtn.addEventListener('click', copyForAiVerification);
      }

      buildingName.addEventListener('input', updateTitle);
      unitNo.addEventListener('input', updateTitle);
      tenantName.addEventListener('input', updateTitle);
      
      // Empty Unit Mode detection and visual indicator - global function
      window.checkEmptyUnitMode = function() {
        const tenantVal = tenantName?.value?.trim().toLowerCase() || '';
        const isEmptyTenant = tenantVal === 'empty' || tenantVal === 'empty unit';
        const banner = qs('#emptyUnitBanner');
        if(isEmptyTenant) {
          document.body.classList.add('empty-unit-mode');
          if(banner) banner.classList.add('visible');
        } else {
          document.body.classList.remove('empty-unit-mode');
          if(banner) banner.classList.remove('visible');
        }
      };
      tenantName.addEventListener('input', window.checkEmptyUnitMode);
      tenantName.addEventListener('change', window.checkEmptyUnitMode);
      // Check on page load in case restoring a saved state
      setTimeout(window.checkEmptyUnitMode, 100);
      setTimeout(window.checkEmptyUnitMode, 500); // Extra check after auto-restore completes
      
      // Initialize Service Charge Calculator
      setupServiceChargeCalculator();
      
      // Initialize Sender Name persistence
      setupSenderNameSync();
      
      // Initialize SC Fields Mandatory Toggle
      setupScMandatoryToggle();
      
      // Initialize SC Buyer Auto/Manual Toggle
      setupScBuyerAutoToggle();

      // Simple cutoff flag emoji helper — shows a small emoji next to the Handover label
      function toggleCutoffEmoji(message) {
        try {
          const lbl = document.querySelector('label[for="handoverDate"]');
          if(!lbl) return;
          let span = lbl.querySelector('.cutoff-flag');
          if(!message) {
            if(span) span.remove();
            return;
          }
          if(!span) {
            span = document.createElement('span');
            span.className = 'cutoff-flag';
            span.innerHTML = '🚩 <span class="cutoff-key">🔑</span>';
            lbl.appendChild(span);
          }
          span.title = message;
        } catch(e) { console.error('toggleCutoffEmoji error', e); }
      }

      // Ensure the cutoff flag updates immediately when the handover date changes
      try {
        const _hd = qs('#handoverDate');
        if(_hd) {
          const updateFlag = () => {
            if(_hd.value) toggleCutoffEmoji('✓ Cutoff date set');
            else toggleCutoffEmoji(null);
          };
          _hd.addEventListener('change', updateFlag);
          _hd.addEventListener('input', updateFlag);
        }
      } catch(e) { console.error('cutoff flag listener error', e); }
      
      // Validation checkmarks & live preview
      function validateFields() {
        const requiredFields = [
          { id: 'unitNo', wrapper: false },
          { id: 'tenantName', wrapper: false },
          { id: 'leaseStart', wrapper: true },
          { id: 'leaseEnd', wrapper: true },
          { id: 'rent', wrapper: true },
          { id: 'handoverDate', wrapper: true },
          { id: 'scArea', wrapper: false },
          { id: 'scRate', wrapper: false },
          { id: 'securityDeposit', wrapper: false },
          { id: 'serviceCharge', wrapper: false }
        ];
        
        requiredFields.forEach(field => {
          const input = qs(`#${field.id}`);
          if(!input) return;
          const parent = field.wrapper ? input.closest('.field-wrapper') : input.parentElement;
          if(!parent) return;
          
          const val = input.value ? input.value.trim().replace(/,/g, '') : '';
          if(val !== '' && val !== '0' && val !== '0.00') {
            parent.classList.add('field-valid');
            toggleFieldHint(field.id, false);
          } else {
            parent.classList.remove('field-valid');
            toggleFieldHint(field.id, true);
          }
        });

        // Also update simple cutoff emoji flag
        // Show icons whenever handover date is filled, with appropriate tooltip
        try {
          const h = handoverDate?.value;
          const s = leaseStart?.value;
          const e = leaseEnd?.value;
          if(h) {
            // Handover date exists - always show the icons
            if(s && e) {
              const dH = new Date(h + 'T00:00:00');
              const dS = new Date(s + 'T00:00:00');
              const dE = new Date(e + 'T00:00:00');
              if(!isNaN(dH.getTime()) && (dH < dS || dH > dE)) {
                toggleCutoffEmoji('⚠ Cutoff date is outside lease range');
              } else {
                toggleCutoffEmoji('✓ Cutoff date set');
              }
            } else {
              toggleCutoffEmoji('✓ Cutoff date set');
            }
          } else {
            // No handover date - hide icons
            toggleCutoffEmoji(null);
          }
        } catch(e) { console.error(e); }

        // Live preview and warnings removed - elements no longer exist
      }
      
      function updateLivePreview() {
        // Live preview element removed - function kept as stub
        return;
      }
      
      function checkWarnings() {
        // Warning box element removed - function kept as stub for health panel
        queueHealthPanelRefresh();
      }
      
      // Attach validation to required fields
      [leaseStart, leaseEnd, rentInput, handoverDate, securityDeposit, serviceCharge, unitNo, tenantName, qs('#scArea'), qs('#scRate')].filter(f => f).forEach(field => {
        field.addEventListener('input', debounce(validateFields, 300));
        field.addEventListener('change', validateFields);
      });

      // Also update the simple emoji flag when related fields change
      if(leaseStart) leaseStart.addEventListener('change', validateFields);
      if(leaseEnd) leaseEnd.addEventListener('change', validateFields);
      if(handoverDate) handoverDate.addEventListener('change', validateFields);
      rentalCountSel.addEventListener('change', validateFields);
      pdcCountSel.addEventListener('change', validateFields);
      
      // Run initial validation
      validateFields();
      
      // Case management events - with safety checks
      const saveCaseBtn = qs('#saveCaseBtn');
      const loadCaseBtn = qs('#loadCaseBtn');
      const closeModalBtn = qs('#closeModal');
      const saveNewCaseBtn = qs('#saveNewCase');
      const caseModal = qs('#caseModal');
      
      if(saveCaseBtn) saveCaseBtn.addEventListener('click', openSaveModal);
      if(loadCaseBtn) loadCaseBtn.addEventListener('click', openLoadModal);
      if(closeModalBtn) closeModalBtn.addEventListener('click', closeModal);
      if(saveNewCaseBtn) saveNewCaseBtn.addEventListener('click', handleSaveCase);
      if(searchCasesInput) searchCasesInput.addEventListener('input', renderCasesList);
      if(buildingFilterSelect) buildingFilterSelect.addEventListener('change', renderCasesList);
      if(sortCasesSelect) sortCasesSelect.addEventListener('change', renderCasesList);
      
      // Advanced filters event listeners
      const rentMin = qs('#rentMin');
      const rentMax = qs('#rentMax');
      const dateFrom = qs('#dateFrom');
      const dateTo = qs('#dateTo');
      const tenantFilter = qs('#tenantFilter');
      const clearAdvancedFilters = qs('#clearAdvancedFilters');
      
      if(rentMin) rentMin.addEventListener('input', renderCasesList);
      if(rentMax) rentMax.addEventListener('input', renderCasesList);
      if(dateFrom) dateFrom.addEventListener('change', renderCasesList);
      if(dateTo) dateTo.addEventListener('change', renderCasesList);
      if(tenantFilter) tenantFilter.addEventListener('input', renderCasesList);
      
      if(clearAdvancedFilters) {
        clearAdvancedFilters.addEventListener('click', () => {
          if(rentMin) rentMin.value = '';
          if(rentMax) rentMax.value = '';
          if(dateFrom) dateFrom.value = '';
          if(dateTo) dateTo.value = '';
          if(tenantFilter) tenantFilter.value = '';
          renderCasesList();
        });
      }
      if(caseModal) {
        caseModal.addEventListener('click', (e) => {
          if(e.target.id === 'caseModal') closeModal();
        });
      }
      
      // Enter key to save case
      const caseNameInput = qs('#caseNameInput');
      if(caseNameInput) {
        caseNameInput.addEventListener('keypress', (e) => {
          if(e.key === 'Enter') handleSaveCase();
        });
      }
      
      // Initial validation
      validateFields();
    }

    function setupCollapsibleSections(){
      // Function is now handled by inline onclick handlers
    }
    
    // Global toggle function for collapsible sections
    window.toggleCollapse = function(targetId, btn) {
      const target = document.getElementById(targetId);
      if(!target) return;
      
      const isCurrentlyCollapsed = target.classList.contains('collapsed');
      if(isCurrentlyCollapsed) {
        // Expand
        target.classList.remove('collapsed');
        target.setAttribute('aria-hidden', 'false');
        btn.classList.remove('is-collapsed');
        btn.setAttribute('aria-expanded', 'true');
      } else {
        // Collapse
        target.classList.add('collapsed');
        target.setAttribute('aria-hidden', 'true');
        btn.classList.add('is-collapsed');
        btn.setAttribute('aria-expanded', 'false');
      }
    };

    function openSaveModal() {
      const modal = qs('#caseModal');
      const modalTitle = qs('#modalTitle');
      const saveSection = qs('#saveSection');
      const loadSection = qs('#loadSection');
      const caseNameInput = qs('#caseNameInput');
      
      if(!modal || !modalTitle || !saveSection || !loadSection || !caseNameInput) {
        console.error('Modal elements not found');
        alert('Error: Modal not found. Please refresh the page.');
        return;
      }
      
      modalTitle.textContent = 'Save Current Case';
      // Ensure load-mode class is removed when opening save modal
      modal.classList.remove('load-mode');
      saveSection.style.display = 'block';
      loadSection.style.display = 'none';
      const defaultName = `${unitNo.value || 'Unit'} - ${tenantName.value || 'Tenant'}`;
      caseNameInput.value = defaultName;
      modal.style.display = 'block';
      setTimeout(() => {
        caseNameInput.focus();
        caseNameInput.select();
      }, 100);
    }

    function openLoadModal() {
      qs('#modalTitle').textContent = 'Load Saved Case';
      // Add load-mode class to style header with a very light background
      qs('#caseModal').classList.add('load-mode');
      qs('#saveSection').style.display = 'none';
      qs('#loadSection').style.display = 'block';
      qs('#searchCases').value = '';
      if(buildingFilterSelect) buildingFilterSelect.value = '';
      if(sortCasesSelect) sortCasesSelect.value = 'newest';
      renderCasesList();
      qs('#caseModal').style.display = 'block';
      qs('#caseModal').removeAttribute('aria-hidden');
    }

    function closeModal() {
      const modal = qs('#caseModal');
      // Remove focus from any element inside modal before hiding
      if(document.activeElement && modal.contains(document.activeElement)) {
        document.activeElement.blur();
      }
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden', 'true');
    }

    function handleSaveCase() {
      const caseNameInput = qs('#caseNameInput');
      if(!caseNameInput) return;
      
      const caseName = caseNameInput.value.trim();
      if(!caseName) {
        alert('Please enter a case name');
        return;
      }
      const result = saveCaseAs(caseName);
      if(result === true) {
        closeModal();
      }
      // If result is 'pending', the building picker is shown - don't close modal yet
    }

    function highlightText(text, search) {
      if (!search || !text) return text;
      const regex = new RegExp(`(${search.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
      return text.replace(regex, '<mark>$1</mark>');
    }

    function buildCasesEmptyState(hasCases, hasActiveFilters){
      if(!hasCases){
        return `
          <div class="cases-empty">
            <strong>No saved cases yet</strong>
            <span>Save your current scenario to build a case library.</span>
          </div>`;
      }
      if(hasActiveFilters){
        return `
          <div class="cases-empty">
            <strong>No matches</strong>
            <span>Clear search or filters to see saved cases.</span>
          </div>`;
      }
      return `
        <div class="cases-empty">
          <strong>No cases available</strong>
          <span>Create and save a scenario to manage it here.</span>
        </div>`;
    }

    let casesViewMode = 'list'; // 'list' or 'monthly'
    let isSelectionMode = false; // Track if selection mode is active
    let selectedCaseIds = new Set(); // Track selected case IDs
    
    function renderCasesList() {
      updateDashboardStats();
      const cases = getAllCases();
      const casesList = qs('#casesList');
      if(!casesList) return;
      const totalCases = Object.keys(cases).length;
      const showArchived = qs('#showArchivedToggle')?.checked || false;
      const archivedCount = Object.values(cases).filter(c => c.archived).length;
      const activeCount = totalCases - archivedCount;
      qs('#caseCount').textContent = showArchived ? totalCases : activeCount;
      const archivedCountEl = qs('#archivedCount');
      if(archivedCountEl) archivedCountEl.textContent = archivedCount;

      const search = (searchCasesInput?.value || '').toLowerCase();
      const buildingFilterValue = (buildingFilterSelect?.value || '').toLowerCase();
      const sortMode = sortCasesSelect?.value || 'newest';
      
      // Advanced filters
      const rentMin = parseFloat(qs('#rentMin')?.value) || null;
      const rentMax = parseFloat(qs('#rentMax')?.value) || null;
      const dateFrom = qs('#dateFrom')?.value || null;
      const dateTo = qs('#dateTo')?.value || null;
      const tenantFilter = (qs('#tenantFilter')?.value || '').toLowerCase();
      
      const hasActiveFilters = Boolean(search || buildingFilterValue || rentMin || rentMax || dateFrom || dateTo || tenantFilter);

      if(buildingFilterSelect) {
        const previousValue = buildingFilterSelect.value;
        const uniqueBuildings = [];
        const seen = new Set();
        Object.values(cases).forEach(c => {
          const name = c.data.buildingName ? String(c.data.buildingName).trim() : '';
          if(!name) return;
          const key = name.toLowerCase();
          if(!seen.has(key)) {
            seen.add(key);
            uniqueBuildings.push(name);
          }
        });
        uniqueBuildings.sort((a,b)=>a.localeCompare(b, undefined, {sensitivity:'base'}));
        const options = ['<option value="">All buildings</option>', ...uniqueBuildings.map(name => `<option value="${name}">${name}</option>`)].join('');
        buildingFilterSelect.innerHTML = options;
        if(previousValue) {
          const match = uniqueBuildings.find(name => name.toLowerCase() === previousValue.toLowerCase());
          buildingFilterSelect.value = match || '';
        } else {
          buildingFilterSelect.value = '';
        }
      }

      const filtered = Object.values(cases).filter(c => {
        // Archive filter
        if(!showArchived && c.archived) return false;
        
        const building = String(c.data.buildingName || '').toLowerCase();
        const unit = String(c.data.unitNo || '').toLowerCase();
        const tenant = String(c.data.tenantName || '').toLowerCase();
        const rent = parseFloat(c.data.totalRent) || 0;
        const caseDate = new Date(c.timestamp);
        
        // Basic filters
        const matchesSearch = !search || c.name.toLowerCase().includes(search) || building.includes(search) || unit.includes(search) || tenant.includes(search);
        const matchesBuilding = !buildingFilterValue || building === buildingFilterValue;
        
        // Advanced filters
        const matchesRentMin = rentMin === null || rent >= rentMin;
        const matchesRentMax = rentMax === null || rent <= rentMax;
        const matchesTenant = !tenantFilter || tenant.includes(tenantFilter);
        
        let matchesDateFrom = true;
        let matchesDateTo = true;
        if (dateFrom) {
          const fromDate = new Date(dateFrom);
          fromDate.setHours(0, 0, 0, 0);
          matchesDateFrom = caseDate >= fromDate;
        }
        if (dateTo) {
          const toDate = new Date(dateTo);
          toDate.setHours(23, 59, 59, 999);
          matchesDateTo = caseDate <= toDate;
        }
        
        return matchesSearch && matchesBuilding && matchesRentMin && matchesRentMax && matchesTenant && matchesDateFrom && matchesDateTo;
      }).sort((a,b) => {
        const timeDiff = new Date(b.timestamp) - new Date(a.timestamp);
        switch(sortMode){
          case 'oldest':
            return -timeDiff;
          case 'name':
            return a.name.localeCompare(b.name, undefined, {sensitivity:'base'}) || timeDiff;
          case 'building': {
            const aBuilding = String(a.data.buildingName || '').toLowerCase();
            const bBuilding = String(b.data.buildingName || '').toLowerCase();
            const buildingDiff = aBuilding.localeCompare(bBuilding);
            if(buildingDiff !== 0) return buildingDiff;
            return timeDiff;
          }
          default:
            return timeDiff;
        }
      });

      // Update result count
      const resultCount = qs('#resultCount');
      if (resultCount) {
        if (hasActiveFilters && filtered.length > 0) {
          resultCount.textContent = ` • ${filtered.length} result${filtered.length !== 1 ? 's' : ''}`;
          resultCount.style.display = '';
        } else {
          resultCount.textContent = '';
          resultCount.style.display = 'none';
        }
      }

      if(filtered.length === 0) {
        casesList.innerHTML = buildCasesEmptyState(totalCases > 0, hasActiveFilters);
        return;
      }
      
      // Render based on view mode
      if (casesViewMode === 'monthly') {
        // Group by month
        const monthGroups = {};
        filtered.forEach(c => {
          const d = new Date(c.timestamp);
          const monthKey = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
          const monthLabel = d.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
          if (!monthGroups[monthKey]) {
            monthGroups[monthKey] = { label: monthLabel, cases: [], totalRent: 0 };
          }
          monthGroups[monthKey].cases.push(c);
          const rent = parseFloat(String(c.data.rent || '0').replace(/,/g, '')) || 0;
          monthGroups[monthKey].totalRent += rent;
        });
        
        const sortedMonths = Object.keys(monthGroups).sort((a, b) => b.localeCompare(a));
        
        casesList.innerHTML = sortedMonths.map(monthKey => {
          const group = monthGroups[monthKey];
          const casesHtml = group.cases.map(c => {
            const date = new Date(c.timestamp).toLocaleString('en-GB', {
              day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit'
            });
            const caseName = highlightText(c.name, search);
            const building = highlightText(c.data.buildingName || '', search);
            const unit = highlightText(c.data.unitNo || 'N/A', search);
            const isSelected = selectedCaseIds.has(c.id);
            const selectableClass = isSelectionMode ? ' selectable' : '';
            const selectedClass = isSelected ? ' selected' : '';
            const archivedClass = c.archived ? ' archived' : '';
            const checkboxHtml = isSelectionMode ? `<input type="checkbox" class="case-checkbox" data-case-id="${c.id}" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation(); toggleCaseSelection('${c.id}')">` : '';
            const rowClick = isSelectionMode ? `onclick="toggleCaseSelection('${c.id}')"` : '';
            const archiveBtn = c.archived 
              ? `<button onclick="event.stopPropagation(); unarchiveCaseById('${c.id}')" class="btn case-row-btn unarchive" title="Unarchive">📤</button>`
              : `<button onclick="event.stopPropagation(); archiveCaseById('${c.id}')" class="btn case-row-btn archive" title="Archive">📥</button>`;
            return `
              <div class="case-row${selectableClass}${selectedClass}${archivedClass}" ${rowClick}>
                ${checkboxHtml}
                <div class="case-row-main">
                  <div class="case-row-title">${caseName}${c.archived ? ' <span style="font-size:0.7rem;color:#9ca3af">(archived)</span>' : ''}</div>
                  <div class="case-row-meta">${building ? building + ' • ' : ''}Unit: ${unit} • ${date}</div>
                </div>
                <div class="case-row-actions">
                  <button onclick="event.stopPropagation(); loadCaseById('${c.id}')" class="btn case-row-btn load" title="Load">📂</button>
                  <button onclick="event.stopPropagation(); editCaseById('${c.id}')" class="btn case-row-btn edit" title="Edit">✏️</button>
                  ${archiveBtn}
                  <button onclick="event.stopPropagation(); deleteCaseById('${c.id}')" class="btn case-row-btn delete" title="Delete">🗑️</button>
                </div>
              </div>
            `;
          }).join('');
          
          const rentDisplay = group.totalRent >= 1000000 
            ? (group.totalRent / 1000000).toFixed(1) + 'M' 
            : group.totalRent >= 1000 
              ? (group.totalRent / 1000).toFixed(0) + 'K'
              : group.totalRent.toFixed(0);
          
          return `
            <div class="month-group">
              <div class="month-header">
                <span class="month-title">📅 ${group.label}</span>
                <div class="month-stats">
                  <span class="month-stat">📋 ${group.cases.length} case${group.cases.length !== 1 ? 's' : ''}</span>
                  <span class="month-stat">💰 AED ${rentDisplay}</span>
                </div>
              </div>
              <div class="month-cases">${casesHtml}</div>
            </div>
          `;
        }).join('');
      } else {
        // List view (default)
        casesList.innerHTML = filtered.map(c => {
          const date = new Date(c.timestamp).toLocaleString('en-GB', {
            day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit'
          });
          const caseName = highlightText(c.name, search);
          const building = highlightText(c.data.buildingName || '', search);
          const unit = highlightText(c.data.unitNo || 'N/A', search);
          const tenant = highlightText(c.data.tenantName || 'N/A', search || tenantFilter);
          const isSelected = selectedCaseIds.has(c.id);
          const selectableClass = isSelectionMode ? ' selectable' : '';
          const selectedClass = isSelected ? ' selected' : '';
          const checkboxHtml = isSelectionMode ? `<input type="checkbox" class="case-checkbox" data-case-id="${c.id}" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation(); toggleCaseSelection('${c.id}')">` : '';
          const rowClick = isSelectionMode ? `onclick="toggleCaseSelection('${c.id}')"` : '';
          const archivedClass = c.archived ? ' archived' : '';
          const archiveBtn = c.archived 
            ? `<button onclick="event.stopPropagation(); unarchiveCaseById('${c.id}')" class="btn case-row-btn unarchive" title="Unarchive">📤</button>`
            : `<button onclick="event.stopPropagation(); archiveCaseById('${c.id}')" class="btn case-row-btn archive" title="Archive">📥</button>`;
          return `
            <div class="case-row${selectableClass}${selectedClass}${archivedClass}" ${rowClick}>
              ${checkboxHtml}
              <div class="case-row-main">
                <div class="case-row-title">${caseName}${c.archived ? ' <span style="font-size:0.7rem;color:#9ca3af">(archived)</span>' : ''}</div>
                <div class="case-row-meta">${building ? building + ' • ' : ''}Unit: ${unit} • Tenant: ${tenant} • ${date}</div>
              </div>
              <div class="case-row-actions">
                <button onclick="event.stopPropagation(); loadCaseById('${c.id}')" class="btn case-row-btn load" title="Load">📂</button>
                <button onclick="event.stopPropagation(); editCaseById('${c.id}')" class="btn case-row-btn edit" title="Edit">✏️</button>
                ${archiveBtn}
                <button onclick="event.stopPropagation(); deleteCaseById('${c.id}')" class="btn case-row-btn delete" title="Delete">🗑️</button>
              </div>
            </div>
          `;
        }).join('');
      }
      updateSelectionCount();
    }

    // Selection Mode Functions
    function toggleSelectionMode() {
      isSelectionMode = !isSelectionMode;
      const btn = qs('#selectModeBtn');
      const bar = qs('#selectionModeBar');
      if(btn) btn.classList.toggle('active', isSelectionMode);
      if(bar) bar.classList.toggle('visible', isSelectionMode);
      if(!isSelectionMode) {
        selectedCaseIds.clear();
      }
      renderCasesList();
    }

    window.toggleCaseSelection = function(caseId) {
      if(selectedCaseIds.has(caseId)) {
        selectedCaseIds.delete(caseId);
      } else {
        selectedCaseIds.add(caseId);
      }
      renderCasesList();
    };

    function updateSelectionCount() {
      const countEl = qs('#selectedCount');
      const genBtn = qs('#generateStatementBtn');
      if(countEl) countEl.textContent = selectedCaseIds.size;
      if(genBtn) genBtn.disabled = selectedCaseIds.size === 0;
    }

    function selectAllCases() {
      const cases = getAllCases();
      Object.keys(cases).forEach(id => selectedCaseIds.add(id));
      renderCasesList();
    }

    function deselectAllCases() {
      selectedCaseIds.clear();
      renderCasesList();
    }

    // Calculate settlement data for a case
    function calculateCaseSettlement(caseData) {
      const data = caseData.data;
      const isEmptyTenant = (data.tenantName || '').toLowerCase() === 'empty' || (data.tenantName || '').toLowerCase() === 'empty unit';
      
      const rent = parseFloat(String(data.rent || '0').replace(/,/g, '')) || 0;
      const secDeposit = parseFloat(String(data.securityDeposit || '0').replace(/,/g, '')) || 0;
      const serviceChg = parseFloat(String(data.serviceCharge || '0').replace(/,/g, '')) || 0;
      
      // Calculate PDC total - ONLY non-cleared cheques (these are handed over to buyer)
      let pdcTotal = 0;
      if(data.cheques && Array.isArray(data.cheques)) {
        data.cheques.forEach(chq => {
          // Only count cheques that are NOT cleared (PDC = Post-Dated Cheques handed to buyer)
          if(!chq.cleared) {
            const amt = parseFloat(String(chq.amount || '0').replace(/,/g, '')) || 0;
            pdcTotal += amt;
          }
        });
      }
      
      // Calculate days
      const ls = data.leaseStart;
      const le = data.leaseEnd;
      const ho = data.handoverDate;
      
      let totalDays = 0, sellerDays = 0, buyerDays = 0;
      let buyerRent = 0, sellerRent = 0;
      
      if(!isEmptyTenant && ls && le && ho) {
        totalDays = daysInclusive(ls, le);
        sellerDays = Math.max(0, daysInclusive(ls, ho));
        buyerDays = Math.max(0, totalDays - sellerDays);
        
        const daily = totalDays ? rent / totalDays : 0;
        sellerRent = daily * sellerDays;
        buyerRent = rent - sellerRent;
      }
      
      // Calculate net settlement
      const adj = buyerRent - pdcTotal;
      const net = Number((adj + secDeposit - serviceChg).toFixed(2));
      
      return {
        caseName: caseData.name,
        building: data.buildingName || '',
        unit: data.unitNo || '',
        tenant: data.tenantName || '',
        buyerName: data.buyerName || '',
        rent: rent,
        buyerRent: buyerRent,
        sellerRent: sellerRent,
        pdcTotal: pdcTotal,
        securityDeposit: secDeposit,
        serviceCharge: serviceChg,
        net: net,
        isSellerPays: net >= 0
      };
    }

    // Generate aggregate statement
    function generateAggregateStatement() {
      if(selectedCaseIds.size === 0) return;
      
      const cases = getAllCases();
      const settlements = [];
      let totals = {
        rent: 0, buyerRent: 0, pdcTotal: 0, securityDeposit: 0, serviceCharge: 0, sellerPays: 0, buyerPays: 0
      };
      
      // Helper to get first and last name only
      function getFirstLastName(fullName) {
        if(!fullName) return '-';
        const parts = fullName.trim().split(/\s+/);
        if(parts.length === 1) return parts[0];
        if(parts.length === 2) return parts.join(' ');
        return `${parts[0]} ${parts[parts.length - 1]}`;
      }
      
      selectedCaseIds.forEach(id => {
        const caseData = cases[id];
        // Skip archived cases - they should not be in aggregate calculation
        if(caseData && !caseData.archived) {
          const settlement = calculateCaseSettlement(caseData);
          settlement.buyerName = getFirstLastName(settlement.buyerName);
          settlements.push(settlement);
          totals.rent += settlement.rent;
          totals.buyerRent += settlement.buyerRent;
          totals.pdcTotal += settlement.pdcTotal;
          totals.securityDeposit += settlement.securityDeposit;
          totals.serviceCharge += settlement.serviceCharge;
          if(settlement.net >= 0) {
            totals.sellerPays += settlement.net;
          } else {
            totals.buyerPays += Math.abs(settlement.net);
          }
        }
      });
      
      const netTotal = totals.sellerPays - totals.buyerPays;
      
      // Update summary
      const summaryEl = qs('#aggregateSummary');
      if(summaryEl) {
        summaryEl.innerHTML = `
          <div class="aggregate-stat">
            <div class="aggregate-stat-value">${settlements.length}</div>
            <div class="aggregate-stat-label">Cases</div>
          </div>
          <div class="aggregate-stat">
            <div class="aggregate-stat-value">${totals.rent.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
            <div class="aggregate-stat-label">Total Rent</div>
          </div>
          <div class="aggregate-stat">
            <div class="aggregate-stat-value">${totals.pdcTotal.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
            <div class="aggregate-stat-label">Total PDC</div>
          </div>
          <div class="aggregate-stat">
            <div class="aggregate-stat-value ${netTotal >= 0 ? '' : 'negative'}">AED ${Math.abs(netTotal).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
            <div class="aggregate-stat-label">${netTotal >= 0 ? 'Seller → Buyer' : 'Buyer → Seller'}</div>
          </div>
        `;
      }
      
      // Update table body
      const tableBody = qs('#aggregateTableBody');
      if(tableBody) {
        tableBody.innerHTML = settlements.map(s => {
          const netClass = s.net >= 0 ? 'positive' : 'negative';
          const netLabel = s.net >= 0 ? 'S→B' : 'B→S';
          return `
            <tr>
              <td>${sanitizeString(s.building) || '-'}</td>
              <td><strong>${sanitizeString(s.unit)}</strong></td>
              <td class="owner-cell" title="${sanitizeString(s.buyerName)}">${sanitizeString(s.buyerName) || '-'}</td>
              <td class="amount neutral">${s.buyerRent.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
              <td class="amount negative">-${s.pdcTotal.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
              <td class="amount positive">+${s.securityDeposit.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
              <td class="amount negative">-${s.serviceCharge.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
              <td class="amount net-cell ${netClass}">AED ${Math.abs(s.net).toLocaleString('en-US', {minimumFractionDigits: 2})} <small>${netLabel}</small></td>
            </tr>
          `;
        }).join('');
      }
      
      // Update table footer
      const tableFoot = qs('#aggregateTableFoot');
      if(tableFoot) {
        const netTotalClass = netTotal >= 0 ? 'positive' : 'negative';
        const netTotalLabel = netTotal >= 0 ? 'S→B' : 'B→S';
        tableFoot.innerHTML = `
          <tr>
            <td colspan="3"><strong>TOTAL</strong> · ${settlements.length} cases</td>
            <td class="amount">${totals.buyerRent.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
            <td class="amount negative">-${totals.pdcTotal.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
            <td class="amount positive">+${totals.securityDeposit.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
            <td class="amount negative">-${totals.serviceCharge.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
            <td class="amount net-cell ${netTotalClass}">AED ${Math.abs(netTotal).toLocaleString('en-US', {minimumFractionDigits: 2})} <small>${netTotalLabel}</small></td>
          </tr>
        `;
      }
      
      // Store data for copy/export
      window.aggregateData = { settlements, totals, netTotal };
      
      // Show modal
      const modal = qs('#aggregateModal');
      if(modal) modal.style.display = 'flex';
    }

    function closeAggregateModal() {
      const modal = qs('#aggregateModal');
      if(modal) modal.style.display = 'none';
    }

    function copyAggregateToClipboard() {
      if(!window.aggregateData) return;
      const { settlements, totals, netTotal } = window.aggregateData;
      
      // Create tab-separated format for Excel
      let text = 'Tower\tUnit\tNew Owner\tBuyer Rent (Pro-rata)\tLess: PDC Handed Over\tAdd: Security Deposit\tLess: Service Charge\tNet Settlement\n';
      
      settlements.forEach(s => {
        const direction = s.net >= 0 ? 'Seller → Buyer' : 'Buyer → Seller';
        text += `${s.building || '-'}\t${s.unit}\t${s.buyerName || '-'}\t`;
        text += `AED ${s.buyerRent.toLocaleString('en-US', {minimumFractionDigits: 2})}\t`;
        text += `- AED ${s.pdcTotal.toLocaleString('en-US', {minimumFractionDigits: 2})}\t`;
        text += `+ AED ${s.securityDeposit.toLocaleString('en-US', {minimumFractionDigits: 2})}\t`;
        text += `- AED ${s.serviceCharge.toLocaleString('en-US', {minimumFractionDigits: 2})}\t`;
        text += `AED ${Math.abs(s.net).toLocaleString('en-US', {minimumFractionDigits: 2})} (${direction})\n`;
      });
      
      // Totals row
      const netTotalLabel = netTotal >= 0 ? 'Seller → Buyer' : 'Buyer → Seller';
      text += `\nTOTALS\t${settlements.length} cases\t\t`;
      text += `AED ${totals.buyerRent.toLocaleString('en-US', {minimumFractionDigits: 2})}\t`;
      text += `- AED ${totals.pdcTotal.toLocaleString('en-US', {minimumFractionDigits: 2})}\t`;
      text += `+ AED ${totals.securityDeposit.toLocaleString('en-US', {minimumFractionDigits: 2})}\t`;
      text += `- AED ${totals.serviceCharge.toLocaleString('en-US', {minimumFractionDigits: 2})}\t`;
      text += `AED ${Math.abs(netTotal).toLocaleString('en-US', {minimumFractionDigits: 2})} (${netTotalLabel})\n`;
      
      navigator.clipboard.writeText(text).then(() => {
        showToast('Copied! Paste into Excel for formatted table');
      }).catch(err => {
        console.error('Copy failed:', err);
        alert('Copy failed. Please try again.');
      });
    }

    async function exportAggregateToPdf() {
      if(!window.aggregateData) return;
      const { settlements, totals, netTotal } = window.aggregateData;
      
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('landscape', 'mm', 'a4');
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        
        // Header
        doc.setFillColor(15, 45, 85);
        doc.rect(0, 0, pageWidth, 22, 'F');
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(14);
        doc.setTextColor(255, 255, 255);
        doc.text('AGGREGATE SETTLEMENT STATEMENT', 14, 14);
        doc.setFontSize(9);
        doc.text(`Generated: ${new Date().toLocaleDateString('en-GB')}`, pageWidth - 14, 14, { align: 'right' });
        
        let y = 32;
        
        // Summary boxes
        doc.setFillColor(240, 253, 244);
        doc.rect(14, y, pageWidth - 28, 14, 'F');
        doc.setTextColor(5, 150, 105);
        doc.setFontSize(9);
        doc.setFont('helvetica', 'bold');
        doc.text(`${settlements.length} Cases`, 20, y + 9);
        doc.text(`Buyer Rent: AED ${totals.buyerRent.toLocaleString('en-US', {minimumFractionDigits: 2})}`, 55, y + 9);
        doc.text(`PDC: - AED ${totals.pdcTotal.toLocaleString('en-US', {minimumFractionDigits: 2})}`, 120, y + 9);
        doc.text(`Deposit: + AED ${totals.securityDeposit.toLocaleString('en-US', {minimumFractionDigits: 2})}`, 175, y + 9);
        doc.setTextColor(netTotal >= 0 ? 5 : 220, netTotal >= 0 ? 150 : 38, netTotal >= 0 ? 105 : 38);
        doc.text(`Net: AED ${Math.abs(netTotal).toLocaleString('en-US', {minimumFractionDigits: 2})} (${netTotal >= 0 ? 'Seller→Buyer' : 'Buyer→Seller'})`, 235, y + 9);
        
        y += 22;
        
        // Table headers
        doc.setFillColor(248, 250, 252);
        doc.rect(14, y, pageWidth - 28, 10, 'F');
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(8);
        doc.setTextColor(71, 85, 105);
        
        const cols = [14, 50, 80, 115, 150, 185, 220, 250];
        doc.text('Tower', cols[0] + 2, y + 6);
        doc.text('Unit', cols[1] + 2, y + 6);
        doc.text('New Owner', cols[2] + 2, y + 6);
        doc.text('Buyer Rent', cols[3] + 2, y + 6);
        doc.text('Less: PDC', cols[4] + 2, y + 6);
        doc.text('Add: Deposit', cols[5] + 2, y + 6);
        doc.text('Less: SC', cols[6] + 2, y + 6);
        doc.text('Net Settlement', cols[7] + 2, y + 6);
        
        y += 12;
        
        // Table rows
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(8);
        
        settlements.forEach(s => {
          if(y > pageHeight - 25) {
            doc.addPage();
            y = 20;
          }
          
          doc.setTextColor(51, 65, 85);
          doc.text((s.building || '-').substring(0, 18), cols[0] + 2, y);
          doc.setFont('helvetica', 'bold');
          doc.text((s.unit || '-').substring(0, 12), cols[1] + 2, y);
          doc.setFont('helvetica', 'normal');
          doc.text((s.buyerName || '-').substring(0, 18), cols[2] + 2, y);
          doc.text(`${s.buyerRent.toLocaleString('en-US', {minimumFractionDigits: 2})}`, cols[3] + 2, y);
          doc.setTextColor(220, 38, 38);
          doc.text(`- ${s.pdcTotal.toLocaleString('en-US', {minimumFractionDigits: 2})}`, cols[4] + 2, y);
          doc.setTextColor(5, 150, 105);
          doc.text(`+ ${s.securityDeposit.toLocaleString('en-US', {minimumFractionDigits: 2})}`, cols[5] + 2, y);
          doc.setTextColor(220, 38, 38);
          doc.text(`- ${s.serviceCharge.toLocaleString('en-US', {minimumFractionDigits: 2})}`, cols[6] + 2, y);
          
          doc.setTextColor(s.net >= 0 ? 5 : 220, s.net >= 0 ? 150 : 38, s.net >= 0 ? 105 : 38);
          doc.setFont('helvetica', 'bold');
          const netLabel = s.net >= 0 ? 'S→B' : 'B→S';
          doc.text(`${Math.abs(s.net).toLocaleString('en-US', {minimumFractionDigits: 2})} (${netLabel})`, cols[7] + 2, y);
          doc.setFont('helvetica', 'normal');
          
          y += 8;
        });
        
        // Totals row
        y += 3;
        doc.setFillColor(241, 245, 249);
        doc.rect(14, y - 5, pageWidth - 28, 12, 'F');
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(8);
        doc.setTextColor(30, 41, 59);
        doc.text(`TOTALS (${settlements.length} cases)`, cols[0] + 2, y + 2);
        doc.text(`${totals.buyerRent.toLocaleString('en-US', {minimumFractionDigits: 2})}`, cols[3] + 2, y + 2);
        doc.setTextColor(220, 38, 38);
        doc.text(`- ${totals.pdcTotal.toLocaleString('en-US', {minimumFractionDigits: 2})}`, cols[4] + 2, y + 2);
        doc.setTextColor(5, 150, 105);
        doc.text(`+ ${totals.securityDeposit.toLocaleString('en-US', {minimumFractionDigits: 2})}`, cols[5] + 2, y + 2);
        doc.setTextColor(220, 38, 38);
        doc.text(`- ${totals.serviceCharge.toLocaleString('en-US', {minimumFractionDigits: 2})}`, cols[6] + 2, y + 2);
        doc.setTextColor(netTotal >= 0 ? 5 : 220, netTotal >= 0 ? 150 : 38, netTotal >= 0 ? 105 : 38);
        const netTotalLabel = netTotal >= 0 ? 'S→B' : 'B→S';
        doc.text(`${Math.abs(netTotal).toLocaleString('en-US', {minimumFractionDigits: 2})} (${netTotalLabel})`, cols[7] + 2, y + 2);
        
        // Download
        const filename = `Aggregate_Settlement_${new Date().toISOString().split('T')[0]}.pdf`;
        doc.save(filename);
        showToast('PDF exported successfully!');
        
      } catch(err) {
        console.error('PDF export failed:', err);
        alert('PDF export failed. Please try again.');
      }
    }

    function printAggregateStatement() {
      if(!window.aggregateData) return;
      
      // Get the table content
      const { settlements, totals, netTotal } = window.aggregateData;
      
      // Create a simple print window
      const printWin = window.open('', '_blank', 'width=900,height=700');
      if(!printWin) {
        alert('Please allow popups to print');
        return;
      }
      
      const netLabel = netTotal >= 0 ? 'Seller → Buyer' : 'Buyer → Seller';
      
      let tableRows = settlements.map(s => {
        const dir = s.net >= 0 ? 'S→B' : 'B→S';
        return `
          <tr>
            <td>${s.building || '-'}</td>
            <td><strong>${s.unit}</strong></td>
            <td>${s.buyerName || '-'}</td>
            <td style="text-align:right">${s.buyerRent.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
            <td style="text-align:right;color:#dc2626">-${s.pdcTotal.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
            <td style="text-align:right;color:#059669">+${s.securityDeposit.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
            <td style="text-align:right;color:#dc2626">-${s.serviceCharge.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
            <td style="text-align:right;font-weight:600;color:${s.net >= 0 ? '#059669' : '#dc2626'}">AED ${Math.abs(s.net).toLocaleString('en-US', {minimumFractionDigits: 2})} <small>${dir}</small></td>
          </tr>
        `;
      }).join('');
      
      const html = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>Aggregate Settlement Statement</title>
          <style>
            @page { size: landscape; margin: 10mm; }
            body { font-family: Arial, sans-serif; padding: 20px; margin: 0; }
            h2 { margin: 0 0 5px 0; font-size: 16px; }
            .date { color: #666; font-size: 12px; margin-bottom: 15px; }
            .summary { display: flex; gap: 30px; margin-bottom: 15px; padding: 10px; background: #f9f9f9; }
            .summary div { text-align: center; }
            .summary .val { font-size: 16px; font-weight: 600; }
            .summary .lbl { font-size: 10px; color: #666; text-transform: uppercase; }
            table { width: 100%; border-collapse: collapse; font-size: 11px; }
            th { background: #f3f3f3; padding: 8px 6px; text-align: left; font-weight: 600; border-bottom: 1px solid #ddd; font-size: 10px; text-transform: uppercase; }
            td { padding: 8px 6px; border-bottom: 1px solid #eee; }
            tfoot td { background: #f3f3f3; font-weight: 600; border-top: 2px solid #ddd; }
            small { color: #888; font-size: 9px; }
            @media print { body { padding: 10px; } }
          </style>
        </head>
        <body>
          <h2>Aggregate Settlement Statement</h2>
          <div class="date">Generated: ${new Date().toLocaleDateString('en-GB')}</div>
          <div class="summary">
            <div><div class="val">${settlements.length}</div><div class="lbl">Cases</div></div>
            <div><div class="val">${totals.rent.toLocaleString('en-US', {minimumFractionDigits: 0})}</div><div class="lbl">Total Rent</div></div>
            <div><div class="val">${totals.pdcTotal.toLocaleString('en-US', {minimumFractionDigits: 0})}</div><div class="lbl">Total PDC</div></div>
            <div><div class="val" style="color:${netTotal >= 0 ? '#059669' : '#dc2626'}">AED ${Math.abs(netTotal).toLocaleString('en-US', {minimumFractionDigits: 2})}</div><div class="lbl">${netLabel}</div></div>
          </div>
          <table>
            <thead>
              <tr>
                <th>Tower</th>
                <th>Unit</th>
                <th>New Owner</th>
                <th style="text-align:right">Buyer Rent</th>
                <th style="text-align:right">Less: PDC</th>
                <th style="text-align:right">Add: Deposit</th>
                <th style="text-align:right">Less: SC</th>
                <th style="text-align:right">Net Settlement</th>
              </tr>
            </thead>
            <tbody>${tableRows}</tbody>
            <tfoot>
              <tr>
                <td colspan="3"><strong>TOTAL</strong> · ${settlements.length} cases</td>
                <td style="text-align:right">${totals.buyerRent.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                <td style="text-align:right;color:#dc2626">-${totals.pdcTotal.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                <td style="text-align:right;color:#059669">+${totals.securityDeposit.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                <td style="text-align:right;color:#dc2626">-${totals.serviceCharge.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                <td style="text-align:right;font-weight:600;color:${netTotal >= 0 ? '#059669' : '#dc2626'}">AED ${Math.abs(netTotal).toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
              </tr>
            </tfoot>
          </table>
          <script>window.onload = function() { window.print(); }<\/script>
        </body>
        </html>
      `;
      
      printWin.document.write(html);
      printWin.document.close();
    }

    window.loadCaseById = function(caseId) {
      loadCase(caseId);
      closeModal();
    };

    window.deleteCaseById = function(caseId) {
      const cases = getAllCases();
      if(cases[caseId] && confirm(`Delete "${cases[caseId].name}"?`)) {
        deleteCase(caseId);
        renderCasesList();
        showToast('Case deleted');
      }
    };

    window.archiveCaseById = function(caseId) {
      const cases = getAllCases();
      if(cases[caseId]) {
        cases[caseId].archived = true;
        localStorage.setItem(CASES_KEY, JSON.stringify(cases));
        renderCasesList();
        showToast('Case archived');
      }
    };

    window.unarchiveCaseById = function(caseId) {
      const cases = getAllCases();
      if(cases[caseId]) {
        cases[caseId].archived = false;
        localStorage.setItem(CASES_KEY, JSON.stringify(cases));
        renderCasesList();
        showToast('Case restored');
      }
    };

    window.editCaseById = function(caseId) {
      const cases = getAllCases();
      const caseData = cases[caseId];
      if(!caseData) return;
      
      // Create edit modal
      const currentName = caseData.name || '';
      const currentUnit = caseData.data?.unitNo || '';
      const currentBuilding = caseData.data?.buildingName || '';
      const currentTenant = caseData.data?.tenantName || '';
      
      const editHtml = `
        <div class="building-picker-overlay" id="editCaseOverlay">
          <div class="building-picker" style="max-width:450px">
            <div class="building-picker-title">✏️ Edit Case</div>
            <div class="building-picker-subtitle">Update case name, unit number, or building</div>
            
            <div style="margin-bottom:12px">
              <label style="display:block;font-size:0.85rem;color:#6b7280;margin-bottom:4px">Case Name</label>
              <input type="text" id="editCaseName" class="building-picker-input" value="${currentName.replace(/"/g, '&quot;')}" style="margin-bottom:0">
            </div>
            
            <div style="margin-bottom:12px">
              <label style="display:block;font-size:0.85rem;color:#6b7280;margin-bottom:4px">Unit Number</label>
              <input type="text" id="editCaseUnit" class="building-picker-input" value="${currentUnit.replace(/"/g, '&quot;')}" style="margin-bottom:0">
            </div>
            
            <div style="margin-bottom:12px">
              <label style="display:block;font-size:0.85rem;color:#6b7280;margin-bottom:4px">Building/Tower</label>
              <input type="text" id="editCaseBuilding" class="building-picker-input" value="${currentBuilding.replace(/"/g, '&quot;')}" style="margin-bottom:0" list="buildingHistory">
            </div>
            
            <div style="margin-bottom:16px">
              <label style="display:block;font-size:0.85rem;color:#6b7280;margin-bottom:4px">Tenant Name</label>
              <input type="text" id="editCaseTenant" class="building-picker-input" value="${currentTenant.replace(/"/g, '&quot;')}" style="margin-bottom:0">
            </div>
            
            <div class="building-picker-actions">
              <button class="btn gray" onclick="closeEditCaseModal()">Cancel</button>
              <button class="btn positive" onclick="saveEditedCase('${caseId}')">Save Changes</button>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', editHtml);
    };

    window.closeEditCaseModal = function() {
      const overlay = qs('#editCaseOverlay');
      if(overlay) overlay.remove();
    };

    window.saveEditedCase = function(caseId) {
      const cases = getAllCases();
      if(!cases[caseId]) return;
      
      const newName = qs('#editCaseName')?.value?.trim();
      const newUnit = qs('#editCaseUnit')?.value?.trim();
      const newBuilding = qs('#editCaseBuilding')?.value?.trim();
      const newTenant = qs('#editCaseTenant')?.value?.trim();
      
      if(!newName) {
        alert('Please enter a case name');
        return;
      }
      
      // Update case data
      cases[caseId].name = newName;
      if(cases[caseId].data) {
        cases[caseId].data.unitNo = newUnit || '';
        cases[caseId].data.buildingName = newBuilding || '';
        cases[caseId].data.tenantName = newTenant || '';
      }
      cases[caseId].timestamp = new Date().toISOString();
      
      // Check if we need to update the case ID (based on new name)
      const newCaseId = newName.toLowerCase().replace(/[^a-z0-9]/g, '_');
      if(newCaseId !== caseId) {
        // Create new entry with new ID
        cases[newCaseId] = cases[caseId];
        cases[newCaseId].id = newCaseId;
        delete cases[caseId];
        
        // Update currentCaseId if this was the active case
        if(currentCaseId === caseId) {
          currentCaseId = newCaseId;
          const origBuilding = (newBuilding || '').trim().toLowerCase();
          const origUnit = (newUnit || '').trim().toLowerCase();
          currentCaseOriginalKey = origBuilding + '|' + origUnit;
        }
      }
      
      localStorage.setItem(CASES_KEY, JSON.stringify(cases));
      closeEditCaseModal();
      renderCasesList();
      showToast('Case updated');
      
      // Save building to history if provided
      if(newBuilding) {
        saveBuildingToHistory(newBuilding);
      }
    };

    initChequesUI();
    wireEvents();
    setupCollapsibleSections();
    updateSectionHealth();
    updateHealthRibbon();
    updateBuildingDatalist(); // Load building history
    updateBankDatalist(); // Load bank history
    
    // Enter key exits current input field
    (function(){
      const exitSelector = 'input:not([type="button"]):not([type="submit"]):not([type="checkbox"]):not([type="radio"]):not([type="hidden"]), select, textarea';
      document.body.addEventListener('keydown', function(e){
        if(e.key === 'Enter' && !e.shiftKey && !e.ctrlKey && !e.metaKey && !e.altKey){
          const el = e.target;
          if(el && el.matches && el.matches(exitSelector)){
            e.preventDefault();
            e.stopImmediatePropagation();
            el.blur();
          }
        }
      }, true);
    })();
    
    // Also attach directly to all inputs for maximum compatibility
    qsa('input, select').forEach(function(el){
      el.addEventListener('keypress', function(e){
        if(e.key === 'Enter' || e.keyCode === 13){
          e.preventDefault();
          this.blur();
        }
      });
    });
    
    // View toggle for cases list
    const viewListBtn = qs('#viewList');
    const viewMonthlyBtn = qs('#viewMonthly');
    if (viewListBtn && viewMonthlyBtn) {
      viewListBtn.addEventListener('click', () => {
        casesViewMode = 'list';
        viewListBtn.classList.add('active');
        viewMonthlyBtn.classList.remove('active');
        renderCasesList();
      });
      viewMonthlyBtn.addEventListener('click', () => {
        casesViewMode = 'monthly';
        viewMonthlyBtn.classList.add('active');
        viewListBtn.classList.remove('active');
        renderCasesList();
      });
    }
    
    // Selection mode event listeners
    const selectModeBtn = qs('#selectModeBtn');
    const selectAllBtn = qs('#selectAllBtn');
    const deselectAllBtn = qs('#deselectAllBtn');
    const generateStatementBtn = qs('#generateStatementBtn');
    const closeAggregateModalBtn = qs('#closeAggregateModal');
    const closeAggregateBtn = qs('#closeAggregateBtn');
    const copyAggregateBtn = qs('#copyAggregateBtn');
    const exportAggregatePdfBtn = qs('#exportAggregatePdfBtn');
    
    if(selectModeBtn) selectModeBtn.addEventListener('click', toggleSelectionMode);
    if(selectAllBtn) selectAllBtn.addEventListener('click', selectAllCases);
    if(deselectAllBtn) deselectAllBtn.addEventListener('click', deselectAllCases);
    if(generateStatementBtn) generateStatementBtn.addEventListener('click', generateAggregateStatement);
    if(closeAggregateModalBtn) closeAggregateModalBtn.addEventListener('click', closeAggregateModal);
    if(closeAggregateBtn) closeAggregateBtn.addEventListener('click', closeAggregateModal);
    if(copyAggregateBtn) copyAggregateBtn.addEventListener('click', copyAggregateToClipboard);
    if(exportAggregatePdfBtn) exportAggregatePdfBtn.addEventListener('click', exportAggregateToPdf);
    const printAggregateBtn = qs('#printAggregateBtn');
    if(printAggregateBtn) printAggregateBtn.addEventListener('click', printAggregateStatement);
    
    // Archive toggle listener
    const showArchivedToggle = qs('#showArchivedToggle');
    if(showArchivedToggle) showArchivedToggle.addEventListener('change', renderCasesList);
    
    // Close aggregate modal when clicking backdrop
    const aggregateModal = qs('#aggregateModal');
    if(aggregateModal) {
      aggregateModal.addEventListener('click', (e) => {
        if(e.target === aggregateModal) closeAggregateModal();
      });
    }
    
    // Apply currency formatting to main amount fields
    [rentInput, securityDeposit, serviceCharge].forEach(input => {
      if (input) formatCurrencyInput(input);
    });
    
    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
      const modifier = isMac ? e.metaKey : e.ctrlKey;
      
      // Don't trigger if typing in an input field (except for specific shortcuts)
      const isTyping = ['INPUT', 'TEXTAREA', 'SELECT'].includes(document.activeElement.tagName);
      
      // Escape - Close any open modal
      if (e.key === 'Escape') {
        if (healthModal && healthModal.classList.contains('show')) {
          healthModal.classList.remove('show');
        }
        if (notesModal && notesModal.classList.contains('show')) {
          notesModal.classList.remove('show');
        }
        const commModal = qs('#commModal');
        if (commModal && commModal.classList.contains('show')) {
          commModal.classList.remove('show');
        }
        document.activeElement.blur();
        return;
      }
      
      if (!modifier) return;
      
      // Ctrl/Cmd + Enter - Calculate
      if (e.key === 'Enter') {
        e.preventDefault();
        calculate();
        return;
      }
      
      // Skip other shortcuts if typing in input
      if (isTyping) return;
      
      // Ctrl/Cmd + S - Save (trigger autosave)
      if (e.key === 's' || e.key === 'S') {
        e.preventDefault();
        saveState();
        if (autosaveStatus) {
          autosaveStatus.textContent = '✓ Saved';
          autosaveStatus.style.color = '#10b981';
          setTimeout(() => { autosaveStatus.style.color = ''; }, 1500);
        }
        return;
      }
      
      // Ctrl/Cmd + Shift + P - Preview PDF
      if ((e.key === 'p' || e.key === 'P') && e.shiftKey) {
        e.preventDefault();
        previewPDF();
        return;
      }
      
      // Ctrl/Cmd + P - Export PDF
      if (e.key === 'p' || e.key === 'P') {
        e.preventDefault();
        exportToPDF();
        return;
      }
      
      // Ctrl/Cmd + E - Export Excel
      if (e.key === 'e' || e.key === 'E') {
        e.preventDefault();
        exportToExcel();
        return;
      }
      
      // Ctrl/Cmd + Shift + R - Reset form (Shift to avoid browser refresh)
      if ((e.key === 'r' || e.key === 'R') && e.shiftKey) {
        e.preventDefault();
        resetAll();
        return;
      }
    });
    
    // Load saved state on page load
    setTimeout(() => {
      debouncedSave.cancel(); // Cancel any pending autosave from initialization
      loadState();
      
      // Capture the restored serviceCharge value BEFORE any toggle/calc overwrites it
      let restoredScValue = null;
      let restoredScAutoMode = true;
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if(saved) {
          const parsed = JSON.parse(saved);
          const state = parsed.state || parsed;
          restoredScValue = state.serviceCharge || null;
          restoredScAutoMode = state.scBuyerAutoMode !== false; // default to true
        }
      } catch(e) {}
      
      // Apply master SC toggle state on initial load
      try{
        const masterToggle = qs('#scMasterToggle');
        if(masterToggle && typeof updateScMasterEnabled === 'function'){
          updateScMasterEnabled(masterToggle.checked, true);
        }
      }catch(e){}
      
      // Re-apply the manual SC value if the case was saved with manual mode
      try {
        if(!restoredScAutoMode && restoredScValue) {
          const scBuyerToggle = qs('#scBuyerAutoMode');
          const scBuyerInputEl = qs('#serviceCharge');
          if(scBuyerToggle) {
            scBuyerToggle.checked = false;
          }
          if(scBuyerInputEl) {
            scBuyerInputEl.readOnly = false;
            scBuyerInputEl.placeholder = 'Enter amount';
            scBuyerInputEl.style.background = '';
            setCurrencyValue(scBuyerInputEl, restoredScValue);
          }
        }
      } catch(e) { console.warn('Re-applying manual SC on load failed', e); }
      
      // Update SC value flag on load
      try{ if(typeof updateScValueFlag === 'function') updateScValueFlag(); }catch(e){}
      // Update Cutoff date flag on load
      try{ if(typeof updateCutoffValueFlag === 'function') updateCutoffValueFlag(); }catch(e){}
      // Update SC Paid End flag on load
      try{ if(typeof updateScPaidEndFlag === 'function') updateScPaidEndFlag(); }catch(e){}
      // Set isInitializing to false after debounce timers would have fired
      setTimeout(() => { 
        isInitializing = false;
        // Auto-calculate on page load if required fields are filled (silent mode)
        if(typeof areRequiredFieldsFilled === 'function' && areRequiredFieldsFilled()) {
          try { calculate(true); } catch(e) { console.warn('Auto-calculate on load failed', e); }
        }
        // Restore scroll position if saved (from refresh button)
        try {
          const savedScrollPos = sessionStorage.getItem('rs_scrollPos');
          if(savedScrollPos) {
            window.scrollTo(0, parseInt(savedScrollPos, 10));
            sessionStorage.removeItem('rs_scrollPos');
          }
        } catch(e) { console.warn('Scroll restore failed', e); }
      }, 400);
    }, 100);
    
    window._rs = { calculate, resetAll };
  })();
  </script><datalist id="bankHistoryList"><option value="ENBD"></option><option value="ADCB"></option><option value="FAB"></option><option value="DIB"></option><option value="CBD"></option><option value="Mashreq"></option><option value="RAK Bank"></option><option value="ADIB"></option><option value="NBF"></option><option value="UAB"></option></datalist>


    
  
  

    
  
  

    
  
  

    
  
  

    
  
  

    
  
  

    
  
  

    
  
  

</body></html>
